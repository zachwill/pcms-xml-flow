<% initial_team = @initial_team.to_s %>

<%# Build team_id lookup for back button logos %>
<% team_id_map = @team_meta_by_code.transform_values { |meta| meta["team_id"] }.to_json %>
<% salary_book_base_path = root_path %>

<%# Season column state machine:
    - Hover/focus year header => preview (selectedseason + selectedseasonteam)
    - Click year header => lock/unlock preview (seasonlocked)
    - Active team changes => clear lock + preview
%>
<div
  id="salarybook"
  class="h-screen w-screen flex flex-col overflow-hidden bg-background"
  data-signals="{
    activeteam: '<%= initial_team %>',
    selectedseason: '',
    selectedseasonteam: '',
    seasonlocked: false,
    sidebarview: 'teamview',
    overlaytype: 'none',
    overlayid: '',
    sidebarteamloaded: '<%= initial_team %>',
    sidebarcapyearloaded: '<%= @salary_year %>',
    sidebardraftloaded: false,
    sidebardraftyearloaded: '',
    sidebarrightsloaded: false,
    displaycapholds: false,
    displayexceptions: true,
    displaydraftpicks: true,
    displaydeadmoney: false,
    displayepm: false,
    displaytaxaprons: true,
    displaycashvscap: false,
    displayluxurytax: false,
    displayoptions: true,
    displayincentives: true,
    displaytwoway: true
  }"
  data-effect="
    if ($seasonlocked && $selectedseasonteam && $selectedseasonteam !== $activeteam) {
      $seasonlocked = false;
      $selectedseason = '';
      $selectedseasonteam = '';
    }
  "
>
  <div id="flash"></div>

  <%# Sidebar loader: hover/locked year updates for the currently loaded team. %>
  <div
    id="salarybook-sidebar-loader"
    class="hidden"
    aria-hidden="true"
    data-effect="
      const effectiveyear = (($selectedseasonteam === $activeteam && $selectedseason !== '') ? $selectedseason : '<%= @salary_year %>');
      if ($activeteam && $sidebarteamloaded === $activeteam && String($sidebarcapyearloaded) !== String(effectiveyear)) {
        $sidebarcapyearloaded = effectiveyear;
        @get('/tools/salary-book/sidebar/team/cap?team=' + $activeteam + '&year=' + effectiveyear);
      }
    "
  ></div>

  <%# Command bar (prototype height: 130px) %>
  <header
    id="commandbar"
    class="shrink-0 h-[130px] border-b border-border bg-background flex items-start px-4 pt-3 gap-4"
  >
    <% if @teams_by_conference["Eastern"].any? || @teams_by_conference["Western"].any? %>
      <%# Team Selector Grid %>
      <div class="flex gap-4" role="navigation" aria-label="Teams">
        <% %w[Eastern Western].each do |conf| %>
          <div class="space-y-1">
            <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70"><%= conf %></div>
            <div class="grid grid-cols-5 gap-1">
              <% @teams_by_conference[conf].each do |team| %>
                <button
                  type="button"
                  class="cursor-pointer relative h-7 px-2 rounded text-xs font-medium transition-all duration-150 border outline-none inline-flex items-center justify-center"
                  data-on:click="
                    const nextteam = '<%= team[:code] %>';
                    if ($activeteam !== nextteam) {
                      $activeteam = nextteam;
                      $sidebarteamloaded = nextteam;
                      $sidebarcapyearloaded = '<%= @salary_year %>';
                      $sidebardraftloaded = false;
                      $sidebardraftyearloaded = '';
                      $sidebarrightsloaded = false;

                      @get('/tools/salary-book/sse/switch-team?team=' + nextteam + '&year=<%= @salary_year %>');
                      window.history.replaceState({}, '', '<%= salary_book_base_path %>?team=' + nextteam + '&year=<%= @salary_year %>');
                    }
                  "
                  data-class="{
                    'bg-primary text-primary-foreground border-primary shadow-sm': $activeteam === '<%= team[:code] %>',
                    'bg-muted/50 text-foreground border-border hover:bg-muted hover:border-foreground/20': $activeteam !== '<%= team[:code] %>'
                  }"
                  title="<%= team[:name] %>"
                ><%= team[:code] %></button>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>

      <%# Divider %>
      <div class="h-20 w-px bg-border self-center"></div>

      <%# Apps (placeholder radios; Salaries is the only active app today) %>
      <div class="min-w-[5.5rem] space-y-1" role="radiogroup" aria-label="Apps">
        <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Apps</div>
        <div class="space-y-1">
          <label class="flex items-center gap-1.5 cursor-not-allowed opacity-60">
            <input
              type="radio"
              id="app-injuries"
              name="salarybook-app"
              value="injuries"
              class="size-3.5 accent-primary"
              disabled
            />
            <span class="text-[11px] leading-none select-none text-muted-foreground">Injuries</span>
          </label>

          <label class="flex items-center gap-1.5 cursor-pointer">
            <input
              type="radio"
              id="app-salaries"
              name="salarybook-app"
              value="salaries"
              class="size-3.5 accent-primary"
              checked
            />
            <span class="text-[11px] leading-none select-none text-foreground font-semibold">Salaries</span>
          </label>

          <label class="flex items-center gap-1.5 cursor-not-allowed opacity-60">
            <input
              type="radio"
              id="app-tankathon"
              name="salarybook-app"
              value="tankathon"
              class="size-3.5 accent-primary"
              disabled
            />
            <span class="text-[11px] leading-none select-none text-muted-foreground">Tankathon</span>
          </label>
        </div>
      </div>

      <%# Divider %>
      <div class="h-20 w-px bg-border self-center"></div>

      <%# Filter Toggles (client-only lenses) %>
      <div class="flex items-start gap-4" role="group" aria-label="Filters">
        <div class="min-w-[5.75rem] space-y-1">
          <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Display</div>
          <div class="space-y-1">
            <div class="flex items-center gap-1.5">
              <input
                type="checkbox"
                id="filter-deadmoney"
                class="size-3.5 accent-primary"
                data-bind="displaydeadmoney"
                data-on:change="window.__salaryBookPreserveContext?.()"
              />
              <label for="filter-deadmoney" class="text-[11px] leading-none cursor-pointer select-none text-foreground/80 hover:text-foreground transition-colors">Dead Money</label>
            </div>
            <div class="flex items-center gap-1.5">
              <input
                type="checkbox"
                id="filter-draftpicks"
                class="size-3.5 accent-primary"
                data-bind="displaydraftpicks"
                data-on:change="window.__salaryBookPreserveContext?.()"
              />
              <label for="filter-draftpicks" class="text-[11px] leading-none cursor-pointer select-none text-foreground/80 hover:text-foreground transition-colors">Draft Picks</label>
            </div>
            <div class="flex items-center gap-1.5">
              <input
                type="checkbox"
                id="filter-exceptions"
                class="size-3.5 accent-primary"
                data-bind="displayexceptions"
                data-on:change="window.__salaryBookPreserveContext?.()"
              />
              <label for="filter-exceptions" class="text-[11px] leading-none cursor-pointer select-none text-foreground/80 hover:text-foreground transition-colors">Exceptions</label>
            </div>
            <div class="flex items-center gap-1.5">
              <input
                type="checkbox"
                id="filter-epm"
                class="size-3.5 accent-primary"
                data-bind="displayepm"
                data-on:change="window.__salaryBookPreserveContext?.()"
              />
              <label for="filter-epm" class="text-[11px] leading-none cursor-pointer select-none text-foreground/80 hover:text-foreground transition-colors">EPM</label>
            </div>
          </div>
        </div>

        <div class="min-w-[6.5rem] space-y-1">
          <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Financials</div>
          <div class="space-y-1">
            <div class="flex items-center gap-1.5">
              <input
                type="checkbox"
                id="filter-taxaprons"
                class="size-3.5 accent-primary"
                data-bind="displaytaxaprons"
                data-on:change="window.__salaryBookPreserveContext?.()"
              />
              <label for="filter-taxaprons" class="text-[11px] leading-none cursor-pointer select-none text-foreground/80 hover:text-foreground transition-colors">Aprons</label>
            </div>
            <div class="flex items-center gap-1.5">
              <input
                type="checkbox"
                id="filter-cashvscap"
                class="size-3.5 accent-primary"
                data-bind="displaycashvscap"
                data-on:change="window.__salaryBookPreserveContext?.()"
              />
              <label for="filter-cashvscap" class="text-[11px] leading-none cursor-pointer select-none text-foreground/80 hover:text-foreground transition-colors">Cash vs Cap</label>
            </div>
            <div class="flex items-center gap-1.5">
              <input
                type="checkbox"
                id="filter-luxurytax"
                class="size-3.5 accent-primary"
                data-bind="displayluxurytax"
                data-on:change="window.__salaryBookPreserveContext?.()"
              />
              <label for="filter-luxurytax" class="text-[11px] leading-none cursor-pointer select-none text-foreground/80 hover:text-foreground transition-colors">Tax Payment</label>
            </div>
          </div>
        </div>

        <div class="min-w-[6.5rem] space-y-1">
          <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Contracts</div>
          <div class="space-y-1">
            <div class="flex items-center gap-1.5">
              <input
                type="checkbox"
                id="filter-capholds"
                class="size-3.5 accent-primary"
                data-bind="displaycapholds"
                data-on:change="window.__salaryBookPreserveContext?.()"
              />
              <label for="filter-capholds" class="text-[11px] leading-none cursor-pointer select-none text-foreground/80 hover:text-foreground transition-colors">Cap Holds</label>
            </div>
            <div class="flex items-center gap-1.5">
              <input
                type="checkbox"
                id="filter-options"
                class="size-3.5 accent-primary"
                data-bind="displayoptions"
                data-on:change="window.__salaryBookPreserveContext?.()"
              />
              <label for="filter-options" class="text-[11px] leading-none cursor-pointer select-none text-foreground/80 hover:text-foreground transition-colors">Options</label>
            </div>
            <div class="flex items-center gap-1.5">
              <input
                type="checkbox"
                id="filter-incentives"
                class="size-3.5 accent-primary"
                data-bind="displayincentives"
                data-on:change="window.__salaryBookPreserveContext?.()"
              />
              <label for="filter-incentives" class="text-[11px] leading-none cursor-pointer select-none text-foreground/80 hover:text-foreground transition-colors">Incentives</label>
            </div>
            <div class="flex items-center gap-1.5">
              <input
                type="checkbox"
                id="filter-twoway"
                class="size-3.5 accent-primary"
                data-bind="displaytwoway"
                data-on:change="window.__salaryBookPreserveContext?.()"
              />
              <label for="filter-twoway" class="text-[11px] leading-none cursor-pointer select-none text-foreground/80 hover:text-foreground transition-colors">Two-Ways</label>
            </div>
          </div>
        </div>
      </div>
    <% else %>
      <div class="text-sm text-muted-foreground">No teams.</div>
    <% end %>

    <%# Global navigation + theme controls %>
    <div class="h-20 w-px bg-border self-center ml-auto shrink-0"></div>
    <%= render partial: "shared/commandbar_navigation", locals: { active_destination: "salary_book" } %>
  </header>

  <div id="viewport" class="flex flex-1 overflow-hidden relative">
    <%# Main canvas %>
    <%= render partial: "tools/salary_book/maincanvas", locals: {
      boot_error: @boot_error,
      salary_year: @salary_year,
      salary_years: @salary_years,
      initial_team: @initial_team,
      initial_players: @initial_players,
      initial_cap_holds: @initial_cap_holds,
      initial_exceptions: @initial_exceptions,
      initial_dead_money: @initial_dead_money,
      initial_picks: @initial_picks,
      initial_team_summaries: @initial_team_summaries_by_year,
      initial_team_meta: @initial_team_meta
    } %>

    <%# Right panel %>
    <aside
      id="rightpanel"
      class="w-[30%] min-w-[320px] max-w-[480px] border-l border-border bg-background overflow-hidden relative"
    >
      <div
        id="rightpanel-base-layer"
        class="absolute inset-0 overflow-y-auto overflow-x-hidden overscroll-y-contain scroll-touch pt-2 px-4 pb-4 transition-opacity duration-300"
      >
        <% if @initial_team.present? %>
          <%= render partial: "tools/salary_book/sidebar_team", locals: {
            team_code: @initial_team,
            summary: @initial_team_summary,
            team_meta: @initial_team_meta,
            summaries_by_year: @initial_team_summaries_by_year,
            year: @salary_year
          } %>
        <% else %>
          <div id="rightpanel-base" class="space-y-4">
            <div class="p-4 rounded-lg border border-border bg-muted/20 text-sm text-muted-foreground">
              Select a team to load context.
            </div>
          </div>
        <% end %>
      </div>

      <%# Overlay container (patched by Datastar) %>
      <div id="rightpanel-overlay"></div>
    </aside>
  </div>
</div>

<% content_for :head_scripts do %>
  <script type="module">
    import "tools/salary_book";
  </script>
  <script>
    // Team ID map for back button logos
    window.__salaryBookTeamIds = <%= raw team_id_map %>;
  </script>
<% end %>
