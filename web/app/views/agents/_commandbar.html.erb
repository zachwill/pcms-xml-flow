<%
  pane_query_expr = "'q=' + encodeURIComponent($agentquery) +
    '&kind=' + $entitykind +
    '&active_only=' + ($activeonly ? '1' : '0') +
    '&certified_only=' + ($certifiedonly ? '1' : '0') +
    '&with_clients=' + ($withclients ? '1' : '0') +
    '&with_book=' + ($withbook ? '1' : '0') +
    '&with_restrictions=' + ($withrestrictions ? '1' : '0') +
    '&with_expiring=' + ($withexpiring ? '1' : '0') +
    '&agency_id=' + encodeURIComponent($agencyfilterid) +
    '&year=' + $bookyear +
    '&sort=' + $sortkey +
    '&dir=' + $sortdir +
    '&agency_scope=' + ($agencyscopeactive ? '1' : '0') +
    '&agency_scope_id=' + encodeURIComponent($agencyscopeid)"

  selected_overlay_query_expr = "'selected_type=' + encodeURIComponent($overlaytype) +
    '&selected_id=' + encodeURIComponent($overlayid) +
    '&selected_return_type=' + encodeURIComponent($overlayreturntype || '') +
    '&selected_return_id=' + encodeURIComponent($overlayreturnid || '')"

  sse_get_expr = "@get('/agents/sse/refresh?' + (#{pane_query_expr}) + '&' + (#{selected_overlay_query_expr}))"
  update_url_expr = "window.history.replaceState({}, '', '/agents?' + (#{pane_query_expr}))"
  refresh_expr = "#{sse_get_expr}; #{update_url_expr}"

  sort_options = if @directory_kind.to_s == "agencies"
    [
      ["book", "Book"],
      ["clients", "Clients"],
      ["agents", "Agents"],
      ["teams", "Teams"],
      ["max", "Max"],
      ["expirings", "Exp"],
      ["options", "Opts"],
      ["name", "Name"]
    ]
  else
    [
      ["book", "Book"],
      ["clients", "Clients"],
      ["teams", "Teams"],
      ["max", "Max"],
      ["expirings", "Exp"],
      ["options", "Opts"],
      ["name", "Name"]
    ]
  end

  agency_filter_choices = [["", "All agencies"]] + Array(@agency_filter_options).map do |row|
    next if row["agency_id"].blank? || row["agency_name"].blank?

    [
      row["agency_id"].to_s,
      "#{row['agency_name']} · #{row['client_count'].to_i} clients"
    ]
  end.compact

  agency_scope_choices = [["", "No scope (all agents)"]] + agency_filter_choices.drop(1)
  scope_name = @sidebar_summary&.dig(:agency_scope_name).presence || Array(@agency_filter_options).find { |row| row["agency_id"].to_i == @agency_scope_id.to_i }&.dig("agency_name")
  scope_label = scope_name.presence || (@agency_scope_id.present? ? "Agency ##{@agency_scope_id}" : nil)
  scope_checkbox_label = scope_label.present? ? "Scoped: #{scope_label}" : "Agency scope"

  scope_toggle_expr = "if ($agencyscopeactive && !$agencyscopeid) { $agencyscopeid = $overlaytype === 'agency' ? $overlayid : $agencyfilterid; }; if (!$agencyscopeid) { $agencyscopeactive = false; }; #{refresh_expr}"
  scope_select_expr = "$agencyscopeactive = $agencyscopeid !== ''; #{refresh_expr}"
%>

<%= render partial: "shared/commandbar", locals: {
  active_entity_scope: (@directory_kind.to_s == "agencies" ? "agencies" : "agents"),
  header_knobs: [
    {
      label: "Directory",
      min_width_class: "min-w-[6.5rem]",
      options: [
        {
          type: "radio",
          name: "agent-directory-kind",
          id: "agent-directory-kind-agents",
          value: "agents",
          label: "Agents",
          checked: @directory_kind == "agents",
          bind: "entitykind",
          on_change: refresh_expr
        },
        {
          type: "radio",
          name: "agent-directory-kind",
          id: "agent-directory-kind-agencies",
          value: "agencies",
          label: "Agencies",
          checked: @directory_kind == "agencies",
          bind: "entitykind",
          on_change: refresh_expr
        }
      ]
    },
    {
      label: "Year",
      min_width_class: "min-w-[4.5rem]",
      options: [
        {
          type: "radio",
          name: "agent-book-year",
          id: "agent-book-year-2025",
          value: "2025",
          label: "2025",
          checked: @book_year == 2025,
          bind: "bookyear",
          on_change: refresh_expr
        },
        {
          type: "radio",
          name: "agent-book-year",
          id: "agent-book-year-2026",
          value: "2026",
          label: "2026",
          checked: @book_year == 2026,
          bind: "bookyear",
          on_change: refresh_expr
        },
        {
          type: "radio",
          name: "agent-book-year",
          id: "agent-book-year-2027",
          value: "2027",
          label: "2027",
          checked: @book_year == 2027,
          bind: "bookyear",
          on_change: refresh_expr
        }
      ]
    },
    {
      label: "Sort",
      min_width_class: "min-w-[8.5rem]",
      options: [
        {
          type: "select",
          id: "agent-sort-key-select",
          value: @sort_key,
          bind: "sortkey",
          on_change: refresh_expr,
          width_class: "w-28",
          choices: sort_options
        },
        {
          type: "radio",
          name: "agent-sort-direction",
          id: "agent-sort-direction-desc",
          value: "desc",
          label: "↓ Desc",
          checked: @sort_dir == "desc",
          bind: "sortdir",
          on_change: refresh_expr
        },
        {
          type: "radio",
          name: "agent-sort-direction",
          id: "agent-sort-direction-asc",
          value: "asc",
          label: "↑ Asc",
          checked: @sort_dir == "asc",
          bind: "sortdir",
          on_change: refresh_expr
        }
      ]
    },
    {
      label: "Agency",
      min_width_class: "min-w-[14rem]",
      options: [
        {
          type: "select",
          id: "agent-filter-agency-select",
          value: @agency_filter_id.to_s,
          bind: "agencyfilterid",
          on_change: refresh_expr,
          width_class: "w-56",
          choices: agency_filter_choices
        }
      ]
    },
    {
      label: "Agent scope",
      min_width_class: "min-w-[14rem]",
      options: [
        {
          type: "checkbox",
          id: "agent-scope-active",
          label: scope_checkbox_label,
          checked: @agency_scope_active && @agency_scope_id.present?,
          bind: "agencyscopeactive",
          on_change: scope_toggle_expr
        },
        {
          type: "select",
          id: "agent-scope-select",
          value: @agency_scope_id.to_s,
          bind: "agencyscopeid",
          on_change: scope_select_expr,
          width_class: "w-56",
          choices: agency_scope_choices
        }
      ]
    },
    {
      label: "Filters",
      min_width_class: "min-w-[7rem]",
      options: [
        {
          type: "checkbox",
          id: "agent-filter-active-only",
          label: "Active",
          checked: @active_only,
          bind: "activeonly",
          on_change: refresh_expr
        },
        {
          type: "checkbox",
          id: "agent-filter-certified-only",
          label: "Certified",
          checked: @certified_only,
          bind: "certifiedonly",
          on_change: refresh_expr
        },
        {
          type: "checkbox",
          id: "agent-filter-with-clients",
          label: "Clients > 0",
          checked: @with_clients,
          bind: "withclients",
          on_change: refresh_expr
        },
        {
          type: "checkbox",
          id: "agent-filter-with-book",
          label: "Book > 0",
          checked: @with_book,
          bind: "withbook",
          on_change: refresh_expr
        },
        {
          type: "checkbox",
          id: "agent-filter-with-expiring",
          label: "Expiring",
          checked: @with_expiring,
          bind: "withexpiring",
          on_change: refresh_expr
        }
      ]
    },
    {
      label: "Flags",
      min_width_class: "min-w-[6rem]",
      options: [
        {
          type: "checkbox",
          id: "agent-filter-with-restrictions",
          label: "Restricted",
          checked: @with_restrictions,
          bind: "withrestrictions",
          on_change: refresh_expr
        }
      ]
    }
  ]
} %>
