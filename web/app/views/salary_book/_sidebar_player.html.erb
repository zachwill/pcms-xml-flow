<%#
  Player overlay (RightPanel entity) — Salary Book sidebar

  NOTE: Root id must remain stable for Datastar morphing.
%>

<%
  presenter = SalaryBook::PlayerSidebarPresenter.new(player: player, helpers: self)
  sidebar = presenter.state

  salary_years = sidebar.fetch(:salary_years)
  compact = sidebar.fetch(:compact)

  player_id = sidebar.fetch(:player_id)
  player_name = sidebar.fetch(:player_name)
  team_code = sidebar.fetch(:team_code)
  team_id = sidebar.fetch(:team_id)
  team_name = sidebar.fetch(:team_name)
  team_logo = sidebar.fetch(:team_logo)
  agent_name = sidebar.fetch(:agent_name)
  agent_id = sidebar.fetch(:agent_id)
  age_yos = sidebar.fetch(:age_yos)
  is_two_way = sidebar.fetch(:is_two_way)

  team_switchable = sidebar.fetch(:team_switchable)
  team_combo_chip_classes = sidebar.fetch(:team_combo_chip_classes)
  team_combo_chip_style = sidebar.fetch(:team_combo_chip_style)
  team_combo_logo_wrap_classes = sidebar.fetch(:team_combo_logo_wrap_classes)
  team_combo_logo_image_classes = sidebar.fetch(:team_combo_logo_image_classes)
  team_combo_code_classes = sidebar.fetch(:team_combo_code_classes)
  team_row_onclick = sidebar.fetch(:team_row_onclick)

  years_data = sidebar.fetch(:years_data)
  active_years = sidebar.fetch(:active_years)
  total_value = sidebar.fetch(:total_value)
  contract_years = sidebar.fetch(:contract_years)
  cap_2025 = sidebar.fetch(:cap_2025)

  next_option = sidebar.fetch(:next_option)
  fa_year = sidebar.fetch(:fa_year)
  next_decision_label = sidebar.fetch(:next_decision_label)
  next_decision_variant = sidebar.fetch(:next_decision_variant)

  header_contract_label = sidebar.fetch(:header_contract_label)
  header_contract_classes = sidebar.fetch(:header_contract_classes)

  status_chips = sidebar.fetch(:status_chips)

  contract_type = sidebar.fetch(:contract_type)
  signed_using = sidebar.fetch(:signed_using)
  exception_type = sidebar.fetch(:exception_type)
  epm_value = sidebar.fetch(:epm_value)
  epm_percentile = sidebar.fetch(:epm_percentile)
  epm_season = sidebar.fetch(:epm_season)
  epm_season_label = sidebar.fetch(:epm_season_label)

  epm_percentile_int_value = sidebar.fetch(:epm_percentile_int_value)
  epm_has_percentile = sidebar.fetch(:epm_has_percentile)
  epm_badge_class = sidebar.fetch(:epm_badge_class)
%>

<div
  id="rightpanel-overlay"
  class="h-full"
  data-signals="{ playertab: 'contract', _playerepmhover: false }"
  data-effect="
    if ($playertab !== 'contract' && $_playerepmhover) {
      $_playerepmhover = false;
    }
  "
>
  <%# Sticky header %>
  <div class="sticky top-0 z-20 h-10 px-4 flex items-center justify-between border-b border-border bg-background">
    <%= render partial: "salary_book/sidebar_back_button" %>

    <a
      class="text-xs text-muted-foreground hover:text-foreground hover:underline"
      href="<%= player_href(player_id) %>"
    >Open player page</a>
  </div>

  <div class="px-4 pb-4 pt-4 space-y-5">
    <%# Header %>
    <div class="flex items-center gap-3">
      <div class="flex items-center gap-1.5 shrink-0">
        <div
          class="w-10 h-10 rounded-full border border-border bg-background overflow-hidden flex items-center justify-center"
          title="<%= team_name %>"
          aria-label="<%= team_name %>"
        >
          <% if team_logo.present? %>
            <img
              src="<%= team_logo %>"
              alt="<%= team_name %> logo"
              class="w-full h-full object-contain p-0.5"
              loading="lazy"
              decoding="async"
              onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
            />
            <span class="hidden text-[10px] font-semibold text-muted-foreground"><%= team_code %></span>
          <% else %>
            <span class="text-[10px] font-semibold text-muted-foreground"><%= team_code %></span>
          <% end %>
        </div>

        <div class="w-14 h-14 rounded border border-border bg-background overflow-hidden">
          <img
            src="<%= player_headshot_url(player_id) %>"
            alt="<%= player_name %>"
            class="w-full h-full object-cover object-top bg-muted"
            loading="lazy"
            decoding="async"
            onerror="if (this.src !== '<%= fallback_headshot_data_uri %>') { this.src = '<%= fallback_headshot_data_uri %>'; }"
          />
        </div>
      </div>

      <div class="min-w-0 space-y-0.5">
        <h2 class="text-lg font-semibold text-foreground truncate"><%= player_name %></h2>

        <div class="text-xs text-muted-foreground/80 tabular-nums flex items-center gap-1 min-w-0 overflow-hidden whitespace-nowrap">
          <% if age_yos.present? || header_contract_label.present? %>
            <% if age_yos.present? %>
              <span class="truncate"><%= age_yos %></span>
            <% end %>

            <% if header_contract_label.present? %>
              <% if age_yos.present? %>
                <span class="text-muted-foreground/50">·</span>
              <% end %>
              <span class="shrink-0 font-medium <%= header_contract_classes %>"><%= header_contract_label %></span>
            <% end %>
          <% else %>
            <span class="text-muted-foreground/50">—</span>
          <% end %>
        </div>
      </div>
    </div>

    <%# Segmented control (kept, even while non-contract tabs are placeholders) %>
    <div class="relative grid grid-cols-4 p-1 rounded-lg bg-muted border border-border">
      <div
        class="absolute top-1 bottom-1 left-1 w-[calc((100%_-_8px)/4)] rounded-md bg-background shadow-sm pointer-events-none transition-[transform,width,opacity] duration-150 ease-out"
        data-class="{
          'translate-x-0': $playertab === 'contract',
          'translate-x-full': $playertab === 'stats',
          'translate-x-[200%]': $playertab === 'history',
          'translate-x-[300%]': $playertab === 'comps'
        }"
        aria-hidden="true"
      ></div>

      <% player_tabs = [
        ["contract", "Contract"],
        ["stats", "Stats"],
        ["history", "History"],
        ["comps", "Comps"]
      ] %>

      <% player_tabs.each do |(id, label)| %>
        <button
          type="button"
          class="cursor-pointer relative z-10 min-w-0 px-3 py-1.5 text-sm font-medium text-center rounded-md transition-colors duration-150
                 focus-visible:outline-none focus-visible:ring-0 focus-visible:border-foreground dark:focus-visible:border-foreground"
          data-on:click="$playertab = '<%= id %>'"
          data-class="{ 'text-foreground': $playertab === '<%= id %>', 'text-muted-foreground hover:text-foreground': $playertab !== '<%= id %>' }"
        ><%= label %></button>
      <% end %>
    </div>

    <%# Snapshot KPIs %>
    <div class="border-t border-border pt-4 space-y-2.5">
      <div class="grid grid-cols-4 gap-1.5">
        <%= render partial: "salary_book/kpi_cell", locals: {
          label: format_year_label(2025),
          value: compact.call(cap_2025),
          class_name: "w-full",
          value_class_name: "text-[11px]",
          variant: (cap_2025.to_f > 0 ? "default" : "muted")
        } %>

        <%= render partial: "salary_book/kpi_cell", locals: {
          label: "Total",
          value: compact.call(total_value),
          class_name: "w-full",
          value_class_name: "text-[11px]",
          variant: (total_value > 0 ? "default" : "muted")
        } %>

        <%= render partial: "salary_book/kpi_cell", locals: {
          label: "Years",
          value: contract_years.to_s,
          class_name: "w-full",
          variant: (contract_years > 0 ? "default" : "muted")
        } %>

        <%= render partial: "salary_book/kpi_cell", locals: {
          label: "Next",
          value: next_decision_label,
          class_name: "w-full",
          value_class_name: "text-[10px]",
          variant: next_decision_variant
        } %>
      </div>

      <% if status_chips.any? %>
        <div class="pt-0.5 flex flex-wrap gap-1.5">
          <% status_chips.each do |chip| %>
            <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-[9px] font-semibold uppercase tracking-wide leading-none <%= chip[:classes] %>">
              <%= chip[:label] %>
            </span>
          <% end %>
        </div>
      <% end %>
    </div>

    <%# Contract tab %>
    <div data-show="$playertab === 'contract'" class="space-y-4">
      <%# Contract details (dense rows) %>
      <div
        class="border-t border-border pt-4 space-y-0.5"
        <% if epm_has_percentile %>
          data-on:mouseenter="$_playerepmhover = true"
          data-on:mouseleave="$_playerepmhover = false"
        <% end %>
      >
        <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground mb-1.5">Contract details</div>

        <div class="flex items-center justify-between py-1.5 gap-3">
          <span class="text-sm text-muted-foreground">Team</span>

          <% if team_row_onclick.present? %>
            <button
              type="button"
              class="<%= team_combo_chip_classes %>"
              style="<%= team_combo_chip_style %>"
              title="<%= team_name %>"
              data-on:click="<%= team_row_onclick %>"
            >
              <span class="<%= team_combo_logo_wrap_classes %>">
                <% if team_logo.present? %>
                  <img
                    src="<%= team_logo %>"
                    alt="<%= team_code %> logo"
                    class="<%= team_combo_logo_image_classes %>"
                    loading="lazy"
                    decoding="async"
                  />
                <% end %>
              </span>
              <span class="<%= team_combo_code_classes %>"><%= team_code %></span>
            </button>
          <% else %>
            <span class="text-sm font-medium tabular-nums"><%= team_code %></span>
          <% end %>
        </div>

        <% if agent_name.present? %>
          <div class="flex items-center justify-between py-1.5 gap-3">
            <span class="text-sm text-muted-foreground">Agent</span>
            <% if agent_id.present? %>
              <button
                type="button"
                class="cursor-pointer text-sm font-medium text-blue-600 dark:text-blue-400 hover:underline text-right
                       focus-visible:outline-none focus-visible:ring-0 focus-visible:border-foreground dark:focus-visible:border-foreground"
                data-on:click="@get('<%= salary_book_sidebar_agent_path(id: agent_id) %>')"
              ><%= agent_name %></button>
            <% else %>
              <span class="text-sm font-medium text-right"><%= agent_name %></span>
            <% end %>
          </div>
        <% end %>

        <% if contract_type.present? %>
          <div class="flex items-center justify-between py-1.5 gap-3">
            <span class="text-sm text-muted-foreground">Type</span>
            <span class="text-sm font-medium text-right"><%= contract_type %></span>
          </div>
        <% end %>

        <% if signed_using.present? %>
          <div class="flex items-center justify-between py-1.5 gap-3">
            <span class="text-sm text-muted-foreground">Signed via</span>
            <span class="text-sm font-medium text-right"><%= signed_using %></span>
          </div>
        <% end %>

        <% if exception_type.present? %>
          <div class="flex items-center justify-between py-1.5 gap-3">
            <span class="text-sm text-muted-foreground">Exception</span>
            <span class="text-sm font-medium text-right"><%= exception_type %></span>
          </div>
        <% end %>

        <% if epm_value.present? %>
          <div class="flex items-center justify-between py-1.5 gap-3">
            <span class="text-sm text-muted-foreground">Latest EPM<% if epm_season_label.present? %> (<%= epm_season_label %>)<% end %></span>
            <span class="relative inline-flex w-[9rem] justify-end items-center overflow-hidden">
              <span
                class="inline-flex items-center rounded px-1.5 py-0.5 text-sm font-semibold tabular-nums translate-x-0 transition-transform duration-200 ease-out <%= epm_badge_class %>"
                data-class="{
                  'translate-x-0': !$_playerepmhover,
                  '-translate-x-[3.1rem]': $_playerepmhover
                }"
              ><%= format_epm_value(epm_value) %></span>
              <% if epm_has_percentile %>
                <span
                  class="absolute right-0 text-sm font-semibold tabular-nums translate-x-4 opacity-0 transition-[opacity,transform] duration-200 ease-out <%= epm_percentile_color_class(epm_percentile) %>"
                  data-class="{
                    'translate-x-0 opacity-100': $_playerepmhover,
                    'translate-x-4 opacity-0': !$_playerepmhover
                  }"
                >P<%= epm_percentile_int_value %></span>
              <% end %>
            </span>
          </div>
        <% end %>
      </div>

      <%# Year-by-year ledger %>
      <div class="border-t border-border pt-4 space-y-2">
        <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Year-by-year</div>

        <% if active_years.empty? %>
          <div class="p-3 rounded-lg bg-muted/30 text-sm text-muted-foreground italic">No salary data available</div>
        <% else %>
          <div class="overflow-x-auto rounded-lg border border-border/60">
            <table class="min-w-full text-[11px]">
              <thead class="bg-muted/20 text-muted-foreground uppercase tracking-wide text-[10px]">
                <tr>
                  <th class="text-left px-2 py-1.5 font-medium">Year</th>
                  <th class="text-right px-2 py-1.5 font-medium">Cap</th>
                  <th class="text-right px-2 py-1.5 font-medium">Guarantee</th>
                  <th class="text-right px-2 py-1.5 font-medium">Option</th>
                  <th class="text-right px-2 py-1.5 font-medium">Bonuses</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-border/50">
                <% active_years.each do |yd| %>
                  <%
                    y = yd[:year]
                    salary = yd[:salary]
                    option = yd[:option]
                    guaranteed_amount = yd[:guaranteed_amount]
                    guarantee_status = yd[:guarantee_status]
                    likely_bonus = yd[:likely_bonus]
                    unlikely_bonus = yd[:unlikely_bonus]

                    guarantee_label = case guarantee_status
                    when "FULL" then "Full"
                    when "PARTIAL" then "Partial"
                    when "NONE" then "None"
                    end

                    option_badge_classes = case option
                    when "PO" then "bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-300"
                    when "TO" then "bg-purple-100 text-purple-700 dark:bg-purple-900/50 dark:text-purple-300"
                    when "ETO" then "bg-orange-100 text-orange-700 dark:bg-orange-900/50 dark:text-orange-300"
                    else nil
                    end

                    bonus_parts = []
                    bonus_parts << "L #{compact.call(likely_bonus)}" if likely_bonus.present? && likely_bonus.to_f != 0
                    bonus_parts << "U #{compact.call(unlikely_bonus)}" if unlikely_bonus.present? && unlikely_bonus.to_f != 0
                  %>
                  <tr class="hover:bg-yellow-50/70 dark:hover:bg-yellow-900/25 transition-colors duration-75">
                    <td class="px-2 py-1.5 tabular-nums"><%= format_year_label(y) %></td>
                    <td class="px-2 py-1.5 text-right tabular-nums font-medium"><%= compact.call(salary) %></td>
                    <td class="px-2 py-1.5 text-right">
                      <% if guaranteed_amount.present? || guarantee_label.present? %>
                        <div class="flex flex-col items-end leading-tight">
                          <span class="tabular-nums"><%= guaranteed_amount.present? ? compact.call(guaranteed_amount) : "—" %></span>
                          <% if guarantee_label.present? %>
                            <span class="text-[10px] text-muted-foreground"><%= guarantee_label %></span>
                          <% end %>
                        </div>
                      <% else %>
                        <span class="text-muted-foreground">—</span>
                      <% end %>
                    </td>
                    <td class="px-2 py-1.5 text-right">
                      <% if option.present? && option_badge_classes.present? %>
                        <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-[9px] font-semibold uppercase tracking-wide leading-none <%= option_badge_classes %>"><%= option %></span>
                      <% else %>
                        <span class="text-muted-foreground">—</span>
                      <% end %>
                    </td>
                    <td class="px-2 py-1.5 text-right tabular-nums text-[10px] text-muted-foreground">
                      <%= bonus_parts.any? ? bonus_parts.join(" · ") : "—" %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% end %>
      </div>
    </div>

    <%# Stats tab placeholder (keep segmented control; stay dense) %>
    <div data-show="$playertab === 'stats'" class="border-t border-border pt-4 space-y-1.5">
      <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Player Stats</div>
      <div class="text-sm text-muted-foreground">No stats warehouse feed is wired to the sidebar yet.</div>
    </div>

    <%# History tab placeholder %>
    <div data-show="$playertab === 'history'" class="border-t border-border pt-4 space-y-1.5">
      <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Contract History</div>
      <div class="text-sm text-muted-foreground">No historical contract module is wired here yet.</div>
    </div>

    <%# Comps tab placeholder %>
    <div data-show="$playertab === 'comps'" class="border-t border-border pt-4 space-y-1.5">
      <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Comparable Players</div>
      <div class="text-sm text-muted-foreground">No comps model is wired to this sidebar yet.</div>
    </div>
  </div>
</div>
