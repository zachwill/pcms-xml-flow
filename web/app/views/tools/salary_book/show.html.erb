<% initial_team = @initial_team.to_s %>

<%# Build team_id lookup for back button logos %>
<% team_id_map = @team_meta_by_code.transform_values { |meta| meta["team_id"] }.to_json %>

<div
  id="salarybook"
  class="h-screen w-screen flex flex-col overflow-hidden bg-background"
  data-signals="{
    activeteam: '<%= initial_team %>',
    selectedseason: '',
    selectedseasonteam: '',
    sidebarview: 'teamview',
    overlaytype: 'none',
    overlayid: '',
    ssestatus: 'idle',
    sseticks: 0,
    displaycapholds: false,
    displayexceptions: true,
    displaydraftpicks: true,
    displaydeadmoney: false,
    displaytaxaprons: true,
    displaycashvscap: false,
    displayluxurytax: false,
    displayoptions: true,
    displayincentives: true,
    displaytwoway: true
  }"
  data-on:salarybook-activeteam="if ($activeteam !== evt.detail.team) { $activeteam = evt.detail.team; }"
  data-effect="if ($activeteam) { @get('<%= tools_salary_book_sidebar_team_path(team: '__TEAM__') %>'.replace('__TEAM__', $activeteam) + '&year=' + (($selectedseasonteam === $activeteam && $selectedseason !== '') ? $selectedseason : <%= @salary_year %>)); }"
>
  <div id="flash"></div>

  <%# Command bar (prototype height: 130px) %>
  <header
    id="commandbar"
    class="shrink-0 h-[130px] border-b border-border bg-background flex items-start px-4 pt-3 gap-4"
  >
    <% if @teams_by_conference["Eastern"].any? || @teams_by_conference["Western"].any? %>
      <%# Team Selector Grid %>
      <div class="flex gap-4" role="navigation" aria-label="Teams">
        <% %w[Eastern Western].each do |conf| %>
          <div class="space-y-1">
            <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70"><%= conf %></div>
            <div class="grid grid-cols-5 gap-1">
              <% @teams_by_conference[conf].each do |team| %>
                <a
                  href="#<%= team[:code] %>"
                  class="relative h-7 px-2 rounded text-xs font-medium transition-all duration-150 border outline-none inline-flex items-center justify-center no-underline hover:no-underline"
                  data-on:click.prevent="$activeteam = '<%= team[:code] %>'; window.__salaryBookScrollToTeam?.('<%= team[:code] %>', 'smooth')"
                  data-class="{
                    'bg-primary text-primary-foreground border-primary shadow-sm': $activeteam === '<%= team[:code] %>',
                    'bg-muted/50 text-foreground border-border hover:bg-muted hover:border-foreground/20': $activeteam !== '<%= team[:code] %>'
                  }"
                  title="<%= team[:name] %>"
                ><%= team[:code] %></a>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>

      <%# Divider %>
      <div class="h-20 w-px bg-border self-center"></div>

      <%# Filter Toggles (client-only lenses) %>
      <div class="flex items-start gap-4" role="group" aria-label="Filters">
        <div class="min-w-[4.5rem] space-y-1">
          <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Display</div>
          <div class="space-y-1">
            <div class="flex items-center gap-1.5">
              <input
                type="checkbox"
                id="filter-capholds"
                class="size-3.5 accent-primary"
                data-bind="displaycapholds"
                data-on:change="window.__salaryBookPreserveContext?.()"
              />
              <label for="filter-capholds" class="text-[11px] leading-none cursor-pointer select-none text-foreground/80 hover:text-foreground transition-colors">Cap Holds</label>
            </div>
            <div class="flex items-center gap-1.5">
              <input
                type="checkbox"
                id="filter-exceptions"
                class="size-3.5 accent-primary"
                data-bind="displayexceptions"
                data-on:change="window.__salaryBookPreserveContext?.()"
              />
              <label for="filter-exceptions" class="text-[11px] leading-none cursor-pointer select-none text-foreground/80 hover:text-foreground transition-colors">Exceptions</label>
            </div>
            <div class="flex items-center gap-1.5">
              <input
                type="checkbox"
                id="filter-draftpicks"
                class="size-3.5 accent-primary"
                data-bind="displaydraftpicks"
                data-on:change="window.__salaryBookPreserveContext?.()"
              />
              <label for="filter-draftpicks" class="text-[11px] leading-none cursor-pointer select-none text-foreground/80 hover:text-foreground transition-colors">Draft Picks</label>
            </div>
            <div class="flex items-center gap-1.5">
              <input
                type="checkbox"
                id="filter-deadmoney"
                class="size-3.5 accent-primary"
                data-bind="displaydeadmoney"
                data-on:change="window.__salaryBookPreserveContext?.()"
              />
              <label for="filter-deadmoney" class="text-[11px] leading-none cursor-pointer select-none text-foreground/80 hover:text-foreground transition-colors">Dead Money</label>
            </div>
          </div>
        </div>

        <div class="min-w-[6.5rem] space-y-1">
          <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Financials</div>
          <div class="space-y-1">
            <div class="flex items-center gap-1.5">
              <input
                type="checkbox"
                id="filter-taxaprons"
                class="size-3.5 accent-primary"
                data-bind="displaytaxaprons"
                data-on:change="window.__salaryBookPreserveContext?.()"
              />
              <label for="filter-taxaprons" class="text-[11px] leading-none cursor-pointer select-none text-foreground/80 hover:text-foreground transition-colors">Tax/Aprons</label>
            </div>
            <div class="flex items-center gap-1.5">
              <input
                type="checkbox"
                id="filter-cashvscap"
                class="size-3.5 accent-primary"
                data-bind="displaycashvscap"
                data-on:change="window.__salaryBookPreserveContext?.()"
              />
              <label for="filter-cashvscap" class="text-[11px] leading-none cursor-pointer select-none text-foreground/80 hover:text-foreground transition-colors">Cash vs Cap</label>
            </div>
            <div class="flex items-center gap-1.5">
              <input
                type="checkbox"
                id="filter-luxurytax"
                class="size-3.5 accent-primary"
                data-bind="displayluxurytax"
                data-on:change="window.__salaryBookPreserveContext?.()"
              />
              <label for="filter-luxurytax" class="text-[11px] leading-none cursor-pointer select-none text-foreground/80 hover:text-foreground transition-colors">Luxury Tax</label>
            </div>
          </div>
        </div>

        <div class="min-w-[6.5rem] space-y-1">
          <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Contracts</div>
          <div class="space-y-1">
            <div class="flex items-center gap-1.5">
              <input
                type="checkbox"
                id="filter-options"
                class="size-3.5 accent-primary"
                data-bind="displayoptions"
                data-on:change="window.__salaryBookPreserveContext?.()"
              />
              <label for="filter-options" class="text-[11px] leading-none cursor-pointer select-none text-foreground/80 hover:text-foreground transition-colors">Options</label>
            </div>
            <div class="flex items-center gap-1.5">
              <input
                type="checkbox"
                id="filter-incentives"
                class="size-3.5 accent-primary"
                data-bind="displayincentives"
                data-on:change="window.__salaryBookPreserveContext?.()"
              />
              <label for="filter-incentives" class="text-[11px] leading-none cursor-pointer select-none text-foreground/80 hover:text-foreground transition-colors">Incentives</label>
            </div>
            <div class="flex items-center gap-1.5">
              <input
                type="checkbox"
                id="filter-twoway"
                class="size-3.5 accent-primary"
                data-bind="displaytwoway"
                data-on:change="window.__salaryBookPreserveContext?.()"
              />
              <label for="filter-twoway" class="text-[11px] leading-none cursor-pointer select-none text-foreground/80 hover:text-foreground transition-colors">Two-Way</label>
            </div>
          </div>
        </div>
      </div>
    <% else %>
      <div class="text-sm text-muted-foreground">No teams.</div>
    <% end %>

    <%# Global navigation + theme controls %>
    <div class="h-20 w-px bg-border self-center ml-auto shrink-0"></div>
    <%= render partial: "shared/commandbar_navigation", locals: { active_destination: "salary_book" } %>
  </header>

  <div id="viewport" class="flex flex-1 overflow-hidden relative">
    <%# Main canvas %>
    <main
      id="maincanvas"
      class="flex-1 min-w-0 overflow-y-auto overflow-x-hidden bg-background relative overscroll-y-contain scroll-touch isolate snap-y snap-proximity"
    >
      <% if @boot_error %>
        <div class="p-6">
          <div class="text-sm font-medium text-destructive">Warehouse not available</div>
          <div class="mt-2 text-xs text-muted-foreground">
            Booted Rails, but querying <code>pcms.*</code> failed:
          </div>
          <pre class="mt-3 p-3 rounded-lg bg-muted/30 border border-border/50 text-xs overflow-auto"><%= @boot_error %></pre>
        </div>
      <% elsif @team_codes.empty? %>
        <div class="flex items-center justify-center h-96 text-muted-foreground">
          No rows returned from <code>pcms.team_salary_warehouse</code> for <code><%= @salary_year %></code>.
        </div>
      <% else %>
        <div class="min-h-full">
          <div class="space-y-0">
            <% @team_codes.each do |team_code| %>
              <%= render partial: "tools/salary_book/team_section", locals: {
                team_code: team_code,
                players: (@players_by_team[team_code] || []),
                cap_holds: (@cap_holds_by_team[team_code] || []),
                exceptions: (@exceptions_by_team[team_code] || []),
                dead_money: (@dead_money_by_team[team_code] || []),
                picks: (@picks_by_team[team_code] || []),
                team_summaries: (@team_summaries[team_code] || {}),
                team_meta: (@team_meta_by_code[team_code] || {}),
                year: @salary_year,
                salary_years: @salary_years
              } %>
            <% end %>

            <%# Small scroll spacer so the last team header can still reach sticky position %>
            <div aria-hidden class="h-8"></div>
          </div>
        </div>
      <% end %>
    </main>

    <%# Right panel %>
    <aside
      id="rightpanel"
      class="w-[30%] min-w-[320px] max-w-[480px] border-l border-border bg-background overflow-hidden relative"
    >
      <div
        id="rightpanel-base-layer"
        class="absolute inset-0 overflow-y-auto overflow-x-hidden overscroll-y-contain scroll-touch pt-2 px-4 pb-4 transition-opacity duration-300"
      >
        <% if @initial_team %>
          <%= render partial: "tools/salary_book/sidebar_team", locals: {
            team_code: @initial_team,
            summary: @initial_team_summary,
            team_meta: @initial_team_meta,
            summaries_by_year: @initial_team_summaries_by_year,
            year: @salary_year
          } %>
        <% else %>
          <div class="flex flex-col items-center justify-center py-12 text-center">
            <div class="w-12 h-12 rounded-full bg-muted flex items-center justify-center mb-3">
              <svg class="w-6 h-6 text-muted-foreground" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
            </div>
            <div class="text-sm text-muted-foreground">Scroll to view team details</div>
          </div>
        <% end %>
      </div>

      <%# Overlay container (patched by Datastar) %>
      <div id="rightpanel-overlay"></div>
    </aside>
  </div>
</div>

<% content_for :head_scripts do %>
  <script type="module">
    import "tools/salary_book";
  </script>
  <script>
    // Team ID map for back button logos
    window.__salaryBookTeamIds = <%= raw team_id_map %>;
  </script>
<% end %>
