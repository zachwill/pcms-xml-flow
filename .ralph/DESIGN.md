# Design Evolution Backlog (`web/`)

North star:
- Entity index pages are explorer workbenches (fast scan, dense rows, low-friction pivots).
- Entity detail pages are decision dossiers (what changed, why it matters, what to do next).
- Canonical Datastar patch boundaries remain stable: `#commandbar`, `#maincanvas`, `#rightpanel-base`, `#rightpanel-overlay`.
- Salary Book is read-only reference quality except explicit Tankathon allow-list work.

Rubric (1-5):
1) Scan speed
2) Information hierarchy
3) Interaction predictability
4) Density/readability balance
5) Navigation/pivots

Guardrails:
- Default: do **not** modify Salary Book files.
- Allowed exception only: `web/app/views/tools/salary_book/_maincanvas_tankathon_frame.html.erb`.
- Do not modify Salary Book controllers/helpers/tests.

Execution mode:
- Current priority is **entity detail page elevation**.
- INDEX and TOOL work continues in parallel where high leverage.
- ENTITY work is explicitly approved in this queue.

Supervisor override: ENTITY
[ENTITY-OVERRIDE]

Supervisor review (2026-02-14):
- Audit scope: last 4 web commits (`teams`, `agents`, `agencies`, `transactions`) plus DESIGN rubric updates.
- Guardrail check: no forbidden Salary Book files touched; commit titles conform to `design: [TRACK] /surface flow-outcome`; ENTITY override marker present.
- Flow-value check: all reviewed commits add explorer/dossier behavior (filters, cross-highlighting, lane pivots, URL-stable state), not cosmetic class sweeps.
- Verification: targeted integration specs pass via `bundle exec ruby -Itest` for
  - `web/test/integration/entities_teams_show_test.rb`
  - `web/test/integration/entities_agents_show_test.rb`
  - `web/test/integration/entities_agencies_show_test.rb`
  - `web/test/integration/entities_transactions_show_test.rb`
- Next-loop constraint: continue single-surface flow outcomes only; reject broad style-only churn unless tied to an active task acceptance criterion.

---

- [x] [P0] [ENTITY] /trades/:id — remove remaining table islands and finish full lane grammar
  - Problem: trade detail still contains table islands in lower sections, causing scan-mode resets after the upgraded top board.
  - Hypothesis: finishing lane grammar end-to-end will make whole-page trade analysis consistent and faster.
  - Scope (files):
    - `web/app/views/entities/trades/show.html.erb`
    - `web/test/integration/entities_trades_show_test.rb`
  - Patch targets: `#maincanvas` (`#player-items`, `#pick-cash`, `#transactions`, `#endnotes`)
  - Response type: `text/html` full-page show render.
  - Acceptance criteria:
    - No `<table>` markup remains in `web/app/views/entities/trades/show.html.erb`.
    - Remaining sections use dense OUT/IN-aware lane grammar with direct pivots.
    - Existing anchors/local-nav targets remain stable.
  - Rubric (before → target):
    - Scan speed: 4 → 5
    - Information hierarchy: 4 → 5
    - Interaction predictability: 4 → 5
    - Density/readability: 4 → 4
    - Navigation/pivots: 4 → 5
  - Guardrails:
    - Do not modify Salary Book files.
  - Completed (2026-02-14):
    - What changed (files):
      - `web/app/views/entities/trades/show.html.erb`: converted `#player-items`, `#pick-cash`, `#transactions`, and `#endnotes` to lane-based rows; also converted `#pick-trades` to lane rows so the page has zero `<table>` islands.
      - `web/test/integration/entities_trades_show_test.rb`: expanded assertions to enforce no `<table>` in full trade show response and validate lower-lane OUT/IN grammar + pivots.
    - Why this improves the flow:
      - Trade analysis now stays in one continuous scan grammar from top board through lower modules (no table-mode reset), with direct pivots preserved on every lane.
    - Rubric (before → after):
      - Scan speed: 4 → 5
      - Information hierarchy: 4 → 5
      - Interaction predictability: 4 → 5
      - Density/readability: 4 → 4
      - Navigation/pivots: 4 → 5
    - Follow-up tasks discovered:
      - Consider extracting shared lane-row partials for trade detail sections to reduce repeated OUT/IN chip + metadata patterns.

- [x] [P1] [ENTITY] /players/:slug — add decision-lens chips (`urgent/upcoming/later`) with URL-stable state
  - Problem: decision rail is strong but long lists still require manual scanning.
  - Hypothesis: lens chips + URL persistence will improve repeat decision workflows.
  - Scope (files):
    - `web/app/views/entities/players/_section_next_decisions.html.erb`
    - `web/app/views/entities/players/show.html.erb`
    - `web/app/helpers/entities_helper.rb`
    - `web/test/integration/entities_players_show_test.rb`
  - Patch targets: `#maincanvas` (`#next-decisions`)
  - Response type: `text/html` full-page show render.
  - Acceptance criteria:
    - Decision lenses filter displayed items without breaking section anchors.
    - Lens state survives reload/share via query or hash state.
    - Rail preserves direct team/transaction/trade pivots under filtering.
  - Rubric (before → target):
    - Scan speed: 4 → 5
    - Information hierarchy: 4 → 5
    - Interaction predictability: 4 → 5
    - Density/readability: 4 → 4
    - Navigation/pivots: 5 → 5
  - Guardrails:
    - Do not modify Salary Book files.
  - Completed (2026-02-14):
    - What changed (files):
      - `web/app/views/entities/players/_section_next_decisions.html.erb`: added decision-lens chips (`all/urgent/upcoming/later`), query-backed link state, filtered lane rendering, and empty-lens fallback copy while preserving existing pivot chips.
      - `web/app/helpers/entities_helper.rb`: added decision-lens normalization/filter/count helpers and extended decision urgency payloads with a stable lens key used by filtering.
      - `web/app/controllers/entities/players_controller.rb`: normalized `decision_lens` query state for player show renders.
      - `web/app/views/entities/players/show.html.erb`: persisted active `decision_lens` into deferred bootstrap URL so skeleton → hydrated sections keep the same lens state.
      - `web/app/controllers/entities/players_sse_controller.rb`: applied show-state lens normalization in bootstrap responses.
      - `web/test/integration/entities_players_show_test.rb`: added assertions for lens URL links and query-driven filtering behavior in the next-decisions section.
    - Why this improves the flow:
      - Analysts can now jump straight to urgent/upcoming/later decision slices without rescanning the full rail, and the selected lens survives reload/share because the state is captured in URL query params.
    - Rubric (before → after):
      - Scan speed: 4 → 5
      - Information hierarchy: 4 → 5
      - Interaction predictability: 4 → 5
      - Density/readability: 4 → 4
      - Navigation/pivots: 5 → 5
    - Follow-up tasks discovered:
      - Consider adding a compact "N hidden by lens" indicator when a lens returns fewer than the default row cap to make filtered context explicit.

- [x] [P1] [ENTITY] /teams/:slug — add transaction-id cross-highlighting between activity and apron provenance
  - Problem: users still manually correlate apron trigger transactions with activity rows.
  - Hypothesis: shared transaction-id highlighting will make causal tracing nearly instant.
  - Scope (files):
    - `web/app/views/entities/teams/_section_activity.html.erb`
    - `web/app/views/entities/teams/_section_apron_provenance.html.erb`
    - `web/app/views/entities/teams/show.html.erb`
    - `web/test/integration/entities_teams_show_test.rb`
  - Patch targets: `#maincanvas` (`#activity`, `#apron-provenance`)
  - Response type: `text/html` full-page show render.
  - Acceptance criteria:
    - Shared transaction references are visually linked across both sections.
    - Hover/focus on a tx link in one section highlights matching rows in the other.
    - No regression in existing pivots/anchors.
  - Rubric (before → target):
    - Scan speed: 4 → 5
    - Information hierarchy: 4 → 5
    - Interaction predictability: 4 → 5
    - Density/readability: 4 → 4
    - Navigation/pivots: 4 → 5
  - Guardrails:
    - Do not modify Salary Book files.
  - Completed (2026-02-14):
    - What changed (files):
      - `web/app/views/entities/teams/show.html.erb`: introduced a page-level Datastar signal (`txhoverid`) for transient cross-section transaction hover/focus state.
      - `web/app/views/entities/teams/_section_activity.html.erb`: added tx-link hover/focus signal emitters plus row-level highlight bindings for both ledger and exception lanes; also added explicit cross-highlight wayfinding copy in the lane header.
      - `web/app/views/entities/teams/_section_apron_provenance.html.erb`: added matching A1/A2 tx-link emitters and row-level highlight bindings that react to shared transaction IDs from activity lanes.
      - `web/test/integration/entities_teams_show_test.rb`: expanded bootstrap assertions to verify new cross-highlight instructions and Datastar tx-hover bindings in both activity and apron provenance sections.
    - Why this improves the flow:
      - Users can now causal-trace apron trigger references without manual ID matching: hovering or focusing a transaction link in either section immediately reveals all related lanes in both modules, preserving existing pivots and anchor navigation.
    - Rubric (before → after):
      - Scan speed: 4 → 5
      - Information hierarchy: 4 → 5
      - Interaction predictability: 4 → 5
      - Density/readability: 4 → 4
      - Navigation/pivots: 4 → 5
    - Follow-up tasks discovered:
      - Consider adding a compact "active transaction: #id" chip near section headers while highlighting is active to improve keyboard-only wayfinding across long sections.

- [x] [P1] [ENTITY] /agents/:slug — add cohort filters and URL-synced cohort state
  - Problem: cohort lanes exist but large books still need quick cohort-only narrowing.
  - Hypothesis: cohort filter chips with URL sync will tighten agent portfolio triage.
  - Scope (files):
    - `web/app/views/entities/agents/show.html.erb`
    - `web/app/views/entities/agents/_client_lane.html.erb`
    - `web/test/integration/entities_agents_show_test.rb`
  - Patch targets: `#maincanvas` (`#client-cohorts`, full roster section)
  - Response type: `text/html` full-page show render.
  - Acceptance criteria:
    - Users can filter to one or more cohorts (max, expiring, restricted, two-way).
    - Active cohort state is reflected in URL and survives reload.
    - Cohort counts and cap rollups update consistently with filter state.
  - Rubric (before → target):
    - Scan speed: 4 → 5
    - Information hierarchy: 4 → 5
    - Interaction predictability: 4 → 5
    - Density/readability: 4 → 4
    - Navigation/pivots: 4 → 5
  - Guardrails:
    - Do not modify Salary Book files.
  - Completed (2026-02-14):
    - What changed (files):
      - `web/app/controllers/entities/agents_controller.rb`: added normalized multi-select cohort query parsing (`cohorts=max,restricted,...`) for agent show, and preserved query params on canonical slug redirects so cohort state survives non-canonical entry.
      - `web/app/views/entities/agents/show.html.erb`: added cohort filter chips with URL-synced toggle links, filtered cohort-lane rendering, and filtered roster rendering (`Filtered clients`) with state-aware counts/rollups.
      - `web/app/views/entities/agents/_client_lane.html.erb`: added optional cohort-match hint chips so filtered roster rows explain why each player is included.
      - `web/test/integration/entities_agents_show_test.rb`: expanded coverage for cohort-filter link generation and query-driven narrowing across both `#client-cohorts` and `#clients` sections.
    - Why this improves the flow:
      - Agent triage is now shareable and repeatable: analysts can jump directly to max/expiring/restricted/two-way slices, combine cohorts in one view, and reload/bookmark URLs without losing context. Cohort counters and cap rollups now stay aligned with the active lens state.
    - Rubric (before → after):
      - Scan speed: 4 → 5
      - Information hierarchy: 4 → 5
      - Interaction predictability: 4 → 5
      - Density/readability: 4 → 4
      - Navigation/pivots: 4 → 5
    - Follow-up tasks discovered:
      - Consider persisting active cohort chips into local-nav link targets (or adding a compact "active filters" chip near the local nav) to keep cohort context visible deeper in long agent pages.

- [x] [P1] [ENTITY] /agencies/:slug — add agency cohort slices mirroring upgraded agent dossier grammar
  - Problem: agency lanes are cleaner now, but negotiation-risk cohorts are not explicit.
  - Hypothesis: cohort slices at agency scope will improve immediate footprint interpretation.
  - Scope (files):
    - `web/app/controllers/entities/agencies_controller.rb`
    - `web/app/views/entities/agencies/show.html.erb`
    - `web/test/integration/entities_agencies_show_test.rb`
  - Patch targets: `#maincanvas` (`#agent-roster`, `#historical`)
  - Response type: `text/html` full-page show render.
  - Acceptance criteria:
    - Agency roster exposes cohort slices (`max`, `expiring`, `restricted`, `option-heavy`).
    - Slice headers show counts + cap totals and preserve pivots.
    - Historical section can be viewed through active slice context.
  - Rubric (before → target):
    - Scan speed: 4 → 5
    - Information hierarchy: 4 → 5
    - Interaction predictability: 4 → 5
    - Density/readability: 4 → 4
    - Navigation/pivots: 4 → 5
  - Guardrails:
    - Do not modify Salary Book files.
  - Completed (2026-02-14):
    - What changed (files):
      - `web/app/controllers/entities/agencies_controller.rb`: added normalized multi-select cohort query parsing for agency show (`cohorts=max,restricted,...`), preserved query params on canonical slug redirects, expanded show client payload fields, and added player-year footprint rows used for cohort-scoped historical aggregation.
      - `web/app/views/entities/agencies/show.html.erb`: introduced agency cohort slice controls (`all/max/expiring/restricted/option-heavy`) with URL-synced toggles, added cohort slice lane modules with count/cap/commitment rollups + player/agent/team pivots, and applied active slice context to both historical book rows and top-client lanes.
      - `web/test/integration/entities_agencies_show_test.rb`: expanded integration coverage for default cohort slice rendering and query-driven cohort filtering across both `#agent-roster` and `#historical`.
    - Why this improves the flow:
      - Agency analysis now supports immediate negotiation-risk triage: users can jump into targeted cohorts, keep state in the URL for share/reload, and review historical footprint + top-client pivots in the same active slice context without rescanning the entire book.
    - Rubric (before → after):
      - Scan speed: 4 → 5
      - Information hierarchy: 4 → 5
      - Interaction predictability: 4 → 5
      - Density/readability: 4 → 4
      - Navigation/pivots: 4 → 5
    - Follow-up tasks discovered:
      - Consider adding cohort chips to local-nav anchor links (or a persistent active-slice badge near local nav) so context remains visible after deep scroll into the team distribution module.

- [x] [P2] [ENTITY] /transactions/:id — add timeline phase filters and optional raw-row expansion
  - Problem: causal timeline is strong, but very dense transactions still need lightweight narrowing.
  - Hypothesis: phase filters + raw expanders will keep default readability while preserving audit depth.
  - Scope (files):
    - `web/app/views/entities/transactions/show.html.erb`
    - `web/test/integration/entities_transactions_show_test.rb`
  - Patch targets: `#maincanvas` (`#causal-timeline`)
  - Response type: `text/html` full-page show render.
  - Acceptance criteria:
    - Phase chips (`facts/parties/ledger/artifacts`) filter lanes in-page.
    - Each phase supports collapsed-by-default raw-row expansion.
    - Deep-link state (active phase) is URL-stable.
  - Rubric (before → target):
    - Scan speed: 4 → 5
    - Information hierarchy: 4 → 5
    - Interaction predictability: 4 → 5
    - Density/readability: 4 → 4
    - Navigation/pivots: 5 → 5
  - Guardrails:
    - Do not modify Salary Book files.
  - Completed (2026-02-14):
    - What changed (files):
      - `web/app/views/entities/transactions/show.html.erb`: added `#causal-timeline` phase filter chips (`all/facts/parties/ledger/artifacts`) with Datastar in-page filtering, URL-stable `phase` query syncing, and per-phase collapsed raw-row expanders for facts/parties/ledger/artifacts lanes.
      - `web/test/integration/entities_transactions_show_test.rb`: expanded coverage for phase filter/render wiring, raw-row expander presence, and query-driven phase bootstrapping (including invalid-phase fallback to `all`).
    - Why this improves the flow:
      - Analysts can now narrow dense transaction timelines to one causal phase without losing context, then opt into raw-row audit detail only when needed, preserving default readability while keeping investigative depth one click away.
    - Rubric (before → after):
      - Scan speed: 4 → 5
      - Information hierarchy: 4 → 5
      - Interaction predictability: 4 → 5
      - Density/readability: 4 → 4
      - Navigation/pivots: 5 → 5
    - Follow-up tasks discovered:
      - Consider per-row raw toggles for extremely dense artifact phases so users can expand just one row without opening all raw rows in that phase.

- [ ] [P2] [ENTITY] /draft-selections/:slug — add provenance lane filters (`deep/conditional/swap`) and team exposure summary
  - Problem: provenance lanes are improved but long chains still require full-scroll parsing.
  - Hypothesis: lane filters plus top exposure summary will accelerate ownership-risk calls.
  - Scope (files):
    - `web/app/views/entities/draft_selections/show.html.erb`
    - `web/test/integration/entities_draft_selections_show_test.rb`
  - Patch targets: `#maincanvas` (`#provenance`)
  - Response type: `text/html` full-page show render.
  - Acceptance criteria:
    - Filter chips narrow lane rows by chain depth/flag type.
    - Summary strip surfaces exposed teams and deepest hop count.
    - Existing transaction/trade pivots remain unchanged.
  - Rubric (before → target):
    - Scan speed: 4 → 5
    - Information hierarchy: 4 → 5
    - Interaction predictability: 4 → 5
    - Density/readability: 4 → 4
    - Navigation/pivots: 4 → 5
  - Guardrails:
    - Do not modify Salary Book files.

- [ ] [P2] [ENTITY] /draft-picks/:slug — add rule-lane filters and chain-map hop highlighting
  - Problem: new rule lanes are clearer, but large rule sets still need faster narrowing and hop tracing.
  - Hypothesis: rule filters + hop highlighting will shorten protection interpretation loops.
  - Scope (files):
    - `web/app/views/entities/draft_picks/show.html.erb`
    - `web/test/integration/entities_draft_picks_show_test.rb`
  - Patch targets: `#maincanvas` (`#protections`, `#trade-chain`)
  - Response type: `text/html` full-page show render.
  - Acceptance criteria:
    - Rule chips (`all/conditional/swap/flagged`) filter lane rows.
    - Selecting a rule lane highlights corresponding hops in chain map.
    - Trade/team pivots continue to work from filtered view.
  - Rubric (before → target):
    - Scan speed: 4 → 5
    - Information hierarchy: 4 → 5
    - Interaction predictability: 4 → 5
    - Density/readability: 4 → 4
    - Navigation/pivots: 4 → 5
  - Guardrails:
    - Do not modify Salary Book files.

- [ ] [P2] [INDEX] /players — add secondary urgency sub-lenses (`option-only`, `expiring-only`, `non-guaranteed-only`)
  - Problem: urgency lanes are strong, but analysts still need narrower follow-up controls.
  - Hypothesis: sub-lenses on top of urgency will reduce false-positive scanning in large result sets.
  - Scope (files):
    - `web/app/controllers/entities/players_controller.rb`
    - `web/app/controllers/entities/players_sse_controller.rb`
    - `web/app/views/entities/players/index.html.erb`
    - `web/app/views/entities/players/_workspace_main.html.erb`
    - `web/test/integration/entities_players_index_test.rb`
  - Patch targets: `#commandbar`, `#maincanvas`, `#rightpanel-base`
  - Response type: one `text/event-stream` response for multi-region refresh.
  - Acceptance criteria:
    - Sub-lens controls are discoverable and URL-stable.
    - Lane counts + rows reflect primary urgency + secondary sub-lens intersection.
    - Overlay preservation behavior remains correct under sub-lens changes.
  - Rubric (before → target):
    - Scan speed: 5 → 5
    - Information hierarchy: 5 → 5
    - Interaction predictability: 5 → 5
    - Density/readability: 4 → 4
    - Navigation/pivots: 5 → 5
  - Guardrails:
    - Do not modify Salary Book files.

- [ ] [P2] [TOOL] /tools/system-values — add global shortcut focus (`Cmd/Ctrl+K`) and match-reason badges
  - Problem: keyboard shortlist exists, but first focus and result rationale are still implicit.
  - Hypothesis: explicit shortcut + reason badges will speed confident metric selection.
  - Scope (files):
    - `web/app/views/tools/system_values/show.html.erb`
    - `web/app/views/tools/system_values/_commandbar.html.erb`
    - `web/app/controllers/tools/system_values_controller.rb`
    - `web/test/integration/tools_system_values_test.rb`
  - Patch targets: `#commandbar`, `#rightpanel-base`
  - Response type: one `text/event-stream` response for multi-region refresh.
  - Acceptance criteria:
    - `Cmd/Ctrl+K` focuses finder from anywhere in the page.
    - Shortlist rows show match reason badges (`exact/prefix/context`).
    - Finder + overlay state remain synchronized after shortcut-driven open.
  - Rubric (before → target):
    - Scan speed: 5 → 5
    - Information hierarchy: 5 → 5
    - Interaction predictability: 5 → 5
    - Density/readability: 4 → 4
    - Navigation/pivots: 5 → 5
  - Guardrails:
    - Do not modify Salary Book files.

- [ ] [P2] [TOOL] /tools/two-way-utility — add global intent focus shortcut and match rationale labels
  - Problem: shortlist open works, but intent initiation and ranking rationale remain opaque for edge queries.
  - Hypothesis: explicit shortcut + reason labels will reduce query iteration loops.
  - Scope (files):
    - `web/app/views/tools/two_way_utility/show.html.erb`
    - `web/app/views/tools/two_way_utility/_commandbar.html.erb`
    - `web/app/controllers/tools/two_way_utility_controller.rb`
    - `web/test/integration/tools_two_way_utility_test.rb`
  - Patch targets: `#commandbar`, `#maincanvas`, `#rightpanel-overlay`
  - Response type: one `text/event-stream` refresh for multi-region updates; overlay open remains `text/html`.
  - Acceptance criteria:
    - `Cmd/Ctrl+K` focuses intent input from board context.
    - Shortlist displays reason labels (`name prefix`, `id exact`, `contains`).
    - Enter-to-open remains deterministic after cursor movement and refresh.
  - Rubric (before → target):
    - Scan speed: 5 → 5
    - Information hierarchy: 5 → 5
    - Interaction predictability: 5 → 5
    - Density/readability: 4 → 4
    - Navigation/pivots: 5 → 5
  - Guardrails:
    - Do not modify Salary Book files.

- [ ] [P3] [PROCESS] design backlog hygiene — keep DESIGN.md active-only and archive done work to git history
  - Problem: backlog files bloat quickly and increase startup/token cost for the loop.
  - Hypothesis: an explicit active-only policy prevents context-window waste and drift.
  - Scope (files):
    - `.ralph/DESIGN.md`
    - `agents/design.ts`
  - Patch targets: N/A
  - Response type: N/A
  - Acceptance criteria:
    - `DESIGN.md` contains only active unchecked tasks.
    - Any done-task summaries are one short audit note or omitted entirely.
    - Loop prompt reminds agent not to reintroduce completed blocks.
  - Rubric (before → target):
    - Scan speed: 3 → 5
    - Information hierarchy: 4 → 5
    - Interaction predictability: 4 → 5
    - Density/readability: 3 → 5
    - Navigation/pivots: 3 → 4
  - Guardrails:
    - Do not modify Salary Book files.
