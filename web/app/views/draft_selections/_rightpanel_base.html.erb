<% summary = @sidebar_summary || {} %>
<% top_rows = Array(summary[:top_rows]) %>
<%
  severity_counts = summary[:severity_counts] || {}
  clean_count = severity_counts.fetch("clean", summary[:clean_count].to_i)
  with_trade_count = severity_counts.fetch("with_trade", summary[:with_trade_count].to_i)
  deep_chain_count = severity_counts.fetch("deep_chain", summary[:deep_chain_count].to_i)
  trade_active_count = summary[:trade_active_count].to_i

  severity_chip_class = lambda do |severity|
    case severity.to_s
    when "deep_chain"
      "entity-chip entity-chip--danger"
    when "with_trade"
      "entity-chip entity-chip--warning"
    else
      "entity-chip entity-chip--muted"
    end
  end
%>

<div id="rightpanel-base" class="space-y-4">
  <div class="rounded-lg border border-border bg-background p-3 space-y-3">
    <div>
      <div class="text-[10px] uppercase tracking-wide text-muted-foreground/80">Workspace snapshot</div>
      <div class="text-sm font-semibold text-foreground">
        Draft selections
        <span class="text-muted-foreground font-medium">· <%= summary[:row_count].to_i %> rows</span>
      </div>
      <div class="text-[11px] text-muted-foreground tabular-nums">
        <span>Sort: <%= summary[:sort_label].presence || @sort_label %></span>
        <% if summary[:lens_label].present? && summary[:lens_label] != "All rows" %>
          <span class="px-1 text-muted-foreground/50">·</span>
          <span>Lens: <%= summary[:lens_label] %></span>
        <% end %>
      </div>
    </div>

    <div class="grid grid-cols-3 gap-1.5">
      <%= render partial: "salary_book/kpi_cell", locals: { label: "Rows", value: summary[:row_count].to_i.to_s, class_name: "w-full" } %>
      <%= render partial: "salary_book/kpi_cell", locals: { label: "Clean", value: clean_count.to_s, class_name: "w-full", variant: (clean_count.positive? ? "default" : "muted") } %>
      <%= render partial: "salary_book/kpi_cell", locals: { label: "With trade", value: with_trade_count.to_s, class_name: "w-full", variant: (with_trade_count.positive? ? "default" : "muted") } %>
      <%= render partial: "salary_book/kpi_cell", locals: { label: "Deep chain", value: deep_chain_count.to_s, class_name: "w-full", variant: (deep_chain_count.positive? ? "negative" : "muted") } %>
      <%= render partial: "salary_book/kpi_cell", locals: { label: "Trade-active", value: trade_active_count.to_s, class_name: "w-full" } %>
      <%= render partial: "salary_book/kpi_cell", locals: { label: "Prov. rows", value: summary[:provenance_trade_total].to_i.to_s, class_name: "w-full" } %>
      <%= render partial: "salary_book/kpi_cell", locals: { label: "R1", value: summary[:first_round_count].to_i.to_s, class_name: "w-full" } %>
      <%= render partial: "salary_book/kpi_cell", locals: { label: "Known", value: summary[:known_player_count].to_i.to_s, class_name: "w-full" } %>
      <%= render partial: "salary_book/kpi_cell", locals: { label: "Teams", value: summary[:unique_team_count].to_i.to_s, class_name: "w-full" } %>
    </div>

    <div class="pt-1 flex flex-wrap gap-1">
      <span class="entity-chip entity-chip--muted">Clean · <span class="font-mono tabular-nums"><%= clean_count %></span></span>
      <span class="entity-chip entity-chip--warning">With trade · <span class="font-mono tabular-nums"><%= with_trade_count %></span></span>
      <span class="entity-chip entity-chip--danger">Deep chain · <span class="font-mono tabular-nums"><%= deep_chain_count %></span></span>
    </div>

    <% if Array(summary[:filters]).any? %>
      <div class="pt-1 flex flex-wrap gap-1">
        <% Array(summary[:filters]).each do |label| %>
          <span class="entity-chip entity-chip--muted"><%= label %></span>
        <% end %>
      </div>
    <% end %>
  </div>

  <% if top_rows.any? %>
    <div class="rounded-lg border border-border bg-background">
      <div class="px-3 py-2 border-b border-border text-[10px] uppercase tracking-wide text-muted-foreground/80">Quick selections · <%= summary[:sort_label].presence || @sort_label %></div>
      <div class="divide-y divide-border">
        <% top_rows.each do |row| %>
          <% row_id = row["transaction_id"].to_s %>
          <% provenance_count = row["provenance_trade_count"].to_i %>
          <% severity = row["provenance_severity"].to_s.presence || "clean" %>
          <% severity_label = row["provenance_severity_label"].to_s.presence || "Clean" %>
          <button
            type="button"
            class="cursor-pointer w-full px-3 py-2 text-left hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 transition-colors duration-75"
            data-class="{ 'bg-yellow-100/80 dark:bg-yellow-900/20': $overlaytype === 'selection' && $overlayid === '<%= row_id %>' }"
            data-on:click="$overlaytype = 'selection'; $overlayid = '<%= row_id %>'; @get('/draft-selections/sidebar/<%= row_id %>')"
          >
            <div class="entity-cell-two-line">
              <div class="entity-cell-primary justify-between gap-2">
                <span class="font-medium"><%= row["draft_year"] %> R<%= row["draft_round"] %> P<%= row["pick_number"] %></span>
                <span class="<%= severity_chip_class.call(severity) %>"><%= severity_label %></span>
              </div>
              <div class="entity-cell-secondary truncate">
                <span><%= row["player_name"].presence || "Unknown player" %></span>
                <% if row["drafting_team_code"].present? %>
                  <span class="px-1 text-muted-foreground/50">·</span>
                  <span><%= row["drafting_team_code"] %></span>
                <% end %>
                <span class="px-1 text-muted-foreground/50">·</span>
                <span class="font-mono tabular-nums">P<%= provenance_count %></span>
                <span class="px-1 text-muted-foreground/50">·</span>
                <span class="font-mono tabular-nums">#<%= row_id %></span>
              </div>
            </div>
          </button>
        <% end %>
      </div>
    </div>
  <% else %>
    <div class="p-4 rounded-lg border border-border bg-muted/20 text-sm text-muted-foreground">
      Use the selection feed to open provenance details.
    </div>
  <% end %>
</div>
