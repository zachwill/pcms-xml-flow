# Design Evolution Backlog (`web/`)

North star:
- Entity index pages should behave like explorer workbenches (Salary Book-like interaction grammar, not clones).
- Fast scan, meaningful filters/knobs, dense interactive rows, and sidebar drill-ins.
- Canonical shell: `#commandbar` + `#maincanvas` + `#rightpanel-base` + `#rightpanel-overlay`.
- Salary Book is read-only and remains the interaction quality bar.
- Team Summary, System Values, and Two-Way Utility should continue converging toward stronger workbench UX.

Rubric (1-5):
1) Scan speed
2) Information hierarchy
3) Interaction predictability
4) Density/readability balance
5) Navigation/pivots

Supervisor review — 2026-02-13:
- Reviewed recent commits for `/players`, `/trades`, and `/tools/team-summary` against workbench interaction goals.
- Confirmed multi-region interactions use one SSE response and canonical patch boundaries (`#maincanvas`, `#rightpanel-base`, `#rightpanel-overlay`).
- Confirmed no Salary Book files were modified.
- Drift noted: `/trades` still needs asset-composition archetype lenses (player-heavy/pick-heavy/cash-TPE) beyond the shipped complexity triage controls.
- Drift noted: `/tools/team-summary` still needs header sorting to route through SSE refresh (separate from the shipped inline pin compare flow).

- [x] [P1] [INDEX] /players — isolate constrained cap commitments without losing drill-in context
  - Problem: Player scanning is strong, but users still need too many row opens to isolate constraint-heavy contracts across multiple cap years.
  - Hypothesis: Adding constraint-specific knobs + cap-horizon switching will make “find risky money fast” a first-pass scan flow.
  - Scope (files):
    - web/app/views/entities/players/index.html.erb
    - web/app/views/entities/players/_workspace_main.html.erb
    - web/app/views/entities/players/_rightpanel_base.html.erb
    - web/app/controllers/entities/players_controller.rb
    - web/app/controllers/entities/players_sse_controller.rb
    - web/test/integration/entities_players_index_test.rb
  - What changed:
    - Added a commandbar **Constraint lens** (`all`, `lock_now`, `options`, `non_guaranteed`, `trade_kicker`, `expiring`) and a **Cap horizon** knob (`2025`, `2026`, `2027`) to `/players`.
    - Extended index query/filter state in `PlayersController` with `constraint` + `horizon`, including horizon-aware cap sort and SQL-backed constraint predicates.
    - Updated main rows to render horizon-aware cap columns (`Cap <horizon>`, `Cap <horizon+1>`) plus dense constraint posture chips.
    - Updated right sidebar base KPIs + quick list to use the same horizon/constraint context and horizon-aware cap values.
    - Extended SSE signal patching (`playerconstraint`, `playerhorizon`) so knob changes still run through one `/players/sse/refresh` multi-region response and preserve overlay when visible.
    - Expanded integration coverage for new commandbar knobs and horizon/constraint SSE behavior.
  - Why this improves the flow:
    - Users can now isolate risk-heavy commitments in one pass from the index (without repeatedly opening overlays), while keeping drill-in continuity when iterating filters.
    - Horizon switching makes cap risk scanning year-aware without losing row density or pivot affordances.
    - Sidebar quick list now mirrors the same lens context as the table, reducing mental mismatch.
  - Rubric (before → after):
    - Scan speed: 4 → 5
    - Information hierarchy: 4 → 5
    - Interaction predictability: 4 → 5
    - Density/readability: 4 → 5
    - Navigation/pivots: 4 → 5
  - Follow-up tasks discovered:
    - Add explicit “why matched” highlighting for the active constraint lens on row chips (currently chips are present but not lens-prioritized).
    - Consider exposing horizon-aware overlay KPI emphasis (currently overlay remains static 2025–2027 snapshot).
  - Guardrails:
    - Do not modify Salary Book files.

- [x] [P1] [INDEX] /trades — complexity-first sorting + lens controls for fast deal triage
  - Problem: Trades rows were dense but effectively single-order; users could not quickly re-rank toward most complex multi-asset deals.
  - Hypothesis: A complexity lens plus explicit sort controls would make high-friction deal review a first-pass scan behavior from the index itself.
  - Scope (files):
    - web/app/views/entities/trades/index.html.erb
    - web/app/views/entities/trades/_results.html.erb
    - web/app/views/entities/trades/_rightpanel_base.html.erb
    - web/app/controllers/entities/trades_controller.rb
    - web/app/controllers/entities/trades_sse_controller.rb
    - web/test/integration/entities_pane_endpoints_test.rb
  - What changed:
    - Added commandbar controls for `sort` (`newest`, `most_teams`, `most_assets`) and `complexity lens` (`all`, `complex`, `mega`).
    - Extended index SQL rollups with `team_count`, `player_count`, `pick_count`, `cash_line_count`, `tpe_line_count`, and `complexity_asset_count` for deterministic ranking.
    - Wired refresh through one `/trades/sse/refresh` response patching results + sidebar + overlay with overlay-preserve/clear semantics.
    - Updated sidebar quick-deals and snapshot KPIs to mirror active sort/lens context.
  - Why this improves the flow:
    - Makes “find the messiest deals first” a direct commandbar action instead of manual row scanning.
    - Keeps users in one explorer surface while preserving drill-in continuity.
  - Rubric (before → after):
    - Scan speed: 4 → 5
    - Information hierarchy: 4 → 5
    - Interaction predictability: 4 → 5
    - Density/readability: 4 → 4
    - Navigation/pivots: 4 → 5
  - Corrective follow-up:
    - Add explicit composition archetype filters (player-heavy vs pick-heavy vs cash/TPE-involved); complexity is now baseline but not the final intent lens.
  - Guardrails:
    - Do not modify Salary Book files.

- [x] [P2] [TOOL] /tools/team-summary — inline Pin A / Pin B compare flow from dense rows
  - Problem: Team Summary allowed one-row drill-ins, but lacked in-grid compare holds for two candidates while continuing to scan.
  - Hypothesis: Inline compare pinning would improve planning flow by removing sidebar/open-close churn during shortlist decisions.
  - Scope (files):
    - web/app/views/tools/team_summary/_workspace_main.html.erb
    - web/app/views/tools/team_summary/_compare_strip.html.erb
    - web/app/views/tools/team_summary/_rightpanel_base.html.erb
    - web/app/controllers/tools/team_summary_controller.rb
    - web/test/integration/tools_team_summary_test.rb
  - What changed:
    - Added row-level Pin A / Pin B controls in the frozen identity column.
    - Added compare strip cards with slot clear actions, delta summary, and direct focus-back into sidebar drill-in.
    - Added `/tools/team-summary/sse/compare` multi-region SSE patching compare strip + rightpanel base + overlay with signal sync (`selectedteam`, `comparea`, `compareb`).
    - Kept row density and sticky-column behavior while adding compare affordances.
  - Why this improves the flow:
    - Supports side-by-side planning decisions directly in the workbench table.
    - Keeps interaction grammar predictable: pin updates are patch-driven and overlay-safe.
  - Rubric (before → after):
    - Scan speed: 4 → 5
    - Information hierarchy: 4 → 5
    - Interaction predictability: 4 → 5
    - Density/readability: 5 → 5
    - Navigation/pivots: 4 → 5
  - Guardrails:
    - Do not modify Salary Book files.

- [x] [P1] [INDEX] /teams — compare two cap-pressure candidates directly from the index table
  - Problem: Team pressure triage is row-by-row; users cannot quickly hold two teams side-by-side without leaving the surface.
  - Hypothesis: Inline pin/compare from dense rows will reduce context switching and speed shortlist decisions.
  - Scope (files):
    - web/app/views/entities/teams/index.html.erb
    - web/app/views/entities/teams/_workspace_main.html.erb
    - web/app/views/entities/teams/_rightpanel_base.html.erb
    - web/app/controllers/entities/teams_controller.rb
    - web/app/controllers/entities/teams_sse_controller.rb
    - web/test/integration/entities_teams_index_test.rb
  - What changed:
    - Added compare state signals (`comparea`, `compareb`) and URL-backed query wiring on `/teams` commandbar refreshes.
    - Added inline row-level **Pin A / Pin B** controls in the team identity cell, with slot badges and pinned-row highlighting.
    - Added an in-surface `#teams-compare-strip` module in maincanvas with slot cards, clear actions, focus-back-to-overlay behavior, and cap/tax/apron delta readouts.
    - Extended `TeamsController` index workspace state to parse/normalize compare slots, apply compare actions (`pin`, `clear_slot`, `clear_all`), and hydrate compare rows (including lookup when filtered out).
    - Updated `entities/teams/_rightpanel_base` with a mirrored compare-slots summary + delta context so sidebar wayfinding matches table compare state.
    - Updated `/teams/sse/refresh` to run compare actions and patch compare signals in the same one-request multi-region SSE response while preserving/clearing selected overlay deterministically.
    - Expanded integration tests to cover compare strip rendering, compare signal patching in refresh SSE, and pin action behavior without forced overlay selection.
  - Why this improves the flow:
    - Team shortlist comparison now happens directly inside the index table, removing row-open/close churn.
    - Users can hold two candidates while continuing to scan and filter, with immediate delta context for cap/tax/apron pressure.
    - Interaction grammar stays predictable: one SSE refresh path updates maincanvas + sidebar + overlay + signals together.
  - Rubric (before → after):
    - Scan speed: 4 → 5
    - Information hierarchy: 4 → 5
    - Interaction predictability: 4 → 5
    - Density/readability: 4 → 5
    - Navigation/pivots: 4 → 5
  - Follow-up tasks discovered:
    - Add URL replaceState updates on pin/unpin actions (currently URL sync happens on commandbar-driven refreshes).
    - Consider exposing compare pin actions directly inside team overlay pivots for parity with row-level controls.
  - Guardrails:
    - Do not modify Salary Book files.

- [x] [P1] [INDEX] /agents — pivot between agent and agency drill-ins without leaving workbench flow
  - Problem: Related pivots in rows/overlays still pull users out to full pages too often during directory scanning.
  - Hypothesis: In-panel cross-entity pivots (agent⇄agency) will preserve scan momentum and reduce backtracking.
  - Scope (files):
    - web/app/views/entities/agents/_workspace_main.html.erb
    - web/app/views/entities/agents/_rightpanel_overlay_agent.html.erb
    - web/app/views/entities/agents/_rightpanel_overlay_agency.html.erb
    - web/app/controllers/entities/agents_controller.rb
    - web/test/integration/entities_agents_index_test.rb
  - What changed:
    - Updated **agency cells in agent rows** to open agency overlays in-place via Datastar (`$overlaytype='agency'`, `$overlayid=<id>`, sidebar GET), while retaining a compact **Page** link to canonical `/agencies/:slug` navigation.
    - Updated **agent overlay header** so agency name now pivots to the agency overlay in-panel (with canonical page link retained alongside it).
    - Updated **agency overlay top-agent rows** to open agent overlays in-panel (click/keyboard), while retaining per-row canonical **Page** links.
    - Expanded overlay scope checks in `Entities::AgentsController#selected_overlay_visible?` so refresh preserves cross-entity overlays when still represented by the current lens (agent⇄agency), instead of clearing whenever kind mismatched.
    - Added integration coverage for in-panel pivot affordances and cross-kind overlay preservation semantics during `/agents/sse/refresh`.
  - Why this improves the flow:
    - Users can pivot agent→agency→agent directly inside the right panel while continuing to scan/filter in the same workbench.
    - Canonical links are still present, so deep-page escape hatches remain obvious without sacrificing in-flow momentum.
    - Overlay state now behaves predictably across refreshes, even when the selected overlay type differs from the active directory lens.
  - Verification:
    - `cd web && bundle exec rails test test/integration/entities_agents_index_test.rb` *(fails in this environment: missing gem `lucide-rails-0.7.3`)*
    - `cd web && ruby -c app/controllers/entities/agents_controller.rb && ruby -c test/integration/entities_agents_index_test.rb` *(syntax OK)*
  - Rubric (before → after):
    - Scan speed: 4 → 5
    - Information hierarchy: 4 → 5
    - Interaction predictability: 4 → 5
    - Density/readability: 4 → 4
    - Navigation/pivots: 4 → 5
  - Follow-up tasks discovered:
    - Consider adding selected-row visual tie-back when an **agency overlay** is open from the agents lens (current highlight remains agent-row scoped).
  - Guardrails:
    - Do not modify Salary Book files.

- [x] [P1] [INDEX] /drafts — sort for ownership complexity to surface high-risk pick situations first
  - Problem: Draft picks/selections views are dense, but users cannot quickly reorder by complexity/provenance risk.
  - Hypothesis: View-aware sort/lens controls will turn the page into a triage board instead of a static listing.
  - Scope (files):
    - web/app/views/entities/drafts/index.html.erb
    - web/app/views/entities/drafts/_results.html.erb
    - web/app/views/entities/drafts/_rightpanel_base.html.erb
    - web/app/controllers/entities/drafts_controller.rb
    - web/app/controllers/entities/drafts_sse_controller.rb
    - web/test/integration/entities_pane_endpoints_test.rb
  - What changed:
    - Added commandbar controls for **Sort** and **Ownership lens** with view-aware sort labels for picks/selections/grid (`board`, `risk`, `provenance`) plus shared lenses (`all`, `at_risk`, `critical`).
    - Extended `/drafts` URL + Datastar signals to carry `sort`/`lens`, and updated `/drafts/sse/refresh` to patch those signals in the same one-response multi-region SSE update.
    - Extended picks query with provenance/risk rollups (`provenance_trade_count`, `ownership_risk_score`, line counts), plus risk/provenance ordering and lens filtering.
    - Extended selections query with provenance counts + `provenance_risk_score`, plus risk/provenance ordering and lens filtering.
    - Extended grid rows with provenance counts, lens filtering for risk tiers, and team-row ordering by risk/provenance so high-encumbrance teams surface first.
    - Updated results table + sidebar base to expose the active sort/lens context and visible complexity cues (risk/provenance columns/chips) so ranking rationale is legible during scan.
    - Expanded integration coverage for new drafts commandbar controls and SSE signal patching of sort/lens while preserving existing overlay preserve/clear semantics.
  - Why this improves the flow:
    - Drafts now behaves like a triage board: users can immediately route to the riskiest ownership situations instead of manually scanning default order.
    - The same sort/lens grammar works across picks, selections, and grid, which improves predictability while still being view-appropriate.
    - Sidebar quick lists now mirror active ranking context, reducing mismatch between main list order and sidebar wayfinding.
  - Verification:
    - `cd web && bundle exec rails test test/integration/entities_pane_endpoints_test.rb` *(fails in this environment: missing gem `lucide-rails-0.7.3`)*
    - `cd web && ruby -c app/controllers/entities/drafts_controller.rb && ruby -c app/controllers/entities/drafts_sse_controller.rb && ruby -c test/integration/entities_pane_endpoints_test.rb` *(syntax OK)*
    - `ruby -rerb -e "['web/app/views/entities/drafts/index.html.erb','web/app/views/entities/drafts/_results.html.erb','web/app/views/entities/drafts/_rightpanel_base.html.erb'].each { |p| ERB.new(File.read(p)).src }; puts 'ERB OK'"`
  - Rubric (before → after):
    - Scan speed: 4 → 5
    - Information hierarchy: 4 → 5
    - Interaction predictability: 5 → 5
    - Density/readability: 4 → 4
    - Navigation/pivots: 5 → 5
  - Follow-up tasks discovered:
    - Add per-row “why matched lens” emphasis (e.g., highlight critical trigger type: forfeited vs conditional vs provenance depth) for faster trust in filtered states.
    - Consider a dedicated grid sidebar quick module for top-risk teams/cells to reduce main-table horizontal scan when using `risk`/`provenance` sort.
  - Guardrails:
    - Do not modify Salary Book files.

- [ ] [P1] [INDEX] /transactions — find transaction rows by player/team intent without losing feed context
  - Problem: Feed filtering is type/date/team-heavy but lacks fast intent search for specific player or description patterns.
  - Hypothesis: A query-first transaction flow will cut scan time for targeted audits.
  - Scope (files):
    - web/app/views/entities/transactions/index.html.erb
    - web/app/views/entities/transactions/_results.html.erb
    - web/app/controllers/entities/transactions_controller.rb
    - web/app/controllers/entities/transactions_sse_controller.rb
    - web/test/integration/entities_pane_endpoints_test.rb
  - Acceptance criteria:
    - Commandbar includes a search input (player, transaction id, description/team text).
    - Query is URL-backed and reflected in Datastar signals during refresh.
    - Query + lens changes keep one SSE response and preserve selected overlay when row remains visible.
    - Row-level pivots (player/team/trade/transaction) remain dense and unobscured.
  - Rubric (before → target):
    - Scan speed: 4 → 5
    - Information hierarchy: 4 → 4
    - Interaction predictability: 5 → 5
    - Density/readability: 4 → 4
    - Navigation/pivots: 5 → 5
  - Guardrails:
    - Do not modify Salary Book files.

- [ ] [P1] [INDEX] /trades — add composition archetype lenses on top of complexity baseline
  - Problem: Complexity sorting/lensing is now in place, but users still can’t quickly isolate by asset-composition intent.
  - Hypothesis: Asset-type composition knobs will complete the “what kind of deal is this?” triage loop.
  - Scope (files):
    - web/app/views/entities/trades/index.html.erb
    - web/app/views/entities/trades/_results.html.erb
    - web/app/views/entities/trades/_rightpanel_base.html.erb
    - web/app/controllers/entities/trades_controller.rb
    - web/app/controllers/entities/trades_sse_controller.rb
    - web/test/integration/entities_pane_endpoints_test.rb
  - Acceptance criteria:
    - Commandbar exposes composition filters (player-heavy, pick-heavy, cash/TPE-involved or equivalent clear archetypes).
    - Results and quick-deals sidebar use the same composition filter semantics.
    - Filter changes preserve active overlay when visible and clear when no longer in result set.
    - Canonical pivots from overlay (trade/team/transaction) remain one-click obvious.
  - Rubric (before → target):
    - Scan speed: 4 → 5
    - Information hierarchy: 5 → 5
    - Interaction predictability: 5 → 5
    - Density/readability: 4 → 4
    - Navigation/pivots: 5 → 5
  - Guardrails:
    - Do not modify Salary Book files.

- [ ] [P1] [INDEX] /draft-selections — prioritize picks with deepest provenance chains
  - Problem: Selection rows are readable, but there is no direct lens for “most provenance complexity first.”
  - Hypothesis: Provenance-first sorting/lensing will speed anomaly and ownership-history investigations.
  - Scope (files):
    - web/app/views/entities/draft_selections/index.html.erb
    - web/app/views/entities/draft_selections/_workspace_main.html.erb
    - web/app/views/entities/draft_selections/_rightpanel_base.html.erb
    - web/app/controllers/entities/draft_selections_controller.rb
    - web/app/controllers/entities/draft_selections_sse_controller.rb
    - web/test/integration/entities_draft_selections_index_test.rb
  - Acceptance criteria:
    - Commandbar includes provenance-oriented sort/lens controls (e.g., with trade, highest provenance count).
    - Rows visibly surface provenance ranking without adding card-like whitespace.
    - Knob changes keep overlay preservation semantics in one SSE response.
    - Sidebar quick selections reflect active sort/lens ordering.
  - Rubric (before → target):
    - Scan speed: 4 → 5
    - Information hierarchy: 4 → 5
    - Interaction predictability: 5 → 5
    - Density/readability: 4 → 4
    - Navigation/pivots: 5 → 5
  - Guardrails:
    - Do not modify Salary Book files.

- [ ] [P2] [TOOL] /tools/team-summary — make table-header sorting fully patch-driven without full-page jumps
  - Problem: Header sort links still behave like navigation links, breaking compare/selection continuity.
  - Hypothesis: Routing header sorts through the existing refresh SSE flow will keep users in continuous workbench mode.
  - Scope (files):
    - web/app/views/tools/team_summary/_workspace_main.html.erb
    - web/app/views/tools/team_summary/show.html.erb
    - web/app/controllers/tools/team_summary_controller.rb
    - web/app/javascript/tools/team_summary.js
    - web/test/integration/tools_team_summary_test.rb
  - Acceptance criteria:
    - Clicking Cap Space / Tax Overage headers triggers SSE refresh instead of full-page reload.
    - Compare strip, row highlights, and rightpanel overlay remain synchronized after sort changes.
    - URL state still reflects active sort for shareability.
    - No reduction in row density or sticky-column behavior.
  - Rubric (before → target):
    - Scan speed: 5 → 5
    - Information hierarchy: 5 → 5
    - Interaction predictability: 4 → 5
    - Density/readability: 5 → 5
    - Navigation/pivots: 5 → 5
  - Guardrails:
    - Do not modify Salary Book files.

- [ ] [P2] [TOOL] /tools/system-values — add rightpanel drill-ins and SSE state transitions for baseline analysis
  - Problem: System Values requires full-page apply loops and has no sidebar drill-in for metric provenance/context.
  - Hypothesis: Converging to workbench shell + SSE updates + metric drill-ins will improve comparison speed and wayfinding.
  - Scope (files):
    - web/app/views/tools/system_values/show.html.erb
    - web/app/views/tools/system_values/_league_system_values_table.html.erb
    - web/app/views/tools/system_values/_league_tax_rates_table.html.erb
    - web/app/controllers/tools/system_values_controller.rb
    - web/test/integration/tools_system_values_test.rb
  - Acceptance criteria:
    - Surface includes explicit rightpanel base/overlay targets for metric context drill-ins.
    - Apply/baseline/range changes patch relevant regions in one response path (SSE for multi-region updates).
    - Clicking a metric row opens rightpanel overlay with selected-vs-baseline explanation and canonical pivots where applicable.
    - Existing dense table grammar is preserved (no cardification).
  - Rubric (before → target):
    - Scan speed: 3 → 5
    - Information hierarchy: 4 → 5
    - Interaction predictability: 3 → 5
    - Density/readability: 4 → 4
    - Navigation/pivots: 3 → 4
  - Guardrails:
    - Do not modify Salary Book files.

- [ ] [P2] [TOOL] /tools/two-way-utility — compare two at-risk players without leaving the risk board
  - Problem: Users can inspect one player deeply, but can’t hold two candidates side-by-side while scanning risk queues.
  - Hypothesis: Inline pin-to-compare for players will accelerate roster-decision workflows.
  - Scope (files):
    - web/app/views/tools/two_way_utility/_player_row.html.erb
    - web/app/views/tools/two_way_utility/_rightpanel_base.html.erb
    - web/app/views/tools/two_way_utility/show.html.erb
    - web/app/controllers/tools/two_way_utility_controller.rb
    - web/test/integration/tools_two_way_utility_test.rb
  - Acceptance criteria:
    - Player rows expose Pin A / Pin B interactions in dense-row format.
    - Sidebar base shows compare board with key deltas (remaining games, used %, signing context).
    - Compare updates preserve active player overlay when still visible and avoid full-page reloads.
    - URL and signals capture compare state for shareable lenses.
  - Rubric (before → target):
    - Scan speed: 4 → 5
    - Information hierarchy: 4 → 5
    - Interaction predictability: 4 → 5
    - Density/readability: 5 → 5
    - Navigation/pivots: 5 → 5
  - Guardrails:
    - Do not modify Salary Book files.

- [ ] [P3] [INDEX] /agencies — shortlist agencies by operating posture (active/inactive + live book risk) in one pass
  - Problem: Agency activity lens is coarse; users can’t quickly isolate inactive-but-still-impactful books or high-risk agency posture.
  - Hypothesis: Purpose-built posture knobs and row cues will improve “who needs attention now?” scanning.
  - Scope (files):
    - web/app/views/entities/agencies/index.html.erb
    - web/app/views/entities/agencies/_workspace_main.html.erb
    - web/app/views/entities/agencies/_rightpanel_base.html.erb
    - web/app/controllers/entities/agencies_controller.rb
    - web/app/controllers/entities/agencies_sse_controller.rb
    - web/test/integration/entities_agencies_index_test.rb
  - Acceptance criteria:
    - Commandbar adds a posture lens beyond active/inactive (e.g., inactive with live book / restrictions present).
    - Row secondary lines make posture state immediately scannable without expanding overlays.
    - Lens changes preserve selected overlay where valid, in one SSE response.
    - Canonical pivots to agency, agents, and clients remain explicit.
  - Rubric (before → target):
    - Scan speed: 4 → 5
    - Information hierarchy: 4 → 5
    - Interaction predictability: 4 → 5
    - Density/readability: 4 → 4
    - Navigation/pivots: 4 → 5
  - Guardrails:
    - Do not modify Salary Book files.
