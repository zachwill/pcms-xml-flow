<% content_for :title, "Players" %>

<%# Avoid N+1 slug lookups %>
<% prefetch_canonical_slugs(entity_type: "player", entity_ids: @players.map { |p| p["player_id"] }) %>
<% prefetch_canonical_slugs(entity_type: "agent", entity_ids: @players.map { |p| p["agent_id"] }) %>
<% prefetch_canonical_slugs(entity_type: "team", entity_ids: @players.map { |p| p["team_id"] }) %>

<div id="players-index" class="h-screen w-screen flex flex-col overflow-hidden bg-background">
  <%= render partial: "entities/shared/commandbar", locals: {
    active_entity_scope: "players"
  } %>

  <%# Main content area — scrollable master list %>
  <main id="maincanvas" class="flex-1 min-w-0 overflow-y-auto overflow-x-hidden bg-background relative">
    <div class="px-4 py-4">
      <% if @query.blank? && @players.any? %>
        <div class="mb-4">
          <p class="text-sm text-muted-foreground">
            Search for a player by name or <code class="text-xs bg-muted px-1 py-0.5 rounded">player_id</code>.
          </p>
        </div>
      <% end %>

      <% if @players.empty? %>
        <div class="p-6 rounded-lg bg-muted/30 border border-border/50 text-sm text-muted-foreground italic text-center">
          No players found.
        </div>
      <% else %>
        <%# Player list container %>
        <div class="rounded-lg border border-border overflow-hidden">
          <%# Sticky header %>
          <div class="sticky top-0 z-10 bg-muted/70 backdrop-blur-sm border-b border-border">
            <div class="flex items-center px-4 h-8 text-[10px] uppercase tracking-wide text-muted-foreground/90 font-medium">
              <div class="w-52 shrink-0">Player</div>
              <div class="w-32 shrink-0">Team</div>
              <div class="w-40 shrink-0">Agent</div>
              <div class="w-24 shrink-0 text-right font-mono">Cap 2025</div>
            </div>
          </div>

          <%# Player rows %>
          <div class="divide-y divide-border/50">
            <% @players.each do |p| %>
              <% player_href_val = player_href(p["player_id"]) %>
              <% is_two_way = p["is_two_way"] %>
              <% yos = p["years_of_service"].present? ? "#{p['years_of_service'].to_i} YOS" : nil %>

              <div
                class="group cursor-pointer transition-colors duration-75 hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10"
                role="button"
                tabindex="0"
                data-on:click="window.location.href='<%= player_href_val %>'"
                data-on:keydown="if (evt.key === 'Enter' || evt.key === ' ') { evt.preventDefault(); window.location.href='<%= player_href_val %>' }"
              >
                <div class="flex items-center px-4 min-h-[48px]">
                  <%# Player column — double-row grid %>
                  <div class="w-52 shrink-0">
                    <div class="grid grid-cols-[36px_1fr] grid-rows-[24px_16px]">
                      <div class="row-span-2 flex items-center justify-start">
                        <div class="w-8 h-8 rounded border border-border bg-background overflow-hidden flex items-center justify-center">
                          <img
                            src="<%= player_headshot_url(p['player_id']) %>"
                            alt="<%= p['player_name'] %>"
                            class="w-full h-full object-cover object-top bg-muted"
                            loading="lazy"
                            decoding="async"
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                          />
                          <span class="hidden text-[9px] font-semibold text-muted-foreground">NBA</span>
                        </div>
                      </div>

                      <div class="h-[24px] flex items-end min-w-0 pl-2">
                        <a href="<%= player_href_val %>" class="truncate font-medium text-[14px] group-hover:text-primary transition-colors" onclick="event.stopPropagation()"><%= p["player_name"] %></a>
                      </div>

                      <div class="h-[16px] -mt-px flex items-start gap-2 min-w-0 pl-2 leading-none text-[10px] text-muted-foreground/80 tabular-nums">
                        <span>id: <%= p["player_id"] %></span>
                        <% if yos %><span><%= yos %></span><% end %>
                        <% if is_two_way %><span class="text-blue-600 dark:text-blue-400">2W</span><% end %>
                      </div>
                    </div>
                  </div>

                  <%# Team column — double-row grid %>
                  <div class="w-32 shrink-0">
                    <% if p["team_code"].present? %>
                      <div class="grid grid-cols-[28px_1fr] grid-rows-[24px_16px]">
                        <div class="row-span-2 flex items-center justify-start">
                          <div class="w-6 h-6 rounded border border-border bg-background overflow-hidden flex items-center justify-center">
                            <% if p["team_id"].present? %>
                              <img
                                src="<%= team_logo_url(p['team_id']) %>"
                                alt="<%= p['team_code'] %>"
                                class="w-full h-full object-contain"
                                loading="lazy"
                                decoding="async"
                                onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                              />
                              <span class="hidden text-[9px] font-mono text-muted-foreground"><%= p["team_code"] %></span>
                            <% else %>
                              <span class="text-[9px] font-mono text-muted-foreground"><%= p["team_code"] %></span>
                            <% end %>
                          </div>
                        </div>

                        <div class="h-[24px] flex items-end min-w-0 pl-1">
                          <a href="<%= team_href(team_code: p['team_code']) %>" class="font-medium text-[13px] hover:underline" onclick="event.stopPropagation()"><%= p["team_code"] %></a>
                        </div>

                        <div class="h-[16px] -mt-px flex items-start min-w-0 pl-1 leading-none text-[10px] text-muted-foreground/80 truncate"><%= p["team_name"].presence || "—" %></div>
                      </div>
                    <% else %>
                      <span class="text-sm text-muted-foreground/50">—</span>
                    <% end %>
                  </div>

                  <%# Agent column %>
                  <div class="w-40 shrink-0">
                    <% if p["agent_id"].present? && p["agent_name"].present? %>
                      <div class="grid grid-rows-[24px_16px]">
                        <div class="h-[24px] flex items-end min-w-0">
                          <a href="<%= agent_href(p['agent_id']) %>" class="text-[13px] text-muted-foreground hover:text-foreground hover:underline truncate" onclick="event.stopPropagation()"><%= p["agent_name"] %></a>
                        </div>
                        <div class="h-[16px] -mt-px flex items-start min-w-0 leading-none text-[10px] text-muted-foreground/60 truncate font-mono tabular-nums">id: <%= p["agent_id"] %></div>
                      </div>
                    <% elsif p["agent_name"].present? %>
                      <span class="text-[13px] text-muted-foreground truncate"><%= p["agent_name"] %></span>
                    <% else %>
                      <span class="text-sm text-muted-foreground/50">—</span>
                    <% end %>
                  </div>

                  <%# Cap column %>
                  <div class="w-24 shrink-0 flex items-center justify-end">
                    <span class="font-mono tabular-nums text-sm"><%= p["cap_2025"].present? ? format_salary(p["cap_2025"]) : "—" %></span>
                  </div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </main>
</div>
