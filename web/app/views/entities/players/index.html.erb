<% content_for :title, "Players" %>

<%# Avoid N+1 slug lookups in the results table %>
<% prefetch_canonical_slugs(entity_type: "player", entity_ids: @players.map { |p| p["player_id"] }) %>
<% prefetch_canonical_slugs(entity_type: "agent", entity_ids: @players.map { |p| p["agent_id"] }) %>

<div id="entity-directory" class="min-h-screen w-full bg-background">
  <%= render partial: "entities/shared/commandbar", locals: {
    active_entity_scope: "players"
  } %>

  <main class="max-w-5xl mx-auto px-4 py-6 space-y-6">
    <% if @query.blank? %>
      <p class="text-sm text-muted-foreground">
        Tip: try <code>lebron</code>, <code>curry</code>, or a numeric <code>player_id</code>.
      </p>
    <% end %>

    <section class="space-y-3">
      <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Results</h2>

      <% if @players.empty? %>
        <div class="p-4 rounded-lg bg-muted/30 border border-border/50 text-sm text-muted-foreground italic">
          No players found.
        </div>
      <% else %>
        <div class="overflow-x-auto rounded-lg border border-border">
          <table class="entity-table min-w-full text-xs">
            <thead class="bg-muted/40 text-[10px] uppercase tracking-wide text-muted-foreground/90">
              <tr>
                <th class="text-left px-3 py-2 font-medium">Player</th>
                <th class="text-left px-3 py-2 font-medium">Team</th>
                <th class="text-left px-3 py-2 font-medium">Agent</th>
                <th class="text-right px-3 py-2 font-medium">Cap 2025</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-border">
              <% @players.each do |p| %>
                <tr class="group hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 transition-colors duration-75">
                  <td class="px-3 py-2">
                    <div class="grid grid-cols-[32px_1fr] grid-rows-[20px_14px] min-h-[34px]">
                      <div class="row-span-2 flex items-center justify-start">
                        <div class="w-7 h-7 rounded border border-border bg-background overflow-hidden flex items-center justify-center">
                          <img
                            src="<%= player_headshot_url(p['player_id']) %>"
                            alt="<%= p['player_name'] %>"
                            class="w-full h-full object-cover object-top bg-muted"
                            loading="lazy"
                            decoding="async"
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                          />
                          <span class="hidden text-[9px] font-semibold text-muted-foreground">NBA</span>
                        </div>
                      </div>

                      <div class="h-[20px] flex items-end min-w-0 pl-1 pr-2 text-[13px]">
                        <a href="<%= player_href(p['player_id']) %>" class="font-medium truncate hover:underline group-hover:text-primary"><%= p["player_name"] %></a>
                      </div>

                      <div class="h-[14px] -mt-px flex items-start gap-2 min-w-0 pl-1 pr-2 text-[10px] text-muted-foreground/80 tabular-nums leading-none">
                        <span>id: <%= p["player_id"] %></span>
                        <% if p["years_of_service"].present? %>
                          <span><%= p["years_of_service"].to_i %> YOS</span>
                        <% end %>
                        <% if p["is_two_way"] %>
                          <span class="text-blue-600 dark:text-blue-400">2W</span>
                        <% end %>
                      </div>
                    </div>
                  </td>

                  <td class="px-3 py-2">
                    <% if p["team_code"].present? %>
                      <div class="grid grid-cols-[24px_1fr] grid-rows-[20px_14px] min-h-[34px]">
                        <div class="row-span-2 flex items-center justify-start">
                          <div class="w-5 h-5 rounded border border-border bg-background overflow-hidden flex items-center justify-center">
                            <% if p["team_id"].present? %>
                              <img
                                src="<%= team_logo_url(p['team_id']) %>"
                                alt="<%= p['team_code'] %>"
                                class="w-full h-full object-contain"
                                loading="lazy"
                                decoding="async"
                                onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                              />
                              <span class="hidden text-[9px] font-mono text-muted-foreground"><%= p["team_code"] %></span>
                            <% else %>
                              <span class="text-[9px] font-mono text-muted-foreground"><%= p["team_code"] %></span>
                            <% end %>
                          </div>
                        </div>

                        <div class="h-[20px] flex items-end min-w-0 pl-1 pr-2 text-[13px]">
                          <a href="<%= team_href(team_code: p['team_code']) %>" class="font-medium truncate hover:underline"><%= p["team_code"] %></a>
                        </div>

                        <div class="h-[14px] -mt-px flex items-start min-w-0 pl-1 pr-2 text-[10px] text-muted-foreground/80 leading-none truncate"><%= p["team_name"].presence || "—" %></div>
                      </div>
                    <% else %>
                      <span class="text-muted-foreground">—</span>
                    <% end %>
                  </td>

                  <td class="px-3 py-2">
                    <div class="entity-cell-two-line">
                      <div class="entity-cell-primary">
                        <% if p["agent_id"].present? && p["agent_name"].present? %>
                          <a href="<%= agent_href(p['agent_id']) %>" class="font-medium truncate hover:underline"><%= p["agent_name"] %></a>
                        <% elsif p["agent_name"].present? %>
                          <span class="font-medium truncate"><%= p["agent_name"] %></span>
                        <% else %>
                          <span class="text-muted-foreground">—</span>
                        <% end %>
                      </div>
                      <div class="entity-cell-secondary">agent_id: <%= p["agent_id"] || "—" %></div>
                    </div>
                  </td>

                  <td class="px-3 py-2 text-right font-mono tabular-nums">
                    <%= p["cap_2025"].present? ? format_salary(p["cap_2025"]) : "—" %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>

        <p class="text-xs text-muted-foreground">
          Links prefer canonical slugs when known; otherwise they use the numeric fallback (<code>/players/:id</code>) which creates/promotes a canonical slug on demand.
        </p>
      <% end %>
    </section>
  </main>
</div>
