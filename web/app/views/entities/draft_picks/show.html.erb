<% group = @draft_pick_group %>
<% team_code = group["team_code"].to_s %>
<% year = group["draft_year"] %>
<% round = group["draft_round"] %>

<% content_for :title, "#{team_code} #{year} R#{round} Draft Picks" %>

<% norm_codes = ->(val) {
  return [] if val.nil?
  return val.map { |v| v.to_s.strip.upcase }.reject(&:blank?) if val.is_a?(Array)

  s = val.to_s
  return [] if s.blank? || s == "{}"

  s.gsub(/[{}\"]/ , "")
    .split(",")
    .map { |v| v.to_s.strip.upcase }
    .reject(&:blank?)
} %>

<% norm_ints = ->(val) {
  return [] if val.nil?
  if val.is_a?(Array)
    return val.filter_map do |v|
      begin
        Integer(v)
      rescue ArgumentError, TypeError
        nil
      end
    end
  end

  s = val.to_s
  return [] if s.blank? || s == "{}"

  s.gsub(/[{}\"]/ , "")
    .split(",")
    .filter_map do |v|
      begin
        Integer(v.to_s.strip)
      rescue ArgumentError, TypeError
        nil
      end
    end
} %>

<% conditional_assets = @assets.select { |a| a["is_conditional"] } %>
<% swap_assets = @assets.select { |a| a["is_swap"] } %>
<% original_owner_code = @trade_chain_rows.map { |r| r["original_team_code"] }.find(&:present?) || team_code %>
<% original_owner_team = @teams_by_code[original_owner_code] || {} %>

<div id="entity-directory" class="min-h-screen w-full bg-background">
  <%= render partial: "entities/shared/commandbar", locals: {
    active_entity_scope: "drafts"
  } %>

  <main class="px-4 pb-8 space-y-6" data-entity-workspace>
    <%= render partial: "entities/shared/workspace_header", locals: {
      breadcrumbs: [["Teams", "/teams"], [team_code, team_href(team_code: team_code)], ["#{year} R#{round} draft pick", nil]],
      title: "#{team_code} — #{year} Round #{round}",
      subtitle: ((@team.present? && @team["team_name"].present?) ? "#{@team['team_name']} · Source: pcms.vw_draft_pick_assets" : "Source: pcms.vw_draft_pick_assets"),
      right_links: [["Open in Salary Book", "/tools/salary-book?team=#{team_code}##{team_code}"], ["Draft selections", "/draft-selections"]]
    } %>

  <div class="lg:flex lg:gap-8">
    <%= render partial: "entities/shared/local_nav", locals: {
      sections: [
        ["vitals", "Vitals"],
        ["protections", "Protection details"],
        ["trade-chain", "Trade chain"],
        ["swap-rights", "Swap rights"]
      ]
    } %>

    <div class="min-w-0 flex-1 space-y-6">
      <section id="vitals" class="scroll-mt-24 space-y-3">
        <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Vitals</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div class="rounded-lg border border-border bg-background p-3">
            <div class="text-xs text-muted-foreground">Year</div>
            <div class="mt-1 text-lg font-semibold font-mono tabular-nums"><%= year %></div>
          </div>
          <div class="rounded-lg border border-border bg-background p-3">
            <div class="text-xs text-muted-foreground">Round</div>
            <div class="mt-1 text-lg font-semibold font-mono tabular-nums"><%= round %></div>
          </div>
          <div class="rounded-lg border border-border bg-background p-3">
            <div class="text-xs text-muted-foreground">Current owner</div>
            <div class="mt-1 text-sm font-medium">
              <a href="<%= team_href(team_code: team_code, team_id: @team&.dig('team_id')) %>" class="hover:underline"><%= team_code %></a>
            </div>
          </div>
          <div class="rounded-lg border border-border bg-background p-3">
            <div class="text-xs text-muted-foreground">Original owner</div>
            <div class="mt-1 text-sm font-medium">
              <a href="<%= team_href(team_code: original_owner_code, team_id: original_owner_team['team_id']) %>" class="hover:underline"><%= original_owner_code %></a>
            </div>
          </div>
        </div>
      </section>

      <section id="protections" class="scroll-mt-24 space-y-3">
        <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Protection details</h2>

        <% if @assets.empty? %>
          <div class="p-4 rounded-lg bg-muted/30 border border-border/50 text-sm text-muted-foreground italic">No asset rows found.</div>
        <% else %>
          <div class="overflow-x-auto rounded-lg border border-border">
            <table class="entity-table min-w-full text-xs">
              <thead class="bg-muted/40 text-[10px] uppercase tracking-wide text-muted-foreground/90">
                <tr>
                  <th class="text-left px-3 py-2 font-medium">Slot</th>
                  <th class="text-left px-3 py-2 font-medium">Type</th>
                  <th class="text-left px-3 py-2 font-medium">Display</th>
                  <th class="text-left px-3 py-2 font-medium">Counterparty</th>
                  <th class="text-left px-3 py-2 font-medium">Flags</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-border">
                <% @assets.each do |a| %>
                  <% slot = "#{a['asset_slot']}.#{a['sub_asset_slot']}" %>
                  <tr class="hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 transition-colors duration-75 align-top">
                    <td class="px-3 py-2 font-mono tabular-nums"><%= slot %></td>
                    <td class="px-3 py-2 font-mono"><%= a["asset_type"] %></td>
                    <td class="px-3 py-2"><%= a["display_text"].presence || a["raw_part"] %></td>
                    <td class="px-3 py-2 text-muted-foreground">
                      <% cp = a["counterparty_team_code"].to_s.strip.upcase.presence %>
                      <% if cp.present? %>
                        <a href="<%= team_href(team_code: cp, team_id: @teams_by_code.dig(cp, 'team_id')) %>" class="hover:underline"><%= cp %></a>
                      <% else %>
                        —
                      <% end %>
                    </td>
                    <td class="px-3 py-2 text-muted-foreground">
                      <% flags = [] %>
                      <% flags << "conditional" if a["is_conditional"] %>
                      <% flags << "swap" if a["is_swap"] %>
                      <% flags << "forfeited" if a["is_forfeited"] %>
                      <% flags << "needs review" if a["needs_review"] %>
                      <%= flags.any? ? flags.join(" · ") : "—" %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% end %>

        <% if conditional_assets.any? %>
          <details class="rounded-lg border border-border bg-background p-3" open>
            <summary class="cursor-pointer text-sm font-medium">Conditional notes (<%= conditional_assets.size %>)</summary>
            <div class="mt-3 space-y-2">
              <% conditional_assets.each do |a| %>
                <article class="rounded border border-border/60 p-2 text-sm">
                  <div class="font-medium"><%= a["display_text"].presence || a["raw_part"] %></div>
                  <% if a["endnote_explanation"].present? %>
                    <div class="text-xs text-muted-foreground mt-1"><%= a["endnote_explanation"] %></div>
                  <% end %>
                </article>
              <% end %>
            </div>
          </details>
        <% end %>
      </section>

      <section id="trade-chain" class="scroll-mt-24 space-y-3">
        <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Trade chain</h2>
        <% if @trade_chain_rows.empty? %>
          <div class="p-4 rounded-lg bg-muted/30 border border-border/50 text-sm text-muted-foreground italic">No draft_pick_trades rows found for this team/year/round.</div>
        <% else %>
          <div class="overflow-x-auto rounded-lg border border-border">
            <table class="entity-table min-w-full text-xs">
              <thead class="bg-muted/40 text-[10px] uppercase tracking-wide text-muted-foreground/90">
                <tr>
                  <th class="text-left px-3 py-2 font-medium">Trade</th>
                  <th class="text-left px-3 py-2 font-medium">Date</th>
                  <th class="text-left px-3 py-2 font-medium">From</th>
                  <th class="text-left px-3 py-2 font-medium">To</th>
                  <th class="text-left px-3 py-2 font-medium">Original</th>
                  <th class="text-left px-3 py-2 font-medium">Flags</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-border">
                <% @trade_chain_rows.each do |row| %>
                  <tr class="hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 transition-colors duration-75">
                    <td class="px-3 py-2 font-mono tabular-nums">
                      <% if row["trade_id"].present? %>
                        <a href="<%= trade_href(row['trade_id']) %>" class="hover:underline">#<%= row["trade_id"] %></a>
                      <% else %>
                        —
                      <% end %>
                    </td>
                    <td class="px-3 py-2 text-muted-foreground"><%= row["trade_date"] || "—" %></td>
                    <td class="px-3 py-2 text-muted-foreground"><%= row["from_team_code"] || "—" %></td>
                    <td class="px-3 py-2 text-muted-foreground"><%= row["to_team_code"] || "—" %></td>
                    <td class="px-3 py-2 text-muted-foreground"><%= row["original_team_code"] || "—" %></td>
                    <td class="px-3 py-2 text-muted-foreground">
                      <% flags = [] %>
                      <% flags << "swap" if row["is_swap"] %>
                      <% flags << "future" if row["is_future"] %>
                      <% flags << "conditional" if row["is_conditional"] %>
                      <% flags << row["conditional_type_lk"] if row["conditional_type_lk"].present? %>
                      <%= flags.any? ? flags.join(" · ") : "—" %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% end %>
      </section>

      <section id="swap-rights" class="scroll-mt-24 space-y-3">
        <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Swap rights</h2>
        <% if swap_assets.empty? %>
          <div class="p-4 rounded-lg bg-muted/30 border border-border/50 text-sm text-muted-foreground italic">No swap rights rows for this pick context.</div>
        <% else %>
          <div class="space-y-2">
            <% swap_assets.each do |a| %>
              <% counterparty = a["counterparty_team_code"].to_s.strip.upcase.presence %>
              <article class="rounded-lg border border-border bg-background p-3">
                <div class="text-sm font-medium">
                  <%= a["display_text"].presence || a["raw_part"] %>
                </div>
                <div class="mt-1 text-xs text-muted-foreground">
                  <% if counterparty.present? %>
                    Counterparty: <a href="<%= team_href(team_code: counterparty, team_id: @teams_by_code.dig(counterparty, 'team_id')) %>" class="hover:underline"><%= counterparty %></a>
                  <% else %>
                    Counterparty: —
                  <% end %>
                  <% via = norm_codes.call(a["via_team_codes"]) %>
                  <% if via.any? %>
                    · via <%= via.join(" → ") %>
                  <% end %>
                </div>
              </article>
            <% end %>
          </div>
        <% end %>

        <% if @endnotes.any? %>
          <details class="rounded-lg border border-border bg-background p-3" open>
            <summary class="cursor-pointer text-sm font-medium">Referenced endnotes (<%= @endnotes.size %>)</summary>
            <div class="mt-3 space-y-2">
              <% @endnotes.each do |n| %>
                <article id="endnote-<%= n['endnote_id'] %>" class="rounded border border-border/60 p-2">
                  <div class="text-sm font-mono">#<%= n["endnote_id"] %></div>
                  <div class="text-xs text-muted-foreground mt-1">
                    <% if n["trade_id"].present? %>
                      Trade <a href="<%= trade_href(n['trade_id']) %>" class="hover:underline">#<%= n["trade_id"] %></a>
                    <% end %>
                    <% if n["trade_date"].present? %>
                      · <%= n["trade_date"] %>
                    <% end %>
                  </div>
                  <div class="mt-2 text-sm whitespace-pre-line"><%= n["explanation"].presence || n["conveyance_text"].presence || "—" %></div>
                </article>
              <% end %>
            </div>
          </details>
        <% end %>
      </section>
    </div>
  </div>
  </main>
</div>
