<% if @sidebar_summary.present? %>
  <% summary = @sidebar_summary %>
  <% cap_horizon = summary[:cap_horizon].to_i %>
  <% cap_horizon_label = summary[:cap_horizon_label].presence || format_year_label(cap_horizon) %>

  <div id="rightpanel-base" class="space-y-4">
    <div class="rounded-lg border border-border bg-background p-3 space-y-3">
      <div>
        <div class="text-[10px] uppercase tracking-wide text-muted-foreground/80">Workspace snapshot</div>
        <div class="text-sm font-semibold text-foreground">
          Players
          <span class="text-muted-foreground font-medium">· <%= summary[:row_count].to_i %> rows</span>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-1.5">
        <%= render partial: "tools/salary_book/kpi_cell", locals: {
          label: "Rows",
          value: summary[:row_count].to_i.to_s,
          class_name: "w-full"
        } %>

        <%= render partial: "tools/salary_book/kpi_cell", locals: {
          label: "Teams",
          value: summary[:team_count].to_i.to_s,
          class_name: "w-full"
        } %>

        <%= render partial: "tools/salary_book/kpi_cell", locals: {
          label: "2W",
          value: summary[:two_way_count].to_i.to_s,
          class_name: "w-full"
        } %>

        <%= render partial: "tools/salary_book/kpi_cell", locals: {
          label: "Constrained",
          value: summary[:constrained_count].to_i.to_s,
          class_name: "w-full"
        } %>
      </div>

      <div class="grid grid-cols-2 gap-1.5">
        <%= render partial: "tools/salary_book/kpi_cell", locals: {
          label: "No-Trade",
          value: summary[:no_trade_count].to_i.to_s,
          class_name: "w-full"
        } %>

        <%= render partial: "tools/salary_book/kpi_cell", locals: {
          label: "Cap #{cap_horizon_label}",
          value: format_compact_currency(summary[:total_cap]),
          value_class_name: "text-[11px]",
          class_name: "w-full"
        } %>
      </div>

      <% if Array(summary[:filters]).any? %>
        <div class="pt-1 flex flex-wrap gap-1">
          <% Array(summary[:filters]).each do |label| %>
            <span class="entity-chip entity-chip--muted"><%= label %></span>
          <% end %>
        </div>
      <% end %>
    </div>

    <div class="rounded-lg border border-border bg-background">
      <div class="px-3 py-2 border-b border-border">
        <div class="text-[10px] uppercase tracking-wide text-muted-foreground/80">Top cap hits · <%= cap_horizon_label %></div>
        <% if summary[:constraint_lens].to_s != "all" %>
          <div class="text-[10px] text-muted-foreground/70"><%= summary[:constraint_lens_label] %></div>
        <% end %>
      </div>

      <% top_rows = Array(summary[:top_rows]) %>
      <% if top_rows.empty? %>
        <div class="p-3 text-sm text-muted-foreground italic">No rows.</div>
      <% else %>
        <div class="divide-y divide-border">
          <% top_rows.each do |row| %>
            <% player_id = row["player_id"] %>
            <% open_expr = "$selectedplayerid = '#{player_id}'; $overlaytype = 'player'; @get('/players/sidebar/#{player_id}')" %>

            <% row_tags = [] %>
            <% row_tags << "Lock" if row["has_lock_now"] %>
            <% row_tags << "Option" if row["has_future_option"] %>
            <% row_tags << "NG" if row["has_non_guaranteed"] %>
            <% row_tags << "TK" if row["is_trade_bonus"] %>
            <% row_tags << "Exp" if row["expires_after_horizon"] %>

            <button
              type="button"
              class="cursor-pointer w-full px-3 py-2 text-left hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 transition-colors duration-75"
              data-class="{ 'bg-yellow-100/80 dark:bg-yellow-900/20': $selectedplayerid === '<%= player_id %>' }"
              data-on:click="<%= open_expr %>"
            >
              <div class="entity-cell-two-line">
                <div class="entity-cell-primary justify-between gap-2">
                  <a href="/players/<%= player_id %>" class="truncate font-medium hover:underline" onclick="event.stopPropagation()"><%= row["player_name"] %></a>
                  <span class="font-mono tabular-nums text-[11px] shrink-0"><%= row["cap_lens_value"].present? ? format_compact_currency(row["cap_lens_value"]) : "—" %></span>
                </div>
                <div class="entity-cell-secondary justify-between gap-2">
                  <span class="truncate"><%= row["team_code"].presence || "Free Agent" %> · <%= row_tags.presence&.join(" · ") || "No active constraints" %></span>
                  <% if row["is_two_way"] %>
                    <span class="entity-chip entity-chip--muted">2W</span>
                  <% end %>
                </div>
              </div>
            </button>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
<% elsif @player_id.present? %>
  <div id="rightpanel-base" class="space-y-4">
    <%= render partial: "entities/shared/known_slugs", locals: {
      entity_type: "player",
      entity_id: @player_id,
      path_prefix: "players"
    } %>
  </div>
<% else %>
  <div id="rightpanel-base" class="space-y-4">
    <div class="p-4 rounded-lg border border-border bg-muted/20 text-sm text-muted-foreground">
      Select a player row to inspect snapshot details.
    </div>
  </div>
<% end %>
