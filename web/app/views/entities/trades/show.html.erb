<% tr = @trade %>
<% content_for :title, "Trade ##{tr['trade_id']}" %>

<% prefetch_canonical_slugs(entity_type: "player", entity_ids: @player_details.map { |r| r["player_id"] } + @transactions.map { |r| r["player_id"] }) %>
<% prefetch_canonical_slugs(entity_type: "team", entity_ids: @trade_teams.map { |r| r["team_id"] } + @player_details.map { |r| r["team_id"] } + @trade_group_rows.map { |r| r["team_id"] } + @trade_group_exception_rows.map { |r| r["team_id"] }) %>
<% available_trade_exception_ids = @trade_group_exception_rows.map { |r| r["team_exception_id"].to_i } %>

<main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
  <%= render partial: "entities/shared/entity_header", locals: {
    title: "Trade ##{tr['trade_id']}",
    subtitle: [tr['trade_date'], tr['record_status_lk']].compact.join(' · '),
    breadcrumbs: [["Trades", nil], ["##{tr['trade_id']}", nil]],
    search_scope: "players",
    search_query: "",
    search_placeholder: "Search players/teams/agents/agencies…",
    salary_book_label: "Open Salary Book",
    right_links: [["Draft selections", "/draft-selections"]],
    search_enabled: false
  } %>

  <% if tr["trade_comments"].present? %>
    <div class="p-3 rounded-lg border border-border bg-background text-sm"><%= tr["trade_comments"] %></div>
  <% end %>

  <section class="space-y-3">
    <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Teams in trade</h2>

    <% if @trade_teams.empty? %>
      <div class="p-4 rounded-lg bg-muted/30 border border-border/50 text-sm text-muted-foreground italic">No trade_teams rows found.</div>
    <% else %>
      <div class="overflow-x-auto rounded-lg border border-border">
        <table class="entity-table min-w-full text-xs">
          <thead class="bg-muted/40 text-[10px] uppercase tracking-wide text-muted-foreground/90">
            <tr>
              <th class="text-left px-3 py-2 font-medium">Team</th>
              <th class="text-right px-3 py-2 font-medium">Salary change</th>
              <th class="text-right px-3 py-2 font-medium">Cash in / out</th>
              <th class="text-right px-3 py-2 font-medium">Players</th>
              <th class="text-right px-3 py-2 font-medium">Picks</th>
              <th class="text-right px-3 py-2 font-medium">TPE</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-border">
            <% @trade_teams.each do |row| %>
              <tr class="hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 transition-colors duration-75">
                <td class="px-3 py-2">
                  <% if row["team_code"].present? %>
                    <a href="<%= safe_team_href(team_code: row['team_code'], team_id: row['team_id']) %>" class="font-medium hover:underline"><%= row["team_code"] %></a>
                    <% if row["team_name"].present? %>
                      <div class="text-xs text-muted-foreground"><%= row["team_name"] %></div>
                    <% end %>
                  <% else %>
                    <span class="text-muted-foreground">—</span>
                  <% end %>
                </td>
                <td class="px-3 py-2 text-right font-mono tabular-nums"><%= format_salary(row["team_salary_change"]) %></td>
                <td class="px-3 py-2 text-right font-mono tabular-nums"><%= format_salary(row["total_cash_received"]) %> / <%= format_salary(row["total_cash_sent"]) %></td>
                <td class="px-3 py-2 text-right font-mono tabular-nums"><%= row["player_line_item_count"] || 0 %></td>
                <td class="px-3 py-2 text-right font-mono tabular-nums"><%= row["pick_line_item_count"] || 0 %></td>
                <td class="px-3 py-2 text-right font-mono tabular-nums"><%= row["tpe_line_item_count"] || 0 %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>
  </section>

  <section class="space-y-3">
    <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Trade-group legal structure</h2>

    <% if @trade_group_rows.empty? %>
      <div class="p-4 rounded-lg bg-muted/30 border border-border/50 text-sm text-muted-foreground italic">No trade_groups rows found.</div>
    <% else %>
      <% grouped_trade_groups = @trade_group_rows.group_by { |r| r["trade_group_number"] } %>
      <div class="space-y-3">
        <% grouped_trade_groups.keys.sort.each do |group_number| %>
          <% rows = grouped_trade_groups[group_number] || [] %>
          <div class="rounded-lg border border-border bg-background p-3 space-y-2">
            <div class="text-sm font-medium">Group <span class="font-mono tabular-nums"><%= group_number %></span></div>
            <div class="overflow-x-auto">
              <table class="entity-table min-w-full text-xs">
                <thead class="text-xs text-muted-foreground">
                  <tr>
                    <th class="text-left px-2 py-1">Team</th>
                    <th class="text-left px-2 py-1">Signed method</th>
                    <th class="text-left px-2 py-1">Generated exception</th>
                    <th class="text-left px-2 py-1">Acquired exception</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-border/60">
                  <% rows.each do |r| %>
                    <tr>
                      <td class="px-2 py-1 text-xs">
                        <% if r["team_id"].present? %>
                          <a href="<%= safe_team_href(team_code: r['team_code'], team_id: r['team_id']) %>" class="hover:underline"><%= r["team_code"] || r["team_id"] %></a>
                          <% if r["team_name"].present? %>
                            <div class="text-muted-foreground"><%= r["team_name"] %></div>
                          <% end %>
                        <% else %>
                          <span class="text-muted-foreground">—</span>
                        <% end %>
                      </td>
                      <td class="px-2 py-1 text-xs text-muted-foreground">
                        <% if r["signed_method_lk"].present? %>
                          <span class="font-mono"><%= r["signed_method_lk"] %></span>
                          <% if r["signed_method_label"].present? %>
                            <span> — <%= r["signed_method_label"] %></span>
                          <% end %>
                        <% else %>
                          —
                        <% end %>
                      </td>
                      <td class="px-2 py-1 text-xs text-muted-foreground">
                        <% if r["generated_team_exception_id"].present? %>
                          <% generated_id = r["generated_team_exception_id"].to_i %>
                          <% if available_trade_exception_ids.include?(generated_id) %>
                            <a href="#team-exception-<%= generated_id %>" class="hover:underline font-mono">#<%= r["generated_team_exception_id"] %></a>
                          <% else %>
                            <span class="font-mono">#<%= r["generated_team_exception_id"] %></span>
                          <% end %>
                          <% if r["generated_exception_type_lk"].present? %>
                            <div>
                              <span class="font-mono"><%= r["generated_exception_type_lk"] %></span>
                              <% if r["generated_exception_type_label"].present? %>
                                <span> — <%= r["generated_exception_type_label"] %></span>
                              <% end %>
                            </div>
                          <% end %>
                        <% else %>
                          —
                        <% end %>
                      </td>
                      <td class="px-2 py-1 text-xs text-muted-foreground">
                        <% if r["acquired_team_exception_id"].present? %>
                          <% acquired_id = r["acquired_team_exception_id"].to_i %>
                          <% if available_trade_exception_ids.include?(acquired_id) %>
                            <a href="#team-exception-<%= acquired_id %>" class="hover:underline font-mono">#<%= r["acquired_team_exception_id"] %></a>
                          <% else %>
                            <span class="font-mono">#<%= r["acquired_team_exception_id"] %></span>
                          <% end %>
                          <% if r["acquired_exception_type_lk"].present? %>
                            <div>
                              <span class="font-mono"><%= r["acquired_exception_type_lk"] %></span>
                              <% if r["acquired_exception_type_label"].present? %>
                                <span> — <%= r["acquired_exception_type_label"] %></span>
                              <% end %>
                            </div>
                          <% end %>
                        <% else %>
                          —
                        <% end %>
                      </td>
                    </tr>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>

    <% if @trade_group_exception_rows.any? %>
      <details class="rounded-lg border border-border bg-background p-3">
        <summary class="cursor-pointer text-sm font-medium">Referenced team exceptions (<%= @trade_group_exception_rows.size %>)</summary>
        <div class="mt-3 space-y-2">
          <% @trade_group_exception_rows.each do |ex| %>
            <article id="team-exception-<%= ex['team_exception_id'] %>" class="rounded border border-border/60 p-2">
              <div class="text-sm font-mono">#<%= ex["team_exception_id"] %></div>
              <div class="text-xs text-muted-foreground mt-1">
                <% if ex["team_id"].present? %>
                  <a href="<%= safe_team_href(team_code: ex['team_code'], team_id: ex['team_id']) %>" class="hover:underline"><%= ex["team_code"] || ex["team_id"] %></a>
                <% else %>
                  <span><%= ex["team_code"] || "—" %></span>
                <% end %>
                · year <span class="font-mono"><%= ex["salary_year"] || "—" %></span>
              </div>
              <div class="text-xs text-muted-foreground mt-1">
                type:
                <% if ex["exception_type_lk"].present? %>
                  <span class="font-mono"><%= ex["exception_type_lk"] %></span>
                  <% if ex["exception_type_label"].present? %>
                    <span> — <%= ex["exception_type_label"] %></span>
                  <% end %>
                <% else %>
                  —
                <% end %>
                · remaining <span class="font-mono tabular-nums"><%= format_salary(ex["remaining_amount"]) %></span>
              </div>
            </article>
          <% end %>
        </div>
      </details>
    <% end %>
  </section>

  <section class="space-y-3">
    <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Player line items</h2>

    <% if @player_details.empty? %>
      <div class="p-4 rounded-lg bg-muted/30 border border-border/50 text-sm text-muted-foreground italic">No player line items.</div>
    <% else %>
      <div class="overflow-x-auto rounded-lg border border-border">
        <table class="entity-table min-w-full text-xs">
          <thead class="bg-muted/40 text-[10px] uppercase tracking-wide text-muted-foreground/90">
            <tr>
              <th class="text-left px-3 py-2 font-medium">Team</th>
              <th class="text-left px-3 py-2 font-medium">Direction</th>
              <th class="text-left px-3 py-2 font-medium">Player</th>
              <th class="text-left px-3 py-2 font-medium">Flags</th>
              <th class="text-left px-3 py-2 font-medium">Contract</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-border">
            <% @player_details.each do |row| %>
              <tr class="hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 transition-colors duration-75">
                <td class="px-3 py-2 text-xs">
                  <% if row["team_code"].present? %>
                    <a href="<%= safe_team_href(team_code: row['team_code'], team_id: row['team_id']) %>" class="hover:underline"><%= row["team_code"] %></a>
                  <% else %>
                    <span class="text-muted-foreground">—</span>
                  <% end %>
                </td>
                <td class="px-3 py-2 text-xs text-muted-foreground"><%= row["is_sent"] ? "Sent" : "Received" %></td>
                <td class="px-3 py-2">
                  <% if row["player_id"].present? %>
                    <a href="<%= player_href(row['player_id']) %>" class="font-medium hover:underline"><%= row["player_name"] %></a>
                  <% else %>
                    <span class="text-muted-foreground">—</span>
                  <% end %>
                </td>
                <td class="px-3 py-2 text-xs text-muted-foreground">
                  <% flags = [] %>
                  <% flags << 'S&T' if row['is_sign_and_trade'] %>
                  <% flags << 'Kicker' if row['is_trade_bonus'] %>
                  <% flags << 'NTC' if row['is_no_trade'] %>
                  <% flags << 'Consent' if row['is_player_consent'] %>
                  <% flags << 'Poison' if row['is_poison_pill'] %>
                  <% flags << 'BYC' if row['is_base_year'] %>
                  <%= flags.any? ? flags.join(' · ') : '—' %>
                </td>
                <td class="px-3 py-2 text-xs text-muted-foreground font-mono tabular-nums"><%= [row['contract_id'], row['version_number']].compact.join(' / ').presence || '—' %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>
  </section>

  <section class="space-y-3">
    <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Pick + cash line items</h2>

    <div class="grid grid-cols-1 xl:grid-cols-2 gap-3">
      <div class="rounded-lg border border-border bg-background p-3 space-y-2">
        <div class="text-sm font-medium">Draft pick details</div>
        <% if @pick_details.empty? %>
          <div class="text-sm text-muted-foreground italic">None</div>
        <% else %>
          <div class="overflow-x-auto">
            <table class="entity-table min-w-full text-xs">
              <thead class="text-muted-foreground">
                <tr>
                  <th class="text-left py-1">Team</th>
                  <th class="text-left py-1">Dir</th>
                  <th class="text-left py-1">Pick</th>
                  <th class="text-left py-1">Flags</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-border/60">
                <% @pick_details.each do |row| %>
                  <tr>
                    <td class="py-1 pr-2"><%= row["team_code"] || '—' %></td>
                    <td class="py-1 pr-2"><%= row["is_sent"] ? 'Sent' : 'Recv' %></td>
                    <td class="py-1 pr-2 font-mono"><%= [row['draft_pick_year'], "R#{row['draft_pick_round']}"] .compact.join(' ') %></td>
                    <td class="py-1 text-muted-foreground">
                      <% flags = [] %>
                      <% flags << 'swap' if row['is_draft_pick_swap'] %>
                      <% flags << 'future' if row['is_draft_pick_future'] %>
                      <% flags << 'Y+2' if row['is_draft_year_plus_two'] %>
                      <% flags << row['draft_pick_conditional_lk'] if row['draft_pick_conditional_lk'].present? %>
                      <%= flags.any? ? flags.join(' · ') : '—' %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% end %>
      </div>

      <div class="rounded-lg border border-border bg-background p-3 space-y-2">
        <div class="text-sm font-medium">Cash details</div>
        <% if @cash_details.empty? %>
          <div class="text-sm text-muted-foreground italic">None</div>
        <% else %>
          <div class="overflow-x-auto">
            <table class="entity-table min-w-full text-xs">
              <thead class="text-muted-foreground">
                <tr>
                  <th class="text-left py-1">Team</th>
                  <th class="text-left py-1">Dir</th>
                  <th class="text-right py-1">Cash</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-border/60">
                <% @cash_details.each do |row| %>
                  <tr>
                    <td class="py-1 pr-2"><%= row["team_code"] || '—' %></td>
                    <td class="py-1 pr-2"><%= row["is_sent"] ? 'Sent' : 'Recv' %></td>
                    <td class="py-1 text-right font-mono tabular-nums"><%= format_salary(row["cash_amount"]) %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% end %>
      </div>
    </div>
  </section>

  <% if @draft_pick_trades.any? %>
    <section class="space-y-3">
      <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Draft pick trades rows</h2>

      <div class="overflow-x-auto rounded-lg border border-border">
        <table class="entity-table min-w-full text-xs">
          <thead class="bg-muted/40 text-[10px] uppercase tracking-wide text-muted-foreground/90">
            <tr>
              <th class="text-left px-3 py-2 font-medium">Year/Round</th>
              <th class="text-left px-3 py-2 font-medium">From</th>
              <th class="text-left px-3 py-2 font-medium">To</th>
              <th class="text-left px-3 py-2 font-medium">Original</th>
              <th class="text-left px-3 py-2 font-medium">Flags</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-border">
            <% @draft_pick_trades.each do |row| %>
              <tr class="hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 transition-colors duration-75">
                <td class="px-3 py-2 font-mono tabular-nums"><%= row['draft_year'] %> R<%= row['draft_round'] %></td>
                <td class="px-3 py-2 text-xs"><%= row['from_team_code'] || '—' %></td>
                <td class="px-3 py-2 text-xs"><%= row['to_team_code'] || '—' %></td>
                <td class="px-3 py-2 text-xs"><%= row['original_team_code'] || '—' %></td>
                <td class="px-3 py-2 text-xs text-muted-foreground">
                  <% flags = [] %>
                  <% flags << 'swap' if row['is_swap'] %>
                  <% flags << 'future' if row['is_future'] %>
                  <% flags << 'conditional' if row['is_conditional'] %>
                  <% flags << row['conditional_type_lk'] if row['conditional_type_lk'].present? %>
                  <%= flags.any? ? flags.join(' · ') : '—' %>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </section>
  <% end %>

  <section class="space-y-3">
    <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Transactions in this trade</h2>

    <% if @transactions.empty? %>
      <div class="p-4 rounded-lg bg-muted/30 border border-border/50 text-sm text-muted-foreground italic">No transaction rows linked to this trade.</div>
    <% else %>
      <div class="overflow-x-auto rounded-lg border border-border">
        <table class="entity-table min-w-full text-xs">
          <thead class="bg-muted/40 text-[10px] uppercase tracking-wide text-muted-foreground/90">
            <tr>
              <th class="text-left px-3 py-2 font-medium">Transaction</th>
              <th class="text-left px-3 py-2 font-medium">Date</th>
              <th class="text-left px-3 py-2 font-medium">Player</th>
              <th class="text-left px-3 py-2 font-medium">Route</th>
              <th class="text-left px-3 py-2 font-medium">Type</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-border">
            <% @transactions.each do |row| %>
              <tr class="hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 transition-colors duration-75">
                <td class="px-3 py-2 font-mono tabular-nums">
                  <a href="<%= transaction_href(row['transaction_id']) %>" class="hover:underline">#<%= row["transaction_id"] %></a>
                </td>
                <td class="px-3 py-2 text-xs text-muted-foreground"><%= row["transaction_date"] || '—' %></td>
                <td class="px-3 py-2 text-xs">
                  <% if row["player_id"].present? %>
                    <a href="<%= player_href(row['player_id']) %>" class="hover:underline"><%= row["player_name"] %></a>
                  <% else %>
                    <span class="text-muted-foreground">—</span>
                  <% end %>
                </td>
                <td class="px-3 py-2 text-xs text-muted-foreground"><%= [row['from_team_code'], row['to_team_code']].compact.reject(&:blank?).join(' → ').presence || '—' %></td>
                <td class="px-3 py-2 text-xs text-muted-foreground"><%= [row['transaction_type_lk'], row['transaction_description_lk']].compact.reject(&:blank?).join(' · ').presence || '—' %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>
  </section>

  <section class="space-y-3">
    <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Related endnotes</h2>

    <% if @endnotes.empty? %>
      <div class="p-4 rounded-lg bg-muted/30 border border-border/50 text-sm text-muted-foreground italic">No endnotes linked to this trade id.</div>
    <% else %>
      <div class="space-y-2">
        <% @endnotes.each do |n| %>
          <article class="rounded-lg border border-border bg-background p-3">
            <div class="flex flex-wrap items-center gap-2 text-sm">
              <span class="font-mono">#<%= n["endnote_id"] %></span>
              <% if n["trade_date"].present? %>
                <span class="text-muted-foreground">· <%= n["trade_date"] %></span>
              <% end %>
              <% if n["status_lk"].present? %>
                <span class="text-xs px-1.5 py-0.5 rounded bg-muted text-muted-foreground"><%= n["status_lk"] %></span>
              <% end %>
              <% if n["is_swap"] %>
                <span class="text-xs px-1.5 py-0.5 rounded bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400">swap</span>
              <% end %>
              <% if n["is_conditional"] %>
                <span class="text-xs px-1.5 py-0.5 rounded bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400">conditional</span>
              <% end %>
            </div>
            <div class="mt-2 text-sm whitespace-pre-line"><%= n["explanation"].presence || n["conveyance_text"].presence || '—' %></div>
          </article>
        <% end %>
      </div>
    <% end %>
  </section>
</main>
