<% year_label = format_year_label(@book_year) %>
<% prefetch_canonical_slugs(entity_type: "agent", entity_ids: @agents.map { |agent| agent["agent_id"] }) %>
<% prefetch_canonical_slugs(entity_type: "agency", entity_ids: @agents.map { |agent| agent["agency_id"] }) %>
<%
  placeholder_dash = "—"

  nbsp_pad = lambda do |text, width|
    raw_text = text.to_s
    return placeholder_dash if raw_text == placeholder_dash

    pad_count = [width.to_i - raw_text.length, 0].max
    ("\u00A0" * pad_count) + raw_text
  end

  percentile_meta = lambda do |value|
    percentile_int = representation_percentile_int(value)

    if percentile_int.present?
      p_int = percentile_int.to_i.clamp(0, 100)
      filled_count = (p_int / 25.0).round.clamp(0, 4)

      {
        label: "P#{p_int}",
        blocks: ("▰" * filled_count) + ("▱" * (4 - filled_count)),
        color_class: representation_percentile_color_class(value)
      }
    else
      {
        label: "P#{placeholder_dash}",
        blocks: "▱▱▱▱",
        color_class: "text-muted-foreground/40"
      }
    end
  end
%>

<div id="agents-maincanvas">
  <% if @agents.empty? %>
    <div class="px-4 py-5 text-sm text-muted-foreground italic border-b border-border bg-muted/20">
      No agents match these lenses.
    </div>
  <% else %>
    <section class="border-b border-border bg-background">
      <div class="min-w-[80rem]">
        <div class="sticky top-0 z-30 bg-muted border-b border-border">
          <div class="flex items-center px-3 h-8 text-[10px] uppercase tracking-wide text-muted-foreground/90 font-medium">
            <div class="w-72 shrink-0 sticky left-3 z-40 h-full flex items-center bg-muted relative after:absolute after:right-0 after:top-0 after:bottom-0 after:w-px after:bg-border/60">Agent</div>
            <div class="w-24 shrink-0 text-center">Book <%= year_label %></div>
            <div class="w-20 shrink-0 text-center">Clients</div>
            <div class="w-24 shrink-0">Top clients</div>
            <div class="w-24 shrink-0">Top teams</div>
            <div class="w-16 shrink-0 text-center">Teams</div>
            <div class="w-16 shrink-0 text-center">Max</div>
            <div class="w-20 shrink-0 text-center">Expiring</div>
            <div class="w-20 shrink-0 text-center">Restr</div>
            <div class="w-20 shrink-0 text-center">Options</div>
            <div class="w-20 shrink-0 text-center">Two-Ways</div>
          </div>
        </div>

        <div class="divide-y divide-border/50">
          <% @agents.each do |agent| %>
            <% row_agent_id = agent["agent_id"] %>
            <% row_agency_id = agent["agency_id"] %>
            <% agency_name = agent["agency_name"].to_s %>
            <% top_client_previews = Array(agent["top_clients_preview"]).first(3) %>
            <% top_team_previews = Array(agent["top_teams_preview"]).first(3) %>

            <% options_count = agent["player_option_count"].to_i + agent["team_option_count"].to_i %>
            <% restrictions_count = agent["no_trade_count"].to_i + agent["trade_kicker_count"].to_i + agent["trade_restricted_count"].to_i %>

            <% row_click_expr = "$overlaytype = 'agent'; $overlayid = '#{row_agent_id}'; $overlayreturntype = 'none'; $overlayreturnid = ''; @get('/agents/sidebar/agent/#{row_agent_id}')" %>
            <% agency_overlay_expr = if row_agency_id.present?
              "$overlayreturntype = 'agent'; $overlayreturnid = '#{row_agent_id}'; $overlaytype = 'agency'; $overlayid = '#{row_agency_id}'; @get('/agents/sidebar/agency/#{row_agency_id}?return_type=agent&return_id=#{row_agent_id}')"
            end %>

            <% agent_avatar_initials = agent_initials(agent["full_name"].to_s) %>

            <% book_total = agent["book_total"].to_i %>
            <% book_value_present = book_total.positive? %>
            <% book_cell_value = book_value_present ? format_salary(book_total) : placeholder_dash %>
            <% book_percentile = percentile_meta.call(agent["book_total_percentile"]) %>

            <% client_count = agent["client_count"].to_i %>
            <% client_count_present = client_count.positive? %>
            <% client_count_value = client_count_present ? number_with_delimiter(client_count) : placeholder_dash %>
            <% client_percentile = percentile_meta.call(agent["client_count_percentile"]) %>

            <% team_count = agent["team_count"].to_i %>
            <% team_count_present = team_count.positive? %>
            <% team_count_value = team_count_present ? number_with_delimiter(team_count) : placeholder_dash %>

            <% max_count = agent["max_contract_count"].to_i %>
            <% max_count_present = max_count.positive? %>
            <% max_count_value = max_count_present ? number_with_delimiter(max_count) : placeholder_dash %>
            <% max_percentile = percentile_meta.call(agent["max_contract_count_percentile"]) %>

            <% expiring_count = agent["expiring_in_window"].to_i %>
            <% expiring_present = expiring_count.positive? %>
            <% expiring_value = expiring_present ? number_with_delimiter(expiring_count) : placeholder_dash %>

            <% restrictions_present = restrictions_count.positive? %>
            <% restrictions_value = restrictions_present ? number_with_delimiter(restrictions_count) : placeholder_dash %>

            <% options_present = options_count.positive? %>
            <% options_value = options_present ? number_with_delimiter(options_count) : placeholder_dash %>

            <% two_way_count = agent["two_way_count"].to_i %>
            <% two_way_present = two_way_count.positive? %>
            <% two_way_value = two_way_present ? number_with_delimiter(two_way_count) : placeholder_dash %>

            <div
              class="group cursor-pointer transition-colors duration-75 hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10"
              role="button"
              tabindex="0"
              data-class="{ 'bg-yellow-100/80 dark:bg-yellow-900/20': $overlaytype === 'agent' && $overlayid === '<%= row_agent_id %>' }"
              data-on:click="<%= row_click_expr %>"
              data-on:keydown="if (evt.key === 'Enter' || evt.key === ' ') { evt.preventDefault(); <%= row_click_expr %>; }"
            >
              <div class="flex items-center px-3 min-h-[40px] text-xs">
                <div
                  class="w-72 shrink-0 sticky left-3 z-[5] relative bg-background transition-colors duration-75
                         group-hover:bg-yellow-50 dark:group-hover:bg-yellow-900
                         after:absolute after:right-0 after:top-0 after:bottom-0 after:w-px after:bg-border/50"
                  data-class="{ 'bg-yellow-100 dark:bg-yellow-900': $overlaytype === 'agent' && $overlayid === '<%= row_agent_id %>' }"
                >
                  <div class="grid grid-cols-[30px_1fr] grid-rows-[24px_16px]">
                    <div class="row-span-2 flex items-center justify-start">
                      <div class="w-7 h-7 rounded border border-border bg-muted/40 flex items-center justify-center text-[10px] font-semibold uppercase text-muted-foreground"><%= agent_avatar_initials %></div>
                    </div>
                    <div class="h-[24px] flex items-end min-w-0 pl-2">
                      <a href="<%= agent_href(row_agent_id) %>" class="truncate font-medium text-[14px] group-hover:text-primary transition-colors hover:underline" onclick="event.stopPropagation()"><%= agent["full_name"] %></a>
                    </div>
                    <div class="h-[16px] -mt-px flex items-start min-w-0 pl-2 leading-none text-[10px] text-muted-foreground/80 overflow-hidden">
                      <% if row_agency_id.present? && agency_name.present? %>
                        <button
                          type="button"
                          class="cursor-pointer truncate text-left text-muted-foreground hover:text-foreground hover:underline"
                          data-on:click="evt.stopPropagation(); <%= agency_overlay_expr %>"
                        ><%= agency_name %></button>
                      <% elsif agency_name.present? %>
                        <span class="truncate"><%= agency_name %></span>
                      <% else %>
                        <span class="truncate">—</span>
                      <% end %>

                      <% if agent["is_active"] == false %>
                        <span class="ml-1 entity-chip entity-chip--muted">inactive</span>
                      <% end %>
                    </div>
                  </div>
                </div>

                <div class="w-24 shrink-0">
                  <% if book_value_present %>
                    <div class="entity-cell-two-line">
                      <div class="entity-cell-primary justify-center font-mono tabular-nums"><%= nbsp_pad.call(book_cell_value, 9) %></div>
                      <div class="entity-cell-secondary justify-center">
                        <span class="font-mono tabular-nums <%= book_percentile[:color_class] %>">
                          <%= book_percentile[:label] %>
                          <span class="ml-0.5 opacity-70"><%= book_percentile[:blocks] %></span>
                        </span>
                      </div>
                    </div>
                  <% else %>
                    <div class="h-[34px] flex items-center justify-center font-mono tabular-nums text-muted-foreground/50"><%= placeholder_dash %></div>
                  <% end %>
                </div>

                <div class="w-20 shrink-0">
                  <% if client_count_present %>
                    <div class="entity-cell-two-line">
                      <div class="entity-cell-primary justify-center font-mono tabular-nums"><%= nbsp_pad.call(client_count_value, 3) %></div>
                      <div class="entity-cell-secondary justify-center">
                        <span class="font-mono tabular-nums <%= client_percentile[:color_class] %>">
                          <%= client_percentile[:label] %>
                          <span class="ml-0.5 opacity-70"><%= client_percentile[:blocks] %></span>
                        </span>
                      </div>
                    </div>
                  <% else %>
                    <div class="h-[34px] flex items-center justify-center font-mono tabular-nums text-muted-foreground/50"><%= placeholder_dash %></div>
                  <% end %>
                </div>

                <div class="w-24 shrink-0 pr-2">
                  <div class="h-[34px] flex items-center justify-start gap-1.5">
                    <% if top_client_previews.any? %>
                      <% top_client_previews.each do |preview| %>
                        <% preview_name = preview["player_name"].to_s %>
                        <% preview_player_id = preview["player_id"].to_i %>
                        <div
                          class="relative w-6 h-6 rounded-md border border-border bg-background overflow-hidden"
                          title="<%= preview_name %>"
                        >
                          <img
                            src="<%= player_headshot_url(preview_player_id) %>"
                            alt="<%= preview_name %>"
                            class="w-full h-full object-cover object-top bg-muted"
                            loading="lazy"
                            decoding="async"
                            onerror="if (this.src !== '<%= fallback_headshot_data_uri %>') { this.src = '<%= fallback_headshot_data_uri %>'; }"
                          />
                        </div>
                      <% end %>
                    <% else %>
                      <span class="text-muted-foreground/50"><%= placeholder_dash %></span>
                    <% end %>
                  </div>
                </div>

                <div class="w-24 shrink-0 pr-2">
                  <div class="h-[34px] flex items-center justify-start gap-1.5">
                    <% if top_team_previews.any? %>
                      <% top_team_previews.each do |preview| %>
                        <% preview_team_id = preview["team_id"].presence %>
                        <% preview_team_code = preview["team_code"].to_s %>
                        <% preview_player_count = preview["player_count"].to_i %>
                        <% preview_logo_url = team_logo_url(preview_team_id) %>
                        <div
                          class="w-6 h-6 rounded-full border border-border bg-background overflow-hidden flex items-center justify-center"
                          title="<%= preview_team_code.presence || placeholder_dash %> · <%= preview_player_count %> clients"
                        >
                          <% if preview_logo_url.present? %>
                            <img
                              src="<%= preview_logo_url %>"
                              alt="<%= preview_team_code %> logo"
                              class="w-full h-full object-contain p-0.5"
                              loading="lazy"
                              decoding="async"
                              onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                            />
                            <span class="hidden text-[9px] font-semibold text-muted-foreground"><%= preview_team_code.presence || placeholder_dash %></span>
                          <% else %>
                            <span class="text-[9px] font-semibold text-muted-foreground"><%= preview_team_code.presence || placeholder_dash %></span>
                          <% end %>
                        </div>
                      <% end %>
                    <% else %>
                      <span class="text-muted-foreground/50"><%= placeholder_dash %></span>
                    <% end %>
                  </div>
                </div>

                <div class="w-16 shrink-0">
                  <div class="h-[34px] flex items-center justify-center font-mono tabular-nums <%= team_count_present ? '' : 'text-muted-foreground/50' %>"><%= team_count_value %></div>
                </div>

                <div class="w-16 shrink-0">
                  <% if max_count_present %>
                    <div class="entity-cell-two-line">
                      <div class="entity-cell-primary justify-center font-mono tabular-nums"><%= nbsp_pad.call(max_count_value, 2) %></div>
                      <div class="entity-cell-secondary justify-center">
                        <span class="font-mono tabular-nums <%= max_percentile[:color_class] %>">
                          <%= max_percentile[:label] %>
                          <span class="ml-0.5 opacity-70"><%= max_percentile[:blocks] %></span>
                        </span>
                      </div>
                    </div>
                  <% else %>
                    <div class="h-[34px] flex items-center justify-center font-mono tabular-nums text-muted-foreground/50"><%= placeholder_dash %></div>
                  <% end %>
                </div>

                <div class="w-20 shrink-0">
                  <% if expiring_present %>
                    <div class="entity-cell-two-line">
                      <div class="entity-cell-primary justify-center font-mono tabular-nums"><%= nbsp_pad.call(expiring_value, 3) %></div>
                      <div class="entity-cell-secondary justify-center font-mono tabular-nums text-muted-foreground/30">&nbsp;</div>
                    </div>
                  <% else %>
                    <div class="h-[34px] flex items-center justify-center font-mono tabular-nums text-muted-foreground/50"><%= placeholder_dash %></div>
                  <% end %>
                </div>

                <div class="w-20 shrink-0">
                  <% if restrictions_present %>
                    <div class="entity-cell-two-line">
                      <div class="entity-cell-primary justify-center font-mono tabular-nums"><%= nbsp_pad.call(restrictions_value, 3) %></div>
                      <div class="entity-cell-secondary justify-center font-mono tabular-nums text-muted-foreground/30">&nbsp;</div>
                    </div>
                  <% else %>
                    <div class="h-[34px] flex items-center justify-center font-mono tabular-nums text-muted-foreground/50"><%= placeholder_dash %></div>
                  <% end %>
                </div>

                <div class="w-20 shrink-0">
                  <% if options_present %>
                    <div class="entity-cell-two-line">
                      <div class="entity-cell-primary justify-center font-mono tabular-nums"><%= nbsp_pad.call(options_value, 3) %></div>
                      <div class="entity-cell-secondary justify-center font-mono tabular-nums text-muted-foreground/30">&nbsp;</div>
                    </div>
                  <% else %>
                    <div class="h-[34px] flex items-center justify-center font-mono tabular-nums text-muted-foreground/50"><%= placeholder_dash %></div>
                  <% end %>
                </div>

                <div class="w-20 shrink-0">
                  <% if two_way_present %>
                    <div class="entity-cell-two-line">
                      <div class="entity-cell-primary justify-center font-mono tabular-nums"><%= nbsp_pad.call(two_way_value, 3) %></div>
                      <div class="entity-cell-secondary justify-center font-mono tabular-nums text-muted-foreground/30">&nbsp;</div>
                    </div>
                  <% else %>
                    <div class="h-[34px] flex items-center justify-center font-mono tabular-nums text-muted-foreground/50"><%= placeholder_dash %></div>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </section>
  <% end %>
</div>
