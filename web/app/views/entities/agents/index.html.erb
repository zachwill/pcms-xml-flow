<% directory_scope = @directory_kind.to_s == "agencies" ? "agencies" : "agents" %>
<% content_for :title, directory_scope == "agencies" ? "Agencies" : "Agents" %>

<%
  pane_query_expr = "'q=' + encodeURIComponent($agentquery) +
    '&kind=' + $entitykind +
    '&active_only=' + ($activeonly ? '1' : '0') +
    '&certified_only=' + ($certifiedonly ? '1' : '0') +
    '&with_clients=' + ($withclients ? '1' : '0') +
    '&with_book=' + ($withbook ? '1' : '0') +
    '&with_restrictions=' + ($withrestrictions ? '1' : '0') +
    '&with_expiring=' + ($withexpiring ? '1' : '0') +
    '&year=' + $bookyear +
    '&sort=' + $sortkey +
    '&dir=' + $sortdir"

  selected_overlay_query_expr = "'selected_type=' + encodeURIComponent($overlaytype) + '&selected_id=' + encodeURIComponent($overlayid)"

  sse_get_expr = "@get('/agents/sse/refresh?' + (#{pane_query_expr}) + '&' + (#{selected_overlay_query_expr}))"
  update_url_expr = "window.history.replaceState({}, '', '/agents?' + (#{pane_query_expr}))"
  refresh_expr = "#{sse_get_expr}; #{update_url_expr}"
  clear_search_expr = "$agentquery = ''; #{refresh_expr}"
%>

<div
  id="agents-workspace"
  class="h-screen w-screen flex flex-col overflow-hidden bg-background"
  data-signals="{
    agentquery: <%= @query.to_json %>,
    entitykind: '<%= @directory_kind %>',
    activeonly: <%= @active_only ? 'true' : 'false' %>,
    certifiedonly: <%= @certified_only ? 'true' : 'false' %>,
    withclients: <%= @with_clients ? 'true' : 'false' %>,
    withbook: <%= @with_book ? 'true' : 'false' %>,
    withrestrictions: <%= @with_restrictions ? 'true' : 'false' %>,
    withexpiring: <%= @with_expiring ? 'true' : 'false' %>,
    bookyear: '<%= @book_year %>',
    sortkey: '<%= @sort_key %>',
    sortdir: '<%= @sort_dir %>',
    overlaytype: 'none',
    overlayid: ''
  }"
>
  <%= render partial: "entities/shared/commandbar", locals: {
    active_entity_scope: directory_scope,
    header_knobs: [
      {
        label: "Search",
        min_width_class: "min-w-[13rem]",
        options: [
          {
            type: "search",
            id: "agents-directory-search",
            placeholder: "agent or agency",
            value: @query,
            bind: "agentquery",
            on_submit: "evt.preventDefault(); #{refresh_expr}",
            on_clear: clear_search_expr,
            input_width_class: "w-40"
          }
        ]
      },
      {
        label: "Directory",
        options: [
          {
            type: "radio",
            name: "agent-directory-kind",
            id: "agent-directory-kind-agents",
            value: "agents",
            label: "Agents",
            checked: @directory_kind == "agents",
            bind: "entitykind",
            on_change: refresh_expr
          },
          {
            type: "radio",
            name: "agent-directory-kind",
            id: "agent-directory-kind-agencies",
            value: "agencies",
            label: "Agencies",
            checked: @directory_kind == "agencies",
            bind: "entitykind",
            on_change: refresh_expr
          }
        ]
      },
      {
        label: "Year",
        options: [
          {
            type: "radio",
            name: "agent-book-year",
            id: "agent-book-year-2025",
            value: "2025",
            label: "2025",
            checked: @book_year == 2025,
            bind: "bookyear",
            on_change: refresh_expr
          },
          {
            type: "radio",
            name: "agent-book-year",
            id: "agent-book-year-2026",
            value: "2026",
            label: "2026",
            checked: @book_year == 2026,
            bind: "bookyear",
            on_change: refresh_expr
          },
          {
            type: "radio",
            name: "agent-book-year",
            id: "agent-book-year-2027",
            value: "2027",
            label: "2027",
            checked: @book_year == 2027,
            bind: "bookyear",
            on_change: refresh_expr
          }
        ]
      },
      {
        label: "Sort",
        options: [
          {
            type: "radio",
            name: "agent-sort-key",
            id: "agent-sort-book",
            value: "book",
            label: "Book",
            checked: @sort_key == "book",
            bind: "sortkey",
            on_change: refresh_expr
          },
          {
            type: "radio",
            name: "agent-sort-key",
            id: "agent-sort-clients",
            value: "clients",
            label: "Clients",
            checked: @sort_key == "clients",
            bind: "sortkey",
            on_change: refresh_expr
          },
          {
            type: "radio",
            name: "agent-sort-key",
            id: "agent-sort-teams",
            value: "teams",
            label: "Teams",
            checked: @sort_key == "teams",
            bind: "sortkey",
            on_change: refresh_expr
          },
          {
            type: "radio",
            name: "agent-sort-key",
            id: "agent-sort-max",
            value: "max",
            label: "Max",
            checked: @sort_key == "max",
            bind: "sortkey",
            on_change: refresh_expr
          },
          {
            type: "radio",
            name: "agent-sort-key",
            id: "agent-sort-expirings",
            value: "expirings",
            label: "Exp",
            checked: @sort_key == "expirings",
            bind: "sortkey",
            on_change: refresh_expr
          },
          {
            type: "radio",
            name: "agent-sort-key",
            id: "agent-sort-options",
            value: "options",
            label: "Opts",
            checked: @sort_key == "options",
            bind: "sortkey",
            on_change: refresh_expr
          },
          {
            type: "radio",
            name: "agent-sort-key",
            id: "agent-sort-name",
            value: "name",
            label: "Name",
            checked: @sort_key == "name",
            bind: "sortkey",
            on_change: refresh_expr
          }
        ]
      },
      {
        label: "Direction",
        options: [
          {
            type: "radio",
            name: "agent-sort-direction",
            id: "agent-sort-direction-desc",
            value: "desc",
            label: "Desc",
            checked: @sort_dir == "desc",
            bind: "sortdir",
            on_change: refresh_expr
          },
          {
            type: "radio",
            name: "agent-sort-direction",
            id: "agent-sort-direction-asc",
            value: "asc",
            label: "Asc",
            checked: @sort_dir == "asc",
            bind: "sortdir",
            on_change: refresh_expr
          }
        ]
      },
      {
        label: "Filters",
        options: [
          {
            type: "checkbox",
            id: "agent-filter-active-only",
            label: "Active",
            checked: @active_only,
            bind: "activeonly",
            on_change: refresh_expr
          },
          {
            type: "checkbox",
            id: "agent-filter-certified-only",
            label: "Certified",
            checked: @certified_only,
            bind: "certifiedonly",
            on_change: refresh_expr
          },
          {
            type: "checkbox",
            id: "agent-filter-with-clients",
            label: "Clients > 0",
            checked: @with_clients,
            bind: "withclients",
            on_change: refresh_expr
          },
          {
            type: "checkbox",
            id: "agent-filter-with-book",
            label: "Book > 0",
            checked: @with_book,
            bind: "withbook",
            on_change: refresh_expr
          },
          {
            type: "checkbox",
            id: "agent-filter-with-restrictions",
            label: "Restricted",
            checked: @with_restrictions,
            bind: "withrestrictions",
            on_change: refresh_expr
          },
          {
            type: "checkbox",
            id: "agent-filter-with-expiring",
            label: "Expiring",
            checked: @with_expiring,
            bind: "withexpiring",
            on_change: refresh_expr
          }
        ]
      }
    ]
  } %>

  <div id="viewport" class="flex flex-1 overflow-hidden relative">
    <main id="maincanvas" class="flex-1 min-w-0 overflow-y-auto overflow-x-hidden bg-background">
      <%= render partial: "entities/agents/workspace_main" %>
    </main>

    <aside
      id="rightpanel"
      class="w-[30%] min-w-[320px] max-w-[480px] border-l border-border bg-background overflow-hidden relative"
    >
      <div
        id="rightpanel-base-layer"
        class="absolute inset-0 overflow-y-auto overflow-x-hidden overscroll-y-contain scroll-touch pt-2 px-4 pb-4"
      >
        <%= render partial: "entities/agents/rightpanel_base" %>
      </div>

      <div id="rightpanel-overlay"></div>
    </aside>
  </div>
</div>
