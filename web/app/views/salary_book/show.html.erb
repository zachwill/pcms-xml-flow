<% initial_team = @initial_team.to_s %>
<% initial_view = @initial_view.to_s %>

<%# Build team_id lookup for back button logos %>
<% team_id_map = @team_meta_by_code.transform_values { |meta| meta["team_id"] }.to_json %>
<% salary_book_base_path = salary_book_path %>

<%# Season column state machine:
    - Hover/focus year header => preview (selectedseason)
    - Click year header => lock/unlock preview (seasonlocked)
%>
<div
  id="salarybook"
  class="h-screen w-full flex flex-col overflow-hidden bg-background"
  style="height: 100dvh;"
  data-signals="{
    activeteam: '<%= initial_team %>',
    activeview: '<%= initial_view %>',
    selectedseason: '',
    seasonlocked: false,
    sidebarteamloaded: '<%= initial_team %>',
    sidebarcapyearloaded: '<%= @salary_year %>',
    sidebardraftloaded: false,
    sidebardraftyearloaded: '',
    sidebarrightsloaded: false,
    displayfreeagentholds: false,
    displaydeadmoney: false,
    displayepm: false,
    displayplayercapholds: <%= salary_book_default_display_player_cap_holds? %>,
    displaycashvscap: false,
    displayluxurytax: true
  }"
  data-on:salarybook-switch-team="
    const rawteam = (evt.detail && evt.detail.team) ? String(evt.detail.team) : '';
    const teamcode = rawteam.trim().toUpperCase();
    if (!teamcode.match(/^[A-Z]{3}$/)) { return; }

    const rawyear = (evt.detail && evt.detail.year) ? String(evt.detail.year) : '';
    const requestedyear = rawyear.trim();
    const effectiveyear = requestedyear.match(/^\d{4}$/) ? requestedyear : '<%= @salary_year %>';

    if ($activeteam === teamcode) { return; }

    $activeteam = teamcode;
    $seasonlocked = false;
    $selectedseason = '';
    $sidebarteamloaded = teamcode;
    $sidebarcapyearloaded = effectiveyear;
    $sidebardraftloaded = false;
    $sidebardraftyearloaded = '';
    $sidebarrightsloaded = false;

    const effectiveview = ['injuries', 'tankathon'].includes($activeview) ? $activeview : 'salary-book';

    @get('/salary-book/switch-team?team=' + teamcode + '&year=' + encodeURIComponent(effectiveyear) + '&view=' + encodeURIComponent(effectiveview));
    window.history.replaceState({}, '', '<%= salary_book_base_path %>?team=' + teamcode + '&year=' + encodeURIComponent(effectiveyear) + '&view=' + encodeURIComponent(effectiveview));
  "
  data-on:salarybook-switch-view="
    const rawview = (evt.detail && evt.detail.view) ? String(evt.detail.view) : '';
    const nextview = rawview.trim().toLowerCase();
    if (!['injuries', 'rotation', 'salary-book', 'tankathon'].includes(nextview)) { return; }
    if (nextview === 'rotation') { return; }

    const fallbackteam = String($activeteam || '<%= initial_team %>').trim().toUpperCase();
    const requestedteam = (evt.detail && evt.detail.team) ? String(evt.detail.team).trim().toUpperCase() : fallbackteam;
    if (!requestedteam.match(/^[A-Z]{3}$/)) { return; }

    const rawyear = (evt.detail && evt.detail.year) ? String(evt.detail.year) : '';
    const requestedyear = rawyear.trim();
    const effectiveyear = requestedyear.match(/^\d{4}$/) ? requestedyear : '<%= @salary_year %>';

    if ($activeview === nextview) { return; }

    $activeview = nextview;
    @get('/salary-book/frame?view=' + encodeURIComponent(nextview) + '&team=' + requestedteam + '&year=' + encodeURIComponent(effectiveyear));
    window.history.replaceState({}, '', '<%= salary_book_base_path %>?team=' + requestedteam + '&year=' + encodeURIComponent(effectiveyear) + '&view=' + encodeURIComponent(nextview));
  "
>
  <div id="flash"></div>

  <%# Sidebar loader: hover/locked year updates for the currently loaded team. %>
  <div
    id="salarybook-sidebar-loader"
    class="hidden"
    aria-hidden="true"
    data-effect="
      const effectiveyear = ($selectedseason !== '' ? $selectedseason : '<%= @salary_year %>');
      if ($activeteam && $sidebarteamloaded === $activeteam && String($sidebarcapyearloaded) !== String(effectiveyear)) {
        $sidebarcapyearloaded = effectiveyear;
        @get('/salary-book/sidebar/team/cap?team=' + $activeteam + '&year=' + effectiveyear);
      }
    "
  ></div>

  <%# Command bar (prototype height: 130px) %>
  <header
    id="commandbar"
    class="shrink-0 h-[130px] border-b border-border bg-background flex items-start px-4 pt-3 gap-4"
  >
    <% if @teams_by_conference["Eastern"].any? || @teams_by_conference["Western"].any? %>
      <%# Team Selector Grid %>
      <div class="flex gap-4" role="navigation" aria-label="Teams">
        <% %w[Eastern Western].each do |conf| %>
          <div class="space-y-1">
            <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70"><%= conf %></div>
            <div class="grid grid-cols-5 gap-1">
              <% @teams_by_conference[conf].each do |team| %>
                <button
                  type="button"
                  class="cursor-pointer relative h-7 px-2 rounded text-xs font-medium transition-all duration-150 border outline-none inline-flex items-center justify-center"
                  data-on:click="el.dispatchEvent(new CustomEvent('salarybook-switch-team', { bubbles: true, detail: { team: '<%= team[:code] %>', year: '<%= @salary_year %>' } }));"
                  data-class="{
                    'bg-primary text-primary-foreground border-primary shadow-sm': $activeteam === '<%= team[:code] %>',
                    'bg-muted/50 hover:bg-muted': $activeteam !== '<%= team[:code] %>',
                    'text-red-600 dark:text-red-400 border-red-500/70 hover:border-red-500/80': '<%= team[:code] %>' === 'POR' && $activeteam !== 'POR',
                    'text-foreground border-border hover:border-foreground/20': $activeteam !== '<%= team[:code] %>' && '<%= team[:code] %>' !== 'POR'
                  }"
                  title="<%= team[:name] %>"
                ><%= team[:code] %></button>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>

      <%# Divider %>
      <div class="h-20 w-px bg-border self-center"></div>

      <%# Views %>
      <div class="min-w-[6.5rem] space-y-1" role="radiogroup" aria-label="Views">
        <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Views</div>
        <div class="space-y-1">
          <label class="flex items-center gap-1.5 cursor-pointer">
            <input
              type="radio"
              id="view-injuries"
              name="salarybook-view"
              value="injuries"
              class="size-3.5 accent-primary"
              <%= "checked" if initial_view == "injuries" %>
              data-on:change="if (el.checked) { el.dispatchEvent(new CustomEvent('salarybook-switch-view', { bubbles: true, detail: { view: 'injuries', team: $activeteam, year: '<%= @salary_year %>' } })); }"
            />
            <span
              class="text-[11px] leading-none select-none transition-colors"
              data-class="{ 'text-foreground font-semibold': $activeview === 'injuries', 'text-muted-foreground': $activeview !== 'injuries' }"
            >Injuries</span>
          </label>

          <label class="flex items-center gap-1.5 cursor-not-allowed opacity-60">
            <input
              type="radio"
              id="view-rotation"
              name="salarybook-view"
              value="rotation"
              class="size-3.5 accent-primary"
              disabled
            />
            <span class="text-[11px] leading-none select-none text-muted-foreground">Rotation</span>
          </label>

          <label class="flex items-center gap-1.5 cursor-pointer">
            <input
              type="radio"
              id="view-salary-book"
              name="salarybook-view"
              value="salary-book"
              class="size-3.5 accent-primary"
              <%= "checked" if initial_view == "salary-book" %>
              data-on:change="if (el.checked) { el.dispatchEvent(new CustomEvent('salarybook-switch-view', { bubbles: true, detail: { view: 'salary-book', team: $activeteam, year: '<%= @salary_year %>' } })); }"
            />
            <span
              class="text-[11px] leading-none select-none transition-colors"
              data-class="{ 'text-foreground font-semibold': $activeview === 'salary-book', 'text-muted-foreground': $activeview !== 'salary-book' }"
            >Salary Book</span>
          </label>

          <label class="flex items-center gap-1.5 cursor-pointer">
            <input
              type="radio"
              id="view-tankathon"
              name="salarybook-view"
              value="tankathon"
              class="size-3.5 accent-primary"
              <%= "checked" if initial_view == "tankathon" %>
              data-on:change="if (el.checked) { el.dispatchEvent(new CustomEvent('salarybook-switch-view', { bubbles: true, detail: { view: 'tankathon', team: $activeteam, year: '<%= @salary_year %>' } })); }"
            />
            <span
              class="text-[11px] leading-none select-none transition-colors"
              data-class="{ 'text-foreground font-semibold': $activeview === 'tankathon', 'text-muted-foreground': $activeview !== 'tankathon' }"
            >Tankathon</span>
          </label>
        </div>
      </div>

      <%# Divider %>
      <div class="h-20 w-px bg-border self-center"></div>

      <%# Filter Toggles (client-only lenses) %>
      <div class="flex items-start gap-4" role="group" aria-label="Filters">
        <div class="min-w-[5.5rem] space-y-1">
          <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Display</div>
          <div class="space-y-1">
            <div class="flex items-center gap-1.5">
              <input
                type="checkbox"
                id="filter-column-capholds"
                class="size-3.5 accent-primary"
                data-bind="displayplayercapholds"
                data-on:change="window.__salaryBookPreserveContext?.()"
                <%= "checked" if salary_book_default_display_player_cap_holds? %>
              />
              <label for="filter-column-capholds" class="text-[11px] leading-none cursor-pointer select-none text-foreground/80 hover:text-foreground transition-colors">Cap Holds</label>
            </div>
            <div class="flex items-center gap-1.5">
              <input
                type="checkbox"
                id="filter-column-epm"
                class="size-3.5 accent-primary"
                data-bind="displayepm"
                data-on:change="window.__salaryBookPreserveContext?.()"
              />
              <label for="filter-column-epm" class="text-[11px] leading-none cursor-pointer select-none text-foreground/80 hover:text-foreground transition-colors">EPM</label>
            </div>
          </div>
        </div>

        <div class="min-w-[7.5rem] space-y-1">
          <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Financials</div>
          <div class="space-y-1">
            <div class="flex items-center gap-1.5">
              <input
                type="checkbox"
                id="filter-cashvscap"
                class="size-3.5 accent-primary"
                data-bind="displaycashvscap"
                data-on:change="window.__salaryBookPreserveContext?.()"
              />
              <label for="filter-cashvscap" class="text-[11px] leading-none cursor-pointer select-none text-foreground/80 hover:text-foreground transition-colors">Cash vs Cap</label>
            </div>
            <div class="flex items-center gap-1.5">
              <input
                type="checkbox"
                id="filter-deadmoney"
                class="size-3.5 accent-primary"
                data-bind="displaydeadmoney"
                data-on:change="window.__salaryBookPreserveContext?.()"
              />
              <label for="filter-deadmoney" class="text-[11px] leading-none cursor-pointer select-none text-foreground/80 hover:text-foreground transition-colors">Dead Money</label>
            </div>
            <div class="flex items-center gap-1.5">
              <input
                type="checkbox"
                id="filter-capholds"
                class="size-3.5 accent-primary"
                data-bind="displayfreeagentholds"
                data-on:change="window.__salaryBookPreserveContext?.()"
              />
              <label for="filter-capholds" class="text-[11px] leading-none cursor-pointer select-none text-foreground/80 hover:text-foreground transition-colors">Free Agent Holds</label>
            </div>
            <div class="flex items-center gap-1.5">
              <input
                type="checkbox"
                id="filter-luxurytax"
                class="size-3.5 accent-primary"
                data-bind="displayluxurytax"
                data-on:change="window.__salaryBookPreserveContext?.()"
                checked
              />
              <label for="filter-luxurytax" class="text-[11px] leading-none cursor-pointer select-none text-foreground/80 hover:text-foreground transition-colors">Tax Payment</label>
            </div>
          </div>
        </div>

      </div>


    <% else %>
      <div class="text-sm text-muted-foreground">No teams.</div>
    <% end %>

    <%# Global navigation + theme controls %>
    <div class="h-20 w-px bg-border self-center ml-auto shrink-0"></div>
    <%= render partial: "shared/commandbar_navigation", locals: { active_destination: "salary_book" } %>
  </header>

  <%= render partial: "salary_book/player_command_palette" %>

  <div id="viewport" class="flex flex-1 overflow-hidden relative">
    <%# Main canvas %>
    <%= render partial: "salary_book/maincanvas", locals: {
      boot_error: @boot_error,
      salary_year: @salary_year,
      salary_years: @salary_years,
      initial_view: @initial_view,
      initial_team: @initial_team,
      initial_players: @initial_players,
      initial_cap_holds: @initial_cap_holds,
      initial_exceptions: @initial_exceptions,
      initial_dead_money: @initial_dead_money,
      initial_picks: @initial_picks,
      initial_team_summaries: @initial_team_summaries_by_year,
      initial_team_meta: @initial_team_meta,
      initial_team_codes: @team_codes,
      initial_team_meta_by_code: @team_meta_by_code,
      initial_tankathon_rows: @initial_tankathon_rows,
      initial_tankathon_standing_date: @initial_tankathon_standing_date,
      initial_tankathon_season_year: @initial_tankathon_season_year,
      initial_tankathon_season_label: @initial_tankathon_season_label
    } %>

    <%# Right panel %>
    <aside
      id="rightpanel"
      class="w-[30%] min-w-[320px] max-w-[480px] border-l border-border bg-background overflow-hidden relative"
    >
      <div
        id="rightpanel-base-layer"
        class="absolute inset-0 overflow-y-auto overflow-x-hidden overscroll-y-contain scroll-touch pt-2 px-4 pb-4 transition-opacity duration-300"
      >
        <% if @initial_team.present? %>
          <%= render partial: "salary_book/sidebar_team", locals: {
            team_code: @initial_team,
            summary: @initial_team_summary,
            team_meta: @initial_team_meta,
            summaries_by_year: @initial_team_summaries_by_year,
            year: @salary_year
          } %>
        <% else %>
          <div id="rightpanel-base" class="space-y-4">
            <div class="p-4 rounded-lg border border-border bg-muted/20 text-sm text-muted-foreground">
              Select a team to load context.
            </div>
          </div>
        <% end %>
      </div>

      <%# Overlay container (patched by Datastar) %>
      <div id="rightpanel-overlay"></div>
    </aside>
  </div>
</div>

<% content_for :head_scripts do %>
  <script type="module">
    import "salary_book";
  </script>
  <script>
    // Team ID map for back button logos
    window.__salaryBookTeamIds = <%= raw team_id_map %>;
  </script>
<% end %>
