<%#
  Cap Horizon Table — multi-year cap totals + thresholds.

  locals:
  - team_salary_rows: (Array) rows from team_salary_warehouse (2025-2031)
%>

<% rows = Array(local_assigns[:team_salary_rows]) %>

<section class="space-y-3">
  <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Cap horizon (2025–2031)</h2>

  <% if rows.empty? %>
    <div class="p-4 rounded-lg bg-muted/30 border border-border/50 text-sm text-muted-foreground italic">No team salary rows found.</div>
  <% else %>
    <div class="overflow-x-auto rounded-lg border border-border">
      <table class="entity-table min-w-full text-xs">
        <thead class="bg-muted/40 text-[10px] uppercase tracking-wide text-muted-foreground/90">
          <tr>
            <th class="text-left px-3 py-2 font-medium">Year</th>
            <th class="text-right px-3 py-2 font-medium">Cap total</th>
            <th class="text-right px-3 py-2 font-medium">Tax room</th>
            <th class="text-right px-3 py-2 font-medium">A1 room</th>
            <th class="text-right px-3 py-2 font-medium">A2 room</th>
            <th class="text-right px-3 py-2 font-medium">Luxury tax</th>
            <th class="text-left px-3 py-2 font-medium">Status</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-border">
          <% rows.each do |r| %>
            <% is_current = r["salary_year"].to_i == 2025 %>
            <tr class="<%= is_current ? 'bg-primary/5 font-medium' : '' %> hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 transition-colors duration-75">
              <td class="px-3 py-2 font-mono tabular-nums">
                <%= r["salary_year"] %>
                <% if is_current %><span class="ml-1 text-[10px] text-primary">(current)</span><% end %>
              </td>
              <td class="px-3 py-2 text-right font-mono tabular-nums"><%= format_salary(r["cap_total_hold"] || r["cap_total"]) %></td>
              <td class="px-3 py-2 text-right font-mono tabular-nums <%= room_amount_color(r['room_under_tax']) %>"><%= format_room_amount(r["room_under_tax"]) %></td>
              <td class="px-3 py-2 text-right font-mono tabular-nums <%= room_amount_color(r['room_under_apron1']) %>"><%= format_room_amount(r["room_under_apron1"]) %></td>
              <td class="px-3 py-2 text-right font-mono tabular-nums <%= room_amount_color(r['room_under_apron2']) %>"><%= format_room_amount(r["room_under_apron2"]) %></td>
              <td class="px-3 py-2 text-right font-mono tabular-nums">
                <% lux = r["luxury_tax_owed"] %>
                <% if lux.present? && lux.to_f > 0 %>
                  <span class="text-red-600 dark:text-red-400"><%= format_salary(lux) %></span>
                <% else %>
                  <span class="text-muted-foreground">—</span>
                <% end %>
              </td>
              <td class="px-3 py-2 text-xs">
                <div class="flex flex-wrap gap-1">
                  <% if r["is_repeater_taxpayer"] %>
                    <span class="entity-chip entity-chip--danger">repeater</span>
                  <% elsif r["is_taxpayer"] %>
                    <span class="entity-chip entity-chip--warning">taxpayer</span>
                  <% end %>
                  <% if r["apron_level_lk"].present? && r["apron_level_lk"] != "NONE" %>
                    <span class="entity-chip entity-chip--muted"><%= r["apron_level_lk"] %></span>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  <% end %>
</section>
