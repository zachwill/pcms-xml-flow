<% team_code = local_assigns.fetch(:team_code, nil).to_s.upcase %>
<% standings_rows = local_assigns.fetch(:standings_rows, []) || [] %>
<% year = local_assigns.fetch(:year, SalaryBookHelper::SALARY_YEARS.first) %>
<% standing_date = local_assigns.fetch(:standing_date, nil) %>
<% season_year = local_assigns.fetch(:season_year, nil) %>
<% season_label = local_assigns.fetch(:season_label, nil) %>
<% error_message = local_assigns.fetch(:error_message, nil) %>

<%
  selected_row = standings_rows.find { |row| row["team_code"].to_s.upcase == team_code }
  display_date = standing_date.present? ? format_date_short(standing_date) : nil
  board_label = season_label.presence || (season_year.present? ? format_year_label(season_year.to_i) : nil)
%>

<div id="salarybook-team-frame" class="min-h-full bg-background">
  <% if error_message.present? %>
    <div class="p-6">
      <div class="max-w-3xl rounded-lg border border-border bg-muted/20 p-4 text-sm">
        <div class="font-medium text-destructive">Unable to load Tankathon view</div>
        <div class="mt-1 text-muted-foreground">Failed while querying <code>nba.standings</code>.</div>
        <pre class="mt-2 overflow-auto rounded bg-muted/40 p-2 text-xs text-muted-foreground"><%= error_message %></pre>
      </div>
    </div>
  <% elsif standings_rows.empty? %>
    <div class="p-6">
      <div class="rounded-lg border border-border bg-muted/20 p-4 text-sm text-muted-foreground">
        No standings rows available yet for this view.
      </div>
    </div>
  <% else %>
    <div class="sticky top-0 z-20 border-b border-border bg-background/95 backdrop-blur px-4 py-3">
      <div class="flex items-end justify-between gap-4">
        <div class="space-y-1">
          <div class="text-[10px] uppercase tracking-wide text-muted-foreground/80">Tankathon</div>
          <div class="text-sm font-medium text-foreground">
            <% if selected_row.present? %>
              <%= selected_row["team_name"].presence || selected_row["team_code"] %>
              <span class="text-muted-foreground font-normal">(<%= selected_row["team_code"] %>)</span>
            <% else %>
              Standings board
            <% end %>
          </div>
          <div class="text-[11px] text-muted-foreground">
            <% if selected_row.present? %>
              Pick <span class="font-mono tabular-nums">#<%= selected_row["lottery_rank"] %></span>
              · Record <span class="font-mono tabular-nums"><%= selected_row["record"].presence || "#{selected_row['wins']}-#{selected_row['losses']}" %></span>
              · <%= selected_row["conference"].presence || "—" %> #<span class="font-mono tabular-nums"><%= selected_row["conference_rank"].presence || "—" %></span>
            <% else %>
              Select a team to see standings context.
            <% end %>
          </div>
        </div>

        <div class="text-right space-y-1">
          <div class="text-[10px] uppercase tracking-wide text-muted-foreground/80">Source</div>
          <div class="text-[11px] text-muted-foreground">
            <span class="font-medium text-foreground">nba.standings</span>
            <% if board_label.present? %>
              · <span class="font-mono tabular-nums"><%= board_label %></span>
            <% end %>
            <% if display_date.present? %>
              · as of <span class="font-mono tabular-nums"><%= display_date %></span>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <div class="px-4 pb-8">
      <div class="mt-3 overflow-x-auto rounded-lg border border-border">
        <table id="salarybook-standings-table" class="min-w-full text-xs">
          <thead class="bg-muted/40 text-[10px] uppercase tracking-wide text-muted-foreground/90 font-medium">
            <tr>
              <th class="h-8 px-2 text-right font-medium">Pick</th>
              <th class="h-8 px-2 text-left font-medium">Team</th>
              <th class="h-8 px-2 text-right font-medium">W</th>
              <th class="h-8 px-2 text-right font-medium">L</th>
              <th class="h-8 px-2 text-right font-medium">Win%</th>
              <th class="h-8 px-2 text-right font-medium">GB</th>
              <th class="h-8 px-2 text-right font-medium">L10</th>
              <th class="h-8 px-2 text-right font-medium">Streak</th>
              <th class="h-8 px-2 text-right font-medium">Net</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-border">
            <% standings_rows.each do |row| %>
              <% row_team_code = row["team_code"].to_s.upcase %>
              <% row_team_name = row["team_name"].presence || row_team_code %>
              <% row_logo_url = team_logo_url(row["team_id"]) %>
              <% is_active = row_team_code == team_code %>

              <% win_pct = row["win_pct"] %>
              <% win_pct_display = win_pct.nil? ? "—" : format("%.3f", win_pct.to_f) %>

              <% league_gb = row["league_games_back"] %>
              <% league_gb_display = if league_gb.nil?
                "—"
              elsif league_gb.to_f.zero?
                "—"
              else
                format("%.1f", league_gb.to_f).sub(/\.0\z/, "")
              end %>

              <% net = row["diff_pts_per_game"] %>
              <% net_display = net.nil? ? "—" : format("%+.1f", net.to_f) %>
              <% net_class = if net.nil?
                "text-muted-foreground"
              elsif net.to_f.positive?
                "text-emerald-600 dark:text-emerald-400"
              elsif net.to_f.negative?
                "text-red-600 dark:text-red-400"
              else
                "text-muted-foreground"
              end %>

              <tr
                class="group cursor-pointer hover:bg-yellow-50/70 dark:hover:bg-yellow-900/25 transition-colors duration-75 <%= is_active ? 'bg-primary/5 dark:bg-primary/10' : '' %>"
                data-on:click="el.dispatchEvent(new CustomEvent('salarybook-switch-team', { bubbles: true, detail: { team: '<%= row_team_code %>', year: '<%= year %>' } }));"
                title="Switch to <%= row_team_code %>"
              >
                <td class="h-10 px-2 text-right font-mono tabular-nums">
                  <% if row["lottery_rank"].to_i <= 14 %>
                    <span class="entity-chip entity-chip--warning">#<%= row["lottery_rank"] %></span>
                  <% else %>
                    #<%= row["lottery_rank"] %>
                  <% end %>
                </td>
                <td class="h-10 px-2">
                  <div class="grid grid-cols-[34px_1fr] grid-rows-[22px_14px]">
                    <div class="row-span-2 flex items-center justify-start">
                      <div class="w-7 h-7 rounded border border-border bg-background overflow-hidden flex items-center justify-center">
                        <% if row_logo_url.present? %>
                          <img
                            src="<%= row_logo_url %>"
                            alt=""
                            class="w-full h-full object-contain"
                            loading="lazy"
                            decoding="async"
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                          />
                          <span class="hidden text-[9px] font-semibold text-muted-foreground"><%= row_team_code %></span>
                        <% else %>
                          <span class="text-[9px] font-semibold text-muted-foreground"><%= row_team_code %></span>
                        <% end %>
                      </div>
                    </div>
                    <div class="h-[22px] min-w-0 pl-2 flex items-end">
                      <span class="truncate text-[13px] font-medium <%= is_active ? 'text-primary' : 'text-foreground group-hover:text-primary' %>"><%= row_team_name %></span>
                    </div>
                    <div class="h-[14px] min-w-0 pl-2 flex items-start gap-1.5 text-[10px] leading-none text-muted-foreground/80">
                      <span class="font-mono tabular-nums"><%= row_team_code %></span>
                      <span>·</span>
                      <span><%= row["conference"].presence || "—" %> #<span class="font-mono tabular-nums"><%= row["conference_rank"].presence || "—" %></span></span>
                    </div>
                  </div>
                </td>
                <td class="h-10 px-2 text-right font-mono tabular-nums"><%= row["wins"].presence || "—" %></td>
                <td class="h-10 px-2 text-right font-mono tabular-nums"><%= row["losses"].presence || "—" %></td>
                <td class="h-10 px-2 text-right font-mono tabular-nums"><%= win_pct_display %></td>
                <td class="h-10 px-2 text-right font-mono tabular-nums"><%= league_gb_display %></td>
                <td class="h-10 px-2 text-right font-mono tabular-nums"><%= row["l10"].presence || "—" %></td>
                <td class="h-10 px-2 text-right font-mono tabular-nums"><%= row["current_streak_text"].presence || "—" %></td>
                <td class="h-10 px-2 text-right font-mono tabular-nums <%= net_class %>"><%= net_display %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
    </div>
  <% end %>
</div>
