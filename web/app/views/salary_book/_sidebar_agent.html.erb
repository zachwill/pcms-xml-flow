<%#
  Agent overlay (RightPanel entity) — Salary Book sidebar

  Rich summary of an agent's book: headline KPIs, roster composition,
  upcoming free agents, trade restrictions, then the full client roster.

  NOTE: Root id must remain stable for Datastar morphing.
%>

<%
  rollup ||= {}
  sidebar_back_button_partial = local_assigns.fetch(:sidebar_back_button_partial, "salary_book/sidebar_back_button")
  sidebar_back_button_locals = local_assigns.fetch(:sidebar_back_button_locals, {})

  presenter = SalaryBook::AgentSidebarPresenter.new(agent: agent, rollup: rollup, helpers: self)
  sidebar = presenter.state

  salary_years = sidebar.fetch(:salary_years)
  compact = sidebar.fetch(:compact)

  agent_id = sidebar.fetch(:agent_id)
  agent_name = sidebar.fetch(:agent_name)
  agency_name = sidebar.fetch(:agency_name)
  initials = sidebar.fetch(:initials)

  total_count = sidebar.fetch(:total_count)
  standard_count = sidebar.fetch(:standard_count)
  two_way_count = sidebar.fetch(:two_way_count)
  team_count = sidebar.fetch(:team_count)

  book_2025 = sidebar.fetch(:book_2025)
  book_2026 = sidebar.fetch(:book_2026)
  book_2027 = sidebar.fetch(:book_2027)

  rookie_scale_count = sidebar.fetch(:rookie_scale_count)
  min_contract_count = sidebar.fetch(:min_contract_count)
  max_contract_count = sidebar.fetch(:max_contract_count)
  no_trade_count = sidebar.fetch(:no_trade_count)
  trade_kicker_count = sidebar.fetch(:trade_kicker_count)
  trade_restricted_count = sidebar.fetch(:trade_restricted_count)

  expiring_2025 = sidebar.fetch(:expiring_2025)
  total_expiring = sidebar.fetch(:total_expiring)

  player_option_count = sidebar.fetch(:player_option_count)
  team_option_count = sidebar.fetch(:team_option_count)
  prior_year_nba_now_free_agent_count = sidebar.fetch(:prior_year_nba_now_free_agent_count)

  book_2025_percentile = sidebar.fetch(:book_2025_percentile)
  book_2026_percentile = sidebar.fetch(:book_2026_percentile)
  book_2027_percentile = sidebar.fetch(:book_2027_percentile)
  client_count_percentile = sidebar.fetch(:client_count_percentile)
  team_count_percentile = sidebar.fetch(:team_count_percentile)
  standard_count_percentile = sidebar.fetch(:standard_count_percentile)
  two_way_count_percentile = sidebar.fetch(:two_way_count_percentile)

  has_options = sidebar.fetch(:has_options)
  has_restrictions = sidebar.fetch(:has_restrictions)
  has_prior_year_now_fa = sidebar.fetch(:has_prior_year_now_fa)
%>

<div id="rightpanel-overlay" class="h-full">
  <%# Sticky header %>
  <div class="sticky top-0 z-20 h-10 px-4 flex items-center justify-between border-b border-border bg-background">
    <%= render partial: sidebar_back_button_partial, locals: sidebar_back_button_locals %>

    <a
      class="text-xs text-muted-foreground hover:text-foreground hover:underline"
      href="<%= agent_href(agent_id) %>"
    >Open agent page</a>
  </div>

  <div class="px-4 pb-4 pt-4 space-y-5">
    <%# ── Agent header ── %>
    <div class="flex items-center gap-3">
      <div
        class="w-12 h-12 rounded-lg bg-gradient-to-br from-violet-500/20 to-violet-600/30 flex items-center justify-center
               text-base font-bold text-violet-600 dark:text-violet-400 ring-1 ring-violet-200 dark:ring-violet-800/50 shrink-0"
      >
        <%= initials %>
      </div>

      <div class="min-w-0 space-y-0.5">
        <h2 class="text-lg font-semibold text-foreground truncate"><%= agent_name %></h2>
        <% if agency_name.present? %>
          <div class="text-sm text-muted-foreground truncate"><%= agency_name %></div>
        <% end %>
      </div>
    </div>

    <%# ── Snapshot KPIs (match team sidebar treatment) ── %>
    <div class="border-t border-border pt-4 space-y-2.5">
      <div class="grid grid-cols-4 gap-1.5">
        <%= render partial: "salary_book/kpi_cell", locals: {
          label: "Clients",
          value: total_count.to_s,
          subvalue: (representation_percentile_int(client_count_percentile).present? ? "P#{representation_percentile_int(client_count_percentile)}" : nil),
          subvalue_class_name: representation_percentile_color_class(client_count_percentile),
          class_name: "w-full"
        } %>

        <%= render partial: "salary_book/kpi_cell", locals: {
          label: "Teams",
          value: team_count.to_s,
          subvalue: (representation_percentile_int(team_count_percentile).present? ? "P#{representation_percentile_int(team_count_percentile)}" : nil),
          subvalue_class_name: representation_percentile_color_class(team_count_percentile),
          class_name: "w-full"
        } %>

        <%= render partial: "salary_book/kpi_cell", locals: {
          label: "Std",
          value: standard_count.to_s,
          subvalue: (representation_percentile_int(standard_count_percentile).present? ? "P#{representation_percentile_int(standard_count_percentile)}" : nil),
          subvalue_class_name: representation_percentile_color_class(standard_count_percentile),
          class_name: "w-full"
        } %>

        <%= render partial: "salary_book/kpi_cell", locals: {
          label: "2W",
          value: two_way_count.to_s,
          subvalue: (representation_percentile_int(two_way_count_percentile).present? ? "P#{representation_percentile_int(two_way_count_percentile)}" : nil),
          subvalue_class_name: representation_percentile_color_class(two_way_count_percentile),
          variant: (two_way_count > 0 ? "default" : "muted"),
          class_name: "w-full"
        } %>
      </div>

      <div class="grid grid-cols-3 gap-1.5">
        <%= render partial: "salary_book/kpi_cell", locals: {
          label: format_year_label(2025),
          value: compact.call(book_2025),
          subvalue: (representation_percentile_int(book_2025_percentile).present? ? "P#{representation_percentile_int(book_2025_percentile)}" : nil),
          subvalue_class_name: representation_percentile_color_class(book_2025_percentile),
          class_name: "w-full",
          value_class_name: "text-[11px]"
        } %>

        <%= render partial: "salary_book/kpi_cell", locals: {
          label: format_year_label(2026),
          value: compact.call(book_2026),
          subvalue: (representation_percentile_int(book_2026_percentile).present? ? "P#{representation_percentile_int(book_2026_percentile)}" : nil),
          subvalue_class_name: representation_percentile_color_class(book_2026_percentile),
          class_name: "w-full",
          value_class_name: "text-[11px]"
        } %>

        <%= render partial: "salary_book/kpi_cell", locals: {
          label: format_year_label(2027),
          value: compact.call(book_2027),
          subvalue: (representation_percentile_int(book_2027_percentile).present? ? "P#{representation_percentile_int(book_2027_percentile)}" : nil),
          subvalue_class_name: representation_percentile_color_class(book_2027_percentile),
          class_name: "w-full",
          value_class_name: "text-[11px]"
        } %>
      </div>

    </div>

    <%# ── Contract mix ── %>
    <div class="border-t border-border pt-4 space-y-2">
      <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Contract mix</div>

      <div class="space-y-0.5">
        <div class="flex items-center justify-between py-1.5">
          <span class="text-sm text-muted-foreground">Max-level (≥25% cap)</span>
          <span class="tabular-nums text-sm font-medium"><%= max_contract_count %></span>
        </div>

        <div class="flex items-center justify-between py-1.5">
          <span class="text-sm text-muted-foreground">Rookie-scale</span>
          <span class="tabular-nums text-sm font-medium"><%= rookie_scale_count %></span>
        </div>

        <div class="flex items-center justify-between py-1.5">
          <span class="text-sm text-muted-foreground">Minimum</span>
          <span class="tabular-nums text-sm font-medium"><%= min_contract_count %></span>
        </div>
      </div>
    </div>

    <%# ── Upcoming events + flags ── %>
    <% if total_expiring > 0 || has_options || has_restrictions || has_prior_year_now_fa %>
      <div class="border-t border-border pt-4 space-y-2">
        <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Upcoming</div>

        <div class="space-y-0.5">
          <% if expiring_2025 > 0 %>
            <div class="flex items-center justify-between py-1.5">
              <span class="text-sm text-muted-foreground">FA after <%= format_year_label(2025) %></span>
              <span class="tabular-nums text-sm font-medium text-orange-600 dark:text-orange-400"><%= expiring_2025 %></span>
            </div>
          <% end %>

          <% if has_prior_year_now_fa %>
            <div class="flex items-center justify-between py-1.5">
              <span class="text-sm text-muted-foreground">Last year NBA, now FA</span>
              <span class="tabular-nums text-sm font-medium"><%= prior_year_nba_now_free_agent_count %></span>
            </div>
          <% end %>

          <% if player_option_count > 0 %>
            <div class="flex items-center justify-between py-1.5">
              <span class="text-sm text-muted-foreground">Player option decisions</span>
              <span class="tabular-nums text-sm font-medium"><%= player_option_count %></span>
            </div>
          <% end %>

          <% if team_option_count > 0 %>
            <div class="flex items-center justify-between py-1.5">
              <span class="text-sm text-muted-foreground">Team option decisions</span>
              <span class="tabular-nums text-sm font-medium"><%= team_option_count %></span>
            </div>
          <% end %>
        </div>

        <% if has_restrictions %>
          <div class="pt-1 flex flex-wrap gap-1.5">
            <% if no_trade_count > 0 %>
              <span class="entity-chip entity-chip--danger"><%= no_trade_count %> No-Trade</span>
            <% end %>
            <% if trade_kicker_count > 0 %>
              <span class="entity-chip entity-chip--warning"><%= trade_kicker_count %> Trade Kicker</span>
            <% end %>
            <% if trade_restricted_count > 0 %>
              <span class="entity-chip entity-chip--danger"><%= trade_restricted_count %> Restricted</span>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>

    <%# ── Client roster ── %>
    <div class="border-t border-border pt-4 space-y-2">
      <div class="flex items-center justify-between">
        <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Clients</div>
        <div class="text-[10px] text-muted-foreground tabular-nums">
          <%= total_count %> player<%= total_count != 1 ? "s" : "" %>
        </div>
      </div>

      <% if clients.empty? %>
        <div class="p-4 rounded-lg bg-muted/30 text-sm text-muted-foreground italic text-center">No NBA clients found</div>
      <% else %>
        <div class="divide-y divide-border/50">
          <% clients.each do |client| %>
            <%
              player_id = client["player_id"]
              team_code = client["team_code"] || "—"
              team_id = client["team_id"]
              team_name = client["team_name"] || team_code

              row_name = presenter.client_row_name(client)

              yos_label = player_years_of_service_display(client)

              current_salary = client["cap_2025"].to_f

              logo_url = team_logo_url(team_id)

              contract_marker = presenter.next_contract_marker(client)
            %>

            <button
              type="button"
              class="cursor-pointer w-full text-left flex items-center justify-between gap-2 py-0.5 px-1.5 rounded-md hover:bg-muted/50 transition-colors
                     focus-visible:outline-none focus-visible:ring-0 focus-visible:border-foreground dark:focus-visible:border-foreground"
              data-on:click="@get('<%= salary_book_sidebar_player_path(id: player_id) %>')"
            >
              <%# Team avatar + headshot %>
              <div class="flex items-center gap-1.5 flex-shrink-0">
                <div
                  class="w-7 h-7 rounded-full border border-border bg-background overflow-hidden flex items-center justify-center"
                  title="<%= team_name %>"
                  aria-label="<%= team_name %>"
                >
                  <% if logo_url.present? %>
                    <img
                      src="<%= logo_url %>"
                      alt="<%= team_name %> logo"
                      class="w-full h-full object-contain p-0.5"
                      loading="lazy"
                      decoding="async"
                      onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                    />
                    <span class="hidden text-[9px] font-semibold text-muted-foreground"><%= team_code %></span>
                  <% else %>
                    <span class="text-[9px] font-semibold text-muted-foreground"><%= team_code %></span>
                  <% end %>
                </div>

                <div class="w-7 h-7 rounded border border-border bg-background overflow-hidden">
                  <img
                    src="<%= player_headshot_url(player_id) %>"
                    alt="<%= row_name %>"
                    class="w-full h-full object-cover object-top bg-muted"
                    loading="lazy"
                    decoding="async"
                    onerror="if (this.src !== '<%= fallback_headshot_data_uri %>') { this.src = '<%= fallback_headshot_data_uri %>'; }"
                  />
                </div>
              </div>

              <%# Player info %>
              <div class="flex-1 min-w-0">
                <div class="h-[26px] flex items-end gap-1 min-w-0">
                  <div class="font-medium text-[14px] truncate"><%= row_name %></div>
                </div>
                <div class="h-[18px] -mt-px flex items-start min-w-0 leading-none text-[10px] text-muted-foreground/80 tabular-nums overflow-hidden">
                  <% if yos_label.present? || contract_marker.present? %>
                    <div class="flex items-start min-w-0 overflow-hidden whitespace-nowrap">
                      <% if yos_label.present? %>
                        <span class="truncate"><%= yos_label %></span>
                      <% end %>

                      <% if contract_marker.present? %>
                        <% if yos_label.present? %>
                          <span class="px-1 text-muted-foreground/50">·</span>
                        <% end %>
                        <span class="shrink-0 font-medium <%= contract_marker[:classes] %>"><%= contract_marker[:label] %></span>
                      <% end %>
                    </div>
                  <% else %>
                    <span class="text-muted-foreground/50">—</span>
                  <% end %>
                </div>
              </div>

              <%# Salary info %>
              <div class="flex-shrink-0 text-right">
                <% if client["is_two_way"] %>
                  <div class="grid place-items-center h-[44px]">
                    <span class="inline-flex items-center justify-center text-[10px] px-1.5 py-0.5 rounded font-medium <%= neutral_badge_classes %>">Two-Way</span>
                  </div>
                <% elsif current_salary > 0 %>
                  <div class="h-[26px] flex items-end justify-end">
                    <div class="tabular-nums text-sm font-medium whitespace-nowrap"><%= compact.call(current_salary) %></div>
                  </div>
                  <div class="h-[18px] -mt-px flex items-start justify-end">
                    <% total_value = presenter.total_contract_value(client) %>
                    <div class="text-[10px] leading-none tabular-nums whitespace-nowrap text-muted-foreground"><%= compact.call(total_value) %> total</div>
                  </div>
                <% else %>
                  <div class="grid place-items-center h-[44px]">
                    <div class="text-[10px] leading-none tabular-nums text-muted-foreground/60 italic whitespace-nowrap">No salary</div>
                  </div>
                <% end %>
              </div>

              <%# Chevron %>
              <%= lucide_icon("chevron-right", class: "w-4 h-4 text-muted-foreground/50", "aria-hidden": true) %>
            </button>
          <% end %>
        </div>
      <% end %>
    </div>

  </div>
</div>
