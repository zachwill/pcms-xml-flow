<% horizon_years = (2025..2030).to_a %>
<% protection_rows = Array(@protection_rows) %>
<% protection_condition_rows = Array(@protection_condition_rows) %>
<% payment_schedule_rows = Array(@payment_schedule_rows) %>

<section id="guarantees" class="space-y-3">
  <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Guarantees + protections</h2>
  <details class="rounded-lg border border-border bg-background p-3" open>
    <summary class="cursor-pointer text-sm font-medium">Guarantee matrix + protection detail</summary>
    <div class="mt-3 space-y-3">
      <div class="overflow-x-auto rounded-lg border border-border">
        <table class="entity-table min-w-full text-xs">
          <thead class="bg-muted/40 text-[10px] uppercase tracking-wide text-muted-foreground/90">
            <tr>
              <th class="text-left px-3 py-2 font-medium">Year</th>
              <th class="text-right px-3 py-2 font-medium">Guaranteed amount</th>
              <th class="text-left px-3 py-2 font-medium">Guarantee type</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-border">
            <% horizon_years.each do |year| %>
              <% guaranteed_amount = @salary_book_row&.fetch("guaranteed_amount_#{year}", nil) %>
              <% is_full = @salary_book_row&.fetch("is_fully_guaranteed_#{year}", nil) %>
              <% is_partial = @salary_book_row&.fetch("is_partially_guaranteed_#{year}", nil) %>
              <% is_non = @salary_book_row&.fetch("is_non_guaranteed_#{year}", nil) %>
              <% type = is_full ? "FULL" : (is_partial ? "PARTIAL" : (is_non ? "NON" : nil)) %>
              <tr class="hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 transition-colors duration-75">
                <td class="px-3 py-2 font-mono tabular-nums"><%= year %></td>
                <td class="px-3 py-2 text-right font-mono tabular-nums"><%= format_salary(guaranteed_amount) %></td>
                <td class="px-3 py-2 text-muted-foreground"><%= type.presence || "—" %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

      <% if protection_rows.any? %>
        <div class="overflow-x-auto rounded-lg border border-border">
          <table class="entity-table min-w-full text-xs">
            <thead class="bg-muted/40 text-[10px] uppercase tracking-wide text-muted-foreground/90">
              <tr>
                <th class="text-left px-3 py-2 font-medium">Year</th>
                <th class="text-right px-3 py-2 font-medium">Protection</th>
                <th class="text-right px-3 py-2 font-medium">Effective</th>
                <th class="text-left px-3 py-2 font-medium">Coverage</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-border">
              <% protection_rows.each do |r| %>
                <tr class="hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 transition-colors duration-75">
                  <td class="px-3 py-2 font-mono tabular-nums"><%= r["salary_year"] %></td>
                  <td class="px-3 py-2 text-right font-mono tabular-nums"><%= format_salary(r["protection_amount"]) %></td>
                  <td class="px-3 py-2 text-right font-mono tabular-nums"><%= format_salary(r["effective_protection_amount"]) %></td>
                  <td class="px-3 py-2 text-muted-foreground"><%= r["coverage_codes"].presence || "—" %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>

      <% if protection_condition_rows.any? %>
        <div class="overflow-x-auto rounded-lg border border-border">
          <table class="entity-table min-w-full text-xs">
            <thead class="bg-muted/40 text-[10px] uppercase tracking-wide text-muted-foreground/90">
              <tr>
                <th class="text-left px-3 py-2 font-medium">Year</th>
                <th class="text-right px-3 py-2 font-medium">Amount</th>
                <th class="text-left px-3 py-2 font-medium">Earned</th>
                <th class="text-left px-3 py-2 font-medium">Clause</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-border">
              <% protection_condition_rows.each do |r| %>
                <tr class="hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 transition-colors duration-75">
                  <td class="px-3 py-2 font-mono tabular-nums"><%= r["salary_year"] || "—" %></td>
                  <td class="px-3 py-2 text-right font-mono tabular-nums"><%= format_salary(r["amount"]) %></td>
                  <td class="px-3 py-2 text-muted-foreground"><%= r["earned_type_lk"].presence || "—" %> · <%= format_plain_date(r["earned_date"]) %></td>
                  <td class="px-3 py-2"><%= r["clause_name"].presence || r["criteria_description"].presence || "—" %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>

      <% if payment_schedule_rows.any? %>
        <div class="overflow-x-auto rounded-lg border border-border">
          <table class="entity-table min-w-full text-xs">
            <thead class="bg-muted/40 text-[10px] uppercase tracking-wide text-muted-foreground/90">
              <tr>
                <th class="text-left px-3 py-2 font-medium">Year</th>
                <th class="text-right px-3 py-2 font-medium">Payment</th>
                <th class="text-left px-3 py-2 font-medium">Schedule</th>
                <th class="text-left px-3 py-2 font-medium">Window</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-border">
              <% payment_schedule_rows.each do |r| %>
                <tr class="hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 transition-colors duration-75">
                  <td class="px-3 py-2 font-mono tabular-nums"><%= r["salary_year"] %></td>
                  <td class="px-3 py-2 text-right font-mono tabular-nums"><%= format_salary(r["payment_amount"]) %></td>
                  <td class="px-3 py-2 text-muted-foreground"><%= [r["schedule_type_lk"], r["payment_type_lk"]].compact.reject(&:blank?).join(" · ").presence || "—" %></td>
                  <td class="px-3 py-2 text-muted-foreground"><%= format_plain_date(r["first_payment_date"]) %> → <%= format_plain_date(r["last_payment_date"]) %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
    </div>
  </details>
</section>
