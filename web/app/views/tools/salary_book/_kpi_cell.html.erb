<%#
  KpiCell â€” Tailwind port of the React prototype component

  Locals:
  - label: optional string
  - value: optional string/HTML
  - title: optional string (tooltip)
  - variant: "default" | "positive" | "negative" | "muted" | "option_po" | "option_to" | "option_eto"
  - dark: boolean (totals footer)
  - class_name: extra classes for the outer box
  - label_class_name: extra classes for the label
  - value_class_name: extra classes for the value
  - subvalue: optional tiny 2nd line (e.g. percentile tag)
  - subvalue_class_name: extra classes for subvalue
  - corner_badge_text: optional tiny badge text
  - corner_badge_icon: optional icon key (currently supports "repeat")
  - corner_badge_title: optional tooltip for corner badge
  - corner_badge_class_name: optional classes for corner badge
%>

<% label = local_assigns.fetch(:label, nil) %>
<% value = local_assigns.fetch(:value, nil) %>
<% subvalue = local_assigns.fetch(:subvalue, nil) %>
<% title = local_assigns.fetch(:title, nil) %>
<% variant = local_assigns.fetch(:variant, "default") %>
<% dark = local_assigns.fetch(:dark, false) %>
<% class_name = local_assigns.fetch(:class_name, "") %>
<% label_class_name = local_assigns.fetch(:label_class_name, "") %>
<% value_class_name = local_assigns.fetch(:value_class_name, "") %>
<% subvalue_class_name = local_assigns.fetch(:subvalue_class_name, "") %>
<% corner_badge_text = local_assigns.fetch(:corner_badge_text, nil) %>
<% corner_badge_icon = local_assigns.fetch(:corner_badge_icon, nil) %>
<% corner_badge_title = local_assigns.fetch(:corner_badge_title, nil) %>
<% corner_badge_class_name = local_assigns.fetch(:corner_badge_class_name, "") %>

<%
  value_color = {
    "default" => "text-foreground",
    "positive" => "text-green-600 dark:text-green-400",
    "negative" => "text-red-500",
    "muted" => "text-muted-foreground/60",
    "option_po" => "text-blue-700 dark:text-blue-300",
    "option_to" => "text-purple-700 dark:text-purple-300",
    "option_eto" => "text-orange-700 dark:text-orange-300"
  }[variant] || "text-foreground"

  dark_value_color = {
    "default" => "text-zinc-100 dark:text-foreground",
    "positive" => "text-green-400",
    "negative" => "text-red-400 dark:text-red-500",
    "muted" => "text-zinc-500 dark:text-muted-foreground/60",
    "option_po" => "text-blue-700 dark:text-blue-300",
    "option_to" => "text-purple-700 dark:text-purple-300",
    "option_eto" => "text-orange-700 dark:text-orange-300"
  }[variant] || "text-zinc-100 dark:text-foreground"

  option_bg = {
    "option_po" => "bg-blue-100/60 dark:bg-blue-900/30",
    "option_to" => "bg-purple-100/60 dark:bg-purple-900/30",
    "option_eto" => "bg-orange-100/60 dark:bg-orange-900/30"
  }[variant]

  label_color = {
    "option_po" => "text-blue-700/80 dark:text-blue-300/80",
    "option_to" => "text-purple-700/80 dark:text-purple-300/80",
    "option_eto" => "text-orange-700/80 dark:text-orange-300/80"
  }[variant] || (dark ? "text-zinc-400 dark:text-muted-foreground" : "text-muted-foreground")

  has_label = label.present?
  has_subvalue = subvalue.present?
  has_corner_badge = corner_badge_text.present? || corner_badge_icon.present?

  # Determine if class_name overrides background (contains 'bg-')
  has_custom_bg = class_name.to_s.include?("bg-")
  default_bg = if has_custom_bg
    ""
  elsif option_bg.present?
    option_bg
  else
    dark ? "bg-zinc-700 dark:bg-zinc-700/80" : "bg-zinc-200/80 dark:bg-zinc-700/80"
  end

  subvalue_color = dark ? "text-zinc-400/90 dark:text-zinc-300/80" : "text-muted-foreground/80"
  height_class = has_subvalue ? "h-12" : "h-10"
%>

<div
  class="relative w-20 <%= height_class %> rounded flex flex-col items-center justify-center text-center px-1 <%= default_bg %> <%= class_name %>"
  <% if title.present? %>title="<%= title %>"<% end %>
>
  <% if has_corner_badge %>
    <span
      class="absolute -right-1.5 -bottom-1.5 inline-flex items-center justify-center leading-none pointer-events-auto cursor-help <%= corner_badge_class_name.presence || 'size-4 rounded-full bg-purple-600 text-white border border-zinc-200 dark:border-zinc-700' %>"
      <% if corner_badge_title.present? %>title="<%= corner_badge_title %>"<% end %>
    >
      <% if corner_badge_icon == "repeat" %>
        <svg viewBox="0 0 20 20" class="size-2.5" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
          <path d="M4 7h8"></path>
          <path d="m10 4 3 3-3 3"></path>
          <path d="M16 13H8"></path>
          <path d="m10 10-3 3 3 3"></path>
        </svg>
      <% else %>
        <span class="text-[8px] font-semibold"><%= corner_badge_text %></span>
      <% end %>
    </span>
  <% end %>
  <% if has_label %>
    <span class="text-[9px] uppercase tracking-wide font-medium leading-none <%= label_color %> <%= label_class_name %>">
      <%= label %>
    </span>
  <% end %>

  <% if value != nil %>
    <span class="text-xs tabular-nums font-semibold leading-tight <%= has_label ? 'mt-0.5' : '' %> <%= dark ? dark_value_color : value_color %> <%= value_class_name %>">
      <%= value %>
    </span>
  <% end %>

  <% if has_subvalue %>
    <span class="mt-0.5 text-[9px] leading-none tabular-nums <%= subvalue_color %> <%= subvalue_class_name %>">
      <%= subvalue %>
    </span>
  <% end %>
</div>
