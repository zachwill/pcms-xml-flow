<section id="apron-provenance" class="space-y-3">
  <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Apron provenance</h2>
  <details class="rounded-lg border border-border bg-background" open>
    <summary class="cursor-pointer px-4 py-3 text-sm font-medium hover:bg-muted/30">
      Yearly apron status + constraints
      <span class="ml-2 text-xs text-muted-foreground">(<%= @apron_provenance_rows.size %> years)</span>
    </summary>
    <div class="px-4 pb-4">
      <% if @apron_provenance_rows.empty? %>
        <div class="p-4 rounded-lg bg-muted/30 border border-border/50 text-sm text-muted-foreground italic">No team tax summary snapshot rows for 2025–2031.</div>
      <% else %>
        <div class="overflow-x-auto rounded-lg border border-border mt-3">
          <table class="entity-table min-w-full text-xs">
            <thead class="bg-muted/40 text-[10px] uppercase tracking-wide text-muted-foreground/90">
              <tr>
                <th class="text-left px-3 py-2 font-medium">Year</th>
                <th class="text-left px-3 py-2 font-medium">Apron status</th>
                <th class="text-left px-3 py-2 font-medium">Reason</th>
                <th class="text-left px-3 py-2 font-medium">A1/A2 tx</th>
                <th class="text-left px-3 py-2 font-medium">Constraints</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-border">
              <% @apron_provenance_rows.each do |r| %>
                <% constraint_lines = r["constraint_lines"].to_s.split("\n").reject(&:blank?) %>
                <tr class="hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 transition-colors duration-75 align-top">
                  <td class="px-3 py-2 font-mono tabular-nums"><%= r["salary_year"] %></td>
                  <td class="px-3 py-2 text-muted-foreground"><%= yes_no(r["is_subject_to_apron"]) %> <%= r["apron_level_lk"].present? ? "· #{r['apron_level_lk']}" : "" %></td>
                  <td class="px-3 py-2 text-muted-foreground"><%= r["subject_to_apron_reason_lk"].presence || "—" %></td>
                  <td class="px-3 py-2 text-xs">
                    <% if r["apron1_transaction_id"].present? %>
                      <a href="<%= transaction_href(r['apron1_transaction_id']) %>" class="hover:underline font-mono">A1 #<%= r["apron1_transaction_id"] %></a>
                    <% else %>
                      <span class="text-muted-foreground">A1 —</span>
                    <% end %>
                    <span class="mx-1 text-muted-foreground">·</span>
                    <% if r["apron2_transaction_id"].present? %>
                      <a href="<%= transaction_href(r['apron2_transaction_id']) %>" class="hover:underline font-mono">A2 #<%= r["apron2_transaction_id"] %></a>
                    <% else %>
                      <span class="text-muted-foreground">A2 —</span>
                    <% end %>
                  </td>
                  <td class="px-3 py-2 text-muted-foreground">
                    <% if constraint_lines.any? %>
                      <ul class="space-y-0.5">
                        <% constraint_lines.each do |line| %><li><%= line %></li><% end %>
                      </ul>
                    <% else %>
                      —
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      <% end %>
    </div>
  </details>
</section>
