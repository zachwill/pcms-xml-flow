<%
  row = @selected_row
  team_code = row["team_code"].to_s.upcase
  logo_url = team_logo_url(row["team_id"])
  conference_name = row["conference_name"].presence || "—"

  cap_space = row["cap_space"]
  tax_overage = row["tax_overage"]
  room_tax = row["room_under_tax"]
  room_a1 = row["room_under_apron1"]
  room_a2 = row["room_under_apron2"]
  luxury_tax_owed = row["luxury_tax_owed"]

  ordered_team_codes = @rows.map { |candidate| candidate["team_code"].to_s.upcase }.select { |code| code.match?(/\A[A-Z]{3}\z/) }
  selected_index = ordered_team_codes.index(team_code)
  can_step_prev = selected_index.present? && selected_index.positive?
  can_step_next = selected_index.present? && selected_index < (ordered_team_codes.length - 1)
  selected_position_label = if selected_index.present?
    "#{selected_index + 1} / #{ordered_team_codes.length}"
  else
    "—"
  end

  step_state_query_expr = team_summary_state_query_expr(selected_expression: "$selectedteam || '#{team_code}'")
  prev_step_expr = "@get('#{team_summary_sse_step_path}?direction=prev&' + (#{step_state_query_expr}))"
  next_step_expr = "@get('#{team_summary_sse_step_path}?direction=next&' + (#{step_state_query_expr}))"

  pressure_bucket = row["pressure_bucket"].to_s
  pressure_label, pressure_chip_classes = case pressure_bucket
    when "over_apron2"
      ["Over Apron 2", "entity-chip entity-chip--danger"]
    when "over_apron1"
      ["Over Apron 1", "entity-chip entity-chip--warning"]
    when "over_tax"
      ["Over Tax", "entity-chip entity-chip--warning"]
    when "over_cap"
      ["Over Cap", "entity-chip entity-chip--muted"]
    else
      ["Under Cap", "entity-chip entity-chip--success"]
    end
%>

<div id="rightpanel-overlay" class="h-full bg-background">
  <div class="sticky top-0 z-20 h-10 px-4 flex items-center justify-between border-b border-border bg-background">
    <%= render partial: "shared/rightpanel_back_button", locals: {
      click_expr: "$selectedteam = ''; @get('#{team_summary_sidebar_clear_path}')",
      hook_data_attribute: "data-team-summary-overlay-clear"
    } %>

    <a
      class="text-xs text-muted-foreground hover:text-foreground hover:underline"
      href="<%= team_href(team_code: team_code, team_id: row['team_id']) %>"
    >Open team page</a>
  </div>

  <div class="px-4 py-4 overflow-y-auto h-[calc(100%-40px)]">
    <section>
      <div class="flex items-center gap-3">
        <div class="w-11 h-11 rounded border border-border bg-background overflow-hidden flex items-center justify-center shrink-0">
          <% if logo_url.present? %>
            <img
              src="<%= logo_url %>"
              alt="<%= row['team_name'] %> logo"
              class="w-full h-full object-contain"
              loading="lazy"
              decoding="async"
              onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
            />
            <span class="hidden text-[10px] font-semibold text-muted-foreground"><%= team_code %></span>
          <% else %>
            <span class="text-[10px] font-semibold text-muted-foreground"><%= team_code %></span>
          <% end %>
        </div>

        <div class="min-w-0">
          <h2 class="text-base font-semibold truncate"><%= row["team_name"] %></h2>
          <div class="text-[11px] text-muted-foreground/80"><%= team_code %> · <%= conference_name %> · <%= format_year_label(@selected_year) %></div>
        </div>
      </div>

      <div class="mt-2 flex flex-wrap items-center gap-1.5 text-[10px]">
        <span class="entity-chip entity-chip--muted">Row <%= selected_position_label %></span>
        <span class="<%= pressure_chip_classes %>"><%= pressure_label %></span>
        <% if row["is_repeater_taxpayer"] %>
          <span class="entity-chip entity-chip--danger">Repeater</span>
        <% elsif row["is_taxpayer"] %>
          <span class="entity-chip entity-chip--warning">Taxpayer</span>
        <% end %>
      </div>
    </section>

    <section class="mt-4 border-t border-border pt-3 space-y-2">
      <div class="flex items-center justify-between gap-2">
        <div class="text-[10px] uppercase tracking-wide font-semibold text-muted-foreground/80">Browse in current view</div>
        <div class="text-[10px] tabular-nums text-muted-foreground"><%= selected_position_label %></div>
      </div>

      <div class="grid grid-cols-2 gap-2">
        <button
          type="button"
          class="cursor-pointer h-8 rounded border border-border text-[11px] font-medium hover:bg-muted transition-colors disabled:cursor-not-allowed disabled:opacity-50"
          data-team-summary-step-prev
          data-on:click="<%= prev_step_expr %>"
          <%= "disabled" unless can_step_prev %>
        >← Prev</button>

        <button
          type="button"
          class="cursor-pointer h-8 rounded border border-border text-[11px] font-medium hover:bg-muted transition-colors disabled:cursor-not-allowed disabled:opacity-50"
          data-team-summary-step-next
          data-on:click="<%= next_step_expr %>"
          <%= "disabled" unless can_step_next %>
        >Next →</button>
      </div>
    </section>

    <section class="mt-4 border-t border-border pt-4">
      <div class="grid grid-cols-2 gap-1.5">
        <%= render partial: "salary_book/kpi_cell", locals: {
          label: "Cap space",
          value: cap_space.nil? ? "—" : format_room_amount(cap_space),
          class_name: "w-full",
          variant: (cap_space.to_f < 0 ? "negative" : "positive")
        } %>

        <%= render partial: "salary_book/kpi_cell", locals: {
          label: "Tax overage",
          value: tax_overage.to_f > 0 ? format_compact_currency(tax_overage) : "—",
          class_name: "w-full",
          variant: (tax_overage.to_f > 0 ? "negative" : "default")
        } %>

        <%= render partial: "salary_book/kpi_cell", locals: {
          label: "Room tax",
          value: room_tax.nil? ? "—" : format_room_amount(room_tax),
          class_name: "w-full",
          variant: (room_tax.to_f < 0 ? "negative" : "default")
        } %>

        <%= render partial: "salary_book/kpi_cell", locals: {
          label: "Room A1",
          value: room_a1.nil? ? "—" : format_room_amount(room_a1),
          class_name: "w-full",
          variant: (room_a1.to_f < 0 ? "negative" : "default")
        } %>

        <%= render partial: "salary_book/kpi_cell", locals: {
          label: "Room A2",
          value: room_a2.nil? ? "—" : format_room_amount(room_a2),
          class_name: "w-full",
          variant: (room_a2.to_f < 0 ? "negative" : "default")
        } %>

        <%= render partial: "salary_book/kpi_cell", locals: {
          label: "Tax owed",
          value: luxury_tax_owed.to_f > 0 ? format_compact_currency(luxury_tax_owed) : "—",
          class_name: "w-full",
          variant: (luxury_tax_owed.to_f > 0 ? "negative" : "default")
        } %>
      </div>
    </section>

    <section class="mt-4 border-t border-border pt-4 space-y-2">
      <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Pressure signals</div>

      <div class="space-y-0.5">
        <div class="flex items-center justify-between py-1.5 gap-2">
          <span class="text-sm text-muted-foreground">Current bucket</span>
          <span class="<%= pressure_chip_classes %>"><%= pressure_label %></span>
        </div>

        <div class="flex items-center justify-between py-1.5 gap-2">
          <span class="text-sm text-muted-foreground">Luxury tax owed</span>
          <span class="text-sm font-medium font-mono tabular-nums <%= luxury_tax_owed.to_f > 0 ? 'text-red-600 dark:text-red-400' : 'text-muted-foreground' %>"><%= luxury_tax_owed.to_f > 0 ? format_compact_currency(luxury_tax_owed) : "—" %></span>
        </div>

        <div class="flex items-center justify-between py-1.5 gap-2">
          <span class="text-sm text-muted-foreground">Roster / Two-way</span>
          <span class="text-sm font-medium font-mono tabular-nums"><%= row["roster_row_count"].to_i %> / <%= row["two_way_row_count"].to_i %></span>
        </div>
      </div>
    </section>

    <section class="mt-4 border-t border-border pt-3 space-y-1.5 text-[11px]">
      <div class="text-[10px] uppercase tracking-wide font-semibold text-muted-foreground/80">Pivots</div>
      <a class="block text-muted-foreground hover:text-foreground hover:underline" href="<%= team_href(team_code: team_code, team_id: row['team_id']) %>">Open canonical team page</a>
      <a class="block text-muted-foreground hover:text-foreground hover:underline" href="<%= salary_book_path(team: team_code, year: @selected_year, view: "salary-book") %>">Open Salary Book at <%= team_code %></a>
      <a class="block text-muted-foreground hover:text-foreground hover:underline" href="<%= team_summary_path(@state_params.merge(selected: team_code)) %>">Share this Team Summary state</a>
    </section>
  </div>
</div>
