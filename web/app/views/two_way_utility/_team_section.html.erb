<% players ||= [] %>
<% team_meta ||= {} %>
<% team_capacity ||= {} %>
<% state_query ||= "" %>

<% team_row = players.first || {} %>
<% team_name = team_row["team_name"].presence || team_meta["team_name"].presence || team_code %>
<% conference_name = team_row["conference_name"].presence || team_meta["conference_name"].presence || "—" %>
<% team_id = team_meta["team_id"] || team_row["team_id"] %>
<% logo_url = team_logo_url(team_id) %>

<% standard_contracts = team_row["team_current_contract_count"] || team_capacity["team_current_contract_count"] %>
<% two_way_contracts = team_row["team_two_way_contract_count"] || players.size %>
<% games_remaining_context = team_row["team_games_remaining_context"] || team_capacity["team_games_remaining_context"] %>
<% under_15_context = if team_row.key?("team_is_under_15_contracts")
  team_row["team_is_under_15_contracts"]
else
  team_capacity["team_is_under_15_contracts"]
end %>

<% critical_count = players.count { |row| row["risk_tier"] == "critical" } %>
<% low_remaining_count = players.count { |row| row["remaining_active_list_games"].present? && row["remaining_active_list_games"].to_i <= 20 } %>
<% estimate_count = players.count { |row| row["limit_status_chip"].present? } %>

<% games_remaining_number = games_remaining_context&.to_i %>
<% games_remaining_variant = games_remaining_number && games_remaining_number < 30 ? "negative" : "default" %>
<% under_15_label = under_15_context.nil? ? "—" : (under_15_context ? "<15 Std" : "15 Std") %>
<% under_15_variant = under_15_context.nil? ? "muted" : "default" %>

<%
  sticky_left_px = 208
  salary_col_px = 96
  date_col_px = 112
  agent_col_px = 160
  min_table_width_px = sticky_left_px + (salary_col_px * 5) + (date_col_px * 2) + agent_col_px
%>

<section id="<%= team_code %>" data-teamcode="<%= team_code %>" class="border-b border-border snap-start scroll-mt-[172px]">
  <div class="relative" data-two-way-table>
    <div class="sticky top-0 z-30 bg-background will-change-transform shadow-[0_1px_3px_0_rgb(0_0_0/0.08),0_1px_2px_-1px_rgb(0_0_0/0.08)]">
      <div data-header-content>
        <div class="h-14 flex items-center border-b border-border bg-muted">
          <div class="w-52 shrink-0 pl-4 flex items-center gap-3">
            <div class="w-8 h-8 rounded flex items-center justify-center flex-shrink-0 bg-background border border-border overflow-hidden">
              <% if logo_url %>
                <img
                  src="<%= logo_url %>"
                  alt="<%= team_name %> logo"
                  class="w-full h-full object-contain"
                  onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                />
                <span class="hidden text-[10px] font-mono font-bold uppercase tracking-tight text-muted-foreground"><%= team_code %></span>
              <% else %>
                <span class="text-[10px] font-mono font-bold uppercase tracking-tight text-muted-foreground"><%= team_code %></span>
              <% end %>
            </div>

            <div class="grid grid-rows-[24px_16px] min-w-0">
              <div class="h-[24px] flex items-end min-w-0">
                <span class="font-semibold leading-tight text-[14px] block w-full truncate"><%= team_name %></span>
              </div>
              <div class="h-[16px] -mt-px flex items-start min-w-0 gap-1.5">
                <span class="text-[10px] leading-none tabular-nums text-muted-foreground/80 truncate"><%= conference_name %> Conference</span>
              </div>
            </div>
          </div>

          <div class="flex items-center">
            <div class="w-24 shrink-0 flex justify-center">
              <%= render partial: "salary_book/kpi_cell", locals: {
                label: "Roster",
                value: (standard_contracts || "—").to_s,
                title: "Current roster contracts"
              } %>
            </div>

            <div class="w-24 shrink-0 flex justify-center">
              <%= render partial: "salary_book/kpi_cell", locals: {
                label: "Two-Way",
                value: (two_way_contracts || "—").to_s,
                title: "Current two-way contracts"
              } %>
            </div>

            <div class="w-24 shrink-0 flex justify-center">
              <%= render partial: "salary_book/kpi_cell", locals: {
                label: "Critical",
                value: critical_count.to_s,
                title: "Players with 10 or fewer active-list games left",
                variant: (critical_count.positive? ? "negative" : "muted")
              } %>
            </div>

            <div class="w-24 shrink-0 flex justify-center">
              <%= render partial: "salary_book/kpi_cell", locals: {
                label: "≤20",
                value: low_remaining_count.to_s,
                title: "Players with 20 or fewer active-list games left",
                variant: (low_remaining_count.positive? ? "negative" : "muted")
              } %>
            </div>

            <div class="w-24 shrink-0 flex justify-center">
              <%= render partial: "salary_book/kpi_cell", locals: {
                label: "Games Left",
                value: (games_remaining_context || "—").to_s,
                title: "Remaining active-list games context",
                variant: games_remaining_variant
              } %>
            </div>

            <div class="w-28 shrink-0 flex justify-center">
              <%= render partial: "salary_book/kpi_cell", locals: {
                label: "Context",
                value: under_15_label,
                title: "Whether under-15 or 15-standard context applies",
                variant: under_15_variant,
                class_name: "w-24"
              } %>
            </div>

            <div class="w-28 shrink-0 flex justify-center">
              <%= render partial: "salary_book/kpi_cell", locals: {
                label: "Est.",
                value: estimate_count.to_s,
                title: "Rows with estimated active-list game limits",
                class_name: "w-20"
              } %>
            </div>

            <div class="w-40 shrink-0"></div>
          </div>
        </div>

        <div
          data-two-way-table-header-scroll
          class="overflow-x-auto overscroll-x-contain [scrollbar-width:none] [-ms-overflow-style:none] [&::-webkit-scrollbar]:hidden"
        >
          <div class="min-w-max" style="min-width: <%= min_table_width_px %>px;">
            <div class="border-b border-border bg-background">
              <div class="h-8 flex items-center text-xs font-medium text-muted-foreground select-none cursor-default">
                <div
                  class="w-52 shrink-0 pl-4 sticky left-0 z-[2] bg-background relative
                         after:absolute after:right-0 after:top-0 after:bottom-0 after:w-px after:bg-border/50"
                >
                  Name / Details
                </div>
                <div class="w-24 shrink-0 text-center tabular-nums">25-26</div>
                <div class="w-24 shrink-0 text-center tabular-nums">26-27</div>
                <div class="w-24 shrink-0 text-center tabular-nums">Used</div>
                <div class="w-24 shrink-0 text-center tabular-nums">Limit</div>
                <div class="w-24 shrink-0 text-center tabular-nums">Remain</div>
                <div class="w-28 shrink-0 text-center tabular-nums">Last Game</div>
                <div class="w-28 shrink-0 text-center tabular-nums">Signed</div>
                <div class="w-40 shrink-0 text-left tabular-nums">Agent / Agency</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div
      data-two-way-table-sticky-shadow
      class="absolute top-0 bottom-0 pointer-events-none z-20 transition-opacity duration-150 opacity-0"
      style="left: <%= sticky_left_px %>px; width: 6px; background: linear-gradient(to right, rgba(0, 0, 0, 0.08), transparent);"
      aria-hidden="true"
    ></div>

    <div
      data-two-way-table-body-scroll
      class="overflow-x-auto overscroll-x-contain relative [scrollbar-width:none] [-ms-overflow-style:none] [&::-webkit-scrollbar]:hidden"
    >
      <div class="min-w-max" style="min-width: <%= min_table_width_px %>px;">
        <div class="[&>*:first-child]:mt-1">
          <% if players.any? %>
            <% players.each do |player| %>
              <%= render partial: "two_way_utility/player_row", locals: { player: player, state_query: state_query } %>
            <% end %>
          <% else %>
            <div class="h-10 px-4 flex items-center text-xs text-muted-foreground border-b border-border/50">
              No active two-way contracts for this risk lens.
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</section>
