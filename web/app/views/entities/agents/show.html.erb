<% content_for :title, @agent&.fetch("full_name", nil) || "Agent" %>

<% agent_name = @agent&.fetch("full_name", nil).to_s %>
<% agency_name = @agent&.fetch("agency_name", nil).to_s %>

<%# Avoid N+1 slug lookups in client table %>
<% prefetch_canonical_slugs(entity_type: "player", entity_ids: @clients.map { |c| c["player_id"] }) %>

<%# Header badges %>
<% header_badges = [] %>
<% header_badges << { label: (@agent['is_active'] == false ? 'Inactive' : 'Active'), variant: (@agent['is_active'] == false ? "muted" : "success") } %>
<% header_badges << { label: (@agent['is_certified'] ? 'Certified' : 'Certification unknown'), variant: (@agent['is_certified'] ? "accent" : "muted") } %>

<%# Header meta %>
<% header_meta = [] %>
<% header_meta << "#{@client_rollup['client_count'] || 0} clients" %>
<% header_meta << "#{@client_rollup['team_count'] || 0} teams" %>
<% header_meta << "Cap 2025: #{format_salary(@client_rollup['cap_2025_total'])}" if @client_rollup['cap_2025_total'] %>
<% header_meta << agency_name if agency_name.present? %>

<% salary_book_href = "/tools/salary-book" %>

<%# Header links %>
<% header_links = [] %>
<% header_links << ["Open in Salary Book", salary_book_href] if salary_book_href.present? %>
<% if @agent["agency_id"].present? && agency_name.present? %>
  <% header_links << ["Agency page", agency_href(@agent['agency_id'])] %>
<% end %>
<% header_links << ["Browse Agencies", "/agencies"] %>

<div id="agent-show" class="min-h-screen w-full bg-background">
  <%= render partial: "entities/shared/commandbar", locals: {
    active_entity_scope: "agents"
  } %>

  <main class="px-4 pb-8" data-entity-workspace data-scroll-offset-extra="64">
    <%= render partial: "entities/agents/sticky_header", locals: {
      image_fallback: "AG",
      title: agent_name.presence || "Agent",
      badges: header_badges,
      meta: header_meta,
      links: header_links,
      agency_name: agency_name,
      client_count: @client_rollup["client_count"],
      team_count: @client_rollup["team_count"],
      cap_2025_total: @client_rollup["cap_2025_total"],
      total_salary_from_2025: @client_rollup["total_salary_from_2025"]
    } %>

    <div class="lg:flex lg:gap-8">
      <div class="min-w-0 flex-1 space-y-8">
      <%# Vitals %>
      <section id="vitals" class="space-y-3">
        <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Vitals</h2>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div class="rounded-lg border border-border bg-background p-3">
            <div class="text-xs text-muted-foreground">Clients</div>
            <div class="mt-1 text-lg font-semibold font-mono tabular-nums"><%= @client_rollup["client_count"] || 0 %></div>
          </div>
          <div class="rounded-lg border border-border bg-background p-3">
            <div class="text-xs text-muted-foreground">Teams represented</div>
            <div class="mt-1 text-lg font-semibold font-mono tabular-nums"><%= @client_rollup["team_count"] || 0 %></div>
          </div>
          <div class="rounded-lg border border-border bg-background p-3">
            <div class="text-xs text-muted-foreground">Cap 2025 total</div>
            <div class="mt-1 text-lg font-semibold font-mono tabular-nums"><%= format_salary(@client_rollup["cap_2025_total"]) %></div>
          </div>
          <div class="rounded-lg border border-border bg-background p-3">
            <div class="text-xs text-muted-foreground">Total from 2025</div>
            <div class="mt-1 text-lg font-semibold font-mono tabular-nums"><%= format_salary(@client_rollup["total_salary_from_2025"]) %></div>
          </div>
        </div>

        <div class="text-xs text-muted-foreground">
          Two-way clients: <span class="font-mono tabular-nums"><%= @client_rollup["two_way_count"] || 0 %></span>
          · Min-contract clients: <span class="font-mono tabular-nums"><%= @client_rollup["min_contract_count"] || 0 %></span>
          · Trade-restricted now: <span class="font-mono tabular-nums"><%= @client_rollup["restricted_now_count"] || 0 %></span>
        </div>
      </section>

      <%# Connections %>
      <section id="connections" class="space-y-3">
        <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Connections</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div class="rounded-lg border border-border bg-background p-4">
            <div class="text-[10px] uppercase tracking-wide text-muted-foreground">Agency</div>
            <% if @agent["agency_id"].present? && agency_name.present? %>
              <a href="<%= agency_href(@agent['agency_id']) %>" class="mt-1 block font-medium hover:underline"><%= agency_name %></a>
            <% else %>
              <div class="mt-1 text-sm text-muted-foreground italic"><%= agency_name.presence || "Unknown" %></div>
            <% end %>
          </div>

          <div class="rounded-lg border border-border bg-background p-4">
            <div class="text-[10px] uppercase tracking-wide text-muted-foreground">Status</div>
            <div class="mt-1 flex flex-wrap gap-2">
              <span class="entity-chip <%= @agent['is_active'] == false ? 'entity-chip--muted' : 'entity-chip--success' %>">
                <%= @agent['is_active'] == false ? 'Inactive' : 'Active' %>
              </span>
              <span class="entity-chip <%= @agent['is_certified'] ? 'entity-chip--accent' : 'entity-chip--muted' %>">
                <%= @agent['is_certified'] ? 'Certified' : 'Certification unknown' %>
              </span>
            </div>
          </div>
        </div>
      </section>

      <%# Team distribution %>
      <section id="team-distribution" class="space-y-3">
        <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Team distribution</h2>

        <% if @team_distribution.empty? %>
          <div class="p-4 rounded-lg bg-muted/30 border border-border/50 text-sm text-muted-foreground italic">No team distribution data.</div>
        <% else %>
          <div class="overflow-x-auto rounded-lg border border-border">
            <table class="entity-table min-w-full text-xs">
              <thead class="bg-muted/40 text-[10px] uppercase tracking-wide text-muted-foreground/90">
                <tr>
                  <th class="text-left px-3 py-2 font-medium">Team</th>
                  <th class="text-right px-3 py-2 font-medium">Clients</th>
                  <th class="text-right px-3 py-2 font-medium">Cap 2025 total</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-border">
                <% @team_distribution.each do |r| %>
                  <tr class="hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 transition-colors duration-75">
                    <td class="px-3 py-2">
                      <% if r["team_code"].present? %>
                        <a href="<%= team_href(team_code: r['team_code'], team_id: r['team_id']) %>" class="font-medium hover:underline"><%= r["team_code"] %></a>
                        <span class="text-muted-foreground ml-1 text-[10px]"><%= r["team_name"].presence || "" %></span>
                      <% else %>
                        <span class="text-muted-foreground">—</span>
                      <% end %>
                    </td>
                    <td class="px-3 py-2 text-right font-mono tabular-nums"><%= r["client_count"] %></td>
                    <td class="px-3 py-2 text-right font-mono tabular-nums"><%= format_salary(r["cap_2025_total"]) %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% end %>
      </section>

      <%# Client list %>
      <section id="clients" class="space-y-3">
        <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Client list</h2>

        <% if @clients.empty? %>
          <div class="p-4 rounded-lg bg-muted/30 border border-border/50 text-sm text-muted-foreground italic">No clients found.</div>
        <% else %>
          <div class="overflow-x-auto rounded-lg border border-border">
            <table class="entity-table min-w-full text-xs">
              <thead class="bg-muted/40 text-[10px] uppercase tracking-wide text-muted-foreground/90">
                <tr>
                  <th class="text-left px-3 py-2 font-medium">Player</th>
                  <th class="text-left px-3 py-2 font-medium">Team</th>
                  <th class="text-right px-3 py-2 font-medium">Cap 2025</th>
                  <th class="text-right px-3 py-2 font-medium">Total from 2025</th>
                  <th class="text-left px-3 py-2 font-medium">Flags</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-border">
                <% @clients.each do |c| %>
                  <tr class="hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 transition-colors duration-75">
                    <td class="px-3 py-2">
                      <a href="<%= player_href(c['player_id']) %>" class="font-medium truncate hover:underline"><%= c["player_name"] %></a>
                      <div class="text-[10px] text-muted-foreground/80">id: <%= c["player_id"] %></div>
                    </td>
                    <td class="px-3 py-2">
                      <% if c["team_code"].present? %>
                        <a href="<%= team_href(team_code: c['team_code'], team_id: c['team_id']) %>" class="font-medium hover:underline"><%= c["team_code"] %></a>
                      <% else %>
                        <span class="text-muted-foreground">—</span>
                      <% end %>
                    </td>
                    <td class="px-3 py-2 text-right font-mono tabular-nums"><%= c["cap_2025"].present? ? format_salary(c["cap_2025"]) : "—" %></td>
                    <td class="px-3 py-2 text-right font-mono tabular-nums"><%= c["total_salary_from_2025"].present? ? format_salary(c["total_salary_from_2025"]) : "—" %></td>
                    <td class="px-3 py-2 text-xs text-muted-foreground">
                      <% flags = [] %>
                      <% flags << "2W" if c["is_two_way"] %>
                      <% flags << "MIN" if c["is_min_contract"] %>
                      <% flags << "RESTRICTED" if c["is_trade_restricted_now"] %>
                      <%= flags.any? ? flags.join(" · ") : "—" %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% end %>
      </section>

      <%# Book by season %>
      <section id="book-by-season" class="space-y-3">
        <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Book by season</h2>

        <details class="rounded-lg border border-border bg-background p-3">
          <summary class="cursor-pointer text-sm font-medium">Season totals (<%= @book_by_year.size %> years)</summary>
          <div class="mt-3">
            <% if @book_by_year.empty? %>
              <div class="text-sm text-muted-foreground italic">No yearly warehouse rows.</div>
            <% else %>
              <div class="overflow-x-auto rounded-lg border border-border">
                <table class="entity-table min-w-full text-xs">
                  <thead class="bg-muted/40 text-[10px] uppercase tracking-wide text-muted-foreground/90">
                    <tr>
                      <th class="text-left px-3 py-2 font-medium">Year</th>
                      <th class="text-right px-3 py-2 font-medium">Players</th>
                      <th class="text-right px-3 py-2 font-medium">Cap total</th>
                      <th class="text-right px-3 py-2 font-medium">Tax total</th>
                      <th class="text-right px-3 py-2 font-medium">Apron total</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-border">
                    <% @book_by_year.each do |r| %>
                      <tr class="hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 transition-colors duration-75">
                        <td class="px-3 py-2 font-mono tabular-nums"><%= r["salary_year"] %></td>
                        <td class="px-3 py-2 text-right font-mono tabular-nums"><%= r["player_count"] %></td>
                        <td class="px-3 py-2 text-right font-mono tabular-nums"><%= format_salary(r["cap_total"]) %></td>
                        <td class="px-3 py-2 text-right font-mono tabular-nums"><%= format_salary(r["tax_total"]) %></td>
                        <td class="px-3 py-2 text-right font-mono tabular-nums"><%= format_salary(r["apron_total"]) %></td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            <% end %>
          </div>
        </details>
      </section>

      <%# Historical footprint %>
      <section id="historical" class="space-y-3">
        <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Historical footprint</h2>

        <details class="rounded-lg border border-border bg-background p-3">
          <summary class="cursor-pointer text-sm font-medium">Historical signings (<%= @historical_signing_trend.size %> years)</summary>
          <div class="mt-3 space-y-4">
            <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
              <div class="rounded-lg border border-border bg-background p-3">
                <div class="text-xs text-muted-foreground">Historical clients</div>
                <div class="mt-1 text-lg font-semibold font-mono tabular-nums"><%= @historical_footprint_rollup["historical_client_count"] || 0 %></div>
              </div>
              <div class="rounded-lg border border-border bg-background p-3">
                <div class="text-xs text-muted-foreground">Contracts</div>
                <div class="mt-1 text-lg font-semibold font-mono tabular-nums"><%= @historical_footprint_rollup["contract_count"] || 0 %></div>
              </div>
              <div class="rounded-lg border border-border bg-background p-3">
                <div class="text-xs text-muted-foreground">Versions</div>
                <div class="mt-1 text-lg font-semibold font-mono tabular-nums"><%= @historical_footprint_rollup["version_count"] || 0 %></div>
              </div>
              <div class="rounded-lg border border-border bg-background p-3">
                <div class="text-xs text-muted-foreground">First signing</div>
                <div class="mt-1 text-sm font-medium"><%= format_plain_date(@historical_footprint_rollup["first_signing_date"]) %></div>
              </div>
              <div class="rounded-lg border border-border bg-background p-3">
                <div class="text-xs text-muted-foreground">Last signing</div>
                <div class="mt-1 text-sm font-medium"><%= format_plain_date(@historical_footprint_rollup["last_signing_date"]) %></div>
              </div>
            </div>

            <div class="text-xs text-muted-foreground">
              Historical but not current clients:
              <span class="font-mono tabular-nums"><%= @historical_footprint_rollup["historical_not_current_client_count"] || 0 %></span>
            </div>

            <% if @historical_signing_trend.any? %>
              <div class="overflow-x-auto rounded-lg border border-border">
                <table class="entity-table min-w-full text-xs">
                  <thead class="bg-muted/40 text-[10px] uppercase tracking-wide text-muted-foreground/90">
                    <tr>
                      <th class="text-left px-3 py-2 font-medium">Signing year</th>
                      <th class="text-right px-3 py-2 font-medium">Distinct clients</th>
                      <th class="text-right px-3 py-2 font-medium">Contracts</th>
                      <th class="text-right px-3 py-2 font-medium">Versions</th>
                    </tr>
                  </thead>
                  <tbody class="divide-y divide-border">
                    <% @historical_signing_trend.each do |r| %>
                      <tr class="hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 transition-colors duration-75">
                        <td class="px-3 py-2 font-mono tabular-nums"><%= r["signing_year"] %></td>
                        <td class="px-3 py-2 text-right font-mono tabular-nums"><%= r["distinct_clients"] %></td>
                        <td class="px-3 py-2 text-right font-mono tabular-nums"><%= r["contract_count"] %></td>
                        <td class="px-3 py-2 text-right font-mono tabular-nums"><%= r["version_count"] %></td>
                      </tr>
                    <% end %>
                  </tbody>
                </table>
              </div>
            <% else %>
              <div class="text-sm text-muted-foreground italic">No historical signing trend rows.</div>
            <% end %>
          </div>
        </details>
      </section>
      </div>

      <%= render partial: "entities/shared/local_nav", locals: {
        sticky_top_class: "top-[196px]",
        sections: [
          ["vitals", "Vitals"],
          ["connections", "Connections"],
          ["team-distribution", "Team distribution"],
          ["clients", "Client list"],
          ["book-by-season", "Book by season"],
          ["historical", "Historical footprint"]
        ]
      } %>
    </div>

    <%= render partial: "entities/shared/known_slugs", locals: { entity_type: "agent", entity_id: @agent_id, path_prefix: "agents" } %>
  </main>
</div>
