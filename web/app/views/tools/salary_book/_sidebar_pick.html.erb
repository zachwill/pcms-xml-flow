<%#
  Pick overlay (RightPanel entity) — Tailwind-ish port of the React prototype (PickDetail)

  NOTE: Root id must remain stable for Datastar morphing.
%>

<% salary_years = SalaryBookHelper::SALARY_YEARS %>

<% round_label = round == 1 ? "1st" : "2nd" %>

<% team_name = team_meta["team_name"] || team_code %>
<% team_id = team_meta["team_id"] %>

<% primary = picks.first %>
<% asset_type = primary["asset_type"] %>
<% is_own = primary["origin_team_code"].blank? || primary["origin_team_code"] == team_code %>
<% is_swap = picks.any? { |p| p["is_swap"] } %>
<% is_conditional = picks.any? { |p| p["is_conditional"] } %>

<%
  origin_codes = picks.map { |p| p["origin_team_code"] }.compact.uniq.reject { |c| c == team_code }

  parse_pg_array = ->(val) {
    return [] if val.nil? || val == "{}"
    return val if val.is_a?(Array)
    val.to_s.gsub(/[{}\"]/, "").split(",").map(&:strip).reject(&:blank?)
  }

  via_codes = picks.flat_map { |p| parse_pg_array.call(p["via_team_codes"]) }.compact.uniq

  descriptions = picks.map { |p| p["description"] }.compact.uniq.reject(&:blank?)
  explanations = picks.map { |p| p["endnote_explanation"] }.compact.uniq.reject(&:blank?)
%>

<%
  asset_badge = if is_own
    { label: "Own Pick", klass: "bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400" }
  elsif asset_type == "TO"
    { label: "Traded Away", klass: "bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400" }
  else
    { label: "Acquired", klass: "bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400" }
  end
%>

<div id="rightpanel-overlay" class="h-full">
  <%# Sticky header %>
  <div class="sticky top-0 z-20 h-10 px-4 flex items-center justify-between border-b border-border bg-background">
    <%= render partial: "tools/salary_book/sidebar_back_button" %>

    <a
      class="text-xs text-muted-foreground hover:text-foreground hover:underline"
      href="<%= draft_pick_path(team_code: team_code, year: year, round: round) %>"
    >Open pick page</a>
  </div>

  <div class="px-4 pb-4 pt-4 space-y-6">
    <%# Pick header (prototype style) %>
    <div class="flex items-start gap-4">
      <div
        class="w-16 h-16 rounded-xl flex flex-col items-center justify-center font-bold"
        style="<%= round == 1 ? 'background: linear-gradient(to bottom right, rgb(251 191 36), rgb(217 119 6)); color: rgb(69 26 3);' : 'background: linear-gradient(to bottom right, rgb(148 163 184), rgb(71 85 105)); color: rgb(2 6 23);' %>"
      >
        <span class="text-2xl tabular-nums"><%= round %></span>
        <span class="text-[10px] uppercase tracking-wide opacity-80"><%= round_label %></span>
      </div>

      <div class="flex-1 space-y-1">
        <h2 class="text-xl font-semibold text-foreground"><%= year %> Draft Pick</h2>
        <div class="text-sm text-muted-foreground">Round <%= round %> • <%= team_name %></div>

        <% if is_swap %>
          <div class="flex items-center gap-1.5 mt-2">
            <span class="inline-flex px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400">
              Pick Swap
            </span>
          </div>
        <% end %>
      </div>
    </div>

    <%# Status badges %>
    <div class="flex flex-wrap items-center gap-2">
      <span class="text-xs text-muted-foreground">Status:</span>
      <span class="inline-flex px-2 py-1 rounded text-xs font-medium <%= asset_badge[:klass] %>"><%= asset_badge[:label] %></span>

      <% if is_conditional %>
        <span class="inline-flex px-2 py-1 rounded text-xs font-medium bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400">Conditional</span>
      <% end %>
    </div>

    <%# Provenance %>
    <% if origin_codes.any? || via_codes.any? %>
      <div class="space-y-2">
        <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Provenance</div>
        <div class="p-3 rounded-lg bg-muted/30 border border-border/50 space-y-2">
          <% if origin_codes.any? %>
            <div class="flex justify-between items-baseline">
              <span class="text-sm text-muted-foreground"><%= asset_type == 'TO' ? 'Owed To' : 'From' %></span>
              <span class="text-sm font-medium"><%= origin_codes.join(", ") %></span>
            </div>
          <% end %>
          <% if via_codes.any? %>
            <div class="flex justify-between items-baseline">
              <span class="text-sm text-muted-foreground">Via</span>
              <span class="text-sm font-medium"><%= via_codes.join(" → ") %></span>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <%# Description %>
    <% if descriptions.any? %>
      <div class="space-y-2">
        <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Pick Details</div>
        <div class="p-3 rounded-lg bg-muted/30 border border-border/50 space-y-2">
          <% descriptions.each do |desc| %>
            <p class="text-sm text-foreground"><%= desc %></p>
          <% end %>
        </div>
      </div>
    <% end %>

    <%# Protections / conditions %>
    <% if explanations.any? %>
      <div class="space-y-2">
        <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Protections</div>
        <div class="p-3 rounded-lg bg-amber-50 border border-amber-200 dark:bg-amber-900/20 dark:border-amber-800 space-y-2">
          <% explanations.each do |explanation| %>
            <p class="text-sm font-medium text-amber-800 dark:text-amber-400"><%= explanation %></p>
          <% end %>
        </div>
      </div>
    <% end %>

    <%# Asset rows (debug) %>
    <% if picks.size > 1 %>
      <div class="space-y-2">
        <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Asset Rows (<%= picks.size %>)</div>
        <div class="p-3 rounded-lg bg-muted/30 border border-border/50 space-y-1">
          <% picks.each do |pick| %>
            <div class="flex items-baseline justify-between text-sm">
              <span class="text-muted-foreground">Slot <%= pick["asset_slot"] %>.<%= pick["sub_asset_slot"] %></span>
              <span class="font-mono tabular-nums"><%= pick["asset_type"] %></span>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

  </div>
</div>
