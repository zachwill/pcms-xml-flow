<% content_for :title, "Draft selection" %>

<% ds = @draft_selection %>
<% pick_label = "#{ds['draft_year']} — R#{ds['draft_round']} P#{ds['pick_number']}" %>
<% player_name = ds["player_name"].to_s %>
<% drafting_team_code = ds["drafting_team_code"].to_s %>

<div id="entity-directory" class="min-h-screen w-full bg-background">
  <%= render partial: "entities/shared/commandbar", locals: {
    active_entity_scope: "draft_selections"
  } %>

  <main class="px-4 pb-8 space-y-6" data-entity-workspace>
    <%= render partial: "entities/shared/workspace_header", locals: {
      breadcrumbs: [["Draft selections", "/draft-selections"], [pick_label, nil]],
      title: pick_label,
      subtitle: ((player_name.present? ? "#{player_name} · " : "") + "transaction_id: #{@draft_selection_id} · slug: #{@draft_selection_slug}" + (ds["transaction_date"].present? ? " · date: #{ds['transaction_date']}" : "")),
      right_links: [["Open Salary Book", "/tools/salary-book"], ["Find player", "/players"]]
    } %>

  <div class="lg:flex lg:gap-8">
    <%= render partial: "entities/shared/local_nav", locals: {
      sections: [
        ["vitals", "Vitals"],
        ["connections", "Connections"],
        ["provenance", "Pick provenance"]
      ]
    } %>

    <div class="min-w-0 flex-1 space-y-6">
      <section id="vitals" class="scroll-mt-24 space-y-3">
        <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Vitals</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div class="rounded-lg border border-border bg-background p-3">
            <div class="text-xs text-muted-foreground">Draft year</div>
            <div class="mt-1 text-lg font-semibold font-mono tabular-nums"><%= ds["draft_year"] %></div>
          </div>
          <div class="rounded-lg border border-border bg-background p-3">
            <div class="text-xs text-muted-foreground">Round</div>
            <div class="mt-1 text-lg font-semibold font-mono tabular-nums"><%= ds["draft_round"] %></div>
          </div>
          <div class="rounded-lg border border-border bg-background p-3">
            <div class="text-xs text-muted-foreground">Pick number</div>
            <div class="mt-1 text-lg font-semibold font-mono tabular-nums"><%= ds["pick_number"] %></div>
          </div>
          <div class="rounded-lg border border-border bg-background p-3">
            <div class="text-xs text-muted-foreground">Drafting team</div>
            <div class="mt-1 text-sm font-medium"><%= drafting_team_code.presence || "—" %></div>
          </div>
        </div>
      </section>

      <section id="connections" class="scroll-mt-24 space-y-3">
        <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Connections</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div class="p-4 rounded-lg border border-border bg-background">
            <div class="text-[10px] uppercase tracking-wide text-muted-foreground">Player</div>
            <% if ds["player_id"].present? %>
              <a href="<%= player_href(ds['player_id']) %>" class="mt-1 block font-medium hover:underline"><%= player_name.presence || ds['player_id'] %></a>
            <% else %>
              <div class="mt-1 text-sm text-muted-foreground italic">Unknown</div>
            <% end %>
          </div>

          <div class="p-4 rounded-lg border border-border bg-background">
            <div class="text-[10px] uppercase tracking-wide text-muted-foreground">Drafting team</div>
            <% if ds["drafting_team_id"].present? %>
              <a href="<%= team_href(team_code: drafting_team_code, team_id: ds['drafting_team_id']) %>" class="mt-1 block font-medium hover:underline"><%= drafting_team_code.presence || "—" %></a>
              <div class="text-sm text-muted-foreground"><%= ds["team_name"].presence || "—" %></div>
            <% else %>
              <div class="mt-1 text-sm text-muted-foreground italic">Unknown</div>
            <% end %>
          </div>

          <div class="p-4 rounded-lg border border-border bg-background">
            <div class="text-[10px] uppercase tracking-wide text-muted-foreground">Current team</div>
            <% if @current_team.present? && @current_team["team_code"].present? %>
              <a href="<%= team_href(team_code: @current_team['team_code'], team_id: @current_team['team_id']) %>" class="mt-1 block font-medium hover:underline"><%= @current_team["team_code"] %></a>
              <div class="text-sm text-muted-foreground"><%= @current_team["team_name"].presence || "—" %></div>
            <% else %>
              <div class="mt-1 text-sm text-muted-foreground italic">Unknown</div>
            <% end %>
          </div>
        </div>
      </section>

      <section id="provenance" class="scroll-mt-24 space-y-3">
        <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Pick provenance</h2>

        <% provenance_rows = Array(@pick_provenance_rows) %>
        <% provenance_hops = provenance_rows.each_with_index.map do |row, index|
          flags = []
          flags << "future" if row["is_future"]
          flags << row["conditional_type_lk"] if row["conditional_type_lk"].present?

          {
            row: row,
            hop_number: index + 1,
            is_deep: index.positive?,
            is_conditional: row["is_conditional"] || row["conditional_type_lk"].present?,
            is_swap: !!row["is_swap"],
            flags: flags
          }
        end %>

        <% deep_hop_count = provenance_hops.count { |hop| hop[:is_deep] } %>
        <% conditional_hop_count = provenance_hops.count { |hop| hop[:is_conditional] } %>
        <% swap_hop_count = provenance_hops.count { |hop| hop[:is_swap] } %>
        <% deepest_hop = provenance_hops.map { |hop| hop[:hop_number] }.max || 0 %>

        <% provenance_lens_options = [
          { key: "all", label: "All hops", count: provenance_hops.size, help: "Full ownership chain" },
          { key: "deep", label: "Deep", count: deep_hop_count, help: "P2+ reroutes" },
          { key: "conditional", label: "Conditional", count: conditional_hop_count, help: "Protection-linked hops" },
          { key: "swap", label: "Swap", count: swap_hop_count, help: "Swap rights hops" }
        ] %>

        <% provenance_lens_keys = provenance_lens_options.map { |opt| opt[:key] } %>
        <% active_provenance_lens = params[:provenance_lens].to_s.strip.downcase %>
        <% active_provenance_lens = "all" unless provenance_lens_keys.include?(active_provenance_lens) %>

        <% lens_chip_class = lambda do |lens_key|
          case lens_key.to_s
          when "deep"
            "entity-chip entity-chip--danger"
          when "conditional"
            "entity-chip entity-chip--warning"
          when "swap"
            "entity-chip entity-chip--accent"
          else
            "entity-chip entity-chip--muted"
          end
        end %>

        <% team_exposure_map = {} %>
        <% provenance_hops.each do |hop|
          row = hop[:row]
          [
            [:from, row["from_team_code"], row["from_team_id"]],
            [:to, row["to_team_code"], row["to_team_id"]],
            [:original, row["original_team_code"], row["original_team_id"]]
          ].each do |role, team_code, team_id|
            next if team_code.blank?

            team_exposure_map[team_code] ||= {
              team_code: team_code,
              team_id: team_id,
              touches: 0,
              from_count: 0,
              to_count: 0,
              original_count: 0
            }

            exposure = team_exposure_map[team_code]
            exposure[:team_id] ||= team_id
            exposure[:touches] += 1
            exposure[:from_count] += 1 if role == :from
            exposure[:to_count] += 1 if role == :to
            exposure[:original_count] += 1 if role == :original
          end
        end %>

        <% if team_exposure_map.empty? && drafting_team_code.present? %>
          <% team_exposure_map[drafting_team_code] = {
            team_code: drafting_team_code,
            team_id: ds["drafting_team_id"],
            touches: 1,
            from_count: 0,
            to_count: 0,
            original_count: 1
          } %>
        <% end %>

        <% team_exposure_rows = team_exposure_map.values.sort_by { |entry| [-entry[:touches], entry[:team_code]] } %>

        <div id="provenance-lanes" data-signals="{ provenancelens: '<%= active_provenance_lens %>' }">
          <div class="rounded-lg border border-border/60 bg-muted/10 px-3 py-2">
            <div class="flex flex-wrap items-start justify-between gap-2">
              <div class="space-y-1">
                <div class="text-[10px] font-medium uppercase tracking-wide text-muted-foreground/80">Team exposure summary</div>
                <div class="flex flex-wrap items-center gap-1.5 text-[10px] text-muted-foreground">
                  <span class="entity-chip entity-chip--muted">Exposed teams · <span class="font-mono tabular-nums"><%= team_exposure_rows.size %></span></span>
                  <span class="entity-chip entity-chip--muted">Deepest hop · <span class="font-mono tabular-nums">P<%= deepest_hop %></span></span>
                  <span class="entity-chip entity-chip--warning">Conditional · <span class="font-mono tabular-nums"><%= conditional_hop_count %></span></span>
                  <span class="entity-chip entity-chip--accent">Swap · <span class="font-mono tabular-nums"><%= swap_hop_count %></span></span>
                </div>
              </div>

              <div class="text-[10px] text-muted-foreground">Filter chain rows by hop depth or flag type.</div>
            </div>

            <% if team_exposure_rows.any? %>
              <div class="mt-2 flex flex-wrap gap-1.5 text-[10px]">
                <% team_exposure_rows.each do |entry| %>
                  <% exposure_label = "#{entry[:team_code]} · #{entry[:touches]}x" %>
                  <% exposure_title = "from #{entry[:from_count]} · to #{entry[:to_count]} · original #{entry[:original_count]}" %>

                  <% if entry[:team_code].present? %>
                    <a
                      href="<%= team_href(team_code: entry[:team_code], team_id: entry[:team_id]) %>"
                      class="entity-chip entity-chip--muted hover:underline"
                      title="<%= exposure_title %>"
                    ><%= exposure_label %></a>
                  <% else %>
                    <span class="entity-chip entity-chip--muted" title="<%= exposure_title %>"><%= exposure_label %></span>
                  <% end %>
                <% end %>
              </div>
            <% end %>
          </div>

          <div class="mt-2 rounded-lg border border-border/60 bg-background px-3 py-2">
            <div class="flex flex-wrap items-center gap-2">
              <span class="text-[10px] font-semibold uppercase tracking-wide text-muted-foreground">Lane filters</span>
              <% provenance_lens_options.each do |lens_option| %>
                <button
                  type="button"
                  class="cursor-pointer inline-flex items-center gap-1 rounded-full border px-2 py-0.5 text-[10px] font-medium transition-colors"
                  data-on:click="$provenancelens = '<%= lens_option[:key] %>'; const url = new URL(window.location.href); if ('<%= lens_option[:key] %>' === 'all') { url.searchParams.delete('provenance_lens'); } else { url.searchParams.set('provenance_lens', '<%= lens_option[:key] %>'); } window.history.replaceState({}, '', url.pathname + url.search + url.hash);"
                  data-class="{ 'bg-primary text-primary-foreground border-primary': $provenancelens === '<%= lens_option[:key] %>', 'bg-background text-muted-foreground border-border hover:text-foreground hover:border-foreground/25': $provenancelens !== '<%= lens_option[:key] %>' }"
                  title="<%= lens_option[:help] %>"
                >
                  <span><%= lens_option[:label] %></span>
                  <span class="<%= lens_chip_class.call(lens_option[:key]) %>"><%= lens_option[:count] %></span>
                </button>
              <% end %>
            </div>
          </div>

          <% if provenance_hops.empty? %>
            <div class="mt-2 rounded-lg border border-border/60 bg-background px-3 py-3 text-sm text-muted-foreground">
              Pick ownership remained direct to draft night (no pre-draft trade rows).
            </div>
          <% else %>
            <div class="mt-2 rounded-lg border border-border/60 divide-y divide-border/50">
              <% provenance_hops.each do |hop| %>
                <% row = hop[:row] %>
                <% row_visible = case active_provenance_lens
                when "deep"
                  hop[:is_deep]
                when "conditional"
                  hop[:is_conditional]
                when "swap"
                  hop[:is_swap]
                else
                  true
                end %>

                <% row_lane_class = if hop[:is_deep]
                  "border-red-200/60 bg-red-50/35 dark:border-red-800/50 dark:bg-red-950/10"
                elsif hop[:is_conditional]
                  "border-amber-200/60 bg-amber-50/35 dark:border-amber-800/50 dark:bg-amber-950/10"
                elsif hop[:is_swap]
                  "border-sky-200/70 bg-sky-50/30 dark:border-sky-800/50 dark:bg-sky-950/10"
                else
                  "border-border/50 bg-background"
                end %>

                <article
                  class="group border px-3 py-2 transition-colors duration-75 hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 <%= row_lane_class %>"
                  data-show="$provenancelens === 'all' || ($provenancelens === 'deep' && <%= hop[:is_deep] %>) || ($provenancelens === 'conditional' && <%= hop[:is_conditional] %>) || ($provenancelens === 'swap' && <%= hop[:is_swap] %>)"
                  <% unless row_visible %>style="display: none;"<% end %>
                >
                  <div class="flex flex-wrap items-start gap-3">
                    <div class="w-24 shrink-0">
                      <div class="entity-cell-two-line">
                        <div class="entity-cell-primary font-mono tabular-nums">P<%= hop[:hop_number] %></div>
                        <div class="entity-cell-secondary font-mono tabular-nums"><%= row["trade_date"].presence || "—" %></div>
                      </div>
                    </div>

                    <div class="min-w-0 flex-1 grid gap-2 sm:grid-cols-2 xl:grid-cols-5">
                      <div class="entity-cell-two-line xl:col-span-2">
                        <div class="entity-cell-primary justify-start gap-1.5 flex-wrap">
                          <% if row["from_team_code"].present? %>
                            <a href="<%= team_href(team_code: row['from_team_code'], team_id: row['from_team_id']) %>" class="hover:underline font-medium"><%= row["from_team_code"] %></a>
                          <% else %>
                            <span class="text-muted-foreground/60">—</span>
                          <% end %>

                          <span class="text-muted-foreground/50">→</span>

                          <% if row["to_team_code"].present? %>
                            <a href="<%= team_href(team_code: row['to_team_code'], team_id: row['to_team_id']) %>" class="hover:underline font-medium"><%= row["to_team_code"] %></a>
                          <% else %>
                            <span class="text-muted-foreground/60">—</span>
                          <% end %>
                        </div>
                        <div class="entity-cell-secondary justify-start">From → To · Original <%= row["original_team_code"].presence || "—" %></div>
                      </div>

                      <div class="entity-cell-two-line">
                        <div class="entity-cell-primary justify-start font-mono tabular-nums">
                          <% if row["trade_id"].present? %>
                            <a href="<%= trade_href(row['trade_id']) %>" class="hover:underline">#<%= row["trade_id"] %></a>
                          <% else %>
                            <span class="text-muted-foreground/60">—</span>
                          <% end %>
                        </div>
                        <div class="entity-cell-secondary justify-start">Trade pivot</div>
                      </div>

                      <div class="entity-cell-two-line xl:col-span-2">
                        <div class="entity-cell-primary justify-start gap-1.5 flex-wrap">
                          <% if hop[:is_deep] %>
                            <span class="entity-chip entity-chip--danger">deep</span>
                          <% end %>
                          <% if hop[:is_conditional] %>
                            <span class="entity-chip entity-chip--warning">conditional</span>
                          <% end %>
                          <% if hop[:is_swap] %>
                            <span class="entity-chip entity-chip--accent">swap</span>
                          <% end %>
                          <% hop[:flags].each do |flag| %>
                            <span class="entity-chip entity-chip--muted"><%= flag %></span>
                          <% end %>
                          <% if hop[:flags].empty? %>
                            <span class="text-muted-foreground/60">No conditional/swap modifiers</span>
                          <% end %>
                        </div>
                        <div class="entity-cell-secondary justify-start">Flags + lane tags</div>
                      </div>
                    </div>
                  </div>
                </article>
              <% end %>
            </div>
          <% end %>

          <% if deep_hop_count.zero? %>
            <div
              class="mt-2 rounded-lg border border-border/60 bg-muted/10 px-3 py-2 text-sm text-muted-foreground"
              data-show="$provenancelens === 'deep'"
              <% unless active_provenance_lens == "deep" %>style="display: none;"<% end %>
            >
              No deep hops for this pick context (chain does not extend beyond P1).
            </div>
          <% end %>

          <% if conditional_hop_count.zero? %>
            <div
              class="mt-2 rounded-lg border border-border/60 bg-muted/10 px-3 py-2 text-sm text-muted-foreground"
              data-show="$provenancelens === 'conditional'"
              <% unless active_provenance_lens == "conditional" %>style="display: none;"<% end %>
            >
              No conditional hops in this provenance chain.
            </div>
          <% end %>

          <% if swap_hop_count.zero? %>
            <div
              class="mt-2 rounded-lg border border-border/60 bg-muted/10 px-3 py-2 text-sm text-muted-foreground"
              data-show="$provenancelens === 'swap'"
              <% unless active_provenance_lens == "swap" %>style="display: none;"<% end %>
            >
              No swap hops in this provenance chain.
            </div>
          <% end %>
        </div>

        <div class="rounded-lg border border-border bg-background p-3 text-xs text-muted-foreground">
          Transaction: <a href="<%= transaction_href(ds['transaction_id']) %>" class="hover:underline font-mono tabular-nums">#<%= ds["transaction_id"] %></a>
          <% if ds["trade_id"].present? %>
            · linked trade: <a href="<%= trade_href(ds['trade_id']) %>" class="hover:underline font-mono tabular-nums">#<%= ds["trade_id"] %></a>
          <% end %>
        </div>
      </section>
    </div>
  </div>

  <%= render partial: "entities/shared/known_slugs", locals: { entity_type: "draft_selection", entity_id: @draft_selection_id, path_prefix: "draft-selections" } %>
  </main>
</div>
