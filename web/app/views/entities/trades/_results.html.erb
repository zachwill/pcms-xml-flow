<div id="trades-results" class="space-y-3">
  <div class="flex items-end justify-between gap-4">
    <div>
      <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">
        Trades feed ·
        <% case @daterange
           when "today" then %>Today<%
           when "week" then %>This week<%
           when "month" then %>This month<%
           when "season" then %>This season<%
           else %>All dates<%
           end %>
        · <%= @sort_label %>
      </h2>
      <p class="text-[11px] text-muted-foreground mt-1">
        Team impact is summarized inline (OUT vs IN) so you can shortlist deals before opening overlay.
        <% if @lens != "all" || @composition != "all" %>
          <span class="font-medium text-foreground">
            <% active_lenses = [] %>
            <% active_lenses << "Complexity: #{@lens_label}" unless @lens == "all" %>
            <% active_lenses << "Composition: #{@composition_label}" unless @composition == "all" %>
            <%= active_lenses.join(" · ") %>
          </span>
        <% end %>
      </p>
    </div>

    <div class="text-[11px] text-muted-foreground tabular-nums">
      <span><%= @trades.size %> rows</span>
    </div>
  </div>

  <% if @trades.empty? %>
    <div class="p-4 rounded-lg bg-muted/30 border border-border/50 text-sm text-muted-foreground italic">
      No trades found for this time period and filters.
    </div>
  <% else %>
    <div class="rounded-lg border border-border overflow-x-auto">
      <div class="min-w-[92rem]">
        <div id="trades-flex-header" class="sticky top-0 z-10 bg-muted/70 backdrop-blur-sm border-b border-border">
          <div class="flex items-center h-8 px-3 text-[10px] uppercase tracking-wide text-muted-foreground/90 font-medium">
            <div class="w-28 shrink-0">When</div>
            <div class="w-40 shrink-0">Deal</div>
            <div class="w-[30rem] shrink-0">Team impact (OUT / IN)</div>
            <div class="w-40 shrink-0">Assets</div>
            <div class="w-40 shrink-0">Composition</div>
            <div class="w-[14rem] shrink-0">Notes</div>
          </div>
        </div>

        <div class="divide-y divide-border/60">
          <% @trades.each do |trade| %>
            <% row_id = trade["trade_id"].to_s %>
            <% open_expr = "$overlaytype = 'trade'; $overlayid = '#{row_id}'; @get('/trades/sidebar/#{row_id}')" %>
            <% teams = trade["teams_involved"].to_s.split(", ").reject(&:blank?) %>
            <% composition_labels = Array(trade["composition_labels"]) %>
            <% primary_impacts = Array(trade["primary_team_impacts"]) %>
            <% additional_impact_count = trade["additional_team_impact_count"].to_i %>

            <div
              class="group cursor-pointer hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 transition-colors duration-75"
              role="button"
              tabindex="0"
              data-class="{ 'bg-yellow-100/80 dark:bg-yellow-900/20': $overlaytype === 'trade' && $overlayid === '<%= row_id %>' }"
              data-on:click="<%= open_expr %>"
              data-on:keydown="if (evt.key === 'Enter' || evt.key === ' ') { evt.preventDefault(); <%= open_expr %>; }"
            >
              <div class="flex items-center min-h-[66px] px-3 text-xs">
                <div class="w-28 shrink-0 pr-2">
                  <div class="entity-cell-two-line">
                    <div class="entity-cell-primary justify-start">
                      <a href="<%= trade_path(trade['trade_id']) %>" class="font-medium font-mono tabular-nums hover:underline" onclick="event.stopPropagation()">#<%= trade["trade_id"] %></a>
                    </div>
                    <div class="entity-cell-secondary justify-start font-mono tabular-nums"><%= format_plain_date(trade["trade_date"]) %></div>
                  </div>
                </div>

                <div class="w-40 shrink-0 pr-2">
                  <div class="entity-cell-two-line">
                    <div class="entity-cell-primary justify-start gap-1.5">
                      <span class="entity-chip entity-chip--muted"><%= trade["team_count"].to_i %> teams</span>
                      <span class="entity-chip entity-chip--warning"><%= trade["complexity_asset_count"].to_i %> assets</span>
                    </div>
                    <div class="entity-cell-secondary justify-start">
                      <% if trade["trade_finalized_date"].present? %>
                        <span class="entity-chip entity-chip--accent">finalized</span>
                      <% else %>
                        <span class="text-muted-foreground/70">pending finalization</span>
                      <% end %>
                    </div>
                  </div>
                </div>

                <div class="w-[30rem] shrink-0 pr-2">
                  <% if primary_impacts.any? %>
                    <div class="flex flex-wrap gap-1.5">
                      <% primary_impacts.each do |impact| %>
                        <% net_variant = trade_impact_net_variant(impact) %>
                        <% net_chip_class = case net_variant
                           when :net_in then "entity-chip entity-chip--success"
                           when :net_out then "entity-chip entity-chip--danger"
                           else "entity-chip entity-chip--muted"
                           end %>
                        <div class="min-w-[13.5rem] flex-1 rounded border border-border/70 bg-muted/20 px-2 py-1">
                          <div class="flex items-center justify-between gap-2 text-[10px] leading-none">
                            <a href="<%= team_href(team_code: impact['team_code'], team_id: impact['team_id']) %>" class="font-semibold tabular-nums hover:underline" onclick="event.stopPropagation()"><%= impact["team_code"].presence || "—" %></a>
                            <span class="<%= net_chip_class %>"><%= trade_impact_net_label(impact) %></span>
                          </div>
                          <div class="mt-1 text-[10px] leading-none tabular-nums flex items-center gap-1 min-w-0 overflow-hidden">
                            <span class="text-red-600 dark:text-red-400 shrink-0">OUT <%= trade_impact_flow_label(impact, direction: :out) %></span>
                            <span class="text-muted-foreground/50">·</span>
                            <span class="text-emerald-600 dark:text-emerald-400 shrink-0">IN <%= trade_impact_flow_label(impact, direction: :in) %></span>
                          </div>
                        </div>
                      <% end %>

                      <% if additional_impact_count.positive? %>
                        <div class="self-center text-[10px] text-muted-foreground tabular-nums">+<%= additional_impact_count %> more team<%= "s" if additional_impact_count != 1 %></div>
                      <% end %>
                    </div>
                  <% else %>
                    <span class="text-[11px] text-muted-foreground">No team impact map</span>
                  <% end %>
                </div>

                <div class="w-40 shrink-0 pr-2">
                  <div class="entity-cell-two-line">
                    <div class="entity-cell-primary justify-start gap-1.5">
                      <span class="entity-chip entity-chip--success"><%= trade["player_count"].to_i %>P</span>
                      <span class="entity-chip entity-chip--accent"><%= trade["pick_count"].to_i %>K</span>
                    </div>
                    <div class="entity-cell-secondary justify-start tabular-nums">
                      <span><%= trade["cash_line_count"].to_i %> cash</span>
                      <span class="text-muted-foreground/50 px-1">·</span>
                      <span><%= trade["tpe_line_count"].to_i %> TPE</span>
                    </div>
                  </div>
                </div>

                <div class="w-40 shrink-0 pr-2">
                  <div class="flex flex-wrap gap-1">
                    <% composition_labels.each do |label| %>
                      <% chip_class = case label
                         when "Player-heavy" then "entity-chip entity-chip--success"
                         when "Pick-heavy" then "entity-chip entity-chip--accent"
                         when "Cash/TPE" then "entity-chip entity-chip--warning"
                         else "entity-chip entity-chip--muted"
                         end %>
                      <span class="<%= chip_class %>"><%= label %></span>
                    <% end %>
                  </div>
                </div>

                <div class="w-[14rem] shrink-0">
                  <div class="entity-cell-two-line">
                    <div class="entity-cell-primary justify-start text-[11px] truncate"><%= trade["trade_comments"].presence || "—" %></div>
                    <div class="entity-cell-secondary justify-start truncate"><%= teams.any? ? teams.join(" · ") : "No team map" %></div>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% end %>
</div>
