<% summary = @sidebar_summary || {} %>
<% top_rows = Array(summary[:top_rows]) %>
<% pressure_counts = summary[:pressure_counts] || {} %>
<% active_pressure_lens = summary[:active_pressure_lens].to_s.presence || "all" %>
<% active_pressure_label = summary[:active_pressure_label].presence || "All teams" %>
<% active_pressure_count = summary[:active_pressure_count].to_i %>
<% active_sort_label = summary[:active_sort_label].presence || "Pressure first" %>

<% pressure_options = [
  ["all", "All teams"],
  ["over_cap", "Over Cap"],
  ["over_tax", "Over Tax"],
  ["over_apron1", "Over Apron 1"],
  ["over_apron2", "Over Apron 2"]
] %>

<% active_chip_classes = case active_pressure_lens
  when "over_apron2"
    "entity-chip entity-chip--danger"
  when "over_apron1"
    "entity-chip entity-chip--warning"
  when "over_tax"
    "entity-chip entity-chip--warning"
  when "over_cap"
    "entity-chip entity-chip--muted"
  else
    "entity-chip entity-chip--success"
  end %>

<div id="rightpanel-base" class="space-y-4">
  <section class="space-y-3">
    <div>
      <div class="text-[10px] uppercase tracking-wide text-muted-foreground/80">Workspace snapshot</div>
      <div class="text-sm font-semibold text-foreground">
        Team Summary
        <span class="text-muted-foreground font-medium">· <%= summary[:row_count].to_i %> rows</span>
      </div>
    </div>

    <div class="grid grid-cols-4 gap-1.5">
      <%= render partial: "salary_book/kpi_cell", locals: {
        label: "Rows",
        value: summary[:row_count].to_i.to_s,
        class_name: "w-full"
      } %>

      <%= render partial: "salary_book/kpi_cell", locals: {
        label: "Tax owed",
        value: format_compact_currency(summary[:luxury_tax_total]),
        class_name: "w-full",
        value_class_name: "text-[11px]"
      } %>

      <%= render partial: "salary_book/kpi_cell", locals: {
        label: "East",
        value: summary[:eastern_count].to_i.to_s,
        class_name: "w-full"
      } %>

      <%= render partial: "salary_book/kpi_cell", locals: {
        label: "West",
        value: summary[:western_count].to_i.to_s,
        class_name: "w-full"
      } %>
    </div>

    <div class="flex flex-wrap gap-1.5 text-[10px]">
      <span class="inline-flex items-center gap-1 rounded-full border border-border/60 bg-muted/20 px-2 py-0.5 text-muted-foreground">
        Over Cap <span class="font-mono tabular-nums text-foreground"><%= summary[:over_cap_count].to_i %></span>
      </span>
      <span class="inline-flex items-center gap-1 rounded-full border border-border/60 bg-muted/20 px-2 py-0.5 text-muted-foreground">
        Over Tax <span class="font-mono tabular-nums text-foreground"><%= summary[:over_tax_count].to_i %></span>
      </span>
      <span class="inline-flex items-center gap-1 rounded-full border border-border/60 bg-muted/20 px-2 py-0.5 text-muted-foreground">
        Over A1 <span class="font-mono tabular-nums text-foreground"><%= summary[:over_apron1_count].to_i %></span>
      </span>
      <span class="inline-flex items-center gap-1 rounded-full border border-border/60 bg-muted/20 px-2 py-0.5 text-muted-foreground">
        Over A2 <span class="font-mono tabular-nums text-foreground"><%= summary[:over_apron2_count].to_i %></span>
      </span>
    </div>

    <div class="border-t border-border pt-3 space-y-1.5">
      <div class="flex items-center justify-between gap-2 text-[10px] uppercase tracking-wide text-muted-foreground/80">
        <span>Active pressure posture</span>
        <span class="normal-case tracking-normal text-muted-foreground"><%= active_sort_label %></span>
      </div>

      <div class="flex items-center justify-between gap-2">
        <span class="<%= active_chip_classes %>"><%= active_pressure_label %></span>
        <span class="text-[11px] text-muted-foreground font-mono tabular-nums"><%= active_pressure_count %> rows</span>
      </div>

      <div class="space-y-0.5">
        <% pressure_options.each do |lens, label| %>
          <div
            class="flex items-center justify-between rounded px-1.5 py-1 text-[11px] border border-transparent"
            data-class="{ 'bg-yellow-50/70 dark:bg-yellow-900/15 border-border/70': $tspressure === '<%= lens %>', 'text-muted-foreground': $tspressure !== '<%= lens %>' }"
          >
            <span data-class="{ 'text-foreground font-medium': $tspressure === '<%= lens %>', 'text-muted-foreground': $tspressure !== '<%= lens %>' }"><%= label %></span>
            <span class="font-mono tabular-nums"><%= pressure_counts[lens].to_i %></span>
          </div>
        <% end %>
      </div>
    </div>

    <% if Array(summary[:filters]).any? %>
      <div class="pt-1 flex flex-wrap gap-1">
        <% Array(summary[:filters]).each do |label| %>
          <span class="entity-chip entity-chip--muted"><%= label %></span>
        <% end %>
      </div>
    <% end %>
  </section>

  <section class="border-t border-border pt-3">
    <div class="flex items-center justify-between px-0.5 pb-2 text-[10px] uppercase tracking-wide text-muted-foreground/80">
      <span>Pressure board</span>
      <span class="font-mono tabular-nums normal-case tracking-normal"><%= top_rows.length %> teams</span>
    </div>

    <% if top_rows.empty? %>
      <div class="p-3 text-sm text-muted-foreground italic">No rows.</div>
    <% else %>
      <div class="divide-y divide-border border border-border/70 rounded-lg overflow-hidden bg-background">
        <% top_rows.each do |row| %>
          <% team_code = row["team_code"].to_s.upcase %>
          <% team_id = row["team_id"] %>
          <% logo_url = team_logo_url(team_id) %>
          <% pressure_bucket = row["pressure_bucket"].to_s %>
          <% pressure_label, pressure_classes = case pressure_bucket
            when "over_apron2"
              ["Over Apron 2", "text-red-600 dark:text-red-400"]
            when "over_apron1"
              ["Over Apron 1", "text-orange-600 dark:text-orange-400"]
            when "over_tax"
              ["Over Tax", "text-orange-600 dark:text-orange-400"]
            when "over_cap"
              ["Over Cap", "text-muted-foreground"]
            else
              ["Under Cap", "text-emerald-600 dark:text-emerald-400"]
            end %>
          <% sidebar_path = team_summary_sidebar_path(team_code: team_code, **@state_params.merge(selected: team_code)) %>

          <button
            type="button"
            class="group cursor-pointer w-full px-3 py-2 text-left hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 transition-colors duration-75"
            data-class="{ 'bg-yellow-100/80 dark:bg-yellow-900/20': $selectedteam === '<%= team_code %>' }"
            data-on:click="$selectedteam = '<%= team_code %>'; @get('<%= sidebar_path %>')"
          >
            <div class="grid grid-cols-[30px_1fr_auto] grid-rows-[20px_16px] items-center gap-x-2">
              <div class="row-span-2 flex items-center justify-center">
                <div class="w-7 h-7 rounded border border-border bg-background overflow-hidden flex items-center justify-center">
                  <% if logo_url.present? %>
                    <img
                      src="<%= logo_url %>"
                      alt="<%= row['team_name'] %> logo"
                      class="w-full h-full object-contain"
                      loading="lazy"
                      decoding="async"
                      onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                    />
                    <span class="hidden text-[9px] font-semibold text-muted-foreground"><%= team_code %></span>
                  <% else %>
                    <span class="text-[9px] font-semibold text-muted-foreground"><%= team_code %></span>
                  <% end %>
                </div>
              </div>

              <div class="min-w-0">
                <a href="<%= team_href(team_code: team_code, team_id: team_id) %>" class="truncate text-sm font-medium hover:underline" onclick="event.stopPropagation()"><%= row["team_name"] %></a>
              </div>

              <div class="text-right font-mono tabular-nums text-[12px] <%= row['room_under_apron2'].to_f < 0 ? 'text-red-600 dark:text-red-400' : '' %>">
                <%= row["room_under_apron2"].nil? ? "—" : format_room_amount(row["room_under_apron2"]) %>
              </div>

              <div class="truncate text-[11px] <%= pressure_classes %>"><%= pressure_label %></div>

              <div class="text-right font-mono tabular-nums text-[11px] text-muted-foreground">
                <%= row["luxury_tax_owed"].to_f > 0 ? format_compact_currency(row["luxury_tax_owed"]) : "—" %>
              </div>
            </div>
          </button>
        <% end %>
      </div>
    <% end %>
  </section>
</div>
