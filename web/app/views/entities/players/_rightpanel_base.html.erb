<% if @sidebar_summary.present? %>
  <% summary = @sidebar_summary %>
  <% cap_horizon = summary[:cap_horizon].to_i %>
  <% cap_horizon_label = summary[:cap_horizon_label].presence || format_year_label(cap_horizon) %>
  <% next_horizon_label = format_year_label(cap_horizon + 1) %>
  <% active_constraint_reason = summary[:constraint_lens_match_reason].to_s.presence %>

  <% urgency_chip_class = lambda do |key|
    case key.to_s
    when "urgent"
      "entity-chip entity-chip--danger"
    when "upcoming"
      "entity-chip entity-chip--warning"
    else
      "entity-chip entity-chip--muted"
    end
  end %>

  <% compare_a_row = summary[:compare_a_row] %>
  <% compare_b_row = summary[:compare_b_row] %>
  <% compare_slots = [
    { key: "a", label: "Slot A", row: compare_a_row, tone: "indigo" },
    { key: "b", label: "Slot B", row: compare_b_row, tone: "emerald" }
  ] %>
  <% has_compare = compare_slots.any? { |slot| slot[:row].present? } %>

  <% if compare_a_row.present? && compare_b_row.present? %>
    <% compare_cap_lens_delta = compare_b_row["cap_lens_value"].to_f - compare_a_row["cap_lens_value"].to_f %>
    <% compare_cap_next_delta = compare_b_row["cap_next_value"].to_f - compare_a_row["cap_next_value"].to_f %>
  <% end %>

  <% refresh_query_expr = "'q=' + encodeURIComponent($playerquery) +
    '&team=' + encodeURIComponent($playerteam) +
    '&status=' + encodeURIComponent($playerstatus) +
    '&constraint=' + encodeURIComponent($playerconstraint) +
    '&urgency=' + encodeURIComponent($playerurgency) +
    '&urgency_sub=' + encodeURIComponent($playerurgencysub) +
    '&horizon=' + encodeURIComponent($playerhorizon) +
    '&sort=' + encodeURIComponent($playersort) +
    '&compare_a=' + encodeURIComponent($comparea) +
    '&compare_b=' + encodeURIComponent($compareb) +
    '&selected_id=' + encodeURIComponent($overlaytype === 'player' ? $selectedplayerid : '')" %>

  <div id="rightpanel-base" class="space-y-4">
    <div class="rounded-lg border border-border bg-background p-3 space-y-3">
      <div>
        <div class="text-[10px] uppercase tracking-wide text-muted-foreground/80">Workspace snapshot</div>
        <div class="text-sm font-semibold text-foreground">
          Players
          <span class="text-muted-foreground font-medium">· <%= summary[:row_count].to_i %> rows</span>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-1.5">
        <%= render partial: "tools/salary_book/kpi_cell", locals: {
          label: "Rows",
          value: summary[:row_count].to_i.to_s,
          class_name: "w-full"
        } %>

        <%= render partial: "tools/salary_book/kpi_cell", locals: {
          label: "Teams",
          value: summary[:team_count].to_i.to_s,
          class_name: "w-full"
        } %>

        <%= render partial: "tools/salary_book/kpi_cell", locals: {
          label: "Urgent",
          value: summary[:urgent_count].to_i.to_s,
          class_name: "w-full",
          variant: (summary[:urgent_count].to_i.positive? ? "negative" : "muted")
        } %>

        <%= render partial: "tools/salary_book/kpi_cell", locals: {
          label: "Upcoming",
          value: summary[:upcoming_count].to_i.to_s,
          class_name: "w-full",
          variant: (summary[:upcoming_count].to_i.positive? ? "default" : "muted")
        } %>
      </div>

      <div class="grid grid-cols-2 gap-1.5">
        <%= render partial: "tools/salary_book/kpi_cell", locals: {
          label: "Stable",
          value: summary[:stable_count].to_i.to_s,
          class_name: "w-full"
        } %>

        <%= render partial: "tools/salary_book/kpi_cell", locals: {
          label: "Cap #{cap_horizon_label}",
          value: format_compact_currency(summary[:total_cap]),
          value_class_name: "text-[11px]",
          class_name: "w-full"
        } %>
      </div>

      <div class="pt-1 flex flex-wrap gap-1.5">
        <span class="<%= urgency_chip_class.call('urgent') %>">Urgent <%= summary[:urgent_count].to_i %></span>
        <span class="<%= urgency_chip_class.call('upcoming') %>">Upcoming <%= summary[:upcoming_count].to_i %></span>
        <span class="<%= urgency_chip_class.call('stable') %>">Stable <%= summary[:stable_count].to_i %></span>
        <% if summary[:urgency_sub_lens].to_s != "all" %>
          <span class="entity-chip entity-chip--accent"><%= summary[:urgency_sub_lens_label].presence || "Focused" %></span>
        <% end %>
      </div>

      <% if Array(summary[:filters]).any? %>
        <div class="pt-1 flex flex-wrap gap-1">
          <% Array(summary[:filters]).each do |label| %>
            <span class="entity-chip entity-chip--muted"><%= label %></span>
          <% end %>
        </div>
      <% end %>

      <% if active_constraint_reason.present? %>
        <div class="rounded border border-border/60 bg-muted/20 px-2 py-1.5 text-[10px] leading-tight text-muted-foreground">
          <span class="text-foreground/90">Constraint filter</span>: <%= active_constraint_reason %>
        </div>
      <% end %>
    </div>

    <div class="rounded-lg border border-border bg-background p-3 space-y-2">
      <div class="flex items-center justify-between gap-2">
        <div class="text-[10px] uppercase tracking-wide font-semibold text-muted-foreground/80">Compare slots</div>
        <% if has_compare %>
          <button
            type="button"
            class="cursor-pointer text-[10px] text-muted-foreground hover:text-foreground hover:underline"
            data-on:click="@get('/players/sse/refresh?' + (<%= refresh_query_expr %>) + '&compare_action=clear_all')"
          >Clear all</button>
        <% end %>
      </div>

      <div class="grid grid-cols-2 gap-2 text-[11px]">
        <% compare_slots.each do |slot| %>
          <% row = slot[:row] %>
          <% slot_badge_class = slot[:tone] == "indigo" ? "text-indigo-700 dark:text-indigo-300 border-indigo-500/40 bg-indigo-500/10" : "text-emerald-700 dark:text-emerald-300 border-emerald-500/40 bg-emerald-500/10" %>
          <div class="rounded border border-border px-2 py-1.5 space-y-1">
            <div class="flex items-center justify-between gap-1">
              <span class="inline-flex items-center rounded border px-1 py-0.5 text-[9px] font-semibold uppercase tracking-wide <%= slot_badge_class %>"><%= slot[:label] %></span>
              <% if row.present? %>
                <button
                  type="button"
                  class="cursor-pointer text-[9px] text-muted-foreground hover:text-foreground hover:underline"
                  data-on:click="@get('/players/sse/refresh?' + (<%= refresh_query_expr %>) + '&compare_action=clear_slot&compare_slot=<%= slot[:key] %>')"
                >Clear</button>
              <% end %>
            </div>

            <% if row.present? %>
              <% player_id = row["player_id"] %>
              <button
                type="button"
                class="cursor-pointer w-full text-left"
                data-on:click="$selectedplayerid = '<%= player_id %>'; $overlaytype = 'player'; @get('/players/sidebar/<%= player_id %>')"
              >
                <div class="font-medium truncate"><%= row["player_name"] %></div>
                <div class="mt-0.5 text-[10px] text-muted-foreground/80 tabular-nums"><%= row["team_code"].presence || "FA" %> · <%= row["urgency_label"].presence || "Stable commitments" %></div>
              </button>
            <% else %>
              <div class="text-[10px] text-muted-foreground italic">No player pinned.</div>
            <% end %>
          </div>
        <% end %>
      </div>

      <% if compare_a_row.present? && compare_b_row.present? %>
        <div class="rounded border border-border/60 bg-muted/20 px-2 py-1.5 text-[10px] tabular-nums flex flex-wrap gap-2">
          <span class="font-medium text-muted-foreground"><%= compare_b_row["player_name"] %> vs <%= compare_a_row["player_name"] %></span>
          <span class="<%= compare_cap_lens_delta >= 0 ? 'text-emerald-600 dark:text-emerald-400' : 'text-red-600 dark:text-red-400' %>">Cap <%= cap_horizon_label %> <%= format_room_amount(compare_cap_lens_delta) %></span>
          <span class="<%= compare_cap_next_delta >= 0 ? 'text-emerald-600 dark:text-emerald-400' : 'text-red-600 dark:text-red-400' %>">Cap <%= next_horizon_label %> <%= format_room_amount(compare_cap_next_delta) %></span>
        </div>
      <% end %>
    </div>

    <div class="rounded-lg border border-border bg-background">
      <div class="px-3 py-2 border-b border-border">
        <div class="text-[10px] uppercase tracking-wide text-muted-foreground/80">Urgency quick feed · <%= cap_horizon_label %></div>
        <div class="text-[10px] text-muted-foreground/70">Mirrors the same urgent/upcoming/stable grammar as the main scan lanes.</div>
      </div>

      <% top_row_lanes = Array(summary[:top_row_lanes]) %>
      <% if top_row_lanes.empty? %>
        <div class="p-3 text-sm text-muted-foreground italic">No rows.</div>
      <% else %>
        <div class="divide-y divide-border">
          <% top_row_lanes.each do |lane| %>
            <section id="players-quick-lane-<%= lane[:key] %>" class="border-b border-border/60 last:border-b-0">
              <div class="px-3 py-1.5 bg-muted/30 border-b border-border/50 flex items-center justify-between gap-2 text-[10px] uppercase tracking-wide">
                <span class="<%= urgency_chip_class.call(lane[:key]) %>"><%= lane[:title] %></span>
                <span class="font-mono tabular-nums text-muted-foreground"><%= lane[:row_count] %></span>
              </div>

              <div class="divide-y divide-border/50">
                <% Array(lane[:rows]).each do |row| %>
                  <% player_id = row["player_id"] %>
                  <% open_expr = "$selectedplayerid = '#{player_id}'; $overlaytype = 'player'; @get('/players/sidebar/#{player_id}')" %>

                  <button
                    type="button"
                    class="cursor-pointer w-full px-3 py-2 text-left hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 transition-colors duration-75"
                    data-class="{ 'bg-yellow-100/80 dark:bg-yellow-900/20': $selectedplayerid === '<%= player_id %>' }"
                    data-on:click="<%= open_expr %>"
                  >
                    <div class="entity-cell-two-line">
                      <div class="entity-cell-primary justify-between gap-2">
                        <a href="/players/<%= player_id %>" class="truncate font-medium hover:underline" onclick="event.stopPropagation()"><%= row["player_name"] %></a>
                        <span class="font-mono tabular-nums text-[11px] shrink-0"><%= row["cap_lens_value"].present? ? format_compact_currency(row["cap_lens_value"]) : "—" %></span>
                      </div>
                      <div class="entity-cell-secondary justify-between gap-2">
                        <span class="truncate"><%= row["team_code"].presence || "Free Agent" %> · <%= row["urgency_reason"].presence || "No immediate horizon trigger" %></span>
                        <% if row["is_two_way"] %>
                          <span class="entity-chip entity-chip--muted">2W</span>
                        <% end %>
                      </div>
                    </div>
                  </button>
                <% end %>
              </div>
            </section>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
<% elsif @player_id.present? %>
  <%
    decision_items = player_next_decision_items(
      salary_book_row: @salary_book_row,
      protection_condition_rows: @protection_condition_rows,
      ledger_entries: @ledger_entries
    )

    chip_class_for = lambda do |variant|
      case variant.to_s
      when "danger"
        "entity-chip entity-chip--danger"
      when "warning"
        "entity-chip entity-chip--warning"
      when "accent"
        "entity-chip entity-chip--accent"
      else
        "entity-chip entity-chip--muted"
      end
    end
  %>

  <div id="rightpanel-base" class="space-y-4">
    <div class="rounded-lg border border-border bg-background p-3 space-y-2">
      <div class="flex items-center justify-between gap-2">
        <div class="text-[10px] uppercase tracking-wide text-muted-foreground/80">Next decisions</div>
        <a href="#next-decisions" class="text-[10px] text-muted-foreground hover:text-foreground hover:underline">Jump</a>
      </div>

      <% if decision_items.empty? %>
        <div class="text-sm text-muted-foreground italic">No immediate decision triggers in the active horizon.</div>
      <% else %>
        <div class="divide-y divide-border/60">
          <% decision_items.first(6).each do |item| %>
            <% urgency = item[:urgency] || {} %>
            <div class="py-1.5 space-y-1">
              <div class="flex items-center justify-between gap-2">
                <a href="#next-decisions" class="text-xs font-medium hover:underline truncate"><%= item[:headline] %></a>
                <span class="text-[10px] font-mono tabular-nums text-muted-foreground shrink-0"><%= item[:season_label] %></span>
              </div>

              <div class="flex flex-wrap items-center gap-1.5">
                <span class="<%= chip_class_for.call(item[:category_variant]) %>"><%= item[:category_label] %></span>
                <span class="<%= chip_class_for.call(urgency[:variant]) %>"><%= urgency[:label] %></span>

                <% if item[:team_code].present? %>
                  <a href="<%= team_href(team_code: item[:team_code], team_id: item[:team_id]) %>" class="entity-chip entity-chip--muted hover:underline">Team <%= item[:team_code] %></a>
                <% end %>

                <% if item[:transaction_id].present? %>
                  <a href="<%= transaction_href(item[:transaction_id]) %>" class="entity-chip entity-chip--warning hover:underline">Txn #<%= item[:transaction_id] %></a>
                <% end %>

                <% if item[:trade_id].present? %>
                  <a href="<%= trade_href(item[:trade_id]) %>" class="entity-chip entity-chip--accent hover:underline">Trade #<%= item[:trade_id] %></a>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

    <%= render partial: "entities/shared/known_slugs", locals: {
      entity_type: "player",
      entity_id: @player_id,
      path_prefix: "players"
    } %>
  </div>
<% else %>
  <div id="rightpanel-base" class="space-y-4">
    <div class="p-4 rounded-lg border border-border bg-muted/20 text-sm text-muted-foreground">
      Select a player row to inspect snapshot details.
    </div>
  </div>
<% end %>
