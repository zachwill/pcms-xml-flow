<%
  pane_query_expr = "'year=' + encodeURIComponent($agencyyear) +
    '&sort=' + encodeURIComponent($agencysort) +
    '&dir=' + encodeURIComponent($agencydir)"

  selected_overlay_query_expr = "'selected_id=' + encodeURIComponent($overlayid)"

  refresh_expr = "@get('/agencies/sse/refresh?' + (#{pane_query_expr}) + '&' + (#{selected_overlay_query_expr})); window.history.replaceState({}, '', '/agencies?' + (#{pane_query_expr}))"
  sort_change_expr = "$agencydir = (el.value === 'name' ? 'asc' : 'desc'); #{refresh_expr}"

  sort_options = [
    ["name", "A â†’ Z"],
    ["book", "Book"],
    ["agents", "Agents"],
    ["clients", "Clients"],
    ["max", "Max"],
    ["expirings", "Expiring"],
    ["restr", "Restr"],
    ["options", "Options"],
    ["two_ways", "Two-Ways"]
  ]

  sort_options_by_key = sort_options.to_h
  sort_primary_keys = %w[name book agents clients]
  sort_secondary_keys = %w[max expirings restr options two_ways]

  agents_sort_key = %w[book clients max expirings options name].include?(@sort_key.to_s) ? @sort_key.to_s : "book"
  agents_view_href = "/agents?#{ { kind: 'agents', year: @book_year, sort: agents_sort_key, dir: @sort_dir }.to_query }"
  agencies_view_href = "/agencies?#{ { year: @book_year, sort: @sort_key, dir: @sort_dir }.to_query }"
%>

<header id="commandbar" class="sticky top-0 z-40 shrink-0 h-[130px] border-b border-border bg-background px-4 pt-3 flex items-start gap-2 select-none">
  <div class="flex items-start min-w-0 overflow-x-auto pb-1 pr-1">
    <div class="w-fit min-w-[5.25rem] space-y-1 shrink-0">
      <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">View</div>
      <div class="space-y-1">
        <label class="flex items-center gap-1.5 cursor-pointer select-none">
          <input
            type="radio"
            id="agencies-view-agencies"
            name="agencies-view"
            class="size-3.5 accent-primary"
            checked
            data-on:change="if (el.checked) { window.location.href = '<%= agencies_view_href %>'; }"
          />
          <span class="text-[11px] leading-none font-semibold text-foreground">Agencies</span>
        </label>

        <label class="flex items-center gap-1.5 cursor-pointer select-none">
          <input
            type="radio"
            id="agencies-view-agents"
            name="agencies-view"
            class="size-3.5 accent-primary"
            data-on:change="if (el.checked) { window.location.href = '<%= agents_view_href %>'; }"
          />
          <span class="text-[11px] leading-none text-muted-foreground">Agents</span>
        </label>
      </div>
    </div>

    <div class="h-20 w-px bg-border self-center shrink-0 mx-3"></div>

    <div class="w-fit min-w-[5.25rem] space-y-1 shrink-0">
      <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Book Year</div>
      <div class="space-y-1">
        <% [2025, 2026, 2027].each do |year| %>
          <label class="flex items-center gap-1.5 cursor-pointer select-none">
            <input
              type="radio"
              id="agencies-book-year-<%= year %>"
              name="agencies-book-year"
              value="<%= year %>"
              class="size-3.5 accent-primary"
              <%= "checked" if @book_year == year %>
              data-bind="agencyyear"
              data-on:change="if (el.checked) { <%= refresh_expr %>; }"
            />
            <span class="text-[11px] leading-none tabular-nums text-foreground/90"><%= format_year_label(year) %></span>
          </label>
        <% end %>
      </div>
    </div>

    <div class="h-20 w-px bg-border self-center shrink-0 mx-3"></div>

    <div class="w-fit space-y-1 shrink-0">
      <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Sort By</div>
      <div class="grid grid-cols-[max-content_max-content] gap-x-6 gap-y-1">
        <div class="space-y-1">
          <% sort_primary_keys.each do |key| %>
            <% label = sort_options_by_key[key] %>
            <% next if label.blank? %>
            <label class="flex items-center gap-1.5 cursor-pointer select-none">
              <input
                type="radio"
                id="agencies-sort-<%= key %>"
                name="agencies-sort"
                value="<%= key %>"
                class="size-3.5 accent-primary"
                <%= "checked" if @sort_key == key %>
                data-bind="agencysort"
                data-on:change="if (el.checked) { <%= sort_change_expr %>; }"
              />
              <span
                class="text-[11px] leading-none"
                data-class="{ 'text-foreground font-semibold': $agencysort === '<%= key %>', 'text-muted-foreground': $agencysort !== '<%= key %>' }"
              ><%= label %></span>
            </label>
          <% end %>
        </div>

        <div class="space-y-1">
          <% sort_secondary_keys.each do |key| %>
            <% label = sort_options_by_key[key] %>
            <% next if label.blank? %>
            <label class="flex items-center gap-1.5 cursor-pointer select-none">
              <input
                type="radio"
                id="agencies-sort-<%= key %>"
                name="agencies-sort"
                value="<%= key %>"
                class="size-3.5 accent-primary"
                <%= "checked" if @sort_key == key %>
                data-bind="agencysort"
                data-on:change="if (el.checked) { <%= sort_change_expr %>; }"
              />
              <span
                class="text-[11px] leading-none"
                data-class="{ 'text-foreground font-semibold': $agencysort === '<%= key %>', 'text-muted-foreground': $agencysort !== '<%= key %>' }"
              ><%= label %></span>
            </label>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <div class="h-20 w-px bg-border self-center ml-auto shrink-0"></div>
  <%= render partial: "shared/commandbar_navigation", locals: { active_destination: "agents" } %>
</header>
