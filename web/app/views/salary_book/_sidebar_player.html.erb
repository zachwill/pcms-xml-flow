<%#
  Player overlay (RightPanel entity) — Salary Book sidebar

  NOTE: Root id must remain stable for Datastar morphing.
%>

<% salary_years = SalaryBookHelper::SALARY_YEARS %>
<% compact = ->(v) { format_salary(v) } %>

<% player_id = player["player_id"] %>
<% player_name = player["player_name"] %>
<% team_code = player["team_code"].presence || "—" %>
<% team_id = player["team_id"] %>
<% team_name = player["team_name"].presence || team_code %>
<% team_logo = team_logo_url(team_id) %>
<% agent_name = player["agent_name"] %>
<% agent_id = player["agent_id"] %>
<% age_yos = player_age_yos_display(player) %>
<% is_two_way = player["is_two_way"] %>

<%
  team_switchable = team_code.match?(/\A[A-Z]{3}\z/)
  team_combo_chip_classes = "cursor-pointer inline-flex items-center gap-0.5 px-1.5 rounded border border-border bg-background hover:border-foreground/20"
  team_combo_chip_style = "width: 78px; height: 24px;"
  team_combo_logo_wrap_classes = "inline-flex items-center justify-center w-4 h-4 overflow-hidden rounded-[3px] bg-muted/20"
  team_combo_logo_image_classes = "w-full h-full object-cover object-center scale-[1.12]"
  team_combo_code_classes = "flex-1 text-xs font-semibold tabular-nums leading-none text-center"

  team_row_onclick = if team_switchable
    "const effectiveyear = String($sidebarcapyearloaded || '#{salary_years.first}'); " \
      "el.dispatchEvent(new CustomEvent('salarybook-switch-team', { bubbles: true, detail: { team: '#{team_code}', year: effectiveyear } }));"
  end

  years_data = salary_years.map do |y|
    salary = player["cap_#{y}"]
    option = normalize_contract_option(player["option_#{y}"])
    guaranteed_amount = player["guaranteed_amount_#{y}"]
    is_full = player["is_fully_guaranteed_#{y}"]
    is_partial = player["is_partially_guaranteed_#{y}"]
    is_non = player["is_non_guaranteed_#{y}"]
    likely_bonus = player["likely_bonus_#{y}"]
    unlikely_bonus = player["unlikely_bonus_#{y}"]

    guarantee_status = if is_full
      "FULL"
    elsif is_partial
      "PARTIAL"
    elsif is_non
      "NONE"
    end

    {
      year: y,
      salary: salary,
      option: option,
      guaranteed_amount: guaranteed_amount,
      guarantee_status: guarantee_status,
      likely_bonus: likely_bonus,
      unlikely_bonus: unlikely_bonus
    }
  end

  active_years = years_data.select { |yd| yd[:salary].present? && yd[:salary].to_f > 0 }

  total_value = active_years.sum { |yd| yd[:salary].to_f }
  contract_years = active_years.size

  # Snapshot / KPI values
  cap_2025 = player["cap_2025"]

  next_option = salary_years.drop(1).map do |y|
    opt = normalize_contract_option(player["option_#{y}"])
    next nil if opt.blank?

    {
      year: y,
      option: opt
    }
  end.compact.first

  fa_year = nil
  unless is_two_way
    salary_years.each_cons(2) do |y, y_next|
      if player["cap_#{y}"].to_f > 0 && player["cap_#{y_next}"].to_f == 0
        fa_year = y
        break
      end
    end
  end

  next_decision_label = if next_option.present?
    "#{next_option[:option]} #{format_year_label(next_option[:year])}"
  elsif fa_year.present?
    "FA #{format_year_label(fa_year)}"
  elsif is_two_way
    "Two-Way"
  else
    "—"
  end

  next_decision_variant = if next_option.present?
    case next_option[:option]
    when "PO" then "option_po"
    when "TO" then "option_to"
    when "ETO" then "option_eto"
    else "muted"
    end
  elsif fa_year.present?
    "default"
  elsif is_two_way
    "muted"
  else
    "muted"
  end

  header_contract_label = if next_option.present?
    "#{next_option[:option]} #{format_year_label(next_option[:year])}"
  elsif fa_year.present?
    "FA #{format_year_label(fa_year + 1)}"
  elsif is_two_way
    "2W"
  end

  header_contract_classes = case next_decision_variant
  when "option_po"
    "text-blue-600 dark:text-blue-400"
  when "option_to"
    "text-purple-600 dark:text-purple-400"
  when "option_eto"
    "text-orange-600 dark:text-orange-400"
  else
    "text-muted-foreground"
  end
%>

<%
  # Trade restrictions / flags
  is_no_trade = player["is_no_trade"]
  is_trade_bonus = player["is_trade_bonus"]
  trade_bonus_percent = player["trade_bonus_percent"]
  is_consent_required = player["is_trade_consent_required_now"]
  is_preconsented = player["is_trade_preconsented"]
  is_poison_pill = player["is_poison_pill"]
  is_trade_restricted_now = player["is_trade_restricted_now"]

  trade_kicker_label = if trade_bonus_percent.present? && trade_bonus_percent.to_f > 0
    pct = trade_bonus_percent.to_f
    pct_str = pct % 1 == 0 ? pct.to_i.to_s : pct.to_s
    "TK #{pct_str}%"
  else
    "Trade Kicker"
  end

  restrictions = [
    { label: trade_kicker_label, active: is_trade_bonus, classes: "bg-orange-100 text-orange-700 dark:bg-orange-900/50 dark:text-orange-300" },
    { label: "No-Trade", active: is_no_trade, classes: "bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-300" },
    { label: "Consent Required", active: is_consent_required, classes: "bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-300" },
    { label: "Restricted", active: is_trade_restricted_now, classes: "bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-300" },
    { label: "Poison Pill", active: is_poison_pill, classes: "bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-300 italic" },
    { label: "Pre-consented", active: is_preconsented, classes: "bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-300" }
  ]

  active_restrictions = restrictions.select { |r| r[:active] }

  status_chips = []
  status_chips << { label: "Two-Way", classes: "bg-zinc-100 text-zinc-700 dark:bg-zinc-800/60 dark:text-zinc-300" } if is_two_way
  if player["is_min_contract"]
    min_label = player["min_contract_lookup_value"].presence
    status_chips << { label: min_label.present? ? "Min · #{min_label}" : "Minimum", classes: "bg-zinc-100 text-zinc-700 dark:bg-zinc-800/60 dark:text-zinc-300" }
  end
  status_chips.concat(active_restrictions)
%>

<%
  contract_type = player["contract_type_lookup_value"] || player["contract_type_code"]
  signed_using = player["signed_method_lookup_value"]
  exception_type = player["exception_type_lookup_value"]
  epm_value = player["epm_value"]
  epm_percentile = player["epm_percentile"]
  epm_season = player["epm_season"]
  epm_season_label = format_epm_season_label(epm_season)

  epm_percentile_int_value = epm_percentile_int(epm_percentile)
  epm_has_percentile = epm_percentile_int_value.present?
  epm_badge_class = if epm_percentile_int_value.present? && epm_percentile_int_value >= 80
    "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300"
  elsif epm_percentile_int_value.present? && epm_percentile_int_value <= 20
    "bg-red-100 text-red-700 dark:bg-red-900/40 dark:text-red-300"
  else
    "bg-muted text-foreground"
  end
%>

<div
  id="rightpanel-overlay"
  class="h-full"
  data-signals="{ playertab: 'contract', _playerepmhover: false }"
  data-effect="
    if ($playertab !== 'contract' && $_playerepmhover) {
      $_playerepmhover = false;
    }
  "
>
  <%# Sticky header %>
  <div class="sticky top-0 z-20 h-10 px-4 flex items-center justify-between border-b border-border bg-background">
    <%= render partial: "salary_book/sidebar_back_button" %>

    <a
      class="text-xs text-muted-foreground hover:text-foreground hover:underline"
      href="<%= player_href(player_id) %>"
    >Open player page</a>
  </div>

  <div class="px-4 pb-4 pt-4 space-y-5">
    <%# Header %>
    <div class="flex items-center gap-3">
      <div class="flex items-center gap-1.5 shrink-0">
        <div
          class="w-10 h-10 rounded-full border border-border bg-background overflow-hidden flex items-center justify-center"
          title="<%= team_name %>"
          aria-label="<%= team_name %>"
        >
          <% if team_logo.present? %>
            <img
              src="<%= team_logo %>"
              alt="<%= team_name %> logo"
              class="w-full h-full object-contain p-0.5"
              loading="lazy"
              decoding="async"
              onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
            />
            <span class="hidden text-[10px] font-semibold text-muted-foreground"><%= team_code %></span>
          <% else %>
            <span class="text-[10px] font-semibold text-muted-foreground"><%= team_code %></span>
          <% end %>
        </div>

        <div class="w-14 h-14 rounded border border-border bg-background overflow-hidden">
          <img
            src="<%= player_headshot_url(player_id) %>"
            alt="<%= player_name %>"
            class="w-full h-full object-cover object-top bg-muted"
            loading="lazy"
            decoding="async"
            onerror="if (this.src !== '<%= fallback_headshot_data_uri %>') { this.src = '<%= fallback_headshot_data_uri %>'; }"
          />
        </div>
      </div>

      <div class="min-w-0 space-y-0.5">
        <h2 class="text-lg font-semibold text-foreground truncate"><%= player_name %></h2>

        <div class="text-xs text-muted-foreground/80 tabular-nums flex items-center gap-1 min-w-0 overflow-hidden whitespace-nowrap">
          <% if age_yos.present? || header_contract_label.present? %>
            <% if age_yos.present? %>
              <span class="truncate"><%= age_yos %></span>
            <% end %>

            <% if header_contract_label.present? %>
              <% if age_yos.present? %>
                <span class="text-muted-foreground/50">·</span>
              <% end %>
              <span class="shrink-0 font-medium <%= header_contract_classes %>"><%= header_contract_label %></span>
            <% end %>
          <% else %>
            <span class="text-muted-foreground/50">—</span>
          <% end %>
        </div>
      </div>
    </div>

    <%# Segmented control (kept, even while non-contract tabs are placeholders) %>
    <div class="relative grid grid-cols-4 p-1 rounded-lg bg-muted border border-border">
      <div
        class="absolute top-1 bottom-1 left-1 w-[calc((100%_-_8px)/4)] rounded-md bg-background shadow-sm pointer-events-none transition-[transform,width,opacity] duration-150 ease-out"
        data-class="{
          'translate-x-0': $playertab === 'contract',
          'translate-x-full': $playertab === 'stats',
          'translate-x-[200%]': $playertab === 'history',
          'translate-x-[300%]': $playertab === 'comps'
        }"
        aria-hidden="true"
      ></div>

      <% player_tabs = [
        ["contract", "Contract"],
        ["stats", "Stats"],
        ["history", "History"],
        ["comps", "Comps"]
      ] %>

      <% player_tabs.each do |(id, label)| %>
        <button
          type="button"
          class="cursor-pointer relative z-10 min-w-0 px-3 py-1.5 text-sm font-medium text-center rounded-md transition-colors duration-150
                 focus-visible:outline-none focus-visible:ring-0 focus-visible:border-foreground dark:focus-visible:border-foreground"
          data-on:click="$playertab = '<%= id %>'"
          data-class="{ 'text-foreground': $playertab === '<%= id %>', 'text-muted-foreground hover:text-foreground': $playertab !== '<%= id %>' }"
        ><%= label %></button>
      <% end %>
    </div>

    <%# Snapshot KPIs %>
    <div class="border-t border-border pt-4 space-y-2.5">
      <div class="grid grid-cols-4 gap-1.5">
        <%= render partial: "salary_book/kpi_cell", locals: {
          label: format_year_label(2025),
          value: compact.call(cap_2025),
          class_name: "w-full",
          value_class_name: "text-[11px]",
          variant: (cap_2025.to_f > 0 ? "default" : "muted")
        } %>

        <%= render partial: "salary_book/kpi_cell", locals: {
          label: "Total",
          value: compact.call(total_value),
          class_name: "w-full",
          value_class_name: "text-[11px]",
          variant: (total_value > 0 ? "default" : "muted")
        } %>

        <%= render partial: "salary_book/kpi_cell", locals: {
          label: "Years",
          value: contract_years.to_s,
          class_name: "w-full",
          variant: (contract_years > 0 ? "default" : "muted")
        } %>

        <%= render partial: "salary_book/kpi_cell", locals: {
          label: "Next",
          value: next_decision_label,
          class_name: "w-full",
          value_class_name: "text-[10px]",
          variant: next_decision_variant
        } %>
      </div>

      <% if status_chips.any? %>
        <div class="pt-0.5 flex flex-wrap gap-1.5">
          <% status_chips.each do |chip| %>
            <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-[9px] font-semibold uppercase tracking-wide leading-none <%= chip[:classes] %>">
              <%= chip[:label] %>
            </span>
          <% end %>
        </div>
      <% end %>
    </div>

    <%# Contract tab %>
    <div data-show="$playertab === 'contract'" class="space-y-4">
      <%# Contract details (dense rows) %>
      <div
        class="border-t border-border pt-4 space-y-0.5"
        <% if epm_has_percentile %>
          data-on:mouseenter="$_playerepmhover = true"
          data-on:mouseleave="$_playerepmhover = false"
        <% end %>
      >
        <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground mb-1.5">Contract details</div>

        <div class="flex items-center justify-between py-1.5 gap-3">
          <span class="text-sm text-muted-foreground">Team</span>

          <% if team_row_onclick.present? %>
            <button
              type="button"
              class="<%= team_combo_chip_classes %>"
              style="<%= team_combo_chip_style %>"
              title="<%= team_name %>"
              data-on:click="<%= team_row_onclick %>"
            >
              <span class="<%= team_combo_logo_wrap_classes %>">
                <% if team_logo.present? %>
                  <img
                    src="<%= team_logo %>"
                    alt="<%= team_code %> logo"
                    class="<%= team_combo_logo_image_classes %>"
                    loading="lazy"
                    decoding="async"
                  />
                <% end %>
              </span>
              <span class="<%= team_combo_code_classes %>"><%= team_code %></span>
            </button>
          <% else %>
            <span class="text-sm font-medium tabular-nums"><%= team_code %></span>
          <% end %>
        </div>

        <% if agent_name.present? %>
          <div class="flex items-center justify-between py-1.5 gap-3">
            <span class="text-sm text-muted-foreground">Agent</span>
            <% if agent_id.present? %>
              <button
                type="button"
                class="cursor-pointer text-sm font-medium text-blue-600 dark:text-blue-400 hover:underline text-right
                       focus-visible:outline-none focus-visible:ring-0 focus-visible:border-foreground dark:focus-visible:border-foreground"
                data-on:click="@get('<%= salary_book_sidebar_agent_path(id: agent_id) %>')"
              ><%= agent_name %></button>
            <% else %>
              <span class="text-sm font-medium text-right"><%= agent_name %></span>
            <% end %>
          </div>
        <% end %>

        <% if contract_type.present? %>
          <div class="flex items-center justify-between py-1.5 gap-3">
            <span class="text-sm text-muted-foreground">Type</span>
            <span class="text-sm font-medium text-right"><%= contract_type %></span>
          </div>
        <% end %>

        <% if signed_using.present? %>
          <div class="flex items-center justify-between py-1.5 gap-3">
            <span class="text-sm text-muted-foreground">Signed via</span>
            <span class="text-sm font-medium text-right"><%= signed_using %></span>
          </div>
        <% end %>

        <% if exception_type.present? %>
          <div class="flex items-center justify-between py-1.5 gap-3">
            <span class="text-sm text-muted-foreground">Exception</span>
            <span class="text-sm font-medium text-right"><%= exception_type %></span>
          </div>
        <% end %>

        <% if epm_value.present? %>
          <div class="flex items-center justify-between py-1.5 gap-3">
            <span class="text-sm text-muted-foreground">Latest EPM<% if epm_season_label.present? %> (<%= epm_season_label %>)<% end %></span>
            <span class="relative inline-flex w-[9rem] justify-end items-center overflow-hidden">
              <span
                class="inline-flex items-center rounded px-1.5 py-0.5 text-sm font-semibold tabular-nums translate-x-0 transition-transform duration-200 ease-out <%= epm_badge_class %>"
                data-class="{
                  'translate-x-0': !$_playerepmhover,
                  '-translate-x-[3.1rem]': $_playerepmhover
                }"
              ><%= format_epm_value(epm_value) %></span>
              <% if epm_has_percentile %>
                <span
                  class="absolute right-0 text-sm font-semibold tabular-nums translate-x-4 opacity-0 transition-[opacity,transform] duration-200 ease-out <%= epm_percentile_color_class(epm_percentile) %>"
                  data-class="{
                    'translate-x-0 opacity-100': $_playerepmhover,
                    'translate-x-4 opacity-0': !$_playerepmhover
                  }"
                >P<%= epm_percentile_int_value %></span>
              <% end %>
            </span>
          </div>
        <% end %>
      </div>

      <%# Year-by-year ledger %>
      <div class="border-t border-border pt-4 space-y-2">
        <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Year-by-year</div>

        <% if active_years.empty? %>
          <div class="p-3 rounded-lg bg-muted/30 text-sm text-muted-foreground italic">No salary data available</div>
        <% else %>
          <div class="overflow-x-auto rounded-lg border border-border/60">
            <table class="min-w-full text-[11px]">
              <thead class="bg-muted/20 text-muted-foreground uppercase tracking-wide text-[10px]">
                <tr>
                  <th class="text-left px-2 py-1.5 font-medium">Year</th>
                  <th class="text-right px-2 py-1.5 font-medium">Cap</th>
                  <th class="text-right px-2 py-1.5 font-medium">Guarantee</th>
                  <th class="text-right px-2 py-1.5 font-medium">Option</th>
                  <th class="text-right px-2 py-1.5 font-medium">Bonuses</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-border/50">
                <% active_years.each do |yd| %>
                  <%
                    y = yd[:year]
                    salary = yd[:salary]
                    option = yd[:option]
                    guaranteed_amount = yd[:guaranteed_amount]
                    guarantee_status = yd[:guarantee_status]
                    likely_bonus = yd[:likely_bonus]
                    unlikely_bonus = yd[:unlikely_bonus]

                    guarantee_label = case guarantee_status
                    when "FULL" then "Full"
                    when "PARTIAL" then "Partial"
                    when "NONE" then "None"
                    end

                    option_badge_classes = case option
                    when "PO" then "bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-300"
                    when "TO" then "bg-purple-100 text-purple-700 dark:bg-purple-900/50 dark:text-purple-300"
                    when "ETO" then "bg-orange-100 text-orange-700 dark:bg-orange-900/50 dark:text-orange-300"
                    else nil
                    end

                    bonus_parts = []
                    bonus_parts << "L #{compact.call(likely_bonus)}" if likely_bonus.present? && likely_bonus.to_f != 0
                    bonus_parts << "U #{compact.call(unlikely_bonus)}" if unlikely_bonus.present? && unlikely_bonus.to_f != 0
                  %>
                  <tr class="hover:bg-yellow-50/70 dark:hover:bg-yellow-900/25 transition-colors duration-75">
                    <td class="px-2 py-1.5 tabular-nums"><%= format_year_label(y) %></td>
                    <td class="px-2 py-1.5 text-right tabular-nums font-medium"><%= compact.call(salary) %></td>
                    <td class="px-2 py-1.5 text-right">
                      <% if guaranteed_amount.present? || guarantee_label.present? %>
                        <div class="flex flex-col items-end leading-tight">
                          <span class="tabular-nums"><%= guaranteed_amount.present? ? compact.call(guaranteed_amount) : "—" %></span>
                          <% if guarantee_label.present? %>
                            <span class="text-[10px] text-muted-foreground"><%= guarantee_label %></span>
                          <% end %>
                        </div>
                      <% else %>
                        <span class="text-muted-foreground">—</span>
                      <% end %>
                    </td>
                    <td class="px-2 py-1.5 text-right">
                      <% if option.present? && option_badge_classes.present? %>
                        <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-[9px] font-semibold uppercase tracking-wide leading-none <%= option_badge_classes %>"><%= option %></span>
                      <% else %>
                        <span class="text-muted-foreground">—</span>
                      <% end %>
                    </td>
                    <td class="px-2 py-1.5 text-right tabular-nums text-[10px] text-muted-foreground">
                      <%= bonus_parts.any? ? bonus_parts.join(" · ") : "—" %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% end %>
      </div>
    </div>

    <%# Stats tab placeholder (keep segmented control; stay dense) %>
    <div data-show="$playertab === 'stats'" class="border-t border-border pt-4 space-y-1.5">
      <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Player Stats</div>
      <div class="text-sm text-muted-foreground">No stats warehouse feed is wired to the sidebar yet.</div>
    </div>

    <%# History tab placeholder %>
    <div data-show="$playertab === 'history'" class="border-t border-border pt-4 space-y-1.5">
      <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Contract History</div>
      <div class="text-sm text-muted-foreground">No historical contract module is wired here yet.</div>
    </div>

    <%# Comps tab placeholder %>
    <div data-show="$playertab === 'comps'" class="border-t border-border pt-4 space-y-1.5">
      <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Comparable Players</div>
      <div class="text-sm text-muted-foreground">No comps model is wired to this sidebar yet.</div>
    </div>
  </div>
</div>
