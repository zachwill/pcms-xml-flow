<% content_for :title, "Draft selection" %>

<% ds = @draft_selection %>
<% pick_label = "#{ds['draft_year']} — R#{ds['draft_round']} P#{ds['pick_number']}" %>
<% player_name = ds["player_name"].to_s %>
<% drafting_team_code = ds["drafting_team_code"].to_s %>

<div id="entity-directory" class="min-h-screen w-full bg-background">
  <%= render partial: "entities/shared/commandbar", locals: {
    active_entity_scope: "drafts"
  } %>

  <main class="px-4 pb-8 space-y-6" data-entity-workspace>
    <%= render partial: "entities/shared/workspace_header", locals: {
      breadcrumbs: [["Draft selections", "/draft-selections"], [pick_label, nil]],
      title: pick_label,
      subtitle: ((player_name.present? ? "#{player_name} · " : "") + "transaction_id: #{@draft_selection_id} · slug: #{@draft_selection_slug}" + (ds["transaction_date"].present? ? " · date: #{ds['transaction_date']}" : "")),
      right_links: [["Open Salary Book", "/tools/salary-book"], ["Find player", "/players"]]
    } %>

  <div class="lg:flex lg:gap-8">
    <%= render partial: "entities/shared/local_nav", locals: {
      sections: [
        ["vitals", "Vitals"],
        ["connections", "Connections"],
        ["provenance", "Pick provenance"]
      ]
    } %>

    <div class="min-w-0 flex-1 space-y-6">
      <section id="vitals" class="scroll-mt-24 space-y-3">
        <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Vitals</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
          <div class="rounded-lg border border-border bg-background p-3">
            <div class="text-xs text-muted-foreground">Draft year</div>
            <div class="mt-1 text-lg font-semibold font-mono tabular-nums"><%= ds["draft_year"] %></div>
          </div>
          <div class="rounded-lg border border-border bg-background p-3">
            <div class="text-xs text-muted-foreground">Round</div>
            <div class="mt-1 text-lg font-semibold font-mono tabular-nums"><%= ds["draft_round"] %></div>
          </div>
          <div class="rounded-lg border border-border bg-background p-3">
            <div class="text-xs text-muted-foreground">Pick number</div>
            <div class="mt-1 text-lg font-semibold font-mono tabular-nums"><%= ds["pick_number"] %></div>
          </div>
          <div class="rounded-lg border border-border bg-background p-3">
            <div class="text-xs text-muted-foreground">Drafting team</div>
            <div class="mt-1 text-sm font-medium"><%= drafting_team_code.presence || "—" %></div>
          </div>
        </div>
      </section>

      <section id="connections" class="scroll-mt-24 space-y-3">
        <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Connections</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div class="p-4 rounded-lg border border-border bg-background">
            <div class="text-[10px] uppercase tracking-wide text-muted-foreground">Player</div>
            <% if ds["player_id"].present? %>
              <a href="<%= player_href(ds['player_id']) %>" class="mt-1 block font-medium hover:underline"><%= player_name.presence || ds['player_id'] %></a>
            <% else %>
              <div class="mt-1 text-sm text-muted-foreground italic">Unknown</div>
            <% end %>
          </div>

          <div class="p-4 rounded-lg border border-border bg-background">
            <div class="text-[10px] uppercase tracking-wide text-muted-foreground">Drafting team</div>
            <% if ds["drafting_team_id"].present? %>
              <a href="<%= team_href(team_code: drafting_team_code, team_id: ds['drafting_team_id']) %>" class="mt-1 block font-medium hover:underline"><%= drafting_team_code.presence || "—" %></a>
              <div class="text-sm text-muted-foreground"><%= ds["team_name"].presence || "—" %></div>
            <% else %>
              <div class="mt-1 text-sm text-muted-foreground italic">Unknown</div>
            <% end %>
          </div>

          <div class="p-4 rounded-lg border border-border bg-background">
            <div class="text-[10px] uppercase tracking-wide text-muted-foreground">Current team</div>
            <% if @current_team.present? && @current_team["team_code"].present? %>
              <a href="<%= team_href(team_code: @current_team['team_code'], team_id: @current_team['team_id']) %>" class="mt-1 block font-medium hover:underline"><%= @current_team["team_code"] %></a>
              <div class="text-sm text-muted-foreground"><%= @current_team["team_name"].presence || "—" %></div>
            <% else %>
              <div class="mt-1 text-sm text-muted-foreground italic">Unknown</div>
            <% end %>
          </div>
        </div>
      </section>

      <section id="provenance" class="scroll-mt-24 space-y-3">
        <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Pick provenance</h2>

        <% provenance_rows = Array(@pick_provenance_rows) %>
        <% provenance_depth = provenance_rows.size %>
        <% provenance_severity = if provenance_depth >= 2
          "deep_chain"
        elsif provenance_depth == 1
          "with_trade"
        else
          "clean"
        end %>

        <% severity_label = lambda do |severity|
          case severity.to_s
          when "deep_chain"
            "Deep chain"
          when "with_trade"
            "With trade"
          else
            "Clean"
          end
        end %>

        <% severity_chip_class = lambda do |severity|
          case severity.to_s
          when "deep_chain"
            "entity-chip entity-chip--danger"
          when "with_trade"
            "entity-chip entity-chip--warning"
          else
            "entity-chip entity-chip--muted"
          end
        end %>

        <% lane_container_class = lambda do |severity|
          case severity.to_s
          when "deep_chain"
            "border-red-300/70 bg-red-50/60 dark:border-red-800/60 dark:bg-red-950/25"
          when "with_trade"
            "border-amber-300/70 bg-amber-50/60 dark:border-amber-800/60 dark:bg-amber-950/20"
          else
            "border-border/60 bg-background"
          end
        end %>

        <% lane_definitions = [
          {
            key: "deep_chain",
            title: "Deep chain",
            help: "P2+ provenance hops · highest ownership complexity",
            rows: (provenance_depth > 1 ? provenance_rows.drop(1) : [])
          },
          {
            key: "with_trade",
            title: "With trade",
            help: "First ownership reroute before draft night",
            rows: (provenance_depth.positive? ? provenance_rows.first(1) : [])
          },
          {
            key: "clean",
            title: "Clean",
            help: "No pre-draft reroute required",
            rows: []
          }
        ] %>

        <div class="rounded-lg border border-border/60 bg-muted/10 px-3 py-2">
          <div class="text-[10px] font-medium uppercase tracking-wide text-muted-foreground/80">Severity-first chain lanes</div>
          <div class="mt-1.5 flex flex-wrap items-center gap-1.5 text-[10px] text-muted-foreground">
            <span class="<%= severity_chip_class.call(provenance_severity) %>"><%= severity_label.call(provenance_severity) %></span>
            <span class="entity-chip entity-chip--muted">Chain depth · <span class="font-mono tabular-nums">P<%= provenance_depth %></span></span>
            <span>Scan order: Deep chain → With trade → Clean.</span>
          </div>
        </div>

        <div class="space-y-2">
          <% lane_definitions.each do |lane| %>
            <% lane_rows = Array(lane[:rows]) %>
            <% lane_active = lane[:key] == "clean" ? provenance_depth.zero? : lane_rows.any? %>
            <% lane_count = lane[:key] == "clean" ? (provenance_depth.zero? ? 1 : 0) : lane_rows.size %>

            <article class="rounded-lg border p-3 <%= lane_container_class.call(lane[:key]) %>">
              <div class="flex flex-wrap items-center justify-between gap-2">
                <div class="flex flex-wrap items-center gap-1.5 text-[11px]">
                  <span class="<%= severity_chip_class.call(lane[:key]) %>"><%= lane[:title] %></span>
                  <span class="font-mono tabular-nums text-muted-foreground">rows: <%= lane_count %></span>
                </div>
                <div class="text-[10px] text-muted-foreground"><%= lane[:help] %></div>
              </div>

              <% if lane[:key] == "clean" %>
                <div class="mt-2 text-sm text-muted-foreground">
                  <% if lane_active %>
                    Pick ownership remained direct to draft night (no pre-draft trade rows).
                  <% else %>
                    Not active: this pick has provenance trade hops and is routed in higher-severity lanes.
                  <% end %>
                </div>
              <% elsif lane_rows.any? %>
                <div class="mt-2 rounded-lg border border-border/60 divide-y divide-border/50">
                  <% lane_rows.each_with_index do |row, lane_index| %>
                    <% hop_number = lane[:key] == "with_trade" ? 1 : lane_index + 2 %>
                    <% flags = [] %>
                    <% flags << "swap" if row["is_swap"] %>
                    <% flags << "future" if row["is_future"] %>
                    <% flags << "conditional" if row["is_conditional"] %>
                    <% flags << row["conditional_type_lk"] if row["conditional_type_lk"].present? %>

                    <div class="group px-3 py-2 transition-colors duration-75 hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10">
                      <div class="flex flex-wrap items-start gap-3">
                        <div class="w-24 shrink-0">
                          <div class="entity-cell-two-line">
                            <div class="entity-cell-primary font-mono tabular-nums">P<%= hop_number %></div>
                            <div class="entity-cell-secondary font-mono tabular-nums"><%= row["trade_date"].presence || "—" %></div>
                          </div>
                        </div>

                        <div class="min-w-0 flex-1 grid gap-2 sm:grid-cols-2 xl:grid-cols-5">
                          <div class="entity-cell-two-line xl:col-span-2">
                            <div class="entity-cell-primary justify-start gap-1.5 flex-wrap">
                              <% if row["from_team_code"].present? %>
                                <a href="<%= team_href(team_code: row['from_team_code'], team_id: row['from_team_id']) %>" class="hover:underline font-medium"><%= row["from_team_code"] %></a>
                              <% else %>
                                <span class="text-muted-foreground/60">—</span>
                              <% end %>

                              <span class="text-muted-foreground/50">→</span>

                              <% if row["to_team_code"].present? %>
                                <a href="<%= team_href(team_code: row['to_team_code'], team_id: row['to_team_id']) %>" class="hover:underline font-medium"><%= row["to_team_code"] %></a>
                              <% else %>
                                <span class="text-muted-foreground/60">—</span>
                              <% end %>
                            </div>
                            <div class="entity-cell-secondary justify-start">From → To · Original <%= row["original_team_code"].presence || "—" %></div>
                          </div>

                          <div class="entity-cell-two-line">
                            <div class="entity-cell-primary justify-start font-mono tabular-nums">
                              <% if row["trade_id"].present? %>
                                <a href="<%= trade_href(row['trade_id']) %>" class="hover:underline">#<%= row["trade_id"] %></a>
                              <% else %>
                                <span class="text-muted-foreground/60">—</span>
                              <% end %>
                            </div>
                            <div class="entity-cell-secondary justify-start">Trade pivot</div>
                          </div>

                          <div class="entity-cell-two-line xl:col-span-2">
                            <div class="entity-cell-primary justify-start gap-1.5 flex-wrap">
                              <% if flags.any? %>
                                <% flags.each do |flag| %>
                                  <span class="entity-chip <%= flag == 'conditional' ? 'entity-chip--warning' : 'entity-chip--muted' %>"><%= flag %></span>
                                <% end %>
                              <% else %>
                                <span class="text-muted-foreground/60">No conditional/swap modifiers</span>
                              <% end %>
                            </div>
                            <div class="entity-cell-secondary justify-start">Flags</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  <% end %>
                </div>
              <% else %>
                <div class="mt-2 text-sm text-muted-foreground italic">No rows in this lane for this pick context.</div>
              <% end %>
            </article>
          <% end %>
        </div>

        <div class="rounded-lg border border-border bg-background p-3 text-xs text-muted-foreground">
          Transaction: <a href="<%= transaction_href(ds['transaction_id']) %>" class="hover:underline font-mono tabular-nums">#<%= ds["transaction_id"] %></a>
          <% if ds["trade_id"].present? %>
            · linked trade: <a href="<%= trade_href(ds['trade_id']) %>" class="hover:underline font-mono tabular-nums">#<%= ds["trade_id"] %></a>
          <% end %>
        </div>
      </section>
    </div>
  </div>

  <%= render partial: "entities/shared/known_slugs", locals: { entity_type: "draft_selection", entity_id: @draft_selection_id, path_prefix: "draft-selections" } %>
  </main>
</div>
