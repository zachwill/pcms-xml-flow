<%
  slots = [
    { key: "a", label: "Slot A", code: @compare_a_code, row: @compare_a_row, tone: "indigo" },
    { key: "b", label: "Slot B", code: @compare_b_code, row: @compare_b_row, tone: "emerald" }
  ]

  has_compare = slots.any? { |slot| slot[:row].present? }
  both_slots_ready = @compare_a_row.present? && @compare_b_row.present?
  team_picker_by_conference = @team_picker_by_conference.presence || { "Eastern" => [], "Western" => [] }

  if both_slots_ready
    cap_space_delta = @compare_b_row["cap_space"].to_f - @compare_a_row["cap_space"].to_f
    tax_overage_delta = @compare_b_row["tax_overage"].to_f - @compare_a_row["tax_overage"].to_f
    room_a1_delta = @compare_b_row["room_under_apron1"].to_f - @compare_a_row["room_under_apron1"].to_f
  end
%>

<div id="team-summary-compare-strip" class="border-b border-border/70 bg-muted/20 px-4 py-3 space-y-2">
  <div class="flex items-center justify-between gap-3">
    <div>
      <div class="text-[10px] uppercase tracking-wide font-semibold text-muted-foreground/80">Compare board</div>
      <div class="text-xs text-muted-foreground">Assign teams to Slot A / Slot B directly in the slots below, then drill in from either slot.</div>
    </div>

    <% if has_compare %>
      <button
        type="button"
        class="cursor-pointer h-7 px-2 rounded border border-border bg-background text-[11px] font-medium hover:bg-muted"
        data-on:click="@get('<%= team_summary_sse_compare_path(@state_params.merge(compare_action: "clear_all")) %>')"
      >Clear compare</button>
    <% end %>
  </div>

  <div class="grid grid-cols-2 gap-2">
    <% slots.each do |slot| %>
      <% row = slot[:row] %>
      <% code = slot[:code] %>
      <% tone = slot[:tone] %>
      <% slot_badge_class = tone == "indigo" ? "text-indigo-700 dark:text-indigo-300 border-indigo-500/40 bg-indigo-500/10" : "text-emerald-700 dark:text-emerald-300 border-emerald-500/40 bg-emerald-500/10" %>

      <div class="rounded border border-border bg-background px-2.5 py-2 space-y-1.5 min-h-[94px]">
        <div class="flex items-center justify-between gap-2">
          <span class="inline-flex items-center rounded border px-1.5 py-0.5 text-[10px] font-semibold uppercase tracking-wide <%= slot_badge_class %>"><%= slot[:label] %></span>

          <% if code.present? %>
            <button
              type="button"
              class="cursor-pointer text-[10px] text-muted-foreground hover:text-foreground hover:underline"
              data-on:click="@get('<%= team_summary_sse_compare_path(@state_params.merge(compare_action: "clear_slot", slot: slot[:key])) %>')"
            >Clear</button>
          <% end %>
        </div>

        <% if row.present? %>
          <% focus_path = team_summary_sidebar_path(team_code: code, **@state_params.merge(selected: code)) %>
          <% logo_url = team_logo_url(row["team_id"]) %>
          <button
            type="button"
            class="cursor-pointer block w-full text-left"
            data-on:click="$selectedteam = '<%= code %>'; @get('<%= focus_path %>')"
          >
            <div class="flex items-center gap-2 min-w-0">
              <div class="w-6 h-6 rounded border border-border bg-background overflow-hidden flex items-center justify-center shrink-0">
                <% if logo_url.present? %>
                  <img
                    src="<%= logo_url %>"
                    alt="<%= row['team_name'] %> logo"
                    class="w-full h-full object-contain"
                    loading="lazy"
                    decoding="async"
                    onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                  />
                  <span class="hidden text-[8px] font-semibold text-muted-foreground"><%= code %></span>
                <% else %>
                  <span class="text-[8px] font-semibold text-muted-foreground"><%= code %></span>
                <% end %>
              </div>

              <div class="min-w-0">
                <div class="text-sm font-medium leading-tight truncate"><%= row["team_name"] %></div>
                <div class="text-[10px] text-muted-foreground/80"><%= code %> · <%= format_year_label(@selected_year) %></div>
              </div>
            </div>

            <div class="mt-1 text-[10px] text-muted-foreground/80">
              Cap <span class="tabular-nums <%= row['cap_space'].to_f >= 0 ? 'text-emerald-600 dark:text-emerald-400' : 'text-red-600 dark:text-red-400' %>"><%= format_room_amount(row["cap_space"]) %></span>
              <span class="mx-1">·</span>
              Tax <span class="tabular-nums <%= row['tax_overage'].to_f > 0 ? 'text-red-600 dark:text-red-400' : '' %>"><%= row['tax_overage'].to_f > 0 ? format_compact_currency(row["tax_overage"]) : '—' %></span>
              <span class="mx-1">·</span>
              A1 <span class="tabular-nums <%= row['room_under_apron1'].to_f < 0 ? 'text-red-600 dark:text-red-400' : '' %>"><%= row['room_under_apron1'].nil? ? '—' : format_room_amount(row["room_under_apron1"]) %></span>
            </div>
          </button>
        <% else %>
          <div class="text-[11px] text-muted-foreground italic">No team pinned.</div>

          <div class="space-y-2">
            <% %w[Eastern Western].each do |conference| %>
              <% conference_teams = team_picker_by_conference[conference] || [] %>
              <% next if conference_teams.empty? %>

              <div class="space-y-1">
                <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70"><%= conference %></div>
                <div class="grid grid-cols-5 gap-1">
                  <% conference_teams.each do |candidate| %>
                    <% candidate_code = candidate[:code].to_s.upcase %>
                    <% next unless candidate_code.match?(/\A[A-Z]{3}\z/) %>
                    <% next if (slot[:key] == "a" && @compare_b_code == candidate_code) || (slot[:key] == "b" && @compare_a_code == candidate_code) %>
                    <% pin_path = team_summary_sse_compare_path(@state_params.merge(compare_action: "pin", slot: slot[:key], team_code: candidate_code)) %>

                    <button
                      type="button"
                      class="cursor-pointer relative h-7 px-2 rounded text-xs font-medium transition-all duration-150 border bg-muted/50 text-foreground border-border hover:bg-muted"
                      title="Pin <%= candidate[:name] %> to <%= slot[:label] %>"
                      data-on:click="@get('<%= pin_path %>')"
                    ><%= candidate_code %></button>
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>

  <% if both_slots_ready %>
    <div class="rounded border border-border/60 bg-background px-2.5 py-2 text-[11px] tabular-nums flex flex-wrap items-center gap-3">
      <span class="font-medium text-muted-foreground"><%= @compare_b_code %> vs <%= @compare_a_code %> delta</span>
      <span class="<%= cap_space_delta >= 0 ? 'text-emerald-600 dark:text-emerald-400' : 'text-red-600 dark:text-red-400' %>">Cap Space: <%= format_room_amount(cap_space_delta) %></span>
      <span class="<%= tax_overage_delta <= 0 ? 'text-emerald-600 dark:text-emerald-400' : 'text-red-600 dark:text-red-400' %>">Tax Overage: <%= format_room_amount(tax_overage_delta) %></span>
      <span class="<%= room_a1_delta >= 0 ? 'text-emerald-600 dark:text-emerald-400' : 'text-red-600 dark:text-red-400' %>">A1 Room: <%= format_room_amount(room_a1_delta) %></span>
    </div>
  <% end %>
</div>
