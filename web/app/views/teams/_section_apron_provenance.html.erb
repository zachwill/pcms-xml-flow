<% provenance_rows = Array(@apron_provenance_rows) %>

<% apron_chip_class = lambda do |row|
  level = row["apron_level_lk"].to_s
  return "entity-chip entity-chip--danger" if level.include?("2")
  return "entity-chip entity-chip--warning" if level.include?("1")
  return "entity-chip entity-chip--warning" if row["is_subject_to_apron"]

  "entity-chip entity-chip--muted"
end %>

<section id="apron-provenance" class="space-y-3">
  <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Apron provenance</h2>

  <details class="rounded-lg border border-border bg-background p-3" open>
    <summary class="cursor-pointer text-sm font-medium">
      Constraint provenance lanes
      <span class="ml-2 text-xs text-muted-foreground">(<%= provenance_rows.size %> years)</span>
    </summary>

    <div class="mt-3 space-y-3">
      <div class="flex flex-wrap items-center gap-2 text-[10px] uppercase tracking-wide text-muted-foreground/80">
        <span>Trigger reason → apron level → active constraints</span>
        <a href="#activity" class="normal-case tracking-normal hover:underline">Open activity</a>
        <span class="text-muted-foreground/50">·</span>
        <a href="#two-way" class="normal-case tracking-normal hover:underline">Open two-way</a>
        <span class="text-muted-foreground/50">·</span>
        <span class="normal-case tracking-normal text-foreground/80">Hover/focus A1/A2 transaction links to cross-highlight activity lanes</span>
      </div>

      <% if provenance_rows.empty? %>
        <div class="p-3 rounded border border-border/60 text-sm text-muted-foreground italic">No team tax summary snapshot rows for 2025–2031.</div>
      <% else %>
        <div class="rounded-lg border border-border divide-y divide-border/60">
          <% provenance_rows.each do |r| %>
            <% constraint_lines = r["constraint_lines"].to_s.split("\n").reject(&:blank?) %>
            <% reason_label = r["subject_to_apron_reason_label"].presence || r["subject_to_apron_reason_lk"].presence || "No explicit apron trigger reason" %>
            <% apron_level = r["apron_level_lk"].presence || "NONE" %>
            <% subject_label = r["is_subject_to_apron"] ? "Subject" : "Not subject" %>
            <% apron1_transaction_id = r["apron1_transaction_id"].presence&.to_s %>
            <% apron2_transaction_id = r["apron2_transaction_id"].presence&.to_s %>
            <% row_match_clauses = [] %>
            <% row_match_clauses << "$txhoverid === '#{apron1_transaction_id}'" if apron1_transaction_id.present? %>
            <% row_match_clauses << "$txhoverid === '#{apron2_transaction_id}'" if apron2_transaction_id.present? %>
            <% row_highlight_expr = row_match_clauses.any? ? "{ 'bg-amber-100/70 dark:bg-amber-900/25 ring-1 ring-amber-300/80 dark:ring-amber-700/60': $txhoverid !== '' && (#{row_match_clauses.join(' || ')}) }" : nil %>

            <article
              class="group px-3 py-2 transition-colors duration-75 hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10"
              <% if row_highlight_expr.present? %>data-class="<%= row_highlight_expr %>"<% end %>
            >
              <div class="flex flex-wrap items-start gap-3">
                <div class="w-44 shrink-0">
                  <div class="entity-cell-two-line">
                    <div class="entity-cell-primary font-mono tabular-nums"><%= format_year_label(r["salary_year"]) %></div>
                    <div class="entity-cell-secondary gap-1.5">
                      <span class="<%= apron_chip_class.call(r) %>"><%= apron_level %></span>
                      <span class="entity-chip <%= r['is_subject_to_apron'] ? 'entity-chip--warning' : 'entity-chip--muted' %>"><%= subject_label %></span>
                    </div>
                  </div>
                </div>

                <div class="min-w-0 flex-1 grid gap-2 sm:grid-cols-2 xl:grid-cols-5">
                  <div class="entity-cell-two-line xl:col-span-2">
                    <div class="entity-cell-primary truncate"><%= reason_label %></div>
                    <div class="entity-cell-secondary">Trigger reason</div>
                  </div>

                  <div class="entity-cell-two-line">
                    <div class="entity-cell-primary gap-1.5 font-mono tabular-nums">
                      <% if apron1_transaction_id.present? %>
                        <a
                          href="<%= transaction_href(r['apron1_transaction_id']) %>"
                          class="hover:underline transition-colors"
                          data-on:mouseenter="$txhoverid = '<%= apron1_transaction_id %>'"
                          data-on:mouseleave="if ($txhoverid === '<%= apron1_transaction_id %>') { $txhoverid = ''; }"
                          data-on:focus="$txhoverid = '<%= apron1_transaction_id %>'"
                          data-on:blur="if ($txhoverid === '<%= apron1_transaction_id %>') { $txhoverid = ''; }"
                          data-class="{ 'text-amber-700 dark:text-amber-300 underline decoration-2 underline-offset-2': $txhoverid === '<%= apron1_transaction_id %>' }"
                        >A1 #<%= apron1_transaction_id %></a>
                      <% else %>
                        <span class="text-muted-foreground/60">A1 —</span>
                      <% end %>

                      <% if apron2_transaction_id.present? %>
                        <a
                          href="<%= transaction_href(r['apron2_transaction_id']) %>"
                          class="hover:underline transition-colors"
                          data-on:mouseenter="$txhoverid = '<%= apron2_transaction_id %>'"
                          data-on:mouseleave="if ($txhoverid === '<%= apron2_transaction_id %>') { $txhoverid = ''; }"
                          data-on:focus="$txhoverid = '<%= apron2_transaction_id %>'"
                          data-on:blur="if ($txhoverid === '<%= apron2_transaction_id %>') { $txhoverid = ''; }"
                          data-class="{ 'text-amber-700 dark:text-amber-300 underline decoration-2 underline-offset-2': $txhoverid === '<%= apron2_transaction_id %>' }"
                        >A2 #<%= apron2_transaction_id %></a>
                      <% else %>
                        <span class="text-muted-foreground/60">A2 —</span>
                      <% end %>
                    </div>
                    <div class="entity-cell-secondary">Trigger transactions</div>
                  </div>

                  <div class="entity-cell-two-line">
                    <div class="entity-cell-primary justify-end font-mono tabular-nums"><%= r["constraint_count"].to_i %></div>
                    <div class="entity-cell-secondary justify-end">Constraint count</div>
                  </div>

                  <div class="entity-cell-two-line xl:col-span-2">
                    <div class="entity-cell-primary flex-wrap gap-1.5">
                      <% if constraint_lines.any? %>
                        <% constraint_lines.first(3).each do |line| %>
                          <span class="entity-chip entity-chip--muted"><%= line %></span>
                        <% end %>
                        <% if constraint_lines.size > 3 %>
                          <span class="entity-chip entity-chip--warning">+<%= constraint_lines.size - 3 %> more</span>
                        <% end %>
                      <% else %>
                        <span class="text-muted-foreground/60">No apron constraint lines</span>
                      <% end %>
                    </div>
                    <div class="entity-cell-secondary">Active constraints</div>
                  </div>
                </div>
              </div>
            </article>
          <% end %>
        </div>
      <% end %>
    </div>
  </details>
</section>
