<%#
  TeamSection — Tailwind port of the React prototype (TeamSection + SalaryTable)

  Layout:
  - Vertical sticky header group (TeamHeader + horizontally-scrollable TableHeader)
  - Horizontally-scrollable body (Player rows + supplementary sections + totals)
  - Sticky left "player" column
%>

<% salary_years ||= SalaryBookHelper::SALARY_YEARS %>
<% cap_holds ||= [] %>
<% exceptions ||= [] %>
<% dead_money ||= [] %>
<% picks ||= [] %>
<% team_summaries ||= {} %>
<% team_meta ||= {} %>

<%# Extract team info %>
<% team_name = team_meta["team_name"] || team_code %>
<% conference = team_meta["conference_name"] || "—" %>
<% team_id = team_meta["team_id"] %>
<% logo_url = team_logo_url(team_id) %>

<%# Header KPI cards should follow hovered year for this team only; otherwise fallback to base year. %>
<% selected_header_year_expr = "(($selectedseasonteam === '#{team_code}' && $selectedseason !== '') ? Number($selectedseason) : #{year})" %>

<%
  # Column math (must match Tailwind widths)
  # w-52 = 208px, w-24 = 96px, w-40 = 160px
  # Note: EPM is an optional client-side column (added via data-show), so we keep
  # the baseline min width here and let content width expand when EPM is enabled.
  sticky_left_px = 208
  col_px = 96
  agent_px = 160
  min_table_width_px = sticky_left_px + ((salary_years.length + 1) * col_px) + agent_px
%>

<section
  id="<%= team_code %>"
  data-teamcode="<%= team_code %>"
  class="border-b border-border snap-start"
  style="content-visibility: auto; contain-intrinsic-size: 1200px 600px;"
>
  <div class="relative" data-salarytable>
    <%# Sticky header group (vertical sticky) %>
    <div
      class="sticky top-0 z-30 bg-background will-change-transform
             shadow-[0_1px_3px_0_rgb(0_0_0/0.1),0_1px_2px_-1px_rgb(0_0_0/0.1)]"
    >
      <%# Content wrapper so scroll-spy can fade text/KPIs without fading the background %>
      <div data-header-content>
        <%# TeamHeader (does not horizontally scroll) %>
        <div class="h-14 flex items-center border-b border-border bg-muted">
          <%# Left section: Logo + Team name + Conference (fixed width) %>
          <div class="w-52 shrink-0 pl-4 flex items-center gap-3">
            <div class="w-8 h-8 rounded flex items-center justify-center flex-shrink-0 bg-background border border-border overflow-hidden">
              <% if logo_url %>
                <img
                  src="<%= logo_url %>"
                  alt="<%= team_name %> logo"
                  class="w-full h-full object-contain"
                  onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                />
                <span class="hidden text-[10px] font-mono font-bold uppercase tracking-tight text-muted-foreground"><%= team_code %></span>
              <% else %>
                <span class="text-[10px] font-mono font-bold uppercase tracking-tight text-muted-foreground"><%= team_code %></span>
              <% end %>
            </div>

            <div class="grid grid-rows-[24px_16px] min-w-0">
              <div class="h-[24px] flex items-end min-w-0">
                <button
                  type="button"
                  class="cursor-pointer font-semibold leading-tight text-left text-[14px] block w-full truncate hover:text-primary transition-colors
                         focus:outline-none focus-visible:underline focus-visible:text-primary"
                  data-on:click="$activeteam = '<%= team_code %>'"
                ><%= team_name %></button>
              </div>
              <div class="h-[16px] -mt-px flex items-start min-w-0">
                <span class="text-[10px] leading-none tabular-nums text-muted-foreground/80 truncate"><%= conference %> Conference</span>
              </div>
            </div>
          </div>

          <%# KPI cards row (fixed position; does not shift when EPM column is toggled) %>
          <div class="flex items-center">
            <div class="w-24 shrink-0 flex justify-center">
              <% salary_years.each do |kpi_year| %>
                <% summary = team_summaries[kpi_year] || {} %>
                <div data-show="<%= "#{selected_header_year_expr} === #{kpi_year}" %>" style="display: none;">
                  <%= render partial: "tools/salary_book/kpi_cell", locals: {
                    label: "Roster",
                    value: (summary["roster_row_count"] || "—").to_s,
                    title: "Number of roster players"
                  } %>
                </div>
              <% end %>
            </div>

            <div class="w-24 shrink-0 flex justify-center">
              <% salary_years.each do |kpi_year| %>
                <% summary = team_summaries[kpi_year] || {} %>
                <div data-show="<%= "#{selected_header_year_expr} === #{kpi_year}" %>" style="display: none;">
                  <%= render partial: "tools/salary_book/kpi_cell", locals: {
                    label: "Two-Way",
                    value: (summary["two_way_row_count"] || "—").to_s,
                    title: "Number of two-way contracts"
                  } %>
                </div>
              <% end %>
            </div>

            <div class="w-24 shrink-0 flex justify-center">
              <% salary_years.each do |kpi_year| %>
                <% summary = team_summaries[kpi_year] || {} %>
                <% cap_total = summary["cap_total"] %>
                <div data-show="<%= "#{selected_header_year_expr} === #{kpi_year}" %>" style="display: none;">
                  <%= render partial: "tools/salary_book/kpi_cell", locals: {
                    label: "Total",
                    value: cap_total ? format_compact_currency(cap_total) : "—",
                    title: "Total salary"
                  } %>
                </div>
              <% end %>
            </div>

            <div class="w-24 shrink-0 flex justify-center">
              <% salary_years.each do |kpi_year| %>
                <% summary = team_summaries[kpi_year] || {} %>
                <% cap_space = summary["cap_space"] %>
                <% variant = cap_space.nil? ? "muted" : (cap_space.to_f > 0 ? "positive" : "default") %>
                <div data-show="<%= "#{selected_header_year_expr} === #{kpi_year}" %>" style="display: none;">
                  <%= render partial: "tools/salary_book/kpi_cell", locals: {
                    label: "Cap Space",
                    value: cap_space ? format_room_amount(cap_space) : "—",
                    title: "Cap space",
                    variant:
                  } %>
                </div>
              <% end %>
            </div>

            <div class="w-24 shrink-0 flex justify-center" data-show="$displaytaxaprons">
              <% salary_years.each do |kpi_year| %>
                <% summary = team_summaries[kpi_year] || {} %>
                <% room_tax = summary["room_under_tax"] %>
                <% variant = room_tax.nil? ? "muted" : (room_tax.to_f < 0 ? "negative" : "default") %>
                <div data-show="<%= "#{selected_header_year_expr} === #{kpi_year}" %>" style="display: none;">
                  <%= render partial: "tools/salary_book/kpi_cell", locals: {
                    label: "Tax Room",
                    value: room_tax ? format_room_amount(room_tax) : "—",
                    title: "Room under luxury tax",
                    variant:
                  } %>
                </div>
              <% end %>
            </div>

            <div class="w-24 shrink-0 flex justify-center" data-show="$displaytaxaprons">
              <% salary_years.each do |kpi_year| %>
                <% summary = team_summaries[kpi_year] || {} %>
                <% room_a1 = summary["room_under_first_apron"] %>
                <% variant = room_a1.nil? ? "muted" : (room_a1.to_f < 0 ? "negative" : "default") %>
                <div data-show="<%= "#{selected_header_year_expr} === #{kpi_year}" %>" style="display: none;">
                  <%= render partial: "tools/salary_book/kpi_cell", locals: {
                    label: "Apron 1",
                    value: room_a1 ? format_room_amount(room_a1) : "—",
                    title: "Room under first apron",
                    variant:
                  } %>
                </div>
              <% end %>
            </div>

            <div class="w-24 shrink-0 flex justify-center" data-show="$displaytaxaprons">
              <% salary_years.each do |kpi_year| %>
                <% summary = team_summaries[kpi_year] || {} %>
                <% room_a2 = summary["room_under_second_apron"] %>
                <% variant = room_a2.nil? ? "muted" : (room_a2.to_f < 0 ? "negative" : "default") %>
                <div data-show="<%= "#{selected_header_year_expr} === #{kpi_year}" %>" style="display: none;">
                  <%= render partial: "tools/salary_book/kpi_cell", locals: {
                    label: "Apron 2",
                    value: room_a2 ? format_room_amount(room_a2) : "—",
                    title: "Room under second apron",
                    variant:
                  } %>
                </div>
              <% end %>
            </div>

            <%# Agent column spacer %>
            <div class="w-40 shrink-0 pr-4"></div>
          </div>
        </div>

        <%# TableHeader (horizontally scrollable; synced with body) %>
        <div
          data-salarytable-header-scroll
          class="overflow-x-auto overscroll-x-contain
                 [scrollbar-width:none] [-ms-overflow-style:none] [&::-webkit-scrollbar]:hidden"
        >
          <div class="min-w-max" style="min-width: <%= min_table_width_px %>px;">
            <%= render partial: "tools/salary_book/table_header", locals: { salary_years: salary_years, team_code: team_code } %>
          </div>
        </div>
      </div>
    </div>

    <%# Shadow overlay for sticky column edge (appears when horizontally scrolled) %>
    <div
      data-salarytable-sticky-shadow
      class="absolute top-0 bottom-0 pointer-events-none z-40 transition-opacity duration-150 opacity-0"
      style="left: <%= sticky_left_px %>px; width: 10px; background: linear-gradient(to right, color-mix(in srgb, var(--border) 35%, transparent), transparent);"
      aria-hidden="true"
    ></div>


    <%# Body horizontal scroller %>
    <div
      data-salarytable-body-scroll
      class="overflow-x-auto overscroll-x-contain relative
             [scrollbar-width:none] [-ms-overflow-style:none] [&::-webkit-scrollbar]:hidden"
    >
      <div class="min-w-max" style="min-width: <%= min_table_width_px %>px;">
        <%# Player rows %>
        <div class="[&>*:first-child]:mt-1">
          <% players.each do |player| %>
            <%= render partial: "tools/salary_book/player_row", locals: { player: player, salary_years: salary_years } %>
          <% end %>
        </div>

        <% if players.empty? %>
          <div class="h-24 flex items-center justify-center text-muted-foreground text-sm">No players</div>
        <% end %>

        <%# Supplementary rows (Display filters) %>

        <div data-show="$displaycapholds">
          <% if cap_holds.any? %>
            <%= render partial: "tools/salary_book/cap_holds_section", locals: { cap_holds: cap_holds, salary_years: salary_years, team_code: team_code } %>
          <% else %>
            <%= render partial: "tools/salary_book/placeholder_section_row", locals: { label: "Cap Holds", salary_years: salary_years, team_code: team_code } %>
          <% end %>
        </div>

        <div data-show="$displayexceptions">
          <% if exceptions.any? %>
            <%= render partial: "tools/salary_book/exceptions_section", locals: { exceptions: exceptions } %>
          <% else %>
            <%= render partial: "tools/salary_book/placeholder_section_row", locals: { label: "Exceptions", salary_years: salary_years, team_code: team_code } %>
          <% end %>
        </div>

        <div data-show="$displaydeadmoney">
          <% if dead_money.any? %>
            <%= render partial: "tools/salary_book/dead_money_section", locals: { dead_money: dead_money, salary_years: salary_years, team_code: team_code } %>
          <% else %>
            <%= render partial: "tools/salary_book/placeholder_section_row", locals: { label: "Dead Money", salary_years: salary_years, team_code: team_code } %>
          <% end %>
        </div>

        <div data-show="$displaydraftpicks">
          <% if picks.any? %>
            <%= render partial: "tools/salary_book/draft_assets_section", locals: { picks: picks, salary_years: salary_years, team_code: team_code } %>
          <% else %>
            <%= render partial: "tools/salary_book/placeholder_section_row", locals: { label: "Draft Assets", salary_years: salary_years, team_code: team_code } %>
          <% end %>
        </div>

      </div>
    </div>
  </div>
</section>
