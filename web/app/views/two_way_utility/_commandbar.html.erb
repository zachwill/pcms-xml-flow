<%
  pane_query_expr = "'conference=' + encodeURIComponent($twconference || 'all') +
    '&team=' + encodeURIComponent($twteam || '') +
    '&risk=' + encodeURIComponent($twrisk || 'all')"

  refresh_query_expr = "(#{pane_query_expr}) + '&selected_id=' + encodeURIComponent($overlaytype === 'player' ? $overlayid : '')"
  refresh_expr = "@get('/two-way-utility/sse/refresh?' + (#{refresh_query_expr}))"

  eastern_teams = Array(@teams_by_conference["Eastern"])
  western_teams = Array(@teams_by_conference["Western"])
%>

<header id="commandbar" class="shrink-0 h-[130px] border-b border-border bg-background flex items-start px-4 pt-3 gap-4">
  <div class="flex gap-4" role="navigation" aria-label="Teams">
    <div class="space-y-1">
      <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Eastern</div>
      <div class="grid grid-cols-5 gap-1">
        <% eastern_teams.each do |team| %>
          <% code = team[:code].to_s.upcase %>
          <button
            type="button"
            class="cursor-pointer relative h-7 px-2 rounded text-xs font-medium transition-all duration-150 border outline-none inline-flex items-center justify-center"
            data-on:click="$twconference = 'all'; $twteam = ($twteam === '<%= code %>' ? '' : '<%= code %>'); <%= refresh_expr %>;"
            data-class="{
              'bg-primary text-primary-foreground border-primary shadow-sm': $twteam === '<%= code %>',
              'bg-muted/50 hover:bg-muted text-foreground border-border hover:border-foreground/20': $twteam !== '<%= code %>'
            }"
            title="<%= team[:name] %>"
          ><%= code %></button>
        <% end %>
      </div>
    </div>

    <div class="space-y-1">
      <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Western</div>
      <div class="grid grid-cols-5 gap-1">
        <% western_teams.each do |team| %>
          <% code = team[:code].to_s.upcase %>
          <button
            type="button"
            class="cursor-pointer relative h-7 px-2 rounded text-xs font-medium transition-all duration-150 border outline-none inline-flex items-center justify-center"
            data-on:click="$twconference = 'all'; $twteam = ($twteam === '<%= code %>' ? '' : '<%= code %>'); <%= refresh_expr %>;"
            data-class="{
              'bg-primary text-primary-foreground border-primary shadow-sm': $twteam === '<%= code %>',
              'bg-muted/50 hover:bg-muted text-foreground border-border hover:border-foreground/20': $twteam !== '<%= code %>'
            }"
            title="<%= team[:name] %>"
          ><%= code %></button>
        <% end %>
      </div>
    </div>
  </div>

  <div class="h-20 w-px bg-border self-center"></div>

  <div class="min-w-[11rem] space-y-1" role="radiogroup" aria-label="Risk lens">
    <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Risk lens</div>
    <% [["all", "All"], ["warning", "≤20 games left"], ["critical", "≤10 games left"], ["estimate", "Estimated limit"]].each do |value, label| %>
      <label class="flex items-center gap-1.5 cursor-pointer">
        <input
          type="radio"
          name="two-way-risk"
          value="<%= value %>"
          class="size-3.5 accent-primary"
          <%= "checked" if @risk == value %>
          data-bind="twrisk"
          data-on:change="if (el.checked) { <%= refresh_expr %>; }"
        />
        <span class="text-[11px] leading-none select-none" data-class="{ 'text-foreground font-semibold': $twrisk === '<%= value %>', 'text-muted-foreground': $twrisk !== '<%= value %>' }"><%= label %></span>
      </label>
    <% end %>
  </div>

  <div class="h-20 w-px bg-border self-center"></div>

  <div class="min-w-[10rem] space-y-1">
    <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">At-risk snapshot</div>
    <div class="grid grid-cols-2 gap-1.5">
      <span class="entity-chip entity-chip--danger justify-center"><%= @sidebar_summary[:critical_count].to_i %> critical</span>
      <span class="entity-chip entity-chip--warning justify-center"><%= @sidebar_summary[:low_remaining_count].to_i %> ≤20</span>
      <span class="entity-chip entity-chip--muted justify-center"><%= @sidebar_summary[:estimate_count].to_i %> est.</span>
      <span class="entity-chip entity-chip--muted justify-center"><%= @sidebar_summary[:row_count].to_i %> rows</span>
    </div>
  </div>

  <div class="h-20 w-px bg-border self-center ml-auto shrink-0"></div>
  <%= render partial: "shared/commandbar_navigation", locals: { active_destination: "two_way_utility" } %>
</header>
