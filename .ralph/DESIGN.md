# Design Evolution Backlog (`web/`)

North star:
- Entity index pages are explorer workbenches (Salary Book-like interaction model, not clones).
- Fast scanning, meaningful knobs, dense interactive rows, and sidebar drill-ins.
- Canonical pattern: `#commandbar` + `#maincanvas` + `#rightpanel-base` + `#rightpanel-overlay`.
- Salary Book remains read-only and is the interaction quality bar.
- Team Summary, System Values, and Two-Way Utility evolve in parallel toward stronger workbench UX.

Rubric (1-5):
1) Scan speed
2) Information hierarchy
3) Interaction predictability
4) Density/readability balance
5) Navigation/pivots

- [x] [P1] [INDEX] /players — keep two candidate players pinned while scanning constraint-matched rows
  - Problem: Users can filter and drill in, but cannot hold two player candidates side-by-side while continuing row scan.
  - Hypothesis: A lightweight compare strip + slot pinning in rows/overlay will reduce rescanning and preserve decision context.
  - Scope (files):
    - web/app/views/entities/players/_workspace_main.html.erb
    - web/app/views/entities/players/_rightpanel_base.html.erb
    - web/app/views/entities/players/_rightpanel_overlay_player.html.erb
    - web/app/controllers/entities/players_controller.rb
    - web/app/controllers/entities/players_sse_controller.rb
    - web/test/integration/entities_players_index_test.rb
  - What changed:
    - Added compare-slot state (`compare_a` / `compare_b`) to `/players` filters/signals and SSE refresh payloads.
    - Added server-side compare action handling (`pin`, `clear_slot`, `clear_all`) and compare-row hydration tied to current filtered workspace rows.
    - Added a `#players-compare-strip` in `#maincanvas` with Slot A / Slot B cards, clear-slot / clear-all controls, and B-vs-A deltas for cap-lens + next-year (plus total delta).
    - Added Pin A / Pin B row controls (inline on player identity row) and overlay controls in `rightpanel-overlay`.
    - Added a compare summary block in `#rightpanel-base` so pinned context remains visible while scanning top-cap hits.
    - Added URL sync for compare params on `/players` so compare changes can persist in query state without breaking existing filter sharing.
    - Expanded integration coverage for compare strip render/restore, SSE pin/clear actions, and overlay compare controls.
  - Why this improves the flow:
    - Users can now keep two candidate players pinned while continuing to scan constraint-matched rows, instead of repeatedly reopening overlays and rescanning cap values.
    - Compare intent is available at both primary interaction points (row + overlay), and the compare strip keeps the decision context anchored in the main scan surface.
    - Delta readouts reduce mental arithmetic and improve shortlist decisions when toggling horizon/sort/filter knobs.
  - Verification:
    - `cd web && bundle exec ruby -Itest test/integration/entities_players_index_test.rb -n "/refresh|sidebar returns/"`
  - Rubric (before → after):
    - Scan speed: 4 → 5
    - Information hierarchy: 4 → 5
    - Interaction predictability: 3 → 5
    - Density/readability: 4 → 4
    - Navigation/pivots: 4 → 5
  - Follow-up tasks discovered:
    - Standardize compare action query key naming across index surfaces (players now uses `compare_action`/`compare_slot`; teams still uses `action`/`slot`).
    - Investigate local test env asset-path setup so full-page index integration tests can run without `tailwind.css` load-path failures.
  - Guardrails:
    - Do not modify Salary Book files.

- [x] [P1] [INDEX] /teams — make pressure filters immediately scannable with live counts and clear active posture
  - Problem: Pressure radio choices are available, but users cannot quickly see expected result volume before toggling.
  - Hypothesis: Showing live counts per pressure option will improve first-pass triage speed and reduce trial toggles.
  - Scope (files):
    - web/app/views/entities/teams/index.html.erb
    - web/app/views/entities/teams/_commandbar.html.erb
    - web/app/controllers/entities/teams_controller.rb
    - web/app/controllers/entities/teams_sse_controller.rb
    - web/app/views/entities/teams/_rightpanel_base.html.erb
    - web/test/integration/entities_teams_index_test.rb
  - What changed:
    - Extracted `/teams` commandbar into `entities/teams/_commandbar` so it can be patched during SSE refresh.
    - Added live pressure counts (All / Over Cap / Over Tax / Over Apron 1 / Over Apron 2) next to pressure controls in commandbar, plus explicit “Active” posture text.
    - Updated index loading to fetch conference/query-scoped team rows once, derive pressure counts server-side, then apply the active pressure lens in Ruby so non-active lens counts remain visible.
    - Added active-pressure snapshot treatment in `#rightpanel-base` (active posture row + count grid) so posture is explicit outside the commandbar.
    - Extended `/teams/sse/refresh` to patch `#commandbar` alongside `#maincanvas`, `#rightpanel-base`, and `#rightpanel-overlay` so counts and active posture stay live.
    - Preserved compare-slot behavior and hardened compare-action parsing by reading query params (`action`/`slot`) safely in addition to explicit compare keys.
    - Expanded integration coverage for SSE commandbar patching and pressure-count/row-count consistency checks.
  - Why this improves the flow:
    - Users can now see expected row volume for every pressure posture before toggling, reducing blind trial-clicking.
    - Active pressure context is visible in both primary orientation zones (commandbar + sidebar snapshot), improving wayfinding during scan loops.
    - One SSE refresh keeps counts, rows, sidebar snapshot, and overlay state synchronized, preserving interaction predictability.
  - Verification:
    - `cd web && bundle exec ruby -Itest test/integration/entities_teams_index_test.rb -n "/teams refresh/"`
    - `cd web && bundle exec ruby -Itest test/integration/entities_teams_index_test.rb -n "/sidebar returns/"`
  - Rubric (before → after):
    - Scan speed: 4 → 5
    - Information hierarchy: 4 → 5
    - Interaction predictability: 4 → 5
    - Density/readability: 5 → 5
    - Navigation/pivots: 4 → 5
  - Follow-up tasks discovered:
    - Migrate teams compare URLs from `action`/`slot` to canonical `compare_action`/`compare_slot` and remove legacy fallback parsing.
    - Fix local integration-test asset setup so full-page `/teams` index tests can run without `tailwind.css` load-path errors.
  - Guardrails:
    - Do not modify Salary Book files.

- [ ] [P1] [INDEX] /drafts — improve grid triage by making ownership risk severity visible before drill-in
  - Problem: Grid users must click many cells to discover which pick cells are high-risk or deeply encumbered.
  - Hypothesis: Inline risk severity encoding + legend will let users identify critical cells faster and drill in intentionally.
  - Scope (files):
    - web/app/views/entities/drafts/_results.html.erb
    - web/app/views/entities/drafts/_rightpanel_base.html.erb
    - web/app/controllers/entities/drafts_controller.rb
    - web/app/controllers/entities/drafts_sse_controller.rb
    - web/test/integration/entities_pane_endpoints_test.rb
  - Acceptance criteria:
    - Grid cells expose a consistent 3-tier risk treatment (normal / at-risk / critical) with legend copy in-surface.
    - Risk treatment uses the same underlying risk scoring as sidebar summary counts.
    - Overlay selection state remains preserved through sort/lens/view SSE refresh when selected cell remains visible.
    - Team and year pivots remain one click from cell or overlay.
  - Rubric (before → target):
    - Scan speed: 3 → 5
    - Information hierarchy: 3 → 5
    - Interaction predictability: 4 → 5
    - Density/readability: 4 → 4
    - Navigation/pivots: 4 → 5
  - Guardrails:
    - Do not modify Salary Book files.

- [ ] [P2] [TOOL] /tools/two-way-utility — add intent search to find one player fast without leaving team-section context
  - Problem: Users scanning many team sections cannot quickly jump to a known player name/id.
  - Hypothesis: Commandbar intent search with in-context filtering/highlighting will cut navigation time while preserving workbench density.
  - Scope (files):
    - web/app/views/tools/two_way_utility/show.html.erb
    - web/app/views/tools/two_way_utility/_workspace_main.html.erb
    - web/app/views/tools/two_way_utility/_rightpanel_base.html.erb
    - web/app/controllers/tools/two_way_utility_controller.rb
    - web/test/integration/tools_two_way_utility_test.rb
  - Acceptance criteria:
    - Commandbar includes player intent search (name/id) that updates board via SSE.
    - Matching rows remain grouped by team section and visibly highlighted.
    - Compare slots and selected overlay player are preserved when still in filtered scope.
    - URL query string captures the search state for sharing.
  - Rubric (before → target):
    - Scan speed: 3 → 5
    - Information hierarchy: 4 → 5
    - Interaction predictability: 4 → 5
    - Density/readability: 4 → 4
    - Navigation/pivots: 4 → 5
  - Guardrails:
    - Do not modify Salary Book files.

- [ ] [P1] [INDEX] /transactions — support fast day-by-day feed triage with date-grouped scanning
  - Problem: Long transaction lists are flat, forcing users to repeatedly re-read dates while scanning.
  - Hypothesis: Date-group headers with stable row density will improve temporal orientation and reduce cognitive load.
  - Scope (files):
    - web/app/views/entities/transactions/_results.html.erb
    - web/app/views/entities/transactions/_rightpanel_base.html.erb
    - web/app/controllers/entities/transactions_controller.rb
    - web/app/controllers/entities/transactions_sse_controller.rb
    - web/test/integration/entities_pane_endpoints_test.rb
  - Acceptance criteria:
    - Transactions render in date-grouped blocks (today-first chronology) with clear separators.
    - Grouping works with intent search and type filters without breaking row click → overlay flow.
    - Sidebar quick feed mirrors grouped chronology for top rows.
    - Overlay preservation behavior remains correct when filtered results still contain selected row.
  - Rubric (before → target):
    - Scan speed: 3 → 5
    - Information hierarchy: 4 → 5
    - Interaction predictability: 4 → 5
    - Density/readability: 4 → 4
    - Navigation/pivots: 4 → 5
  - Guardrails:
    - Do not modify Salary Book files.

- [ ] [P1] [INDEX] /trades — make team-in/team-out impact obvious from the list before opening overlay
  - Problem: Trade rows show team count and assets, but not immediate net direction by team, causing extra overlay opens.
  - Hypothesis: Compact net-flow summaries in-row will let users shortlist relevant deals faster.
  - Scope (files):
    - web/app/views/entities/trades/_results.html.erb
    - web/app/views/entities/trades/_rightpanel_base.html.erb
    - web/app/controllers/entities/trades_controller.rb
    - web/app/controllers/entities/trades_sse_controller.rb
    - web/test/integration/entities_pane_endpoints_test.rb
  - Acceptance criteria:
    - Each trade row includes a compact team-impact summary (at least outgoing/incoming emphasis for primary teams).
    - Composition and complexity lenses continue to behave consistently with summary labels.
    - Sidebar quick deals include the same impact grammar as main rows.
    - Overlay opens with unchanged route and selected-state behavior.
  - Rubric (before → target):
    - Scan speed: 3 → 5
    - Information hierarchy: 4 → 5
    - Interaction predictability: 4 → 5
    - Density/readability: 4 → 4
    - Navigation/pivots: 4 → 5
  - Guardrails:
    - Do not modify Salary Book files.

- [ ] [P2] [TOOL] /tools/system-values — jump directly to a metric and open drill-in in one flow
  - Problem: Users must manually scroll across large tables to reach a known metric/bracket.
  - Hypothesis: Metric finder + jump-to-row drill-in will accelerate expert workflows while preserving dense table layout.
  - Scope (files):
    - web/app/views/tools/system_values/_commandbar.html.erb
    - web/app/views/tools/system_values/_workspace_main.html.erb
    - web/app/views/tools/system_values/_rightpanel_base.html.erb
    - web/app/controllers/tools/system_values_controller.rb
    - web/test/integration/tools_system_values_test.rb
  - Acceptance criteria:
    - Commandbar exposes a metric finder that can target system/tax/minimum/rookie metrics.
    - Choosing a metric scrolls to the relevant section/row and opens corresponding sidebar drill-in.
    - Overlay query params remain canonical and survive SSE refresh.
    - Existing section visibility toggles and scrollspy continue to work.
  - Rubric (before → target):
    - Scan speed: 3 → 5
    - Information hierarchy: 4 → 5
    - Interaction predictability: 4 → 5
    - Density/readability: 4 → 4
    - Navigation/pivots: 4 → 5
  - Guardrails:
    - Do not modify Salary Book files.

- [ ] [P1] [INDEX] /agents — allow agency-anchored narrowing while keeping agency overlay context
  - Problem: After opening an agency overlay, users still scan the full agent list and must mentally filter represented agents.
  - Hypothesis: A one-click “scope to active agency overlay” flow will reduce visual noise and speed agency-to-agent triage.
  - Scope (files):
    - web/app/views/entities/agents/index.html.erb
    - web/app/views/entities/agents/_workspace_main.html.erb
    - web/app/views/entities/agents/_rightpanel_base.html.erb
    - web/app/controllers/entities/agents_controller.rb
    - web/app/controllers/entities/agents_sse_controller.rb
    - web/test/integration/entities_agents_index_test.rb
  - Acceptance criteria:
    - When an agency overlay is active, users can toggle a scoped view showing only represented agents.
    - Scoped mode preserves agency overlay and keeps row highlight/tie-back cues.
    - Clearing scope returns to prior filters/sort without losing overlay state.
    - URL state captures scope mode for shareability.
  - Rubric (before → target):
    - Scan speed: 4 → 5
    - Information hierarchy: 4 → 5
    - Interaction predictability: 3 → 5
    - Density/readability: 4 → 4
    - Navigation/pivots: 4 → 5
  - Guardrails:
    - Do not modify Salary Book files.

- [ ] [P1] [INDEX] /draft-selections — make provenance severity legible at row glance for faster shortlist building
  - Problem: Provenance intensity is mostly numeric and requires close reading across many rows.
  - Hypothesis: Explicit severity chips and consistent row grammar will speed deep-chain vs clean-pick triage.
  - Scope (files):
    - web/app/views/entities/draft_selections/_workspace_main.html.erb
    - web/app/views/entities/draft_selections/_rightpanel_base.html.erb
    - web/app/controllers/entities/draft_selections_controller.rb
    - web/app/controllers/entities/draft_selections_sse_controller.rb
    - web/test/integration/entities_draft_selections_index_test.rb
  - Acceptance criteria:
    - Rows include provenance severity chip taxonomy (e.g., clean / with-trade / deep-chain).
    - Severity taxonomy aligns with lens behavior and sidebar KPI counts.
    - Quick selections panel mirrors row severity grammar.
    - Selection overlay and pivots remain unchanged functionally.
  - Rubric (before → target):
    - Scan speed: 3 → 5
    - Information hierarchy: 4 → 5
    - Interaction predictability: 4 → 5
    - Density/readability: 4 → 4
    - Navigation/pivots: 4 → 5
  - Guardrails:
    - Do not modify Salary Book files.

- [ ] [P2] [TOOL] /tools/team-summary — support next/previous team stepping inside overlay without losing compare context
  - Problem: Users must close overlay or click new rows to compare adjacent teams, breaking drill-in rhythm.
  - Hypothesis: Overlay next/prev controls tied to current filtered ordering will create a faster, predictable triage loop.
  - Scope (files):
    - web/app/views/tools/team_summary/_rightpanel_overlay_team.html.erb
    - web/app/views/tools/team_summary/_workspace_main.html.erb
    - web/app/controllers/tools/team_summary_controller.rb
    - web/app/javascript/tools/team_summary.js
    - web/test/integration/tools_team_summary_test.rb
  - Acceptance criteria:
    - Overlay exposes Next/Prev actions that move through current filtered row order.
    - Stepping updates overlay content and selected row highlight via one SSE flow.
    - Compare slots (A/B) remain intact while stepping.
    - Keyboard escape behavior still closes overlay correctly.
  - Rubric (before → target):
    - Scan speed: 4 → 5
    - Information hierarchy: 4 → 5
    - Interaction predictability: 3 → 5
    - Density/readability: 5 → 5
    - Navigation/pivots: 4 → 5
  - Guardrails:
    - Do not modify Salary Book files.

- [ ] [P3] [INDEX] /agencies — add direct “open in agents lens” pivot from agency rows/overlay
  - Problem: Agency triage often requires immediate jump into agent-level rows, but pivot requires manual nav/filter recreation.
  - Hypothesis: Preserving lens context while pivoting to `/agents` will reduce context-switch friction.
  - Scope (files):
    - web/app/views/entities/agencies/_workspace_main.html.erb
    - web/app/views/entities/agencies/_rightpanel_overlay_agency.html.erb
    - web/app/controllers/entities/agencies_controller.rb
    - web/test/integration/entities_agencies_index_test.rb
  - Acceptance criteria:
    - Agency row and overlay expose one-click pivot to `/agents` pre-scoped to that agency.
    - Pivot preserves year/sort posture where applicable.
    - Returned `/agents` view opens in agents mode with scoped context visible.
    - Existing agency overlay behavior is unaffected.
  - Rubric (before → target):
    - Scan speed: 4 → 5
    - Information hierarchy: 4 → 5
    - Interaction predictability: 4 → 5
    - Density/readability: 4 → 4
    - Navigation/pivots: 4 → 5
  - Guardrails:
    - Do not modify Salary Book files.

- [ ] [P3] [TOOL] /tools/system-values — persist section visibility state in shareable URL
  - Problem: Section visibility toggles are client-only, so shared links reopen with default visibility and lose analyst framing.
  - Hypothesis: Encoding visibility toggles in URL + SSE state will improve collaboration and replayability of analysis views.
  - Scope (files):
    - web/app/views/tools/system_values/show.html.erb
    - web/app/views/tools/system_values/_commandbar.html.erb
    - web/app/controllers/tools/system_values_controller.rb
    - web/test/integration/tools_system_values_test.rb
  - Acceptance criteria:
    - Visibility toggles (System/Tax/Minimum/Rookie) are reflected in URL query state.
    - Reloading or sharing URL restores identical visible-section layout.
    - SSE refresh preserves overlay and visibility state together.
    - Scrollspy and section wayfinding ignore hidden sections correctly.
  - Rubric (before → target):
    - Scan speed: 4 → 4
    - Information hierarchy: 4 → 5
    - Interaction predictability: 3 → 5
    - Density/readability: 4 → 4
    - Navigation/pivots: 4 → 5
  - Guardrails:
    - Do not modify Salary Book files.
