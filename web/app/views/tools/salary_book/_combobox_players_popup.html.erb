<% players = Array(local_assigns[:players]) %>
<% query = local_assigns[:query].to_s %>
<% seq = local_assigns.fetch(:seq, 0).to_i %>
<% team_code = local_assigns[:team_code].to_s.strip.upcase.presence %>
<% error_message = local_assigns[:error_message].to_s.strip.presence %>
<%
  error_label = "Unable to load players"

  empty_message = if error_message.present?
    error_label
  elsif query.present?
    "No players found"
  elsif team_code.present?
    "No players on #{team_code}"
  else
    "Type to search players"
  end

  scope_label = if query.present?
    "query: #{query.first(24)}"
  elsif team_code.present?
    "team: #{team_code}"
  else
    "all players"
  end
%>

<div
  id="sbplayercb-popup"
  class="w-full overflow-hidden rounded-md border border-border bg-background shadow-sm"
  data-show="$_sbplayercbopen"
  style="display: none;"
  data-seq="<%= seq %>"
>
  <div
    id="sbplayercb-status"
    class="h-7 px-2 border-b border-border/60 bg-muted/20 flex items-center justify-between text-[10px] uppercase tracking-wide text-muted-foreground/90"
    role="status"
    aria-live="polite"
  >
    <% if error_message.present? %>
      <span><%= error_label %></span>
    <% elsif players.any? %>
      <span><%= pluralize(players.length, "result") %></span>
    <% else %>
      <span><%= empty_message %></span>
    <% end %>

    <% if players.any? %>
      <span class="font-mono tabular-nums text-[10px] text-muted-foreground/70"><%= scope_label %></span>
    <% end %>
  </div>

  <div id="sbplayercb-list" role="listbox" class="max-h-72 overflow-y-auto overscroll-contain py-1">
    <% if players.any? %>
      <% players.each_with_index do |player, index| %>
        <%= render partial: "tools/salary_book/combobox_players_option", locals: { player:, index: } %>
      <% end %>
    <% else %>
      <div class="px-3 py-2 text-xs text-muted-foreground"><%= empty_message %></div>
    <% end %>
  </div>
</div>
