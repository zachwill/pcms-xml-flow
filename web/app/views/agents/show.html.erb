<% content_for :title, @agent&.fetch("full_name", nil) || "Agent" %>

<% agent_name = @agent&.fetch("full_name", nil).to_s %>
<% agency_name = @agent&.fetch("agency_name", nil).to_s %>

<%# Prefetch slugs for links %>
<% prefetch_canonical_slugs(entity_type: "player", entity_ids: @clients.map { |c| c["player_id"] }) %>
<% prefetch_canonical_slugs(entity_type: "team", entity_ids: @team_distribution.map { |t| t["team_id"] }) %>

<%# Rollup aliases %>
<% r = @client_rollup %>
<% standard_count = r["standard_count"].to_i %>
<% two_way_count = r["two_way_count"].to_i %>
<% client_count = r["client_count"].to_i %>
<% team_count = r["team_count"].to_i %>
<% rookie_scale_count = r["rookie_scale_count"].to_i %>
<% max_contract_count = r["max_contract_count"].to_i %>
<% min_contract_count = r["min_contract_count"].to_i %>
<% no_trade_count = r["no_trade_count"].to_i %>
<% trade_kicker_count = r["trade_kicker_count"].to_i %>
<% restricted_count = r["restricted_now_count"].to_i %>
<% expiring_2025 = r["expiring_2025"].to_i %>
<% expiring_2026 = r["expiring_2026"].to_i %>
<% expiring_2027 = r["expiring_2027"].to_i %>
<% expiring_window_count = expiring_2025 + expiring_2026 + expiring_2027 %>
<% player_option_count = r["player_option_count"].to_i %>
<% team_option_count = r["team_option_count"].to_i %>
<% option_window_count = player_option_count + team_option_count %>

<% book_2025_percentile = r["cap_2025_total_percentile"] %>
<% client_count_percentile = r["client_count_percentile"] %>
<% max_contract_count_percentile = r["max_contract_count_percentile"] %>

<%# Header badges %>
<% header_badges = [] %>
<% header_badges << { label: (@agent['is_active'] == false ? 'Inactive' : 'Active'), variant: (@agent['is_active'] == false ? "muted" : "success") } %>
<% header_badges << { label: (@agent['is_certified'] ? 'Certified' : 'Certification unknown'), variant: (@agent['is_certified'] ? "accent" : "muted") } %>

<%# Header meta %>
<% header_meta = [] %>
<% header_meta << "#{client_count} clients" %>
<% header_meta << "#{team_count} teams" %>
<% header_meta << "Book '25: #{format_salary(r['cap_2025_total'])}" if r['cap_2025_total'] %>
<% header_meta << agency_name if agency_name.present? %>

<% posture_chips = [] %>
<% posture_chips << { label: "#{max_contract_count} max", variant: "accent" } if max_contract_count > 0 %>
<% posture_chips << { label: "#{expiring_window_count} expiring ≤27", variant: "warning" } if expiring_window_count > 0 %>
<% posture_chips << { label: "#{restricted_count} restricted", variant: "danger" } if restricted_count > 0 %>
<% posture_chips << { label: "#{option_window_count} options", variant: "accent" } if option_window_count > 0 %>

<% salary_book_href = "/" %>

<%# Header links %>
<% header_links = [] %>
<% header_links << ["Open in Salary Book", salary_book_href] if salary_book_href.present? %>
<% if @agent["agency_id"].present? && agency_name.present? %>
  <% header_links << ["Agency page", agency_href(@agent['agency_id'])] %>
<% end %>
<% header_links << ["Browse Agents", "/agents"] %>

<%
  client_rows = @clients.map do |client|
    age_str = client["age"].present? ? "#{client['age'].to_i}y" : nil
    yos_str = client["years_of_service"].present? ? "#{client['years_of_service'].to_i} YOS" : nil

    next_option = nil
    (2026..2028).each do |year|
      normalized = normalize_contract_option(client["option_#{year}"])
      next if normalized.blank?

      option_classes = case normalized
      when "PO"
        "text-blue-600 dark:text-blue-400"
      when "TO"
        "text-purple-600 dark:text-purple-400"
      else
        "text-orange-600 dark:text-orange-400"
      end

      option_chip_classes = case normalized
      when "PO"
        "bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300"
      when "TO"
        "bg-purple-100 dark:bg-purple-900/50 text-purple-700 dark:text-purple-300"
      else
        "bg-orange-100 dark:bg-orange-900/50 text-orange-700 dark:text-orange-300"
      end

      next_option = {
        year: year,
        label: "#{normalized} #{format_year_label(year)}",
        chip_label: "#{normalized} '#{format_year_label(year).split('-').first}",
        decision_classes: option_classes,
        chip_classes: option_chip_classes
      }
      break
    end

    fa_year = nil
    (2025..2029).each do |year|
      if client["cap_#{year}"].to_f > 0 && client["cap_#{year + 1}"].to_f == 0
        fa_year = year
        break
      end
    end

    is_max_level = !client["is_two_way"] && client["pct_cap_2025"].to_f >= 0.25
    is_restricted = client["is_no_trade"] || client["is_trade_bonus"] || client["is_trade_restricted_now"]
    is_expiring_window = fa_year.present? && fa_year <= 2027

    chips = []
    chips << { label: "2W", classes: neutral_badge_classes } if client["is_two_way"]
    chips << { label: "Max", classes: "bg-violet-100 text-violet-700 dark:bg-violet-900/40 dark:text-violet-300" } if is_max_level
    chips << { label: "Rook", classes: "bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300" } if client["years_of_service"].to_i <= 3 && !client["is_two_way"]
    chips << { label: "Min", classes: neutral_badge_classes } if client["is_min_contract"]
    chips << { label: "NTC", classes: "bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-300" } if client["is_no_trade"]

    if client["is_trade_bonus"]
      pct = client["trade_bonus_percent"]
      kicker_label = if pct.present? && pct.to_f > 0
        pct_value = pct.to_f
        pct_str = pct_value % 1 == 0 ? pct_value.to_i.to_s : pct_value.to_s
        "TK #{pct_str}%"
      else
        "TK"
      end
      chips << { label: kicker_label, classes: "bg-orange-100 text-orange-700 dark:bg-orange-900/50 dark:text-orange-300" }
    end

    chips << { label: "Restricted", classes: "bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-300" } if client["is_trade_restricted_now"]
    chips << { label: next_option[:chip_label], classes: next_option[:chip_classes] } if next_option.present?
    chips << { label: "FA '#{format_year_label(fa_year).split('-').first}", classes: "bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-300" } if is_expiring_window

    decision_label = if next_option.present?
      next_option[:label]
    elsif fa_year.present?
      "FA #{format_year_label(fa_year)}"
    elsif client["is_two_way"]
      "Two-Way"
    else
      "—"
    end

    detail_parts = [age_str, yos_str, client["contract_type_code"].presence].compact

    cohort_memberships = []
    cohort_memberships << { key: "two_way", label: "2W" } if client["is_two_way"]
    cohort_memberships << { key: "max", label: "Max" } if is_max_level
    cohort_memberships << { key: "expiring", label: "Exp ≤27" } if is_expiring_window
    cohort_memberships << { key: "restricted", label: "Restricted" } if is_restricted

    {
      player_id: client["player_id"],
      player_name: client["player_name"],
      team_code: client["team_code"],
      team_id: client["team_id"],
      team_name: client["team_name"],
      cap_2025: client["cap_2025"],
      total_salary_from_2025: client["total_salary_from_2025"],
      decision_label: decision_label,
      decision_classes: (next_option&.dig(:decision_classes) || "text-muted-foreground"),
      detail_line: detail_parts.join(" · "),
      chips: chips,
      cohort_memberships: cohort_memberships,
      cohort_keys: cohort_memberships.map { |membership| membership[:key] },
      is_two_way: client["is_two_way"],
      is_max_level: is_max_level,
      is_restricted: is_restricted,
      is_expiring_window: is_expiring_window
    }
  end

  sorted_client_rows = client_rows.sort_by { |row| [-(row[:cap_2025].to_f), row[:player_name].to_s] }

  active_cohort_filters = Array(@show_cohort_filters)
    .map { |value| value.to_s.strip.downcase.tr("-", "_") }
    .reject(&:blank?)
    .select { |value| %w[max expiring restricted two_way].include?(value) }
    .uniq
  active_cohort_filter_lookup = active_cohort_filters.index_with(true)

  cohort_definitions = [
    {
      key: "max",
      id: "cohort-max",
      title: "Max-level anchors",
      subtitle: "Largest leverage contracts in this book.",
      match: ->(row) { row[:is_max_level] }
    },
    {
      key: "expiring",
      id: "cohort-expiring",
      title: "Expiring through 2027",
      subtitle: "Near-term free agency windows requiring negotiation sequencing.",
      match: ->(row) { row[:is_expiring_window] }
    },
    {
      key: "restricted",
      id: "cohort-restricted",
      title: "Restricted / no-trade / kicker",
      subtitle: "Movement constraints and transaction-sensitive clients.",
      match: ->(row) { row[:is_restricted] }
    },
    {
      key: "two_way",
      id: "cohort-two-way",
      title: "Two-way clients",
      subtitle: "Conversion and roster-slot watchlist.",
      match: ->(row) { row[:is_two_way] }
    }
  ]

  cohort_rows_by_key = cohort_definitions.to_h do |definition|
    [definition[:key], sorted_client_rows.select { |row| definition[:match].call(row) }]
  end

  visible_cohort_definitions = if active_cohort_filters.any?
    cohort_definitions.select { |definition| active_cohort_filter_lookup[definition[:key]] }
  else
    cohort_definitions
  end

  filtered_client_rows = if active_cohort_filters.any?
    sorted_client_rows.select { |row| (row[:cohort_keys] & active_cohort_filters).any? }
  else
    sorted_client_rows
  end
%>

<div id="agent-show" class="min-h-screen w-full bg-background">
  <%= render partial: "shared/commandbar", locals: {
    active_entity_scope: "agents"
  } %>

  <main class="px-4 pb-8" data-entity-workspace data-scroll-offset-extra="64">
    <%= render partial: "agents/sticky_header", locals: {
      image_fallback: agent_initials(agent_name),
      title: agent_name.presence || "Agent",
      badges: header_badges,
      meta: header_meta,
      links: header_links,
      posture_chips: posture_chips,
      agency_name: agency_name,
      client_count: client_count,
      team_count: team_count,
      cap_2025_total: r["cap_2025_total"],
      total_salary_from_2025: r["total_salary_from_2025"]
    } %>

    <div class="lg:flex lg:gap-8">
      <div class="min-w-0 flex-1 space-y-8">

        <section id="at-a-glance" class="scroll-mt-24 space-y-3">
          <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Portfolio posture</h2>

          <div class="rounded-lg border border-border overflow-hidden">
            <div class="divide-y divide-border/60">
              <div class="flex items-center justify-between gap-3 px-3 py-2">
                <div class="text-xs text-muted-foreground uppercase tracking-wide">Book '<%= format_year_label(2025).split("-").first %></div>
                <div class="text-right">
                  <div class="text-sm font-semibold font-mono tabular-nums"><%= format_salary(r["cap_2025_total"]) %></div>
                  <% if representation_percentile_label(book_2025_percentile).present? %>
                    <div class="text-[10px] tabular-nums <%= representation_percentile_color_class(book_2025_percentile) %>">
                      <%= representation_percentile_label(book_2025_percentile) %>
                      ·
                      <%= representation_percentile_blocks(book_2025_percentile) %>
                    </div>
                  <% end %>
                </div>
              </div>

              <div class="flex items-center justify-between gap-3 px-3 py-2">
                <div class="text-xs text-muted-foreground uppercase tracking-wide">Clients</div>
                <div class="text-right">
                  <div class="text-sm font-semibold font-mono tabular-nums"><%= standard_count %><% if two_way_count > 0 %><span class="text-muted-foreground/80"> + <%= two_way_count %> 2W</span><% end %></div>
                  <% if representation_percentile_label(client_count_percentile).present? %>
                    <div class="text-[10px] tabular-nums <%= representation_percentile_color_class(client_count_percentile) %>">
                      <%= representation_percentile_label(client_count_percentile) %>
                      ·
                      <%= representation_percentile_blocks(client_count_percentile) %>
                    </div>
                  <% end %>
                </div>
              </div>

              <div class="flex items-center justify-between gap-3 px-3 py-2">
                <div class="text-xs text-muted-foreground uppercase tracking-wide">Teams</div>
                <div class="text-sm font-semibold font-mono tabular-nums"><%= team_count %></div>
              </div>

              <div class="flex items-center justify-between gap-3 px-3 py-2">
                <div class="text-xs text-muted-foreground uppercase tracking-wide">Total committed</div>
                <div class="text-sm font-semibold font-mono tabular-nums"><%= format_salary(r["total_salary_from_2025"]) %></div>
              </div>
            </div>
          </div>

          <div class="flex flex-wrap gap-1.5 text-[10px]">
            <% if max_contract_count > 0 %>
              <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full font-semibold uppercase tracking-wide bg-violet-100 text-violet-700 dark:bg-violet-900/40 dark:text-violet-300">
                <span><%= max_contract_count %> Max-level</span>
                <% if representation_percentile_int(max_contract_count_percentile).present? %>
                  <span class="font-mono tabular-nums text-[9px] opacity-80">P<%= representation_percentile_int(max_contract_count_percentile) %></span>
                <% end %>
              </span>
            <% end %>
            <% if rookie_scale_count > 0 %>
              <span class="inline-flex items-center px-2 py-0.5 rounded-full font-semibold uppercase tracking-wide bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-300"><%= rookie_scale_count %> Rookie-scale</span>
            <% end %>
            <% if min_contract_count > 0 %>
              <span class="inline-flex items-center px-2 py-0.5 rounded-full font-semibold uppercase tracking-wide <%= neutral_badge_classes %>"><%= min_contract_count %> Minimum</span>
            <% end %>
            <% if no_trade_count > 0 %>
              <span class="inline-flex items-center px-2 py-0.5 rounded-full font-semibold uppercase tracking-wide bg-red-100 text-red-700 dark:bg-red-900/40 dark:text-red-300"><%= no_trade_count %> No-Trade</span>
            <% end %>
            <% if trade_kicker_count > 0 %>
              <span class="inline-flex items-center px-2 py-0.5 rounded-full font-semibold uppercase tracking-wide bg-orange-100 text-orange-700 dark:bg-orange-900/40 dark:text-orange-300"><%= trade_kicker_count %> Trade Kicker</span>
            <% end %>
            <% if restricted_count > 0 %>
              <span class="inline-flex items-center px-2 py-0.5 rounded-full font-semibold uppercase tracking-wide bg-red-100 text-red-700 dark:bg-red-900/40 dark:text-red-300"><%= restricted_count %> Trade Restricted</span>
            <% end %>
            <% if expiring_window_count > 0 %>
              <span class="inline-flex items-center px-2 py-0.5 rounded-full font-semibold uppercase tracking-wide bg-amber-100 text-amber-700 dark:bg-amber-900/40 dark:text-amber-300"><%= expiring_window_count %> Expiring ≤ 27</span>
            <% end %>
          </div>
        </section>

        <section id="book-horizon" class="scroll-mt-24 space-y-3">
          <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Book horizon</h2>
          <% if @book_by_year.any? %>
            <%
              max_book = @book_by_year.map { |y| y["cap_total"].to_i }.max
              max_book = [max_book, 1].max
            %>
            <div class="overflow-x-auto rounded-lg border border-border">
              <div class="flex min-w-max">
                <% (2025..2030).each do |year| %>
                  <%
                    row = @book_by_year.find { |y| y["salary_year"] == year }
                    cap_total = row ? row["cap_total"].to_i : 0
                    player_count = row ? row["player_count"].to_i : 0
                    bar_pct = max_book > 0 ? (cap_total.to_f / max_book * 100).round(1) : 0
                  %>
                  <div class="min-w-24 flex-1 border-r border-border p-3 text-center last:border-r-0 relative overflow-hidden">
                    <div class="absolute inset-x-0 bottom-0 bg-violet-100/60 dark:bg-violet-900/20 transition-all" style="height: <%= bar_pct %>%"></div>
                    <div class="relative">
                      <div class="text-[10px] text-muted-foreground uppercase tracking-wide font-medium"><%= format_year_label(year) %></div>
                      <% if cap_total > 0 %>
                        <div class="mt-1 text-base font-semibold font-mono tabular-nums"><%= format_salary(cap_total) %></div>
                        <div class="mt-0.5 text-[10px] text-muted-foreground/70 tabular-nums"><%= player_count %> player<%= player_count != 1 ? "s" : "" %></div>
                      <% else %>
                        <div class="mt-1 text-sm text-muted-foreground/50">—</div>
                      <% end %>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          <% else %>
            <div class="p-4 rounded-lg bg-muted/30 border border-border/50 text-sm text-muted-foreground italic">No book data available.</div>
          <% end %>
        </section>

        <section id="client-cohorts" class="scroll-mt-24 space-y-3">
          <div class="flex items-center justify-between">
            <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Client cohorts</h2>
            <% if active_cohort_filters.any? %>
              <span class="text-[10px] text-muted-foreground tabular-nums"><%= visible_cohort_definitions.size %> of <%= cohort_definitions.size %> cohorts · <%= filtered_client_rows.size %> matching clients</span>
            <% else %>
              <span class="text-[10px] text-muted-foreground tabular-nums"><%= cohort_definitions.size %> cohorts · <%= client_count %> clients</span>
            <% end %>
          </div>

          <div class="flex flex-wrap gap-1.5 text-[10px] uppercase tracking-wide">
            <a
              href="<%= agent_path(@agent_slug, anchor: 'client-cohorts') %>"
              class="rounded border px-2 py-0.5 transition-colors <%= active_cohort_filters.empty? ? 'border-primary bg-primary/10 text-primary font-semibold' : 'border-border text-muted-foreground hover:text-foreground hover:border-foreground/20' %>"
            >All cohorts</a>

            <% cohort_definitions.each do |definition| %>
              <% cohort_rows = cohort_rows_by_key.fetch(definition[:key], []) %>
              <% filter_active = active_cohort_filter_lookup[definition[:key]] %>
              <% next_filters = filter_active ? (active_cohort_filters - [definition[:key]]) : (active_cohort_filters + [definition[:key]]) %>
              <% cohort_href = agent_path(@agent_slug, cohorts: (next_filters.any? ? next_filters.join(",") : nil), anchor: "client-cohorts") %>

              <a
                href="<%= cohort_href %>"
                class="rounded border px-2 py-0.5 transition-colors <%= filter_active ? 'border-primary bg-primary/10 text-primary font-semibold' : 'border-border text-muted-foreground hover:text-foreground hover:border-foreground/20' %>"
              >
                <span><%= definition[:title] %></span>
                <span class="ml-1 font-mono tabular-nums"><%= cohort_rows.size %></span>
              </a>
            <% end %>
          </div>

          <div class="space-y-4">
            <% visible_cohort_definitions.each do |cohort| %>
              <% cohort_rows = cohort_rows_by_key.fetch(cohort[:key], []) %>
              <% cohort_cap_total = cohort_rows.sum { |row| row[:cap_2025].to_f } %>
              <% cohort_salary_total = cohort_rows.sum { |row| row[:total_salary_from_2025].to_f } %>

              <article id="<%= cohort[:id] %>" class="rounded-lg border border-border overflow-hidden">
                <header class="px-3 py-2 border-b border-border/60 bg-muted/20">
                  <div class="flex flex-wrap items-center justify-between gap-2">
                    <div>
                      <h3 class="text-[11px] font-semibold uppercase tracking-wide text-foreground"><%= cohort[:title] %></h3>
                      <p class="text-[10px] text-muted-foreground/80"><%= cohort[:subtitle] %></p>
                    </div>
                    <div class="text-right tabular-nums">
                      <div class="text-xs font-semibold"><%= cohort_rows.size %> client<%= cohort_rows.size == 1 ? "" : "s" %></div>
                      <div class="text-[10px] text-muted-foreground">
                        <span class="font-mono"><%= cohort_cap_total.positive? ? format_salary(cohort_cap_total) : "—" %></span>
                        ·
                        <span class="font-mono"><%= cohort_salary_total.positive? ? format_salary(cohort_salary_total) : "—" %> total</span>
                      </div>
                    </div>
                  </div>
                </header>

                <% if cohort_rows.any? %>
                  <div class="divide-y divide-border/50">
                    <% cohort_rows.each do |client_row| %>
                      <%= render partial: "agents/client_lane", locals: { client_row: client_row } %>
                    <% end %>
                  </div>
                <% else %>
                  <div class="px-3 py-3 text-[11px] text-muted-foreground italic">No clients currently in this cohort.</div>
                <% end %>
              </article>
            <% end %>
          </div>
        </section>

        <section id="team-distribution" class="scroll-mt-24 space-y-3">
          <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Team footprint</h2>

          <% if @team_distribution.empty? %>
            <div class="p-4 rounded-lg bg-muted/30 border border-border/50 text-sm text-muted-foreground italic">No team distribution data.</div>
          <% else %>
            <%
              max_team_book = @team_distribution.map { |t| t["cap_2025_total"].to_i }.max
              max_team_book = [max_team_book, 1].max
            %>
            <div class="rounded-lg border border-border overflow-hidden">
              <div class="bg-muted/20 border-b border-border/60">
                <div class="flex items-center px-3 h-7 text-[10px] uppercase tracking-wide text-muted-foreground/90 font-medium">
                  <div class="min-w-0 flex-1">Team</div>
                  <div class="w-16 shrink-0 text-right font-mono tabular-nums">Clients</div>
                  <div class="w-24 shrink-0 text-right font-mono tabular-nums">Cap '25</div>
                  <div class="w-24 shrink-0 text-right font-mono tabular-nums">Cap '26</div>
                </div>
              </div>

              <div class="divide-y divide-border/50">
                <% @team_distribution.each do |team| %>
                  <%
                    team_book = team["cap_2025_total"].to_i
                    bar_pct = (team_book.to_f / max_team_book * 100).round(1)
                  %>
                  <div class="group relative overflow-hidden transition-colors duration-75 hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10">
                    <div class="absolute inset-y-0 left-0 bg-violet-100/40 dark:bg-violet-900/15" style="width: <%= bar_pct %>%"></div>
                    <div class="relative flex items-center px-3 py-1.5 text-xs">
                      <div class="min-w-0 flex-1">
                        <% if team["team_code"].present? %>
                          <a href="<%= team_href(team_code: team['team_code'], team_id: team['team_id']) %>" class="font-medium hover:underline"><%= team["team_code"] %></a>
                          <% if team["team_name"].present? %>
                            <span class="text-[10px] text-muted-foreground/70"> · <%= team["team_name"] %></span>
                          <% end %>
                        <% else %>
                          <span class="text-muted-foreground">—</span>
                        <% end %>
                      </div>

                      <div class="w-16 shrink-0 text-right font-mono tabular-nums"><%= team["client_count"].to_i %></div>
                      <div class="w-24 shrink-0 text-right font-mono tabular-nums"><%= team_book.positive? ? format_salary(team_book) : "—" %></div>
                      <div class="w-24 shrink-0 text-right font-mono tabular-nums"><%= team["cap_2026_total"].to_i.positive? ? format_salary(team["cap_2026_total"]) : "—" %></div>
                    </div>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </section>

        <section id="clients" class="scroll-mt-24 space-y-3">
          <div class="flex items-center justify-between">
            <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground"><%= active_cohort_filters.any? ? "Filtered clients" : "All clients" %></h2>
            <% if active_cohort_filters.any? %>
              <span class="text-[10px] text-muted-foreground tabular-nums"><%= filtered_client_rows.size %> of <%= client_count %> players</span>
            <% else %>
              <span class="text-[10px] text-muted-foreground tabular-nums"><%= client_count %> player<%= client_count != 1 ? "s" : "" %></span>
            <% end %>
          </div>

          <% if filtered_client_rows.empty? %>
            <div class="p-4 rounded-lg bg-muted/30 border border-border/50 text-sm text-muted-foreground italic">
              No clients match the active cohort filters.
              <a href="<%= agent_path(@agent_slug, anchor: 'client-cohorts') %>" class="not-italic hover:underline">Show all cohorts</a>
            </div>
          <% else %>
            <div class="rounded-lg border border-border overflow-hidden">
              <div class="bg-muted/20 border-b border-border/60">
                <div class="flex items-center px-3 h-7 text-[10px] uppercase tracking-wide text-muted-foreground/90 font-medium">
                  <div class="min-w-0 flex-[1.3]">Player</div>
                  <div class="w-14 shrink-0">Team</div>
                  <div class="w-24 shrink-0 text-right font-mono tabular-nums">Cap '25</div>
                  <div class="w-24 shrink-0 text-right font-mono tabular-nums">Next</div>
                  <div class="min-w-0 flex-1 text-right">Flags</div>
                </div>
              </div>

              <div class="divide-y divide-border/50">
                <% filtered_client_rows.each do |client_row| %>
                  <% row_tone_class = active_cohort_filters.any? ? "bg-violet-50/40 dark:bg-violet-900/10" : "" %>
                  <% cohort_hint_labels = client_row[:cohort_memberships].filter_map { |membership| membership[:label] if active_cohort_filter_lookup[membership[:key]] } %>
                  <%= render partial: "agents/client_lane", locals: { client_row: client_row, row_tone_class: row_tone_class, cohort_hint_labels: cohort_hint_labels } %>
                <% end %>
              </div>
            </div>
          <% end %>
        </section>

        <section id="connections" class="scroll-mt-24 space-y-3">
          <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Connections</h2>

          <div class="rounded-lg border border-border overflow-hidden divide-y divide-border/60">
            <div class="flex items-center justify-between gap-3 px-3 py-2">
              <span class="text-xs uppercase tracking-wide text-muted-foreground">Agency</span>
              <% if @agent["agency_id"].present? && agency_name.present? %>
                <a href="<%= agency_href(@agent['agency_id']) %>" class="font-medium text-sm hover:underline"><%= agency_name %></a>
              <% else %>
                <span class="text-sm text-muted-foreground italic"><%= agency_name.presence || "Unknown" %></span>
              <% end %>
            </div>

            <div class="flex items-center justify-between gap-3 px-3 py-2">
              <span class="text-xs uppercase tracking-wide text-muted-foreground">Status</span>
              <div class="flex flex-wrap items-center justify-end gap-1.5">
                <span class="entity-chip <%= @agent['is_active'] == false ? 'entity-chip--muted' : 'entity-chip--success' %>">
                  <%= @agent['is_active'] == false ? 'Inactive' : 'Active' %>
                </span>
                <span class="entity-chip <%= @agent['is_certified'] ? 'entity-chip--accent' : 'entity-chip--muted' %>">
                  <%= @agent['is_certified'] ? 'Certified' : 'Certification unknown' %>
                </span>
              </div>
            </div>
          </div>
        </section>

        <section id="historical" class="scroll-mt-24 space-y-3">
          <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Historical footprint</h2>

          <div class="rounded-lg border border-border overflow-hidden divide-y divide-border/60">
            <div class="flex items-center justify-between gap-3 px-3 py-2">
              <span class="text-xs uppercase tracking-wide text-muted-foreground">Historical clients</span>
              <span class="text-sm font-semibold font-mono tabular-nums"><%= @historical_footprint_rollup["historical_client_count"] || 0 %></span>
            </div>
            <div class="flex items-center justify-between gap-3 px-3 py-2">
              <span class="text-xs uppercase tracking-wide text-muted-foreground">Contracts</span>
              <span class="text-sm font-semibold font-mono tabular-nums"><%= @historical_footprint_rollup["contract_count"] || 0 %></span>
            </div>
            <div class="flex items-center justify-between gap-3 px-3 py-2">
              <span class="text-xs uppercase tracking-wide text-muted-foreground">Versions</span>
              <span class="text-sm font-semibold font-mono tabular-nums"><%= @historical_footprint_rollup["version_count"] || 0 %></span>
            </div>
            <div class="flex items-center justify-between gap-3 px-3 py-2">
              <span class="text-xs uppercase tracking-wide text-muted-foreground">First signing</span>
              <span class="text-sm font-medium font-mono tabular-nums"><%= format_plain_date(@historical_footprint_rollup["first_signing_date"]) %></span>
            </div>
            <div class="flex items-center justify-between gap-3 px-3 py-2">
              <span class="text-xs uppercase tracking-wide text-muted-foreground">Last signing</span>
              <span class="text-sm font-medium font-mono tabular-nums"><%= format_plain_date(@historical_footprint_rollup["last_signing_date"]) %></span>
            </div>
          </div>

          <% if @historical_footprint_rollup["historical_not_current_client_count"].to_i > 0 %>
            <div class="text-xs text-muted-foreground">
              Historical but not current clients:
              <span class="font-mono tabular-nums font-medium"><%= @historical_footprint_rollup["historical_not_current_client_count"] %></span>
            </div>
          <% end %>

          <% if @historical_signing_trend.any? %>
            <div class="rounded-lg border border-border overflow-hidden">
              <div class="bg-muted/20 border-b border-border/60">
                <div class="flex items-center px-3 h-7 text-[10px] uppercase tracking-wide text-muted-foreground/90 font-medium">
                  <div class="w-16 shrink-0">Year</div>
                  <div class="w-20 shrink-0 text-right font-mono tabular-nums">Clients</div>
                  <div class="w-20 shrink-0 text-right font-mono tabular-nums">Contracts</div>
                  <div class="w-20 shrink-0 text-right font-mono tabular-nums">Versions</div>
                </div>
              </div>

              <div class="divide-y divide-border/50">
                <% @historical_signing_trend.each do |trend| %>
                  <div class="flex items-center px-3 py-1.5 text-xs transition-colors duration-75 hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10">
                    <div class="w-16 shrink-0 font-mono tabular-nums"><%= trend["signing_year"] %></div>
                    <div class="w-20 shrink-0 text-right font-mono tabular-nums"><%= trend["distinct_clients"] %></div>
                    <div class="w-20 shrink-0 text-right font-mono tabular-nums"><%= trend["contract_count"] %></div>
                    <div class="w-20 shrink-0 text-right font-mono tabular-nums"><%= trend["version_count"] %></div>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </section>

      </div>

      <%= render partial: "shared/local_nav", locals: {
        sticky_top_class: "top-[196px]",
        sections: [
          ["at-a-glance", "Posture"],
          ["book-horizon", "Book horizon"],
          ["client-cohorts", "Cohorts"],
          ["team-distribution", "Teams"],
          ["clients", "All clients"],
          ["connections", "Connections"],
          ["historical", "Historical"]
        ]
      } %>
    </div>

    <%= render partial: "shared/known_slugs", locals: { entity_type: "agent", entity_id: @agent_id, path_prefix: "agents" } %>
  </main>
</div>
