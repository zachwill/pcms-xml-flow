<%
  agent ||= {}
  clients ||= []
  name = agent["full_name"].to_s
  initials = agent_initials(name)

  compact = ->(v) { format_salary(v) }

  total_count = agent["client_count"].to_i
  standard_count = agent["standard_count"].to_i
  two_way_count = agent["two_way_count"].to_i
  team_count = agent["team_count"].to_i

  max_contract_count = agent["max_contract_count"].to_i
  rookie_scale_count = agent["rookie_scale_count"].to_i
  min_contract_count = agent["min_contract_count"].to_i

  no_trade_count = agent["no_trade_count"].to_i
  trade_kicker_count = agent["trade_kicker_count"].to_i
  trade_restricted_count = agent["trade_restricted_count"].to_i

  expiring_2025 = agent["expiring_2025"].to_i
  total_expiring = expiring_2025

  player_option_count = agent["player_option_count"].to_i
  team_option_count = agent["team_option_count"].to_i
  prior_year_nba_now_free_agent_count = agent["prior_year_nba_now_free_agent_count"].to_i

  short_year = ->(y) { y.to_i.to_s[-2..] }

  # Next contract inflection marker (matches Salary Book _sidebar_agent pattern)
  next_contract_marker = ->(c) {
    return nil if c["is_two_way"]

    markers = []

    [2026, 2027, 2028].each do |y|
      option = normalize_contract_option(c["option_#{y}"])
      if option.present?
        option_classes = case option
        when "PO"
          "text-blue-600 dark:text-blue-400"
        when "TO"
          "text-purple-600 dark:text-purple-400"
        when "ETO"
          "text-orange-600 dark:text-orange-400"
        end

        if option_classes.present?
          markers << {
            year: y,
            priority: 1,
            label: "#{option} #{short_year.call(y)}",
            classes: option_classes
          }
        end
      end
    end

    [2025, 2026, 2027].each_cons(2) do |y, y_next|
      next unless c["cap_#{y}"].to_f > 0 && c["cap_#{y_next}"].to_f == 0

      markers << {
        year: y_next,
        priority: 3,
        label: "FA #{short_year.call(y_next)}",
        classes: (y_next == 2026 ? "text-red-600 dark:text-red-400" : "text-muted-foreground")
      }
      break
    end

    markers.min_by { |m| [m[:year], m[:priority]] }
  }
%>

<% prefetch_canonical_slugs(entity_type: "player", entity_ids: clients.map { |c| c["player_id"] }) %>
<% prefetch_canonical_slugs(entity_type: "team", entity_ids: clients.map { |c| c["team_id"] }) %>
<% prefetch_canonical_slugs(entity_type: "agency", entity_ids: [agent["agency_id"]]) %>

<div id="rightpanel-overlay" class="h-full">
  <%# Sticky header %>
  <div class="sticky top-0 z-20 h-10 px-4 flex items-center justify-between border-b border-border bg-background">
    <button
      type="button"
      class="cursor-pointer flex items-center gap-1.5 text-sm transition-colors text-muted-foreground hover:text-foreground
             focus-visible:outline-none focus-visible:ring-0 focus-visible:border-foreground dark:focus-visible:border-foreground"
      data-on:click="$overlaytype = 'none'; $overlayid = ''; @get('/agents/sidebar/clear')"
    >
      <%= lucide_icon("arrow-left", class: "w-4 h-4", "aria-hidden": true) %>
      <span class="font-medium">Back</span>
    </button>

    <a href="<%= agent_href(agent['agent_id']) %>" class="text-xs text-muted-foreground hover:text-foreground hover:underline">Open agent page</a>
  </div>

  <div class="px-4 pb-4 pt-4 space-y-5">
    <%# ── Agent header ── %>
    <div class="flex items-center gap-3">
      <div
        class="w-12 h-12 rounded-lg bg-gradient-to-br from-violet-500/20 to-violet-600/30 flex items-center justify-center
               text-base font-bold text-violet-600 dark:text-violet-400 ring-1 ring-violet-200 dark:ring-violet-800/50 shrink-0"
      >
        <%= initials %>
      </div>

      <div class="min-w-0 space-y-0.5">
        <h2 class="text-lg font-semibold text-foreground truncate"><%= name.presence || "Agent" %></h2>
        <div class="text-sm text-muted-foreground flex items-center gap-2 min-w-0">
          <% if agent["agency_id"].present? && agent["agency_name"].present? %>
            <button
              type="button"
              class="cursor-pointer min-w-0 truncate hover:text-foreground hover:underline"
              data-on:click="$overlaytype = 'agency'; $overlayid = '<%= agent['agency_id'] %>'; @get('/agents/sidebar/agency/<%= agent['agency_id'] %>')"
            ><%= agent["agency_name"] %></button>
            <a
              href="<%= agency_href(agent['agency_id']) %>"
              class="shrink-0 text-[10px] uppercase tracking-wide text-muted-foreground/70 hover:text-foreground hover:underline"
            >Page</a>
          <% elsif agent["agency_name"].present? %>
            <span class="truncate"><%= agent["agency_name"] %></span>
          <% else %>
            <span>Agency unknown</span>
          <% end %>
          <% if agent["is_active"] == false %>
            <span class="entity-chip entity-chip--muted shrink-0">inactive</span>
          <% end %>
          <% if agent["is_certified"] %>
            <span class="entity-chip entity-chip--accent shrink-0">certified</span>
          <% end %>
        </div>
      </div>
    </div>

    <%# ── Snapshot KPIs (match Salary Book sidebar treatment) ── %>
    <div class="border-t border-border pt-4 space-y-2.5">
      <div class="grid grid-cols-4 gap-1.5">
        <%= render partial: "salary_book/kpi_cell", locals: {
          label: "Clients",
          value: total_count.to_s,
          subvalue: (representation_percentile_int(agent["client_count_percentile"]).present? ? "P#{representation_percentile_int(agent['client_count_percentile'])}" : nil),
          subvalue_class_name: representation_percentile_color_class(agent["client_count_percentile"]),
          class_name: "w-full"
        } %>

        <%= render partial: "salary_book/kpi_cell", locals: {
          label: "Teams",
          value: team_count.to_s,
          subvalue: (representation_percentile_int(agent["team_count_percentile"]).present? ? "P#{representation_percentile_int(agent['team_count_percentile'])}" : nil),
          subvalue_class_name: representation_percentile_color_class(agent["team_count_percentile"]),
          class_name: "w-full"
        } %>

        <%= render partial: "salary_book/kpi_cell", locals: {
          label: "Std",
          value: standard_count.to_s,
          subvalue: (representation_percentile_int(agent["standard_count_percentile"]).present? ? "P#{representation_percentile_int(agent['standard_count_percentile'])}" : nil),
          subvalue_class_name: representation_percentile_color_class(agent["standard_count_percentile"]),
          class_name: "w-full"
        } %>

        <%= render partial: "salary_book/kpi_cell", locals: {
          label: "2W",
          value: two_way_count.to_s,
          subvalue: (representation_percentile_int(agent["two_way_count_percentile"]).present? ? "P#{representation_percentile_int(agent['two_way_count_percentile'])}" : nil),
          subvalue_class_name: representation_percentile_color_class(agent["two_way_count_percentile"]),
          variant: (two_way_count > 0 ? "default" : "muted"),
          class_name: "w-full"
        } %>
      </div>

      <div class="grid grid-cols-3 gap-1.5">
        <%= render partial: "salary_book/kpi_cell", locals: {
          label: format_year_label(2025),
          value: compact.call(agent["cap_2025_total"]),
          subvalue: (representation_percentile_int(agent["cap_2025_total_percentile"]).present? ? "P#{representation_percentile_int(agent['cap_2025_total_percentile'])}" : nil),
          subvalue_class_name: representation_percentile_color_class(agent["cap_2025_total_percentile"]),
          value_class_name: "text-[11px]",
          class_name: "w-full"
        } %>
        <%= render partial: "salary_book/kpi_cell", locals: {
          label: format_year_label(2026),
          value: compact.call(agent["cap_2026_total"]),
          subvalue: (representation_percentile_int(agent["cap_2026_total_percentile"]).present? ? "P#{representation_percentile_int(agent['cap_2026_total_percentile'])}" : nil),
          subvalue_class_name: representation_percentile_color_class(agent["cap_2026_total_percentile"]),
          value_class_name: "text-[11px]",
          class_name: "w-full"
        } %>
        <%= render partial: "salary_book/kpi_cell", locals: {
          label: format_year_label(2027),
          value: compact.call(agent["cap_2027_total"]),
          subvalue: (representation_percentile_int(agent["cap_2027_total_percentile"]).present? ? "P#{representation_percentile_int(agent['cap_2027_total_percentile'])}" : nil),
          subvalue_class_name: representation_percentile_color_class(agent["cap_2027_total_percentile"]),
          value_class_name: "text-[11px]",
          class_name: "w-full"
        } %>
      </div>
    </div>

    <%# ── Contract mix ── %>
    <div class="border-t border-border pt-4 space-y-2">
      <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Contract mix</div>

      <div class="space-y-0.5">
        <div class="flex items-center justify-between py-1.5">
          <span class="text-sm text-muted-foreground">Max-level</span>
          <span class="tabular-nums text-sm font-medium"><%= max_contract_count %></span>
        </div>

        <div class="flex items-center justify-between py-1.5">
          <span class="text-sm text-muted-foreground">Rookie-scale</span>
          <span class="tabular-nums text-sm font-medium"><%= rookie_scale_count %></span>
        </div>

        <div class="flex items-center justify-between py-1.5">
          <span class="text-sm text-muted-foreground">Minimum</span>
          <span class="tabular-nums text-sm font-medium"><%= min_contract_count %></span>
        </div>
      </div>
    </div>

    <%# ── Upcoming events + flags ── %>
    <% has_options = player_option_count > 0 || team_option_count > 0 %>
    <% has_restrictions = no_trade_count > 0 || trade_kicker_count > 0 || trade_restricted_count > 0 %>
    <% has_prior_year_now_fa = prior_year_nba_now_free_agent_count > 0 %>
    <% if total_expiring > 0 || has_options || has_restrictions || has_prior_year_now_fa %>
      <div class="border-t border-border pt-4 space-y-2">
        <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Upcoming</div>

        <div class="space-y-0.5">
          <% if expiring_2025 > 0 %>
            <div class="flex items-center justify-between py-1.5">
              <span class="text-sm text-muted-foreground">FA after <%= format_year_label(2025) %></span>
              <span class="tabular-nums text-sm font-medium text-orange-600 dark:text-orange-400"><%= expiring_2025 %></span>
            </div>
          <% end %>

          <% if has_prior_year_now_fa %>
            <div class="flex items-center justify-between py-1.5">
              <span class="text-sm text-muted-foreground">Last year NBA, now FA</span>
              <span class="tabular-nums text-sm font-medium"><%= prior_year_nba_now_free_agent_count %></span>
            </div>
          <% end %>

          <% if player_option_count > 0 %>
            <div class="flex items-center justify-between py-1.5">
              <span class="text-sm text-muted-foreground">Player option decisions</span>
              <span class="tabular-nums text-sm font-medium"><%= player_option_count %></span>
            </div>
          <% end %>

          <% if team_option_count > 0 %>
            <div class="flex items-center justify-between py-1.5">
              <span class="text-sm text-muted-foreground">Team option decisions</span>
              <span class="tabular-nums text-sm font-medium"><%= team_option_count %></span>
            </div>
          <% end %>
        </div>

        <% if has_restrictions %>
          <div class="pt-1 flex flex-wrap gap-1.5">
            <% if no_trade_count > 0 %>
              <span class="entity-chip entity-chip--danger"><%= no_trade_count %> No-Trade</span>
            <% end %>
            <% if trade_kicker_count > 0 %>
              <span class="entity-chip entity-chip--warning"><%= trade_kicker_count %> Trade Kicker</span>
            <% end %>
            <% if trade_restricted_count > 0 %>
              <span class="entity-chip entity-chip--danger"><%= trade_restricted_count %> Restricted</span>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>

    <%# ── Client roster ── %>
    <div class="border-t border-border pt-4 space-y-2">
      <div class="flex items-center justify-between">
        <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Clients</div>
        <div class="text-[10px] text-muted-foreground tabular-nums">
          <%= total_count %> player<%= total_count != 1 ? "s" : "" %>
        </div>
      </div>

      <% if clients.empty? %>
        <div class="p-4 rounded-lg bg-muted/30 text-sm text-muted-foreground italic text-center">No NBA clients found</div>
      <% else %>
        <div class="divide-y divide-border/50">
          <% clients.each do |c| %>
            <%
              player_id = c["player_id"]
              player_name = c["player_name"].to_s
              team_code = c["team_code"] || "—"
              team_id = c["team_id"]
              team_name_val = c["team_name"] || team_code
              logo_url = team_logo_url(team_id)

              yos = c["years_of_service"].present? ? "#{c['years_of_service'].to_i} YOS" : nil
              contract_marker = next_contract_marker.call(c)

              current_salary = c["cap_2025"].to_f
              total_value = [c["cap_2025"], c["cap_2026"], c["cap_2027"]].compact.sum(&:to_f)
            %>

            <a
              href="<%= player_href(player_id) %>"
              class="w-full text-left flex items-center justify-between gap-2 py-0.5 px-1.5 rounded-md hover:bg-muted/50 transition-colors
                     focus-visible:outline-none focus-visible:ring-0 focus-visible:border-foreground dark:focus-visible:border-foreground"
            >
              <%# Team avatar + headshot %>
              <div class="flex items-center gap-1.5 flex-shrink-0">
                <div
                  class="w-7 h-7 rounded-full border border-border bg-background overflow-hidden flex items-center justify-center"
                  title="<%= team_name_val %>"
                  aria-label="<%= team_name_val %>"
                >
                  <% if logo_url.present? %>
                    <img
                      src="<%= logo_url %>"
                      alt="<%= team_name_val %> logo"
                      class="w-full h-full object-contain p-0.5"
                      loading="lazy"
                      decoding="async"
                      onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                    />
                    <span class="hidden text-[9px] font-semibold text-muted-foreground"><%= team_code %></span>
                  <% else %>
                    <span class="text-[9px] font-semibold text-muted-foreground"><%= team_code %></span>
                  <% end %>
                </div>

                <div class="w-7 h-7 rounded border border-border bg-background overflow-hidden">
                  <img
                    src="<%= player_headshot_url(player_id) %>"
                    alt="<%= player_name %>"
                    class="w-full h-full object-cover object-top bg-muted"
                    loading="lazy"
                    decoding="async"
                    onerror="if (this.src !== '<%= fallback_headshot_data_uri %>') { this.src = '<%= fallback_headshot_data_uri %>'; }"
                  />
                </div>
              </div>

              <%# Player info %>
              <div class="flex-1 min-w-0">
                <div class="h-[26px] flex items-end gap-1 min-w-0">
                  <div class="font-medium text-[14px] truncate"><%= player_name %></div>
                </div>
                <div class="h-[18px] -mt-px flex items-start min-w-0 leading-none text-[10px] text-muted-foreground/80 tabular-nums overflow-hidden">
                  <% if yos.present? || contract_marker.present? %>
                    <div class="flex items-start min-w-0 overflow-hidden whitespace-nowrap">
                      <% if yos.present? %>
                        <span class="truncate"><%= yos %></span>
                      <% end %>

                      <% if contract_marker.present? %>
                        <% if yos.present? %>
                          <span class="px-1 text-muted-foreground/50">·</span>
                        <% end %>
                        <span class="shrink-0 font-medium <%= contract_marker[:classes] %>"><%= contract_marker[:label] %></span>
                      <% end %>
                    </div>
                  <% else %>
                    <span class="text-muted-foreground/50">—</span>
                  <% end %>
                </div>
              </div>

              <%# Salary info %>
              <div class="flex-shrink-0 text-right">
                <% if c["is_two_way"] %>
                  <div class="grid place-items-center h-[44px]">
                    <span class="inline-flex items-center justify-center text-[10px] px-1.5 py-0.5 rounded font-medium <%= neutral_badge_classes %>">Two-Way</span>
                  </div>
                <% elsif current_salary > 0 %>
                  <div class="h-[26px] flex items-end justify-end">
                    <div class="tabular-nums text-sm font-medium whitespace-nowrap"><%= compact.call(current_salary) %></div>
                  </div>
                  <div class="h-[18px] -mt-px flex items-start justify-end">
                    <div class="text-[10px] leading-none tabular-nums whitespace-nowrap text-muted-foreground"><%= compact.call(total_value) %> total</div>
                  </div>
                <% else %>
                  <div class="grid place-items-center h-[44px]">
                    <div class="text-[10px] leading-none tabular-nums text-muted-foreground/60 italic whitespace-nowrap">No salary</div>
                  </div>
                <% end %>
              </div>

              <%# Chevron %>
              <%= lucide_icon("chevron-right", class: "w-4 h-4 text-muted-foreground/50", "aria-hidden": true) %>
            </a>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>
