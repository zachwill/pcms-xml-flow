<%#
  Agent overlay (RightPanel entity) — Tailwind port of the React prototype (AgentDetail)

  NOTE: Root id must remain stable for Datastar morphing.
%>

<% salary_years = SalaryBookHelper::SALARY_YEARS %>
<% compact = ->(v) { format_salary(v) } %>

<% agent_id = agent["agent_id"] %>
<% agent_name = agent["name"] %>
<% agency_name = agent["agency_name"] %>

<%
  initials = agent_name
    .to_s
    .split(" ")
    .map { |n| n[0] }
    .join("")
    .upcase
    .slice(0, 2)

  client_count = clients.size
  total_book = clients.sum { |c| c["cap_2025"].to_f }

  client_row_name = ->(c) {
    last = c["display_last_name"].to_s.strip
    first = c["display_first_name"].to_s.strip

    return "#{last}, #{first}" if last.present? && first.present?
    return last if last.present?
    return first if first.present?

    c["player_name"].to_s
  }
%>

<div id="rightpanel-overlay" class="h-full">
  <%# Sticky header %>
  <div class="sticky top-0 z-20 h-10 px-4 flex items-center justify-between border-b border-border bg-background">
    <%= render partial: "tools/salary_book/sidebar_back_button" %>

    <a
      class="text-xs text-muted-foreground hover:text-foreground hover:underline"
      href="<%= agent_href(agent_id) %>"
    >Open agent page</a>
  </div>

  <div class="px-4 pb-4 pt-4 space-y-6">
    <%# Agent header %>
    <div class="flex flex-col items-center text-center space-y-3">
      <div
        class="w-16 h-16 rounded-xl bg-gradient-to-br from-violet-500/20 to-violet-600/30 flex items-center justify-center
               text-xl font-bold text-violet-600 dark:text-violet-400 ring-2 ring-violet-200 dark:ring-violet-800/50"
      >
        <%= initials %>
      </div>

      <div class="space-y-1">
        <h2 class="text-xl font-semibold text-foreground"><%= agent_name %></h2>
        <% if agency_name.present? %>
          <div class="text-sm text-muted-foreground"><%= agency_name %></div>
        <% end %>
        <div class="text-xs text-muted-foreground/80">
          <%= client_count %> NBA client<%= client_count != 1 ? "s" : "" %>
        </div>
      </div>
    </div>

    <%# Client roster %>
    <div class="space-y-3">
      <div class="flex items-center justify-between">
        <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Client Roster</div>
        <div class="text-xs text-muted-foreground">
          Book: <span class="tabular-nums font-medium"><%= compact.call(total_book) %></span>
        </div>
      </div>

      <% if clients.empty? %>
        <div class="p-4 rounded-lg bg-muted/30 text-sm text-muted-foreground italic text-center">No NBA clients found</div>
      <% else %>
        <div class="divide-y divide-border/50">
          <% clients.each do |client| %>
            <%
              player_id = client["player_id"]
              team_code = client["team_code"] || "—"
              team_id = client["team_id"]
              team_name = client["team_name"] || team_code

              row_name = client_row_name.call(client)

              detail_line = player_age_yos_display(client).presence || team_name

              current_salary = client["cap_2025"].to_f
              total_value = salary_years.sum { |y| client["cap_#{y}"].to_f }

              logo_url = team_logo_url(team_id)
            %>

            <button
              type="button"
              class="cursor-pointer w-full text-left flex items-center justify-between gap-2 py-0.5 px-1.5 rounded-md hover:bg-muted/50 transition-colors
                     focus-visible:outline-none focus-visible:ring-0 focus-visible:border-foreground dark:focus-visible:border-foreground"
              data-on:click="@get('<%= tools_salary_book_sidebar_player_path(id: player_id) %>')"
            >
              <%# Team avatar + headshot %>
              <div class="flex items-center gap-1.5 flex-shrink-0">
                <div
                  class="w-7 h-7 rounded-full border border-border bg-background overflow-hidden flex items-center justify-center"
                  title="<%= team_name %>"
                  aria-label="<%= team_name %>"
                >
                  <% if logo_url.present? %>
                    <img
                      src="<%= logo_url %>"
                      alt="<%= team_name %> logo"
                      class="w-full h-full object-contain p-0.5"
                      loading="lazy"
                      decoding="async"
                      onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                    />
                    <span class="hidden text-[9px] font-semibold text-muted-foreground"><%= team_code %></span>
                  <% else %>
                    <span class="text-[9px] font-semibold text-muted-foreground"><%= team_code %></span>
                  <% end %>
                </div>

                <div class="w-7 h-7 rounded border border-border bg-background overflow-hidden">
                  <img
                    src="<%= player_headshot_url(player_id) %>"
                    alt="<%= row_name %>"
                    class="w-full h-full object-cover object-top bg-muted"
                    loading="lazy"
                    decoding="async"
                    onerror="if (this.src !== '<%= fallback_headshot_data_uri %>') { this.src = '<%= fallback_headshot_data_uri %>'; }"
                  />
                </div>
              </div>

              <%# Player info %>
              <div class="flex-1 min-w-0">
                <div class="h-[26px] flex items-end min-w-0">
                  <div class="font-medium text-[14px] truncate"><%= row_name %></div>
                </div>
                <div class="h-[18px] -mt-px flex items-start min-w-0 leading-none text-[10px] text-muted-foreground/80 tabular-nums">
                  <span class="truncate"><%= detail_line %></span>
                </div>
              </div>

              <%# Salary info %>
              <div class="flex-shrink-0 text-right">
                <% if client["is_two_way"] %>
                  <div class="grid place-items-center h-[44px]">
                    <span class="inline-flex items-center justify-center text-[10px] px-1.5 py-0.5 rounded font-medium bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300">Two-Way</span>
                  </div>
                <% elsif current_salary > 0 %>
                  <div class="h-[26px] flex items-end justify-end">
                    <div class="tabular-nums text-sm font-medium whitespace-nowrap"><%= compact.call(current_salary) %></div>
                  </div>
                  <div class="h-[18px] -mt-px flex items-start justify-end">
                    <div class="text-[10px] leading-none tabular-nums whitespace-nowrap text-gray-400 dark:text-gray-500"><%= compact.call(total_value) %> total</div>
                  </div>
                <% else %>
                  <div class="grid place-items-center h-[44px]">
                    <div class="text-[10px] leading-none tabular-nums text-muted-foreground/60 italic whitespace-nowrap">No salary</div>
                  </div>
                <% end %>
              </div>

              <%# Chevron %>
              <svg class="w-4 h-4 text-muted-foreground/50" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
              </svg>
            </button>
          <% end %>
        </div>
      <% end %>
    </div>

    <%# Metadata %>
    <div class="pt-4 border-t border-border text-xs text-muted-foreground">
      agent_id: <code><%= agent_id %></code>
    </div>
  </div>
</div>
