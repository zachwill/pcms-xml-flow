<%#
  Pick overlay (RightPanel entity) â€” Salary Book sidebar

  NOTE: Root id must remain stable for Datastar morphing.
%>

<%
  presenter = SalaryBook::PickSidebarPresenter.new(
    team_code: team_code,
    year: year,
    round: round,
    salary_year: local_assigns.fetch(:salary_year, SalaryBookHelper::SALARY_YEARS.first),
    picks: picks,
    team_meta: team_meta,
    team_meta_by_code: local_assigns.fetch(:team_meta_by_code, {}),
    helpers: self
  )

  sidebar = presenter.state

  round_i = sidebar.fetch(:round_i)
  team_name = sidebar.fetch(:team_name)
  logo_url = sidebar.fetch(:logo_url)

  status_badge = sidebar.fetch(:status_badge)
  flow_label = sidebar.fetch(:flow_label)
  flow_value = sidebar.fetch(:flow_value)

  descriptions = sidebar.fetch(:descriptions)
  explanations = sidebar.fetch(:explanations)
  source_rows = sidebar.fetch(:source_rows)

  is_swap = sidebar.fetch(:is_swap)
  is_conditional = sidebar.fetch(:is_conditional)
%>

<div id="rightpanel-overlay" class="h-full">
  <%# Sticky header %>
  <div class="sticky top-0 z-20 h-10 px-4 flex items-center justify-between border-b border-border bg-background">
    <%= render partial: "salary_book/sidebar_back_button" %>

    <a
      class="text-xs text-muted-foreground hover:text-foreground hover:underline"
      href="<%= draft_pick_path(team_code: team_code, year: year, round: round) %>"
    >Open pick page</a>
  </div>

  <div class="px-4 pb-4 pt-4 space-y-5">
    <%# Header %>
    <div class="flex items-center gap-2.5">
      <div class="w-12 h-12 shrink-0 rounded-lg border border-border bg-muted/30 flex flex-col items-center justify-center text-center leading-none">
        <div class="text-[10px] uppercase tracking-wide text-muted-foreground">Round</div>
        <div class="mt-0.5 text-sm font-semibold tabular-nums">R<%= round_i %></div>
      </div>

      <div class="w-12 h-12 rounded-lg border border-border bg-muted/30 flex items-center justify-center overflow-hidden shrink-0">
        <% if logo_url.present? %>
          <img
            src="<%= logo_url %>"
            alt="<%= team_name %> logo"
            class="w-full h-full object-contain"
            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
          />
          <span class="hidden text-sm font-semibold text-muted-foreground"><%= team_code %></span>
        <% else %>
          <span class="text-sm font-semibold text-muted-foreground"><%= team_code %></span>
        <% end %>
      </div>

      <div class="min-w-0 flex-1 space-y-0.5">
        <h2 class="text-lg font-semibold text-foreground truncate"><%= year %> Round <%= round_i %></h2>
        <div class="text-sm text-muted-foreground truncate"><%= team_name %></div>
      </div>
    </div>

    <%# Snapshot KPIs %>
    <div class="border-t border-border pt-4 space-y-2.5">
      <div class="grid grid-cols-4 gap-1.5">
        <%= render partial: "salary_book/kpi_cell", locals: {
          label: "Year",
          value: year.to_s,
          class_name: "w-full"
        } %>

        <%= render partial: "salary_book/kpi_cell", locals: {
          label: "Round",
          value: "R#{round_i}",
          class_name: "w-full"
        } %>

        <%= render partial: "salary_book/kpi_cell", locals: {
          label: "Status",
          value: status_badge[:label].sub(" Pick", ""),
          class_name: "w-full",
          value_class_name: "text-[10px]"
        } %>

        <%= render partial: "salary_book/kpi_cell", locals: {
          label: flow_label,
          value: flow_value,
          class_name: "w-full",
          value_class_name: "text-[10px]"
        } %>
      </div>

      <div class="flex flex-wrap gap-1.5">
        <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-[9px] font-semibold uppercase tracking-wide leading-none <%= status_badge[:klass] %>">
          <%= status_badge[:label] %>
        </span>

        <% if is_swap %>
          <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-[9px] font-semibold uppercase tracking-wide leading-none bg-violet-100/70 text-violet-700 dark:bg-violet-900/30 dark:text-violet-300">
            Swap
          </span>
        <% end %>

        <% if is_conditional %>
          <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-[9px] font-semibold uppercase tracking-wide leading-none bg-amber-100/80 text-amber-700 dark:bg-amber-900/30 dark:text-amber-300">
            Conditional
          </span>
        <% end %>
      </div>
    </div>

    <%= render partial: "salary_book/sidebar_pick_ownership", locals: {
      presenter: presenter,
      sidebar: sidebar,
      team_code: team_code
    } %>

    <% if descriptions.any? %>
      <%= render partial: "salary_book/sidebar_pick_text_block", locals: {
        title: "Pick details",
        rows: descriptions,
        row_text_class: "text-foreground"
      } %>
    <% end %>

    <% if explanations.any? %>
      <%= render partial: "salary_book/sidebar_pick_text_block", locals: {
        title: "Protections",
        rows: explanations,
        row_text_class: "text-amber-700 dark:text-amber-300"
      } %>
    <% end %>

    <% if source_rows.size > 1 %>
      <%= render partial: "salary_book/sidebar_pick_source_rows", locals: {
        source_rows: source_rows
      } %>
    <% end %>
  </div>
</div>
