<%#
  Team sidebar (RightPanel base) — Tailwind port of the React prototype (TeamContext)

  NOTE: Root id must remain stable for Datastar morphing.
%>

<% team_meta ||= {} %>
<% summaries_by_year ||= {} %>
<% summary ||= summaries_by_year[year] || {} %>
<% stats_by_year ||= summaries_by_year %>

<% team_name = team_meta["team_name"] || "Team #{team_code}" %>
<% conference = team_meta["conference_name"] || "—" %>
<% team_id = team_meta["team_id"] %>
<% logo_url = team_logo_url(team_id) %>

<div
  id="rightpanel-base"
  class="space-y-4"
  data-signals="{ sidebartab: 'cap', _sidebarcappcthover: false }"
  data-effect="
    const activeyear = ($selectedseason !== '' ? $selectedseason : '<%= year %>');
    if ($sidebartab !== 'cap' && $_sidebarcappcthover) {
      $_sidebarcappcthover = false;
    }
    if ($sidebartab === 'draft' && (!$sidebardraftloaded || String($sidebardraftyearloaded) !== String(activeyear))) {
      $sidebardraftloaded = true;
      $sidebardraftyearloaded = activeyear;
      @get('<%= tools_salary_book_sidebar_team_draft_path(team: team_code) %>&year=' + activeyear);
    }
    if ($sidebartab === 'rights' && !$sidebarrightsloaded) {
      $sidebarrightsloaded = true;
      @get('<%= tools_salary_book_sidebar_team_rights_path(team: team_code) %>');
    }
  "
>
  <%# Header %>
  <div class="flex items-start gap-3">
    <div class="flex items-center gap-3 min-w-0">
      <div class="w-14 h-14 rounded-lg bg-background border border-border flex items-center justify-center overflow-hidden">
        <% if logo_url %>
          <img
            src="<%= logo_url %>"
            alt="<%= team_name %> logo"
            class="w-full h-full object-contain"
            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
          />
          <span class="hidden text-lg font-bold text-muted-foreground"><%= team_code %></span>
        <% else %>
          <span class="text-lg font-bold text-muted-foreground"><%= team_code %></span>
        <% end %>
      </div>

      <div class="min-w-0">
        <a
          href="<%= team_href(team_code: team_code, team_id: team_id) %>"
          target="_blank"
          rel="noopener noreferrer"
          class="font-semibold text-lg truncate block text-foreground hover:underline focus-visible:underline"
        ><%= team_name %></a>
        <div class="text-sm text-muted-foreground truncate"><%= conference %> Conference</div>
      </div>
    </div>
  </div>

  <%# Tab toggle (5 tabs; Draft + Rights are lazy-loaded) %>
  <div class="relative grid grid-cols-5 p-1 rounded-lg bg-muted border border-border">
    <%# Sliding indicator (equal-width tabs; no gap keeps math stable) %>
    <div
      class="absolute top-1 bottom-1 left-1 w-[calc((100%_-_8px)/5)] rounded-md bg-background shadow-sm pointer-events-none transition-[transform,width,opacity] duration-150 ease-out"
      data-class="{
        'translate-x-0': $sidebartab === 'cap',
        'translate-x-full': $sidebartab === 'draft',
        'translate-x-[200%]': $sidebartab === 'rights',
        'translate-x-[300%]': $sidebartab === 'injuries',
        'translate-x-[400%]': $sidebartab === 'stats'
      }"
      aria-hidden="true"
    ></div>

    <% tabs = [
      ["cap", "Cap"],
      ["draft", "Draft"],
      ["rights", "Rights"],
      ["injuries", "Injuries"],
      ["stats", "Stats"]
    ] %>

    <% tabs.each do |(id, label)| %>
      <button
        type="button"
        class="cursor-pointer relative z-10 min-w-0 px-3 py-1.5 text-sm font-medium text-center rounded-md transition-colors duration-150
               focus-visible:outline-none focus-visible:ring-0 focus-visible:border-foreground dark:focus-visible:border-foreground"
        data-on:click="$sidebartab = '<%= id %>'"
        data-class="{ 'text-foreground': $sidebartab === '<%= id %>', 'text-muted-foreground hover:text-foreground': $sidebartab !== '<%= id %>' }"
      ><%= label %></button>
    <% end %>
  </div>

  <%= render partial: "tools/salary_book/sidebar_team_tab_cap", locals: {
    summary:,
    summaries_by_year:,
    year:
  } %>

  <%= render partial: "tools/salary_book/sidebar_team_tab_draft", locals: {
    team_code:,
    year:,
    draft_start_year: year + 1,
    draft_assets: [],
    draft_loaded: false
  } %>

  <%= render partial: "tools/salary_book/sidebar_team_tab_rights", locals: {
    rights_by_kind: {},
    rights_loaded: false
  } %>

  <div data-show="$sidebartab === 'injuries'" class="border-t border-border pt-4">
    <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground mb-2">Injuries</div>
    <div class="p-3 rounded-lg bg-muted/30 border border-border/50 text-sm text-muted-foreground italic">
      Data unavailable (no confirmed <code>pcms.*</code> injury source table yet).
    </div>
  </div>

  <%= render partial: "tools/salary_book/sidebar_team_tab_stats", locals: {
    stats_by_year:,
    year:
  } %>
</div>
