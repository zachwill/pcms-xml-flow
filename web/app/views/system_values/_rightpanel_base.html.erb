<% overlay_query_expr ||= "''" %>

<div id="rightpanel-base" class="space-y-4">
  <div class="rounded-lg border border-border bg-muted/20 p-3 space-y-2">
    <div>
      <div class="text-[10px] uppercase tracking-wide font-semibold text-muted-foreground/80">Baseline analysis workspace</div>
      <div class="text-xs text-muted-foreground">Click metric cells in System / Tax / Rookie and row bands in Minimum to open selected-vs-baseline context without leaving the board.</div>
    </div>

    <div class="flex flex-wrap gap-1.5 text-[10px]">
      <span class="entity-chip entity-chip--muted">Season <%= format_year_label(@selected_year) %></span>
      <span class="entity-chip entity-chip--muted">Baseline <%= format_year_label(@baseline_year) %></span>
      <span class="entity-chip entity-chip--muted">Range <%= @from_year %>–<%= @to_year %></span>
      <span class="entity-chip entity-chip--muted"><%= @league_system_values.size %> system rows</span>
    </div>
  </div>

  <div class="rounded-lg border border-border bg-background p-3 space-y-2">
    <div class="text-[10px] uppercase tracking-wide font-semibold text-muted-foreground/80">Selection state</div>
    <% if @metric_finder_query.present? %>
      <div class="rounded border border-border/70 bg-muted/20 px-2 py-1.5 text-xs">
        <div class="font-medium text-foreground">Deep-link query: <span class="font-mono tabular-nums"><%= @metric_finder_query %></span></div>
        <div class="mt-0.5 text-muted-foreground"><%= Array(@metric_finder_shortlist).size %> shortlist rows resolved for this state.</div>
      </div>
    <% else %>
      <div class="text-xs text-muted-foreground">Use table cells and quick drill-ins to open selected-vs-baseline context in the overlay.</div>
    <% end %>

    <% if @active_metric_finder_option.present? %>
      <div class="rounded border border-amber-500/50 bg-amber-100/60 dark:bg-amber-900/20 px-2 py-1.5 text-xs">
        <div class="font-medium text-foreground">Overlay target active</div>
        <div class="mt-0.5 text-muted-foreground"><%= @active_metric_finder_option[:label] %></div>
      </div>
    <% end %>
  </div>

  <div class="rounded-lg border border-border bg-background p-3 space-y-2">
    <div class="text-[10px] uppercase tracking-wide font-semibold text-muted-foreground/80">Quick drill-ins</div>

    <% if @quick_metric_cards.empty? %>
      <div class="text-xs text-muted-foreground italic">No metrics available for the selected years.</div>
    <% else %>
      <div class="space-y-1.5">
        <% @quick_metric_cards.each do |card| %>
          <% delta_class = case card[:delta_variant]
          when "positive"
            "text-emerald-600 dark:text-emerald-400"
          when "negative"
            "text-red-500"
          when "neutral"
            "text-foreground"
          else
            "text-muted-foreground"
          end %>

          <button
            type="button"
            class="cursor-pointer w-full rounded border border-border/70 px-2 py-1.5 text-left hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 transition-colors"
            data-on:click="$svmetricfinder=''; $svoverlaysection='<%= card[:section] %>'; $svoverlaymetric='<%= card[:metric] %>'; $svoverlayyear='<%= card[:year] %>'; $svoverlaylower='<%= card[:lower] %>'; $svoverlayupper='<%= card[:upper] %>'; @get('<%= system_values_sidebar_metric_path %>?' + (<%= overlay_query_expr %>));"
          >
            <div class="flex items-center justify-between gap-2">
              <span class="text-xs font-medium truncate"><%= card[:label] %></span>
              <span class="text-[10px] font-mono tabular-nums"><%= card[:value_label] %></span>
            </div>
            <div class="mt-0.5 text-[10px] font-mono tabular-nums <%= delta_class %>">
              Δ <%= card[:delta_label] %> vs <%= format_year_label(@baseline_year) %>
            </div>
          </button>
        <% end %>
      </div>
    <% end %>
  </div>

  <div class="rounded-lg border border-border bg-background p-3 space-y-2">
    <div class="text-[10px] uppercase tracking-wide font-semibold text-muted-foreground/80">Pivots</div>
    <div class="space-y-1 text-xs">
      <a href="<%= team_summary_path(year: @selected_year, conference: "all", pressure: "all", sort: "cap_space_desc") %>" class="inline-flex items-center gap-1 text-muted-foreground hover:text-foreground hover:underline">
        Open Team Summary (<%= format_year_label(@selected_year) %>)
      </a>
      <a href="<%= system_values_path(@state_params) %>" class="inline-flex items-center gap-1 text-muted-foreground hover:text-foreground hover:underline">
        Open canonical System Values URL
      </a>
    </div>
  </div>
</div>
