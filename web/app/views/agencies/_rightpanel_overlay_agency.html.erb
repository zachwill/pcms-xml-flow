<%
  agency ||= {}
  top_agents ||= []
  top_clients ||= []

  compact = ->(v) { format_salary(v) }

  agency_name = agency["agency_name"].to_s
  initials = agent_initials(agency_name)

  agent_count = agency["agent_count"].to_i
  client_count = agency["client_count"].to_i
  standard_count = agency["standard_count"].to_i
  two_way_count = agency["two_way_count"].to_i
  team_count = agency["team_count"].to_i

  max_contract_count = agency["max_contract_count"].to_i
  rookie_scale_count = agency["rookie_scale_count"].to_i
  min_contract_count = agency["min_contract_count"].to_i

  no_trade_count = agency["no_trade_count"].to_i
  trade_kicker_count = agency["trade_kicker_count"].to_i
  trade_restricted_count = agency["trade_restricted_count"].to_i

  expiring_2025 = agency["expiring_2025"].to_i
  total_expiring = expiring_2025

  player_option_count = agency["player_option_count"].to_i
  team_option_count = agency["team_option_count"].to_i
  prior_year_nba_now_free_agent_count = agency["prior_year_nba_now_free_agent_count"].to_i

%>

<% prefetch_canonical_slugs(entity_type: "agency", entity_ids: [agency["agency_id"]]) %>
<% prefetch_canonical_slugs(entity_type: "team", entity_ids: top_clients.map { |c| c["team_id"] }) %>

<div id="rightpanel-overlay" class="h-full bg-background overflow-y-auto overflow-x-hidden overscroll-y-contain scroll-touch">
  <div class="sticky top-0 z-20 h-10 px-4 flex items-center justify-start border-b border-border bg-background">
    <button
      type="button"
      class="cursor-pointer flex items-center gap-1.5 text-sm transition-colors text-muted-foreground hover:text-foreground
             focus-visible:outline-none focus-visible:ring-0 focus-visible:border-foreground dark:focus-visible:border-foreground"
      data-on:click="$overlaytype = 'none'; $overlayid = ''; @get('/agencies/sidebar/clear')"
    >
      <%= lucide_icon("arrow-left", class: "w-4 h-4", "aria-hidden": true) %>
      <span class="font-medium">Back</span>
    </button>
  </div>

  <div class="px-4 pb-4 pt-4 space-y-5">
    <div class="flex items-center gap-3">
      <div
        class="w-12 h-12 rounded-lg bg-gradient-to-br from-violet-500/20 to-violet-600/30 flex items-center justify-center
               text-base font-bold text-violet-600 dark:text-violet-400 ring-1 ring-violet-200 dark:ring-violet-800/50 shrink-0"
      >
        <%= initials %>
      </div>

      <div class="min-w-0 space-y-0.5">
        <h2 class="text-lg font-semibold text-foreground truncate"><%= agency_name.presence || "Agency" %></h2>
        <div class="text-xs text-muted-foreground/80 tabular-nums flex items-center gap-1 min-w-0 overflow-hidden whitespace-nowrap">
          <span class="truncate"><%= pluralize(agent_count, "agent") %></span>
          <span class="text-muted-foreground/50">·</span>
          <span class="truncate"><%= pluralize(client_count, "client") %></span>
          <% if agency["is_active"] == false %>
            <span class="text-muted-foreground/50">·</span>
            <span class="text-muted-foreground/60">inactive</span>
          <% end %>
        </div>
      </div>
    </div>

    <div class="border-t border-border pt-4 space-y-2.5">
      <div class="grid grid-cols-4 gap-1.5">
        <%= render partial: "salary_book/kpi_cell", locals: {
          label: "Agents",
          value: agent_count.to_s,
          subvalue: (representation_percentile_int(agency["agent_count_percentile"]).present? ? "P#{representation_percentile_int(agency['agent_count_percentile'])}" : nil),
          subvalue_class_name: representation_percentile_color_class(agency["agent_count_percentile"]),
          class_name: "w-full"
        } %>

        <%= render partial: "salary_book/kpi_cell", locals: {
          label: "Clients",
          value: client_count.to_s,
          subvalue: (representation_percentile_int(agency["client_count_percentile"]).present? ? "P#{representation_percentile_int(agency['client_count_percentile'])}" : nil),
          subvalue_class_name: representation_percentile_color_class(agency["client_count_percentile"]),
          class_name: "w-full"
        } %>

        <%= render partial: "salary_book/kpi_cell", locals: {
          label: "Teams",
          value: team_count.to_s,
          class_name: "w-full"
        } %>

        <%= render partial: "salary_book/kpi_cell", locals: {
          label: "2W",
          value: two_way_count.to_s,
          variant: (two_way_count > 0 ? "default" : "muted"),
          class_name: "w-full"
        } %>
      </div>

      <div class="grid grid-cols-3 gap-1.5">
        <%= render partial: "salary_book/kpi_cell", locals: {
          label: format_year_label(2025),
          value: compact.call(agency["cap_2025_total"]),
          subvalue: (representation_percentile_int(agency["cap_2025_total_percentile"]).present? ? "P#{representation_percentile_int(agency['cap_2025_total_percentile'])}" : nil),
          subvalue_class_name: representation_percentile_color_class(agency["cap_2025_total_percentile"]),
          value_class_name: "text-[11px]",
          class_name: "w-full"
        } %>

        <%= render partial: "salary_book/kpi_cell", locals: {
          label: format_year_label(2026),
          value: compact.call(agency["cap_2026_total"]),
          subvalue: (representation_percentile_int(agency["cap_2026_total_percentile"]).present? ? "P#{representation_percentile_int(agency['cap_2026_total_percentile'])}" : nil),
          subvalue_class_name: representation_percentile_color_class(agency["cap_2026_total_percentile"]),
          value_class_name: "text-[11px]",
          class_name: "w-full"
        } %>

        <%= render partial: "salary_book/kpi_cell", locals: {
          label: format_year_label(2027),
          value: compact.call(agency["cap_2027_total"]),
          subvalue: (representation_percentile_int(agency["cap_2027_total_percentile"]).present? ? "P#{representation_percentile_int(agency['cap_2027_total_percentile'])}" : nil),
          subvalue_class_name: representation_percentile_color_class(agency["cap_2027_total_percentile"]),
          value_class_name: "text-[11px]",
          class_name: "w-full"
        } %>
      </div>
    </div>

    <div class="border-t border-border pt-4 space-y-2">
      <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Composition</div>

      <div class="space-y-0.5">
        <div class="flex items-center justify-between py-1.5">
          <span class="text-sm text-muted-foreground">Standard</span>
          <span class="tabular-nums text-sm font-medium"><%= standard_count %></span>
        </div>

        <div class="flex items-center justify-between py-1.5">
          <span class="text-sm text-muted-foreground">Two-way</span>
          <span class="tabular-nums text-sm font-medium"><%= two_way_count %></span>
        </div>

        <div class="flex items-center justify-between py-1.5">
          <span class="text-sm text-muted-foreground">Max-level</span>
          <span class="tabular-nums text-sm font-medium"><%= max_contract_count %></span>
        </div>

        <div class="flex items-center justify-between py-1.5">
          <span class="text-sm text-muted-foreground">Rookie-scale</span>
          <span class="tabular-nums text-sm font-medium"><%= rookie_scale_count %></span>
        </div>

        <div class="flex items-center justify-between py-1.5">
          <span class="text-sm text-muted-foreground">Minimum</span>
          <span class="tabular-nums text-sm font-medium"><%= min_contract_count %></span>
        </div>
      </div>
    </div>

    <% has_options = player_option_count > 0 || team_option_count > 0 %>
    <% has_restrictions = no_trade_count > 0 || trade_kicker_count > 0 || trade_restricted_count > 0 %>
    <% has_prior_year_now_fa = prior_year_nba_now_free_agent_count > 0 %>
    <% if total_expiring > 0 || has_options || has_restrictions || has_prior_year_now_fa %>
      <div class="border-t border-border pt-4 space-y-2">
        <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Upcoming</div>

        <div class="space-y-0.5">
          <% if expiring_2025 > 0 %>
            <div class="flex items-center justify-between py-1.5">
              <span class="text-sm text-muted-foreground">FA after <%= format_year_label(2025) %></span>
              <span class="tabular-nums text-sm font-medium text-orange-600 dark:text-orange-400"><%= expiring_2025 %></span>
            </div>
          <% end %>

          <% if has_prior_year_now_fa %>
            <div class="flex items-center justify-between py-1.5">
              <span class="text-sm text-muted-foreground">Last year NBA, now FA</span>
              <span class="tabular-nums text-sm font-medium"><%= prior_year_nba_now_free_agent_count %></span>
            </div>
          <% end %>

          <% if player_option_count > 0 %>
            <div class="flex items-center justify-between py-1.5">
              <span class="text-sm text-muted-foreground">Player option decisions</span>
              <span class="tabular-nums text-sm font-medium"><%= player_option_count %></span>
            </div>
          <% end %>

          <% if team_option_count > 0 %>
            <div class="flex items-center justify-between py-1.5">
              <span class="text-sm text-muted-foreground">Team option decisions</span>
              <span class="tabular-nums text-sm font-medium"><%= team_option_count %></span>
            </div>
          <% end %>
        </div>

        <% if has_restrictions %>
          <div class="pt-1 flex flex-wrap gap-1.5">
            <% if no_trade_count > 0 %>
              <span class="entity-chip entity-chip--danger"><%= no_trade_count %> No-Trade</span>
            <% end %>
            <% if trade_kicker_count > 0 %>
              <span class="entity-chip entity-chip--warning"><%= trade_kicker_count %> Trade Kicker</span>
            <% end %>
            <% if trade_restricted_count > 0 %>
              <span class="entity-chip entity-chip--danger"><%= trade_restricted_count %> Restricted</span>
            <% end %>
          </div>
        <% end %>
      </div>
    <% end %>

    <div class="border-t border-border pt-4 space-y-2">
      <div class="flex items-center justify-between">
        <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Top agents</div>
        <div class="text-[10px] text-muted-foreground tabular-nums">
          <%= agent_count %> agent<%= agent_count != 1 ? "s" : "" %>
        </div>
      </div>

      <% if top_agents.empty? %>
        <div class="p-4 rounded-lg bg-muted/30 text-sm text-muted-foreground italic text-center">No agents found</div>
      <% else %>
        <div class="divide-y divide-border/50">
          <% top_agents.each do |agent_row| %>
            <%
              agent_id = agent_row["agent_id"]
              agent_name = agent_row["full_name"].to_s
              agent_avatar_initials = agent_initials(agent_name)
            %>

            <div class="w-full text-left flex items-center justify-between gap-2 py-0.5 px-1.5 rounded-md">
              <div class="flex items-center gap-1.5 flex-shrink-0">
                <div
                  class="w-7 h-7 rounded border border-border bg-background overflow-hidden flex items-center justify-center"
                  title="<%= agent_name %>"
                  aria-label="<%= agent_name %>"
                >
                  <span class="text-[9px] font-semibold text-muted-foreground"><%= agent_avatar_initials %></span>
                </div>
              </div>

              <div class="flex-1 min-w-0">
                <div class="h-[26px] flex items-end gap-1 min-w-0">
                  <div class="font-medium text-[14px] truncate"><%= agent_name %></div>
                </div>
                <div class="h-[18px] -mt-px flex items-start min-w-0 leading-none text-[10px] text-muted-foreground/80 tabular-nums overflow-hidden">
                  <span><%= agent_row["client_count"].to_i %> clients · <%= agent_row["team_count"].to_i %> teams</span>
                </div>
              </div>

              <div class="flex-shrink-0 text-right">
                <div class="h-[26px] flex items-end justify-end">
                  <div class="tabular-nums text-sm font-medium whitespace-nowrap"><%= compact.call(agent_row["cap_2025_total"]) %></div>
                </div>
                <div class="h-[18px] -mt-px flex items-start justify-end">
                  <% if representation_percentile_int(agent_row["cap_2025_total_percentile"]).present? %>
                    <span class="text-[10px] leading-none tabular-nums font-medium <%= representation_percentile_color_class(agent_row['cap_2025_total_percentile']) %>">P<%= representation_percentile_int(agent_row["cap_2025_total_percentile"]) %></span>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

    <div class="border-t border-border pt-4 space-y-2">
      <div class="flex items-center justify-between">
        <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Top clients</div>
        <div class="text-[10px] text-muted-foreground tabular-nums">
          <%= client_count %> player<%= client_count != 1 ? "s" : "" %>
        </div>
      </div>

      <% if top_clients.empty? %>
        <div class="p-4 rounded-lg bg-muted/30 text-sm text-muted-foreground italic text-center">No clients found</div>
      <% else %>
        <div class="divide-y divide-border/50">
          <% top_clients.each do |client| %>
            <%
              player_id = client["player_id"]
              player_name = client["player_name"].to_s
              team_code = client["team_code"] || "—"
              team_id = client["team_id"]
              team_name_val = client["team_name"] || team_code
              logo_url = team_logo_url(team_id)

              current_salary = client["cap_2025"].to_f
              total_value = client["total_salary_from_2025"].to_f
            %>

            <div class="w-full text-left flex items-center justify-between gap-2 py-0.5 px-1.5 rounded-md">
              <div class="flex items-center gap-1.5 flex-shrink-0">
                <div
                  class="w-7 h-7 rounded-full border border-border bg-background overflow-hidden flex items-center justify-center"
                  title="<%= team_name_val %>"
                  aria-label="<%= team_name_val %>"
                >
                  <% if logo_url.present? %>
                    <img
                      src="<%= logo_url %>"
                      alt="<%= team_name_val %> logo"
                      class="w-full h-full object-contain p-0.5"
                      loading="lazy"
                      decoding="async"
                      onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                    />
                    <span class="hidden text-[9px] font-semibold text-muted-foreground"><%= team_code %></span>
                  <% else %>
                    <span class="text-[9px] font-semibold text-muted-foreground"><%= team_code %></span>
                  <% end %>
                </div>

                <div class="w-7 h-7 rounded border border-border bg-background overflow-hidden">
                  <img
                    src="<%= player_headshot_url(player_id) %>"
                    alt="<%= player_name %>"
                    class="w-full h-full object-cover object-top bg-muted"
                    loading="lazy"
                    decoding="async"
                    onerror="if (this.src !== '<%= fallback_headshot_data_uri %>') { this.src = '<%= fallback_headshot_data_uri %>'; }"
                  />
                </div>
              </div>

              <div class="flex-1 min-w-0">
                <div class="h-[26px] flex items-end gap-1 min-w-0">
                  <div class="font-medium text-[14px] truncate"><%= player_name %></div>
                </div>
                <div class="h-[18px] -mt-px flex items-start min-w-0 leading-none text-[10px] text-muted-foreground/80 tabular-nums overflow-hidden">
                  <% if client["agent_name"].present? %>
                    <span class="truncate"><%= client["agent_name"] %></span>
                  <% elsif team_code != "—" %>
                    <span class="truncate"><%= team_code %></span>
                  <% else %>
                    <span class="text-muted-foreground/50">—</span>
                  <% end %>
                </div>
              </div>

              <div class="flex-shrink-0 text-right">
                <% if client["is_two_way"] %>
                  <div class="grid place-items-center h-[44px]">
                    <span class="inline-flex items-center justify-center text-[10px] px-1.5 py-0.5 rounded font-medium <%= neutral_badge_classes %>">Two-Way</span>
                  </div>
                <% elsif current_salary > 0 %>
                  <div class="h-[26px] flex items-end justify-end">
                    <div class="tabular-nums text-sm font-medium whitespace-nowrap"><%= compact.call(current_salary) %></div>
                  </div>
                  <div class="h-[18px] -mt-px flex items-start justify-end">
                    <% if total_value > 0 %>
                      <div class="text-[10px] leading-none tabular-nums whitespace-nowrap text-muted-foreground"><%= compact.call(total_value) %> total</div>
                    <% end %>
                  </div>
                <% else %>
                  <div class="grid place-items-center h-[44px]">
                    <div class="text-[10px] leading-none tabular-nums text-muted-foreground/60 italic whitespace-nowrap">No salary</div>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>
