<%
  txn = transaction || {}
  ledger = ledger_summary || {}
  artifacts = artifact_summary || {}

  transaction_id = txn["transaction_id"]
  transaction_href_value = transaction_href(transaction_id)
  trade_id = txn["trade_id"]

  route_labels = [txn["from_team_code"], txn["to_team_code"]].compact.reject(&:blank?)
  route_display = route_labels.any? ? route_labels.join(" → ") : "No team route"

  cap_change_total = ledger["cap_change_total"]
  tax_change_total = ledger["tax_change_total"]
  apron_change_total = ledger["apron_change_total"]

  type_variant = case txn["transaction_type_lk"].to_s
  when "SIGN", "RSIGN" then "entity-chip--success"
  when "WAIVE", "WAIVR" then "entity-chip--danger"
  when "EXTSN" then "entity-chip--accent"
  else "entity-chip--muted"
  end
%>

<div id="rightpanel-overlay" class="h-full">
  <div class="sticky top-0 z-20 h-10 px-4 flex items-center justify-between border-b border-border bg-background">
    <button
      type="button"
      class="cursor-pointer flex items-center gap-1.5 text-sm transition-colors text-muted-foreground hover:text-foreground"
      data-on:click="$overlaytype = 'none'; $overlayid = ''; @get('/transactions/sidebar/clear')"
    >
      <%= lucide_icon("arrow-left", class: "w-4 h-4", "aria-hidden": true) %>
      <span class="font-medium">Back</span>
    </button>

    <a href="<%= transaction_href_value %>" class="text-xs text-muted-foreground hover:text-foreground hover:underline">Open transaction page</a>
  </div>

  <div class="px-4 pb-4 pt-4 space-y-5">
    <div class="space-y-1">
      <h2 class="text-lg font-semibold text-foreground truncate">Transaction #<%= transaction_id %></h2>
      <div class="text-xs text-muted-foreground/80 tabular-nums">
        <span><%= txn["transaction_date"].presence || "—" %></span>
        <span class="text-muted-foreground/50 px-1">·</span>
        <span class="entity-chip <%= type_variant %>"><%= txn["transaction_type_lk"].presence || "—" %></span>
      </div>
    </div>

    <div class="grid grid-cols-2 gap-1.5 border-t border-border pt-4">
      <%= render partial: "tools/salary_book/kpi_cell", locals: { label: "Ledger rows", value: ledger["ledger_row_count"].to_i.to_s, class_name: "w-full" } %>
      <%= render partial: "tools/salary_book/kpi_cell", locals: { label: "Cap Δ", value: format_salary(cap_change_total), class_name: "w-full", value_class_name: "text-[11px]" } %>
      <%= render partial: "tools/salary_book/kpi_cell", locals: { label: "Tax Δ", value: format_salary(tax_change_total), class_name: "w-full", value_class_name: "text-[11px]" } %>
      <%= render partial: "tools/salary_book/kpi_cell", locals: { label: "Apron Δ", value: format_salary(apron_change_total), class_name: "w-full", value_class_name: "text-[11px]" } %>
    </div>

    <div class="border-t border-border pt-4 space-y-2">
      <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Key facts</div>

      <div class="space-y-0.5">
        <div class="flex items-center justify-between py-1.5 gap-3">
          <span class="text-sm text-muted-foreground">Player</span>
          <% if txn["player_id"].present? %>
            <a href="<%= player_href(txn['player_id']) %>" class="text-sm font-medium hover:underline text-right"><%= txn["player_name"].presence || txn["player_id"] %></a>
          <% else %>
            <span class="text-sm text-muted-foreground">—</span>
          <% end %>
        </div>

        <div class="flex items-center justify-between py-1.5 gap-3">
          <span class="text-sm text-muted-foreground">Route</span>
          <span class="text-sm font-medium tabular-nums"><%= route_display %></span>
        </div>

        <div class="flex items-center justify-between py-1.5 gap-3">
          <span class="text-sm text-muted-foreground">Method</span>
          <span class="text-sm font-medium tabular-nums"><%= txn["signed_method_lk"].presence || "—" %></span>
        </div>

        <div class="flex items-center justify-between py-1.5 gap-3">
          <span class="text-sm text-muted-foreground">Contract type</span>
          <span class="text-sm font-medium tabular-nums"><%= txn["contract_type_lk"].presence || "—" %></span>
        </div>

        <div class="flex items-center justify-between py-1.5 gap-3">
          <span class="text-sm text-muted-foreground">Description</span>
          <span class="text-sm font-medium text-right"><%= txn["transaction_description_lk"].presence || "—" %></span>
        </div>
      </div>

      <div class="pt-1 flex flex-wrap gap-1.5">
        <% if artifacts["exception_usage_count"].to_i.positive? %>
          <span class="entity-chip entity-chip--warning"><%= artifacts["exception_usage_count"].to_i %> exception usage rows</span>
        <% end %>
        <% if artifacts["dead_money_count"].to_i.positive? %>
          <span class="entity-chip entity-chip--danger"><%= artifacts["dead_money_count"].to_i %> dead money rows</span>
        <% end %>
        <% if artifacts["budget_snapshot_count"].to_i.positive? %>
          <span class="entity-chip entity-chip--muted"><%= artifacts["budget_snapshot_count"].to_i %> budget snapshots</span>
        <% end %>
      </div>
    </div>

    <div class="border-t border-border pt-4 space-y-2">
      <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Pivots</div>
      <div class="flex flex-col gap-1.5 text-sm">
        <a href="<%= transaction_href_value %>" class="text-muted-foreground hover:text-foreground hover:underline">Open canonical transaction page</a>

        <% if txn["player_id"].present? %>
          <a href="<%= player_href(txn['player_id']) %>" class="text-muted-foreground hover:text-foreground hover:underline">Open player page</a>
        <% end %>

        <% if txn["from_team_code"].present? %>
          <a href="<%= team_href(team_code: txn['from_team_code']) %>" class="text-muted-foreground hover:text-foreground hover:underline">Open from-team page (<%= txn["from_team_code"] %>)</a>
        <% end %>

        <% if txn["to_team_code"].present? %>
          <a href="<%= team_href(team_code: txn['to_team_code']) %>" class="text-muted-foreground hover:text-foreground hover:underline">Open to-team page (<%= txn["to_team_code"] %>)</a>
        <% end %>

        <% if trade_id.present? %>
          <a href="<%= trade_href(trade_id) %>" class="text-muted-foreground hover:text-foreground hover:underline">Open trade #<%= trade_id %></a>
          <% if trade_summary.present? %>
            <div class="text-[11px] text-muted-foreground tabular-nums">
              Trade context · <%= trade_summary["team_count"].to_i %> teams · <%= trade_summary["player_line_item_count"].to_i %> players · <%= trade_summary["pick_line_item_count"].to_i %> picks
            </div>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
</div>
