<%
  row = @selected_row
  team_code = row["team_code"].to_s.upcase
  logo_url = team_logo_url(row["team_id"])
  conference_name = row["conference_name"].presence || "—"

  cap_space = row["cap_space"].to_f
  tax_overage = row["tax_overage"].to_f
  room_tax = row["room_under_tax"]&.to_f
  room_a1 = row["room_under_apron1"]&.to_f
  room_a2 = row["room_under_apron2"]&.to_f
  luxury_tax_owed = row["luxury_tax_owed"].to_f

  has_compare = @compare_a_code.present? || @compare_b_code.present?

  ordered_team_codes = @rows.map { |candidate| candidate["team_code"].to_s.upcase }.select { |code| code.match?(/\A[A-Z]{3}\z/) }
  selected_index = ordered_team_codes.index(team_code)
  can_step_prev = selected_index.present? && selected_index.positive?
  can_step_next = selected_index.present? && selected_index < (ordered_team_codes.length - 1)
  selected_position_label = if selected_index.present?
    "#{selected_index + 1} / #{ordered_team_codes.length}"
  else
    "—"
  end

  step_params = @state_params.merge(selected: team_code)
  prev_step_path = team_summary_sse_step_path(step_params.merge(direction: "prev"))
  next_step_path = team_summary_sse_step_path(step_params.merge(direction: "next"))

  slot_configs = [
    { key: "a", label: "Slot A", current: @compare_a_code, active_class: "border-indigo-500/60 bg-indigo-500/10 text-indigo-700 dark:text-indigo-300" },
    { key: "b", label: "Slot B", current: @compare_b_code, active_class: "border-emerald-500/60 bg-emerald-500/10 text-emerald-700 dark:text-emerald-300" }
  ]

  snapshot_rows = [
    {
      label: "Cap Space",
      value: format_room_amount(cap_space),
      value_class: cap_space >= 0 ? "text-emerald-600 dark:text-emerald-400" : "text-red-600 dark:text-red-400"
    },
    {
      label: "Tax Overage",
      value: tax_overage > 0 ? format_compact_currency(tax_overage) : "—",
      value_class: tax_overage > 0 ? "text-red-600 dark:text-red-400" : "text-muted-foreground"
    },
    {
      label: "Room Under Tax",
      value: room_tax.nil? ? "—" : format_room_amount(room_tax),
      value_class: room_tax && room_tax < 0 ? "text-red-600 dark:text-red-400" : ""
    },
    {
      label: "Room Under Apron 1",
      value: room_a1.nil? ? "—" : format_room_amount(room_a1),
      value_class: room_a1 && room_a1 < 0 ? "text-red-600 dark:text-red-400" : ""
    },
    {
      label: "Room Under Apron 2",
      value: room_a2.nil? ? "—" : format_room_amount(room_a2),
      value_class: room_a2 && room_a2 < 0 ? "text-red-600 dark:text-red-400" : ""
    },
    {
      label: "Luxury Tax",
      value: luxury_tax_owed > 0 ? format_compact_currency(luxury_tax_owed) : "—",
      value_class: luxury_tax_owed > 0 ? "text-red-600 dark:text-red-400" : ""
    },
    {
      label: "Roster / 2W",
      value: "#{row['roster_row_count']} / #{row['two_way_row_count']}",
      value_class: ""
    }
  ]
%>

<div id="rightpanel-overlay" class="h-full bg-background">
  <div class="sticky top-0 z-20 h-10 px-4 flex items-center justify-between border-b border-border bg-background">
    <button
      type="button"
      class="cursor-pointer text-xs text-muted-foreground hover:text-foreground hover:underline"
      data-team-summary-overlay-clear
      data-on:click="$selectedteam = ''; @get('<%= team_summary_sidebar_clear_path %>')"
    >Close</button>

    <a
      class="text-xs text-muted-foreground hover:text-foreground hover:underline"
      href="<%= team_href(team_code: team_code, team_id: row['team_id']) %>"
    >Open team page</a>
  </div>

  <div class="px-4 py-4 overflow-y-auto h-[calc(100%-40px)]">
    <section>
      <div class="flex items-center gap-3">
        <div class="w-11 h-11 rounded border border-border bg-background overflow-hidden flex items-center justify-center shrink-0">
          <% if logo_url.present? %>
            <img
              src="<%= logo_url %>"
              alt="<%= row['team_name'] %> logo"
              class="w-full h-full object-contain"
              loading="lazy"
              decoding="async"
              onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
            />
            <span class="hidden text-[10px] font-semibold text-muted-foreground"><%= team_code %></span>
          <% else %>
            <span class="text-[10px] font-semibold text-muted-foreground"><%= team_code %></span>
          <% end %>
        </div>

        <div class="min-w-0">
          <h2 class="text-base font-semibold truncate"><%= row["team_name"] %></h2>
          <div class="text-[11px] text-muted-foreground/80"><%= team_code %> · <%= conference_name %> · <%= format_year_label(@selected_year) %></div>
        </div>
      </div>

      <div class="mt-2 flex items-center gap-1.5 text-[10px]">
        <span class="entity-chip entity-chip--muted">Row <%= selected_position_label %></span>
        <span class="entity-chip entity-chip--muted" data-show="$comparea === '<%= team_code %>'" style="display: none;">Pinned A</span>
        <span class="entity-chip entity-chip--muted" data-show="$compareb === '<%= team_code %>'" style="display: none;">Pinned B</span>
      </div>
    </section>

    <section class="mt-4 border-t border-border pt-3 space-y-2">
      <div class="flex items-center justify-between gap-2">
        <div class="text-[10px] uppercase tracking-wide font-semibold text-muted-foreground/80">Browse in current view</div>
        <div class="text-[10px] tabular-nums text-muted-foreground"><%= selected_position_label %></div>
      </div>

      <div class="grid grid-cols-2 gap-2">
        <button
          type="button"
          class="cursor-pointer h-8 rounded border border-border text-[11px] font-medium hover:bg-muted transition-colors disabled:cursor-not-allowed disabled:opacity-50"
          data-team-summary-step-prev
          data-on:click="@get('<%= prev_step_path %>')"
          <%= "disabled" unless can_step_prev %>
        >← Prev</button>

        <button
          type="button"
          class="cursor-pointer h-8 rounded border border-border text-[11px] font-medium hover:bg-muted transition-colors disabled:cursor-not-allowed disabled:opacity-50"
          data-team-summary-step-next
          data-on:click="@get('<%= next_step_path %>')"
          <%= "disabled" unless can_step_next %>
        >Next →</button>
      </div>
    </section>

    <section class="mt-4 border-t border-border pt-3">
      <div class="text-[10px] uppercase tracking-wide font-semibold text-muted-foreground/80 mb-1.5">Cap snapshot</div>
      <div class="space-y-1">
        <% snapshot_rows.each do |item| %>
          <div class="flex items-center justify-between gap-2 py-1">
            <span class="text-sm text-muted-foreground"><%= item[:label] %></span>
            <span class="text-sm tabular-nums font-medium <%= item[:value_class] %>"><%= item[:value] %></span>
          </div>
        <% end %>
      </div>
    </section>

    <section class="mt-4 border-t border-border pt-3 space-y-2">
      <div class="text-[10px] uppercase tracking-wide font-semibold text-muted-foreground/80">Compare actions</div>
      <div class="grid grid-cols-2 gap-2">
        <% slot_configs.each do |slot| %>
          <% slot_is_active = slot[:current] == team_code %>
          <% slot_filled = slot[:current].present? %>
          <% button_label = if slot_is_active
            "Remove #{slot[:label]}"
          elsif slot_filled
            "Replace #{slot[:label]}"
          else
            "Pin #{slot[:label]}"
          end %>

          <% compare_params = @state_params.merge(slot: slot[:key], selected: team_code) %>
          <% if slot_is_active %>
            <% compare_params = compare_params.merge(compare_action: "clear_slot") %>
          <% else %>
            <% compare_params = compare_params.merge(compare_action: "pin", team_code: team_code) %>
          <% end %>

          <button
            type="button"
            class="cursor-pointer h-8 rounded border border-border text-[11px] font-medium hover:bg-muted transition-colors <%= slot_is_active ? slot[:active_class] : '' %>"
            data-on:click="@get('<%= team_summary_sse_compare_path(compare_params) %>')"
          ><%= button_label %></button>
        <% end %>
      </div>

      <% if has_compare %>
        <button
          type="button"
          class="cursor-pointer h-7 px-2 rounded border border-border text-[11px] hover:bg-muted"
          data-on:click="@get('<%= team_summary_sse_compare_path(@state_params.merge(compare_action: "clear_all", selected: team_code)) %>')"
        >Clear compare board</button>
      <% end %>
    </section>

    <section class="mt-4 border-t border-border pt-3 space-y-1.5 text-[11px]">
      <div class="text-[10px] uppercase tracking-wide font-semibold text-muted-foreground/80">Pivots</div>
      <a class="block text-muted-foreground hover:text-foreground hover:underline" href="<%= team_href(team_code: team_code, team_id: row['team_id']) %>">Open canonical team page</a>
      <a class="block text-muted-foreground hover:text-foreground hover:underline" href="<%= salary_book_path(team: team_code, year: @selected_year, view: "salary-book") %>">Open Salary Book at <%= team_code %></a>
      <a class="block text-muted-foreground hover:text-foreground hover:underline" href="<%= team_summary_path(@state_params.merge(selected: team_code)) %>">Share this Team Summary state</a>
    </section>
  </div>
</div>
