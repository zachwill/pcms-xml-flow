<%#
  Pick Overlay — Draft pick detail view

  Sections:
  1. Header (back button, year/round label)
  2. Pick summary (destination team, type, status)
  3. Description (raw text from PCMS)
  4. Protections/conditions (if any endnote explanation)

  Locals:
  - picks: Array of pick asset rows (same team/year/round, multiple slots possible)
  - team_code: Team code that owns/controls the pick
  - team_meta: Team metadata (name, logo)
  - year: Draft year
  - round: Draft round (1 or 2)
%>

<% salary_years = SalaryBookHelper::SALARY_YEARS %>
<% compact = ->(v) { format_salary(v) } %>

<%# Round label %>
<% round_label = round == 1 ? "1st Round" : "2nd Round" %>
<% year_label = format_year_label(year) %>

<%# Get team info %>
<% team_name = team_meta["team_name"] || team_code %>
<% team_id = team_meta["team_id"] %>

<%# Primary pick (first in list) %>
<% primary = picks.first %>
<% asset_type = primary["asset_type"] %>
<% is_own = primary["origin_team_code"].blank? || primary["origin_team_code"] == team_code %>
<% is_swap = picks.any? { |p| p["is_swap"] } %>
<% is_conditional = picks.any? { |p| p["is_conditional"] } %>

<%# Origin team(s) %>
<%
  origin_codes = picks.map { |p| p["origin_team_code"] }.compact.uniq.reject { |c| c == team_code }

  # Parse PostgreSQL array strings like "{BKN,DET}" into Ruby arrays
  parse_pg_array = ->(val) {
    return [] if val.nil? || val == "{}"
    return val if val.is_a?(Array)
    val.to_s.gsub(/[{}"]/, "").split(",").map(&:strip).reject(&:blank?)
  }

  via_codes = picks.flat_map { |p| parse_pg_array.call(p["via_team_codes"]) }.compact.uniq
%>

<%# Collect unique descriptions %>
<%
  descriptions = picks.map { |p| p["description"] }.compact.uniq.reject(&:blank?)
  explanations = picks.map { |p| p["endnote_explanation"] }.compact.uniq.reject(&:blank?)
%>

<div id="rightpanel-overlay" class="sidebar-pick">
  <%# Back button + Header %>
  <header class="sidebar-pick-header">
    <div class="sidebar-pick-back">
      <button
        type="button"
        class="panel-button"
        data-on:click="@get('<%= tools_salary_book_sidebar_clear_path %>')"
      >← Back</button>
    </div>
  </header>

  <div class="sidebar-pick-body">
    <%# Pick Identity (year/round badge + team logo) %>
    <div class="sidebar-pick-identity">
      <div class="sidebar-pick-badge">
        <span class="sidebar-pick-badge-year"><%= year %></span>
        <span class="sidebar-pick-badge-round"><%= round_label %></span>
      </div>
      <div class="sidebar-pick-team">
        <% if team_id %>
          <img
            class="sidebar-pick-team-logo"
            src="<%= team_logo_url(team_id) %>"
            alt="<%= team_name %>"
            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
          />
          <span class="sidebar-pick-team-fallback" style="display: none;"><%= team_code %></span>
        <% else %>
          <span class="sidebar-pick-team-fallback"><%= team_code %></span>
        <% end %>
        <span class="sidebar-pick-team-name"><%= team_name %></span>
      </div>
    </div>

    <%# Status Badges %>
    <div class="sidebar-pick-status">
      <% if is_own %>
        <span class="sidebar-badge sidebar-badge--green">Own Pick</span>
      <% elsif asset_type == "TO" %>
        <span class="sidebar-badge sidebar-badge--red">Owed Out</span>
      <% else %>
        <span class="sidebar-badge sidebar-badge--blue">Acquired</span>
      <% end %>

      <% if is_swap %>
        <span class="sidebar-badge sidebar-badge--purple">Swap Rights</span>
      <% end %>

      <% if is_conditional %>
        <span class="sidebar-badge sidebar-badge--orange">Conditional</span>
      <% end %>
    </div>

    <%# Provenance Section %>
    <% if origin_codes.any? || via_codes.any? %>
      <div class="sidebar-section">
        <div class="sidebar-section-label">Provenance</div>
        <div class="sidebar-pick-provenance">
          <% if origin_codes.any? %>
            <div class="sidebar-stat-row">
              <span class="sidebar-stat-label"><%= asset_type == "TO" ? "Owed To" : "From" %></span>
              <span class="sidebar-stat-value"><%= origin_codes.join(", ") %></span>
            </div>
          <% end %>
          <% if via_codes.any? %>
            <div class="sidebar-stat-row">
              <span class="sidebar-stat-label">Via</span>
              <span class="sidebar-stat-value"><%= via_codes.join(" → ") %></span>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <%# Description Section (raw PCMS text) %>
    <% if descriptions.any? %>
      <div class="sidebar-section">
        <div class="sidebar-section-label">PCMS Summary</div>
        <div class="sidebar-pick-descriptions">
          <% descriptions.each do |desc| %>
            <div class="sidebar-pick-description"><%= desc %></div>
          <% end %>
        </div>
      </div>
    <% end %>

    <%# Protections / Conditions (endnote explanations) %>
    <% if explanations.any? %>
      <div class="sidebar-section">
        <div class="sidebar-section-label">Protections</div>
        <div class="sidebar-pick-explanations">
          <% explanations.each do |explanation| %>
            <div class="sidebar-pick-explanation"><%= explanation %></div>
          <% end %>
        </div>
      </div>
    <% end %>

    <%# All pick asset rows (debug/detail view) %>
    <% if picks.size > 1 %>
      <div class="sidebar-section">
        <div class="sidebar-section-label">Asset Rows (<%= picks.size %>)</div>
        <div class="sidebar-pick-rows">
          <% picks.each_with_index do |pick, idx| %>
            <div class="sidebar-pick-row-item">
              <span class="sidebar-pick-row-slot">Slot <%= pick["asset_slot"] %>.<%= pick["sub_asset_slot"] %></span>
              <span class="sidebar-pick-row-type"><%= pick["asset_type"] %></span>
              <% if pick["origin_team_code"].present? && pick["origin_team_code"] != team_code %>
                <span class="sidebar-pick-row-origin"><%= pick["origin_team_code"] %></span>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>

    <%# Metadata footer %>
    <div class="sidebar-meta">
      refreshed_at: <code><%= primary["refreshed_at"] || "—" %></code>
    </div>
  </div>
</div>
