<% overlay_query_expr ||= "''" %>

<div class="flex-1 min-w-0">
  <form
    method="get"
    action="<%= system_values_path %>"
    class="flex items-start gap-4 min-w-0 overflow-x-auto pb-1"
    role="group"
    aria-label="System Values controls"
    data-on:submit="evt.preventDefault(); @get('<%= system_values_sse_refresh_path %>?' + (<%= overlay_query_expr %>));"
  >
    <input type="hidden" name="metric_finder_query" value="<%= @metric_finder_query %>" data-bind="svmetricfinderquery" />
    <input type="hidden" name="metric_finder_cursor" value="<%= @metric_finder_cursor_value %>" data-bind="svmetricfindercursor" />

    <div class="min-w-[24rem] space-y-1">
      <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Season Lens</div>
      <div class="flex items-center gap-1.5">
        <select
          id="system-values-year-select"
          name="year"
          class="h-7 w-[6.5rem] rounded border border-border bg-muted/50 px-2 text-xs font-mono tabular-nums"
          data-bind="svyear"
        >
          <% @available_years.each do |candidate_year| %>
            <option value="<%= candidate_year %>" <%= "selected" if candidate_year == @selected_year %>><%= format_year_label(candidate_year) %></option>
          <% end %>
        </select>

        <span class="text-[10px] uppercase tracking-wide text-muted-foreground/70">vs</span>

        <select
          id="system-values-baseline-year-select"
          name="baseline_year"
          class="h-7 w-[6.5rem] rounded border border-border bg-muted/50 px-2 text-xs font-mono tabular-nums"
          data-bind="svbaseline"
        >
          <% @available_years.each do |candidate_year| %>
            <option value="<%= candidate_year %>" <%= "selected" if candidate_year == @baseline_year %>><%= format_year_label(candidate_year) %></option>
          <% end %>
        </select>

        <span class="text-[10px] uppercase tracking-wide text-muted-foreground/70">range</span>

        <select
          id="system-values-from-year-select"
          name="from_year"
          class="h-7 w-[5.25rem] rounded border border-border bg-muted/50 px-2 text-xs font-mono tabular-nums"
          data-bind="svfrom"
        >
          <% @available_years.each do |candidate_year| %>
            <option value="<%= candidate_year %>" <%= "selected" if candidate_year == @from_year %>><%= candidate_year %></option>
          <% end %>
        </select>

        <span class="text-[10px] uppercase tracking-wide text-muted-foreground/70">→</span>

        <select
          id="system-values-to-year-select"
          name="to_year"
          class="h-7 w-[5.25rem] rounded border border-border bg-muted/50 px-2 text-xs font-mono tabular-nums"
          data-bind="svto"
        >
          <% @available_years.each do |candidate_year| %>
            <option value="<%= candidate_year %>" <%= "selected" if candidate_year == @to_year %>><%= candidate_year %></option>
          <% end %>
        </select>

        <button type="submit" class="h-7 px-2 rounded border border-border bg-muted/50 text-xs font-medium hover:bg-muted">Apply</button>
      </div>
    </div>

    <div class="h-20 w-px bg-border self-center shrink-0"></div>

    <div class="min-w-[15rem] space-y-1">
      <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Visible sections</div>
      <div class="grid grid-cols-2 gap-x-3 gap-y-1">
        <label class="flex items-center gap-1.5 text-[11px] text-foreground/80 cursor-pointer select-none">
          <input type="checkbox" class="size-3.5 accent-primary" data-bind="showsystemvalues" />
          System
        </label>
        <label class="flex items-center gap-1.5 text-[11px] text-foreground/80 cursor-pointer select-none">
          <input type="checkbox" class="size-3.5 accent-primary" data-bind="showtaxrates" />
          Tax Rates
        </label>
        <label class="flex items-center gap-1.5 text-[11px] text-foreground/80 cursor-pointer select-none">
          <input type="checkbox" class="size-3.5 accent-primary" data-bind="showsalaryscales" />
          Minimum
        </label>
        <label class="flex items-center gap-1.5 text-[11px] text-foreground/80 cursor-pointer select-none">
          <input type="checkbox" class="size-3.5 accent-primary" data-bind="showrookiescales" />
          Rookie
        </label>
      </div>
    </div>

    <div class="h-20 w-px bg-border self-center shrink-0"></div>

    <div class="min-w-[17rem] space-y-1">
      <div class="text-[10px] font-semibold uppercase tracking-wider text-muted-foreground/70">Drill-in</div>
      <div class="flex items-center gap-1.5 h-7">
        <span
          class="inline-flex items-center rounded border border-border/70 bg-background px-2 h-7 text-[11px] text-muted-foreground"
          data-show="$svoverlaysection === ''"
        >No active selection</span>

        <span
          class="inline-flex items-center rounded border border-amber-500/50 bg-amber-100/60 dark:bg-amber-900/20 px-2 h-7 text-[11px] font-mono tabular-nums text-foreground"
          data-show="$svoverlaysection !== ''"
          style="display: none;"
          data-text="($svoverlaysection || '').toUpperCase() + ' · ' + ($svoverlaymetric || '') + ' · ' + ($svoverlayyear || '')"
        ></span>

        <button
          type="button"
          class="h-7 px-2 rounded border border-border bg-background text-xs font-medium text-muted-foreground hover:text-foreground hover:bg-muted"
          data-show="$svoverlaysection !== ''"
          style="display: none;"
          data-on:click="$svmetricfinder=''; $svoverlaysection=''; $svoverlaymetric=''; $svoverlayyear=''; $svoverlaylower=''; $svoverlayupper=''; @get('<%= system_values_sidebar_clear_path %>')"
        >Clear</button>
      </div>

      <div class="flex flex-wrap items-center gap-1.5">
        <% @section_shift_cards.each do |card| %>
          <% card_class = case card[:variant]
          when "positive"
            "text-emerald-700 dark:text-emerald-300 border-emerald-300/70 dark:border-emerald-500/40 bg-emerald-50/60 dark:bg-emerald-900/20"
          when "negative"
            "text-red-700 dark:text-red-300 border-red-300/70 dark:border-red-500/40 bg-red-50/60 dark:bg-red-900/20"
          when "neutral"
            "text-foreground border-border/80 bg-background"
          else
            "text-muted-foreground border-border/70 bg-background"
          end %>

          <span class="h-5 px-1.5 rounded border text-[10px] font-mono tabular-nums inline-flex items-center gap-1 <%= card_class %>">
            <span class="font-semibold"><%= card[:label] %></span>
            <span><%= card[:metric_label] %> <%= card[:delta_label] %></span>
          </span>
        <% end %>
      </div>
    </div>
  </form>
</div>

<div class="h-20 w-px bg-border self-center ml-auto shrink-0"></div>
<%= render partial: "shared/commandbar_navigation", locals: { active_destination: "system_values" } %>
