<%
  summary = @sidebar_summary || {}
  year = summary[:year].to_i
  year = 2025 if year <= 0
  year_label = format_year_label(year)
  top_rows = Array(summary[:top_rows])
  overlay_query_expr = "'year=' + encodeURIComponent($agencyyear) + '&sort=' + encodeURIComponent($agencysort) + '&dir=' + encodeURIComponent($agencydir)"

  compact_currency = lambda do |amount|
    return "—" if amount.nil?

    value = amount.to_f
    sign = value.negative? ? "-" : ""
    abs = value.abs

    if abs >= 1_000_000_000
      "#{sign}$#{format('%.1f', abs / 1_000_000_000)}B"
    else
      format_compact_currency(value)
    end
  end

  # Batch-load canonical slugs for agencies in top rows to avoid N+1 queries.
  prefetch_canonical_slugs(entity_type: "agency", entity_ids: top_rows.map { |r| r[:id] })
%>

<div id="rightpanel-base" class="space-y-4">
  <div class="px-1 space-y-2">
    <div class="text-lg font-semibold leading-tight">Agencies</div>

    <div class="grid grid-cols-2 gap-1.5">
      <div class="h-12 border border-border bg-background px-2 flex flex-col justify-center">
        <div class="text-[10px] uppercase tracking-wide text-muted-foreground/80">Book total · <%= year_label %></div>
        <div class="tabular-nums text-sm font-semibold"><%= compact_currency.call(summary[:book_total]) %></div>
      </div>

      <div class="h-12 border border-border bg-background px-2 flex flex-col justify-center">
        <div class="text-[10px] uppercase tracking-wide text-muted-foreground/80">Agencies</div>
        <div class="tabular-nums text-sm font-semibold"><%= summary[:row_count].to_i %></div>
      </div>
    </div>

    <div class="bg-background divide-y divide-border/60">
      <div class="px-2 py-1.5 flex items-center justify-between gap-2">
        <span class="text-sm text-muted-foreground">Agents</span>
        <span class="tabular-nums text-sm font-medium"><%= summary[:agent_total].to_i %></span>
      </div>
      <div class="px-2 py-1.5 flex items-center justify-between gap-2">
        <span class="text-sm text-muted-foreground">Clients</span>
        <span class="tabular-nums text-sm font-medium"><%= summary[:client_total].to_i %></span>
      </div>
      <div class="px-2 py-1.5 flex items-center justify-between gap-2">
        <span class="text-sm text-muted-foreground">Max</span>
        <span class="tabular-nums text-sm font-medium"><%= summary[:max_total].to_i %></span>
      </div>
      <div class="px-2 py-1.5 flex items-center justify-between gap-2">
        <span class="text-sm text-muted-foreground">Expiring</span>
        <span class="tabular-nums text-sm font-medium"><%= summary[:expiring_total].to_i %></span>
      </div>
      <div class="px-2 py-1.5 flex items-center justify-between gap-2">
        <span class="text-sm text-muted-foreground">Options</span>
        <span class="tabular-nums text-sm font-medium"><%= summary[:option_total].to_i %></span>
      </div>
    </div>

    <% if Array(summary[:filters]).any? %>
      <div class="pt-0.5 flex flex-wrap gap-1">
        <% Array(summary[:filters]).each do |label| %>
          <span class="entity-chip entity-chip--muted"><%= label %></span>
        <% end %>
      </div>
    <% end %>
  </div>

  <div class="border border-border bg-background">
    <div class="px-3 py-2 border-b border-border text-[10px] uppercase tracking-wide text-muted-foreground/80">
      Top agencies by current sort
    </div>

    <% if top_rows.empty? %>
      <div class="p-3 text-sm text-muted-foreground italic">No rows.</div>
    <% else %>
      <div class="divide-y divide-border">
        <% top_rows.each do |row| %>
          <% row_id = row[:id] %>
          <% row_has_book = row[:book_total].to_f.positive? %>
          <% row_percentile_int = representation_percentile_int(row[:percentile]) %>

          <button
            type="button"
            class="cursor-pointer w-full px-3 py-2 text-left hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 transition-colors duration-75"
            data-on:click="$overlaytype = 'agency'; $overlayid = '<%= row_id %>'; @get('/agencies/sidebar/<%= row_id %>?' + (<%= overlay_query_expr %>))"
          >
            <div class="entity-cell-two-line">
              <div class="entity-cell-primary justify-between gap-2">
                <a href="<%= agency_href(row_id) %>" class="truncate font-medium hover:underline" onclick="event.stopPropagation()"><%= row[:title] %></a>
                <% if row_has_book %>
                  <span class="font-mono tabular-nums text-[11px] shrink-0"><%= compact_currency.call(row[:book_total]) %></span>
                <% else %>
                  <span class="font-mono tabular-nums text-[11px] shrink-0 min-w-8 text-center text-muted-foreground/50">—</span>
                <% end %>
              </div>
              <div class="entity-cell-secondary justify-between gap-2">
                <span class="truncate"><%= row[:subtitle] %></span>
                <% if row_has_book && row_percentile_int.present? %>
                  <span class="font-mono tabular-nums <%= representation_percentile_color_class(row[:percentile]) %>">P<%= row_percentile_int %></span>
                <% end %>
              </div>
            </div>
          </button>
        <% end %>
      </div>
    <% end %>
  </div>

  <div class="text-[10px] text-muted-foreground/70 tabular-nums px-1">
    Sort: <%= summary[:sort_key].to_s.humanize.presence || "Book" %> · <%= summary[:sort_dir].to_s.upcase.presence || "DESC" %>
  </div>
</div>
