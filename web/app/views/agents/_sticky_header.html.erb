<%#
  Agent sticky header — compact, Salary Book-inspired context strip.

  locals:
  - image_fallback
  - title
  - badges: [{ label:, variant: }] or Array[String]
  - meta: Array[String]
  - links: [[label, href], ...]
  - posture_chips: [{ label:, variant: }]
  - agency_name
  - client_count
  - team_count
  - cap_2025_total
  - total_salary_from_2025
%>

<%
  image_fallback = local_assigns[:image_fallback].to_s.strip.presence || "AG"
  title = local_assigns[:title].to_s.strip.presence || "Agent"

  badges = Array(local_assigns[:badges]).filter_map do |b|
    if b.is_a?(Hash)
      label = (b[:label] || b["label"]).to_s.strip
      variant = (b[:variant] || b["variant"]).to_s.strip.presence || "muted"
      next if label.blank?
      { label: label, variant: variant }
    else
      label = b.to_s.strip
      next if label.blank?
      { label: label, variant: "muted" }
    end
  end

  meta = Array(local_assigns[:meta]).map { |m| m.to_s.strip }.reject(&:blank?)

  links = Array(local_assigns[:links]).filter_map do |entry|
    if entry.is_a?(Array)
      label = entry[0].to_s.strip
      href = entry[1].to_s.strip
      next if label.blank? || href.blank?
      [label, href]
    elsif entry.is_a?(Hash)
      label = (entry[:label] || entry["label"]).to_s.strip
      href = (entry[:href] || entry["href"]).to_s.strip
      next if label.blank? || href.blank?
      [label, href]
    end
  end

  posture_chips = Array(local_assigns[:posture_chips]).filter_map do |chip|
    if chip.is_a?(Hash)
      label = (chip[:label] || chip["label"]).to_s.strip
      variant = (chip[:variant] || chip["variant"]).to_s.strip.presence || "muted"
      next if label.blank?
      { label: label, variant: variant }
    else
      label = chip.to_s.strip
      next if label.blank?
      { label: label, variant: "muted" }
    end
  end

  agency_name = local_assigns[:agency_name].to_s.strip.presence
  client_count = local_assigns[:client_count]
  team_count = local_assigns[:team_count]
  cap_2025_total = local_assigns[:cap_2025_total]
  total_salary_from_2025 = local_assigns[:total_salary_from_2025]
%>

<header
  id="agent-header"
  class="sticky top-[130px] z-40 -mx-4 px-4 border-b border-border bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/80 shadow-[0_1px_3px_0_rgb(0_0_0/0.1),0_1px_2px_-1px_rgb(0_0_0/0.1)]"
>
  <div class="h-16 flex items-center gap-3">
    <div class="min-w-0 flex flex-1 items-center gap-3">
      <div class="w-10 h-10 rounded border border-border bg-muted/40 flex items-center justify-center shrink-0">
        <span class="text-[11px] font-semibold tracking-wide text-muted-foreground"><%= image_fallback %></span>
      </div>

      <div class="min-w-0 grid grid-rows-[24px_16px]">
        <div class="h-[24px] flex items-end gap-2 min-w-0 overflow-hidden">
          <h1 class="text-[16px] font-semibold leading-tight truncate"><%= title %></h1>
          <% badges.each do |badge| %>
            <% variant_class = case badge[:variant]
              when "danger" then "entity-chip--danger"
              when "warning" then "entity-chip--warning"
              when "success" then "entity-chip--success"
              when "accent" then "entity-chip--accent"
              else "entity-chip--muted"
            end %>
            <span class="hidden sm:inline-flex entity-chip <%= variant_class %>"><%= badge[:label] %></span>
          <% end %>
        </div>

        <div class="h-[16px] -mt-px flex items-start min-w-0">
          <% if meta.any? %>
            <span class="truncate text-[10px] leading-none text-muted-foreground/85 tabular-nums"><%= meta.join(" · ") %></span>
          <% elsif agency_name.present? %>
            <span class="truncate text-[10px] leading-none text-muted-foreground/85"><%= agency_name %></span>
          <% else %>
            <span class="truncate text-[10px] leading-none text-muted-foreground/60">No profile metadata</span>
          <% end %>
        </div>
      </div>
    </div>

    <% if posture_chips.any? %>
      <div class="hidden 2xl:flex items-center gap-1 shrink-0">
        <% posture_chips.first(4).each do |chip| %>
          <% chip_variant = case chip[:variant]
            when "danger" then "entity-chip--danger"
            when "warning" then "entity-chip--warning"
            when "success" then "entity-chip--success"
            when "accent" then "entity-chip--accent"
            else "entity-chip--muted"
          end %>
          <span class="entity-chip <%= chip_variant %>"><%= chip[:label] %></span>
        <% end %>
      </div>
    <% end %>

    <% if links.any? %>
      <div class="hidden lg:flex items-center gap-3 shrink-0 text-[11px]">
        <% links.first(3).each do |label, href| %>
          <a href="<%= href %>" class="text-muted-foreground hover:text-foreground hover:underline whitespace-nowrap"><%= label %></a>
        <% end %>
      </div>
    <% end %>

    <div class="hidden xl:flex items-center gap-1.5 shrink-0">
      <%= render partial: "salary_book/kpi_cell", locals: {
        label: "Clients",
        value: client_count.present? ? client_count.to_i.to_s : "0",
        variant: "default",
        class_name: "bg-muted/70 dark:bg-muted/60"
      } %>

      <%= render partial: "salary_book/kpi_cell", locals: {
        label: "Teams",
        value: team_count.present? ? team_count.to_i.to_s : "0",
        variant: "default",
        class_name: "bg-muted/70 dark:bg-muted/60"
      } %>

      <%= render partial: "salary_book/kpi_cell", locals: {
        label: "Cap 25",
        value: cap_2025_total.present? ? format_compact_currency(cap_2025_total) : "—",
        variant: cap_2025_total.present? ? "default" : "muted",
        class_name: "bg-muted/70 dark:bg-muted/60"
      } %>

      <%= render partial: "salary_book/kpi_cell", locals: {
        label: "Total",
        value: total_salary_from_2025.present? ? format_compact_currency(total_salary_from_2025) : "—",
        variant: total_salary_from_2025.present? ? "default" : "muted",
        class_name: "bg-muted/70 dark:bg-muted/60"
      } %>
    </div>
  </div>
</header>
