<%
  trade_row = trade || {}
  teams = trade_row["teams_involved"].to_s.split(", ").reject(&:blank?)
  team_rows = Array(team_anatomy_rows)
  detail_rows = Array(asset_rows)
  tx_rows = Array(related_transactions)

  formatted_date = trade_row["trade_date"].present? ? Date.parse(trade_row["trade_date"].to_s).strftime("%b %d, %Y") : "—"
  comments = trade_row["trade_comments"].presence
  overlay_trade_id = local_assigns[:overlay_trade_id].presence || trade_row["trade_id"].to_s
%>

<div
  id="rightpanel-overlay"
  class="absolute inset-0 z-20 overflow-y-auto overflow-x-hidden bg-background"
  data-trade-overlay-id="<%= overlay_trade_id %>"
  data-show="$overlaytype === 'trade' && $overlayid === '<%= overlay_trade_id %>'"
>
  <div class="sticky top-0 z-20 h-10 px-4 flex items-center justify-between border-b border-border bg-background">
    <button
      type="button"
      class="cursor-pointer flex items-center gap-1.5 text-sm transition-colors text-muted-foreground hover:text-foreground"
      data-on:click="$overlaytype = 'none'; $overlayid = ''; @get('/trades/sidebar/clear')"
    >
      <%= lucide_icon("arrow-left", class: "w-4 h-4", "aria-hidden": true) %>
      <span class="font-medium">Back</span>
    </button>

    <a href="<%= trade_href(trade_row['trade_id']) %>" class="text-xs text-muted-foreground hover:text-foreground hover:underline">Open trade page</a>
  </div>

  <div class="px-4 pb-4 pt-4 space-y-5">
    <div class="space-y-1">
      <h2 class="text-lg font-semibold text-foreground truncate">Trade #<%= trade_row["trade_id"] %></h2>
      <div class="text-xs text-muted-foreground/80 tabular-nums">
        <span><%= formatted_date %></span>
        <span class="text-muted-foreground/50 px-1">·</span>
        <span><%= teams.any? ? teams.join(" · ") : "No teams" %></span>
      </div>
      <% if comments.present? %>
        <p class="text-[11px] text-muted-foreground"><%= comments %></p>
      <% end %>
    </div>

    <div class="grid grid-cols-2 gap-1.5 border-t border-border pt-4">
      <%= render partial: "salary_book/kpi_cell", locals: { label: "Teams", value: trade_row["team_count"].to_i.to_s, class_name: "w-full" } %>
      <%= render partial: "salary_book/kpi_cell", locals: { label: "Players", value: trade_row["player_count"].to_i.to_s, class_name: "w-full" } %>
      <%= render partial: "salary_book/kpi_cell", locals: { label: "Picks", value: trade_row["pick_count"].to_i.to_s, class_name: "w-full" } %>
      <%= render partial: "salary_book/kpi_cell", locals: { label: "Cash/TPE", value: "#{trade_row['cash_line_count'].to_i}/#{trade_row['tpe_line_count'].to_i}", class_name: "w-full" } %>
    </div>

    <div class="border-t border-border pt-4 space-y-2">
      <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Team anatomy</div>

      <% if team_rows.any? %>
        <div class="divide-y divide-border/60 rounded-lg border border-border/70">
          <% team_rows.each do |row| %>
            <% out_parts = [] %>
            <% in_parts = [] %>
            <% out_parts << "#{row['players_out'].to_i}P" if row["players_out"].to_i.positive? %>
            <% out_parts << "#{row['picks_out'].to_i}K" if row["picks_out"].to_i.positive? %>
            <% out_parts << "#{format_salary(row['cash_out'])} cash" if row["cash_out"].to_f.positive? %>
            <% out_parts << "#{row['tpe_out'].to_i} TPE" if row["tpe_out"].to_i.positive? %>
            <% in_parts << "#{row['players_in'].to_i}P" if row["players_in"].to_i.positive? %>
            <% in_parts << "#{row['picks_in'].to_i}K" if row["picks_in"].to_i.positive? %>
            <% in_parts << "#{format_salary(row['cash_in'])} cash" if row["cash_in"].to_f.positive? %>
            <% in_parts << "#{row['tpe_in'].to_i} TPE" if row["tpe_in"].to_i.positive? %>
            <div class="px-3 py-2.5 space-y-1">
              <div class="flex items-center justify-between gap-2">
                <a href="<%= team_href(team_code: row['team_code']) %>" class="font-medium text-sm hover:underline"><%= row["team_code"] %></a>
                <span class="text-[10px] text-muted-foreground truncate"><%= row["team_name"].presence || "—" %></span>
              </div>
              <div class="text-[11px] text-muted-foreground tabular-nums flex flex-wrap gap-x-2 gap-y-1">
                <span>Out: <span class="text-foreground"><%= out_parts.any? ? out_parts.join(" · ") : "—" %></span></span>
                <span>In: <span class="text-foreground"><%= in_parts.any? ? in_parts.join(" · ") : "—" %></span></span>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="text-sm text-muted-foreground">No team-level detail available.</div>
      <% end %>
    </div>

    <div class="border-t border-border pt-4 space-y-2">
      <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Asset snippets</div>

      <% if detail_rows.any? %>
        <div class="divide-y divide-border/60 rounded-lg border border-border/70">
          <% detail_rows.first(18).each do |row| %>
            <%
              row_label = if row["player_id"].present?
                row["player_name"].presence || row["player_id"].to_s
              elsif row["draft_pick_year"].present?
                "#{row['draft_pick_year']} R#{row['draft_pick_round'].presence || '?'} pick"
              elsif row["trade_entry_lk"].to_s == "TREX"
                "Trade exception"
              elsif row["cash_amount"].to_f != 0
                "Cash #{format_salary(row['cash_amount'])}"
              elsif row["trade_entry_lk"].present?
                row["trade_entry_lk"]
              else
                "Line item"
              end

              direction_chip = row["is_sent"] == true ? "OUT" : (row["is_sent"] == false ? "IN" : "—")
              direction_variant = if row["is_sent"] == true
                "entity-chip--danger"
              elsif row["is_sent"] == false
                "entity-chip--success"
              else
                "entity-chip--muted"
              end
            %>
            <div class="px-3 py-2 flex items-center justify-between gap-2 text-[11px]">
              <div class="min-w-0">
                <% if row["player_id"].present? %>
                  <a href="<%= player_href(row['player_id']) %>" class="font-medium hover:underline truncate"><%= row_label %></a>
                <% else %>
                  <span class="font-medium"><%= row_label %></span>
                <% end %>
                <div class="text-muted-foreground tabular-nums"><%= row["team_code"].presence || "—" %></div>
              </div>
              <span class="entity-chip <%= direction_variant %>"><%= direction_chip %></span>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="text-sm text-muted-foreground">No detailed line items found.</div>
      <% end %>
    </div>

    <div class="border-t border-border pt-4 space-y-2">
      <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Pivots</div>
      <div class="flex flex-col gap-1.5 text-sm">
        <a href="<%= trade_href(trade_row['trade_id']) %>" class="text-muted-foreground hover:text-foreground hover:underline">Open canonical trade page</a>

        <% teams.each do |code| %>
          <a href="<%= team_href(team_code: code) %>" class="text-muted-foreground hover:text-foreground hover:underline">Open team page (<%= code %>)</a>
        <% end %>

        <% if tx_rows.any? %>
          <div class="text-[11px] text-muted-foreground tabular-nums mt-1">Related transactions</div>
          <% tx_rows.first(6).each do |txn| %>
            <a href="<%= transaction_href(txn['transaction_id']) %>" class="text-muted-foreground hover:text-foreground hover:underline">Txn #<%= txn["transaction_id"] %> · <%= txn["transaction_type_lk"].presence || "—" %></a>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
</div>
