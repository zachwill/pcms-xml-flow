<%#
  Team sidebar (RightPanel base) — Tailwind port of the React prototype (TeamContext)

  NOTE: Root id must remain stable for Datastar morphing.
%>

<% team_meta ||= {} %>
<% summaries_by_year ||= {} %>
<% summary ||= summaries_by_year[year] || {} %>
<% draft_assets ||= [] %>
<% rights_by_kind ||= {} %>
<% stats_by_year ||= summaries_by_year %>

<% team_name = team_meta["team_name"] || "Team #{team_code}" %>
<% conference = team_meta["conference_name"] || "—" %>
<% team_id = team_meta["team_id"] %>
<% logo_url = team_logo_url(team_id) %>

<% cap_total = summary["cap_total"] %>
<% cap_space = summary["cap_space"] %>
<% room_tax = summary["room_under_tax"] %>
<% room_a1 = summary["room_under_first_apron"] %>
<% room_a2 = summary["room_under_second_apron"] %>
<% roster_count = summary["roster_row_count"] %>
<% two_way_count = summary["two_way_row_count"] %>

<% status = tax_status(summary) %>
<%
  status_badge_class_for = ->(label) {
    case label
    when "Under Tax"
      "bg-emerald-100 text-emerald-800 dark:bg-emerald-900/30 dark:text-emerald-400"
    when "Tax"
      "bg-orange-100 text-orange-800 dark:bg-orange-900/30 dark:text-orange-400"
    when "Apron 1"
      "bg-amber-100 text-amber-800 dark:bg-amber-900/30 dark:text-amber-400"
    when "Apron 2"
      "bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400"
    else
      "bg-muted text-muted-foreground"
    end
  }

  status_value_class_for = ->(variant) {
    case variant
    when "positive"
      "text-emerald-600 dark:text-emerald-400"
    when "negative"
      "text-red-500"
    else
      "text-muted-foreground"
    end
  }

  room_under_color = ->(v) {
    return nil if v.nil?
    val = v.to_f
    return "text-red-500" if val < 0
    return "text-emerald-600 dark:text-emerald-400" if val >= 10_000_000
    nil
  }

  cap_space_display = cap_space.nil? ? "—" : format_room_amount(cap_space)
  cap_space_color = cap_space.nil? ? nil : (cap_space.to_f >= 0 ? "text-emerald-600 dark:text-emerald-400" : "text-red-500")
  projection_years = SalaryBookHelper::SALARY_YEARS

  cap_outlook_is_restricted = ["Tax", "Apron 1", "Apron 2"].include?(status[:label])
  cap_outlook_kpi_class = cap_outlook_is_restricted ? "w-full bg-red-100/80 dark:bg-red-900/30" : "w-full"

  room_tax_val = room_tax&.to_f
  at_or_above_tax = room_tax_val.present? && room_tax_val <= 0
  luxury_tax_owed = summary["luxury_tax_owed"]

  tax_metric_label = at_or_above_tax ? "Luxury Tax Payment" : "Tax Room"
  tax_metric_value = if at_or_above_tax
    if luxury_tax_owed.nil?
      room_tax_val == 0 ? format_compact_currency(0) : "—"
    else
      format_compact_currency(luxury_tax_owed)
    end
  else
    room_tax ? format_room_amount(room_tax) : "—"
  end
  tax_metric_variant = if at_or_above_tax
    room_tax_val&.<(0) ? "negative" : "muted"
  elsif room_tax.nil?
    "muted"
  else
    "positive"
  end
  tax_metric_title = at_or_above_tax ? "Estimated luxury tax payment" : "Room under luxury tax"
%>

<div id="rightpanel-base" class="space-y-4" data-signals="{ sidebartab: 'cap' }">
  <%# Header %>
  <div class="flex items-start gap-3">
    <div class="flex items-center gap-3 min-w-0">
      <div class="w-14 h-14 rounded-lg bg-background border border-border flex items-center justify-center overflow-hidden">
        <% if logo_url %>
          <img
            src="<%= logo_url %>"
            alt="<%= team_name %> logo"
            class="w-full h-full object-contain"
            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
          />
          <span class="hidden text-lg font-bold text-muted-foreground"><%= team_code %></span>
        <% else %>
          <span class="text-lg font-bold text-muted-foreground"><%= team_code %></span>
        <% end %>
      </div>

      <div class="min-w-0">
        <a
          href="<%= team_href(team_code: team_code, team_id: team_id) %>"
          target="_blank"
          rel="noopener noreferrer"
          class="font-semibold text-lg truncate block text-foreground hover:underline focus-visible:underline"
        ><%= team_name %></a>
        <div class="text-sm text-muted-foreground truncate"><%= conference %> Conference</div>
      </div>
    </div>
  </div>

  <%# Tab toggle (5 tabs; only Cap + Stats have content right now) %>
  <div class="relative grid grid-cols-5 p-1 rounded-lg bg-muted border border-border">
    <%# Sliding indicator (equal-width tabs; no gap keeps math stable) %>
    <div
      class="absolute top-1 bottom-1 left-1 w-[calc((100%-8px)/5)] rounded-md bg-background shadow-sm pointer-events-none transition-[transform,width,opacity] duration-150 ease-out"
      data-class="{
        'translate-x-0': $sidebartab === 'cap',
        'translate-x-full': $sidebartab === 'draft',
        'translate-x-[200%]': $sidebartab === 'rights',
        'translate-x-[300%]': $sidebartab === 'injuries',
        'translate-x-[400%]': $sidebartab === 'stats'
      }"
      aria-hidden="true"
    ></div>

    <% tabs = [
      ["cap", "Cap"],
      ["draft", "Draft"],
      ["rights", "Rights"],
      ["injuries", "Injuries"],
      ["stats", "Stats"]
    ] %>

    <% tabs.each do |(id, label)| %>
      <button
        type="button"
        class="cursor-pointer relative z-10 min-w-0 px-3 py-1.5 text-sm font-medium text-center rounded-md transition-colors duration-150
               focus-visible:outline-none focus-visible:ring-0 focus-visible:border-foreground dark:focus-visible:border-foreground"
        data-on:click="$sidebartab = '<%= id %>'"
        data-class="{ 'text-foreground': $sidebartab === '<%= id %>', 'text-muted-foreground hover:text-foreground': $sidebartab !== '<%= id %>' }"
      ><%= label %></button>
    <% end %>
  </div>

  <%# Cap tab %>
  <div data-show="$sidebartab === 'cap'">
    <% if summary.empty? %>
      <div class="p-4 rounded-lg bg-muted/30 border border-border/50 text-sm text-muted-foreground italic">
        No <code>pcms.team_salary_warehouse</code> data for <%= team_code %> / <%= year %>.
      </div>
    <% else %>
      <%# KPI strip %>
      <div class="border-t border-border pt-4 pb-3">
        <div class="grid grid-cols-4 gap-1.5">
          <%= render partial: "tools/salary_book/kpi_cell", locals: {
            label: "Roster",
            value: (roster_count || "—").to_s,
            class_name: "w-full",
            title: "Standard roster contracts"
          } %>

          <%= render partial: "tools/salary_book/kpi_cell", locals: {
            label: "Two-Ways",
            value: (two_way_count || "—").to_s,
            class_name: "w-full",
            title: "Two-way contracts"
          } %>

          <%= render partial: "tools/salary_book/kpi_cell", locals: {
            label: "#{format_year_label(year)} CAP",
            value: status[:label],
            variant: status[:variant],
            class_name: cap_outlook_kpi_class,
            title: "#{format_year_label(year)} outlook: #{status[:label]} (#{status[:value]})"
          } %>

          <%= render partial: "tools/salary_book/kpi_cell", locals: {
            label: tax_metric_label,
            value: tax_metric_value,
            variant: tax_metric_variant,
            class_name: "w-full",
            label_class_name: "text-[8px] tracking-normal",
            title: tax_metric_title
          } %>
        </div>
      </div>

      <%# Cap details %>
      <div>
        <div class="space-y-0.5">
          <div class="flex justify-between items-baseline py-1.5">
            <span class="text-sm text-muted-foreground">Total Salary</span>
            <span class="tabular-nums text-sm font-medium"><%= cap_total ? format_compact_currency(cap_total) : "—" %></span>
          </div>

          <div class="flex justify-between items-baseline py-1.5">
            <span class="text-sm text-muted-foreground">Cap Space</span>
            <span class="tabular-nums text-sm font-medium <%= cap_space_color %>"><%= cap_space_display %></span>
          </div>

          <div class="flex justify-between items-baseline py-1.5" data-show="$displaytaxaprons">
            <span class="text-sm text-muted-foreground">Room Under Tax</span>
            <span class="tabular-nums text-sm font-medium <%= room_under_color.call(room_tax) %>"><%= room_tax ? format_room_amount(room_tax) : "—" %></span>
          </div>

          <div class="flex justify-between items-baseline py-1.5" data-show="$displaytaxaprons">
            <span class="text-sm text-muted-foreground">Room Under 1st Apron</span>
            <span class="tabular-nums text-sm font-medium <%= room_under_color.call(room_a1) %>"><%= room_a1 ? format_room_amount(room_a1) : "—" %></span>
          </div>

          <div class="flex justify-between items-baseline py-1.5" data-show="$displaytaxaprons">
            <span class="text-sm text-muted-foreground">Room Under 2nd Apron</span>
            <span class="tabular-nums text-sm font-medium <%= room_under_color.call(room_a2) %>"><%= room_a2 ? format_room_amount(room_a2) : "—" %></span>
          </div>
        </div>
      </div>

      <%# Season ledger (replaces table footer totals in main canvas) %>
      <div class="mt-2 border-t border-border pt-4">
        <div class="flex items-center justify-between mb-2">
          <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Season Ledger</div>
          <div class="text-[10px] text-muted-foreground tabular-nums">Roster Cost · Cap Space</div>
        </div>

        <div class="overflow-x-auto rounded-lg border border-border/60">
          <table class="min-w-full text-[11px]">
            <thead class="bg-muted/20 text-muted-foreground uppercase tracking-wide text-[10px]">
              <tr>
                <th class="text-left px-2 py-1.5 font-medium">Year</th>
                <th class="text-right px-2 py-1.5 font-medium">Roster Cost</th>
                <th class="text-right px-2 py-1.5 font-medium">Cap Space</th>
                <th class="text-right px-2 py-1.5 font-medium" data-show="$displaytaxaprons">Tax Status</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-border/50">
              <% projection_years.each do |ledger_year| %>
                <% ledger = summaries_by_year[ledger_year] || {} %>
                <% ledger_cap_total = ledger["cap_total"] %>
                <% ledger_cap_space = ledger["cap_space"] %>
                <% ledger_status = ledger.empty? ? { label: "—", value: "—", variant: "muted" } : tax_status(ledger) %>
                <% ledger_status_label = ledger_status[:label] == "Under Tax" ? "Under" : ledger_status[:label] %>
                <% ledger_cap_space_class = ledger_cap_space.nil? ? nil : (ledger_cap_space.to_f >= 0 ? "text-emerald-600 dark:text-emerald-400" : "text-red-500") %>
                <% highlight = ledger_year.to_i == year.to_i %>
                <tr class="<%= highlight ? 'bg-yellow-50/70 dark:bg-yellow-900/10' : '' %>">
                  <td class="px-2 py-1.5 tabular-nums"><%= format_year_label(ledger_year) %></td>
                  <td class="px-2 py-1.5 text-right tabular-nums"><%= ledger_cap_total ? format_compact_currency(ledger_cap_total) : "—" %></td>
                  <td class="px-2 py-1.5 text-right tabular-nums <%= ledger_cap_space_class %>"><%= ledger_cap_space ? format_room_amount(ledger_cap_space) : "—" %></td>
                  <td class="px-2 py-1.5 text-right" data-show="$displaytaxaprons">
                    <div class="flex flex-col items-end leading-tight">
                      <span class="inline-flex px-1.5 py-px rounded text-[10px] font-medium leading-none <%= status_badge_class_for.call(ledger_status[:label]) %>"><%= ledger_status_label %></span>
                      <span class="tabular-nums text-[10px] <%= status_value_class_for.call(ledger_status[:variant]) %>"><%= ledger_status[:value] %></span>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>

      <%# Salary Projection mini-chart %>
      <div class="border-t border-border pt-4 pb-2">
        <div class="space-y-2">
          <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Salary Projection</div>
          <div class="flex items-end gap-1 h-20">
            <%
              cap_totals = projection_years.map { |y| (summaries_by_year[y] || {})["cap_total"].to_f }
              max_val = [cap_totals.max || 1, 1].max
            %>
            <% projection_years.each_with_index do |proj_year, i| %>
              <%
                val = cap_totals[i] || 0
                height_pct = [(val / max_val * 100).round, 4].max
              %>
              <div class="flex-1 flex flex-col items-center gap-1 h-full">
                <div class="flex-1 w-full flex items-end">
                  <div
                    class="w-full rounded-t transition-all duration-300 <%= val > 0 ? 'bg-blue-500/80' : 'bg-muted' %>"
                    style="height: <%= height_pct %>%;"
                  ></div>
                </div>
                <span class="text-[10px] text-muted-foreground tabular-nums"><%= format_year_label(proj_year) %></span>
              </div>
            <% end %>
          </div>
        </div>
      </div>

    <% end %>
  </div>

  <%= render partial: "tools/salary_book/sidebar_team_tab_draft", locals: {
    team_code:,
    year:,
    draft_assets:
  } %>

  <%= render partial: "tools/salary_book/sidebar_team_tab_rights", locals: {
    rights_by_kind:
  } %>

  <div data-show="$sidebartab === 'injuries'" class="border-t border-border pt-4">
    <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground mb-2">Injuries</div>
    <div class="p-3 rounded-lg bg-muted/30 border border-border/50 text-sm text-muted-foreground italic">
      Data unavailable (no confirmed <code>pcms.*</code> injury source table yet).
    </div>
  </div>

  <%= render partial: "tools/salary_book/sidebar_team_tab_stats", locals: {
    stats_by_year:,
    year:
  } %>
</div>
