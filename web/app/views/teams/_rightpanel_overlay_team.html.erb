<%
  team = team_row || {}

  team_id = team["team_id"]
  team_code = team["team_code"].to_s
  team_name = team["team_name"].to_s
  conference_name = team["conference_name"].presence || "—"
  city_name = team["city"].presence

  pressure_bucket = team["pressure_bucket"].to_s
  pressure_label, pressure_chip_classes = case pressure_bucket
    when "over_apron2"
      ["Over Apron 2", "entity-chip entity-chip--danger"]
    when "over_apron1"
      ["Over Apron 1", "entity-chip entity-chip--warning"]
    when "over_tax"
      ["Over Tax", "entity-chip entity-chip--warning"]
    when "over_cap"
      ["Over Cap", "entity-chip entity-chip--muted"]
    else
      ["Under Cap", "entity-chip entity-chip--success"]
    end

  team_page_href = team_href(team_code: team_code, team_id: team_id)

  team_summary_pressure = case pressure_bucket
    when "over_apron2", "over_apron1", "over_tax"
      pressure_bucket
    else
      "all"
    end
  team_summary_conference = %w[Eastern Western].include?(conference_name) ? conference_name : "all"
  team_summary_href = team_summary_path(
    year: 2025,
    conference: team_summary_conference,
    pressure: team_summary_pressure,
    sort: "team_asc"
  ) + "#team-summary-row-#{team_code.downcase}"

  salary_book_href = "/?team=#{team_code}##{team_code}"

  refresh_query_expr = "'q=' + encodeURIComponent($teamsquery) +
    '&conference=' + encodeURIComponent($teamsconference) +
    '&pressure=' + encodeURIComponent($teamspressure) +
    '&sort=' + encodeURIComponent($teamssort) +
    '&compare_a=' + encodeURIComponent($comparea) +
    '&compare_b=' + encodeURIComponent($compareb) +
    '&selected_id=' + encodeURIComponent('#{team_id}')"

  pin_a_expr = "@get('/teams/sse/refresh?' + (#{refresh_query_expr}) + '&action=pin&slot=a&team_id=#{team_id}')"
  pin_b_expr = "@get('/teams/sse/refresh?' + (#{refresh_query_expr}) + '&action=pin&slot=b&team_id=#{team_id}')"
  clear_a_expr = "@get('/teams/sse/refresh?' + (#{refresh_query_expr}) + '&action=clear_slot&slot=a')"
  clear_b_expr = "@get('/teams/sse/refresh?' + (#{refresh_query_expr}) + '&action=clear_slot&slot=b')"
%>

<div id="rightpanel-overlay" class="h-full">
  <div class="sticky top-0 z-20 h-10 px-4 flex items-center justify-between border-b border-border bg-background">
    <button
      type="button"
      class="cursor-pointer flex items-center gap-1.5 text-sm transition-colors text-muted-foreground hover:text-foreground"
      data-on:click="$overlaytype = 'none'; $selectedteamid = ''; @get('/teams/sidebar/clear')"
    >
      <%= lucide_icon("arrow-left", class: "w-4 h-4", "aria-hidden": true) %>
      <span class="font-medium">Back</span>
    </button>

    <a href="<%= team_page_href %>" class="text-xs text-muted-foreground hover:text-foreground hover:underline">Open team page</a>
  </div>

  <div class="px-4 pb-4 pt-4 space-y-5">
    <div class="flex items-center gap-3">
      <div class="w-12 h-12 rounded border border-border bg-background overflow-hidden flex items-center justify-center">
        <img
          src="<%= team_logo_url(team_id) %>"
          alt="<%= team_code %>"
          class="w-full h-full object-contain"
          loading="lazy"
          decoding="async"
          onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
        />
        <span class="hidden text-[10px] font-semibold text-muted-foreground"><%= team_code %></span>
      </div>

      <div class="min-w-0 space-y-1">
        <h2 class="text-lg font-semibold text-foreground truncate"><%= team_name %></h2>
        <div class="text-xs text-muted-foreground/80 tabular-nums flex items-center gap-1">
          <span><%= team_code %></span>
          <span class="text-muted-foreground/50">·</span>
          <span><%= conference_name %></span>
          <% if city_name.present? %>
            <span class="text-muted-foreground/50">·</span>
            <span><%= city_name %></span>
          <% end %>
        </div>

        <div class="flex flex-wrap items-center gap-1.5" data-on:click="evt.stopPropagation()" data-on:keydown="evt.stopPropagation()">
          <button
            type="button"
            class="cursor-pointer h-5 px-1.5 rounded border border-border/70 text-[10px] font-semibold uppercase tracking-wide text-muted-foreground hover:text-foreground hover:border-foreground/30 transition-colors"
            aria-label="Pin <%= team_name %> to compare slot A"
            title="Pin to compare slot A"
            data-class="{ 'border-indigo-500/60 bg-indigo-500/10 text-indigo-700 dark:text-indigo-300': $comparea === '<%= team_id %>' }"
            data-on:click="<%= pin_a_expr %>"
          >Pin A</button>

          <button
            type="button"
            class="cursor-pointer h-5 px-1.5 rounded border border-border/70 text-[10px] font-semibold uppercase tracking-wide text-muted-foreground hover:text-foreground hover:border-foreground/30 transition-colors"
            aria-label="Pin <%= team_name %> to compare slot B"
            title="Pin to compare slot B"
            data-class="{ 'border-emerald-500/60 bg-emerald-500/10 text-emerald-700 dark:text-emerald-300': $compareb === '<%= team_id %>' }"
            data-on:click="<%= pin_b_expr %>"
          >Pin B</button>

          <button
            type="button"
            class="cursor-pointer h-5 px-1.5 rounded border border-border/70 text-[10px] uppercase tracking-wide text-muted-foreground hover:text-foreground hover:border-foreground/30 transition-colors"
            data-show="$comparea === '<%= team_id %>'"
            style="display: none;"
            aria-label="Clear compare slot A"
            title="Clear compare slot A"
            data-on:click="<%= clear_a_expr %>"
          >Clear A</button>

          <button
            type="button"
            class="cursor-pointer h-5 px-1.5 rounded border border-border/70 text-[10px] uppercase tracking-wide text-muted-foreground hover:text-foreground hover:border-foreground/30 transition-colors"
            data-show="$compareb === '<%= team_id %>'"
            style="display: none;"
            aria-label="Clear compare slot B"
            title="Clear compare slot B"
            data-on:click="<%= clear_b_expr %>"
          >Clear B</button>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-2 gap-1.5 border-t border-border pt-4">
      <%= render partial: "salary_book/kpi_cell", locals: {
        label: "Cap space",
        value: team["cap_space"].nil? ? "—" : format_room_amount(team["cap_space"]),
        class_name: "w-full",
        variant: (team["cap_space"].to_f < 0 ? "negative" : "positive")
      } %>

      <%= render partial: "salary_book/kpi_cell", locals: {
        label: "Room tax",
        value: team["room_under_tax"].nil? ? "—" : format_room_amount(team["room_under_tax"]),
        class_name: "w-full",
        variant: (team["room_under_tax"].to_f < 0 ? "negative" : "default")
      } %>

      <%= render partial: "salary_book/kpi_cell", locals: {
        label: "Room A1",
        value: team["room_under_apron1"].nil? ? "—" : format_room_amount(team["room_under_apron1"]),
        class_name: "w-full",
        variant: (team["room_under_apron1"].to_f < 0 ? "negative" : "default")
      } %>

      <%= render partial: "salary_book/kpi_cell", locals: {
        label: "Room A2",
        value: team["room_under_apron2"].nil? ? "—" : format_room_amount(team["room_under_apron2"]),
        class_name: "w-full",
        variant: (team["room_under_apron2"].to_f < 0 ? "negative" : "default")
      } %>
    </div>

    <div class="border-t border-border pt-4 space-y-2">
      <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Pressure signals</div>

      <div class="space-y-0.5">
        <div class="flex items-center justify-between py-1.5 gap-2">
          <span class="text-sm text-muted-foreground">Current bucket</span>
          <span class="<%= pressure_chip_classes %>"><%= pressure_label %></span>
        </div>

        <div class="flex items-center justify-between py-1.5 gap-2">
          <span class="text-sm text-muted-foreground">Luxury tax owed</span>
          <span class="text-sm font-medium font-mono tabular-nums <%= team['luxury_tax_owed'].to_f > 0 ? 'text-red-600 dark:text-red-400' : 'text-muted-foreground' %>"><%= team["luxury_tax_owed"].to_f > 0 ? format_compact_currency(team["luxury_tax_owed"]) : "—" %></span>
        </div>

        <div class="flex items-center justify-between py-1.5 gap-2">
          <span class="text-sm text-muted-foreground">Roster / Two-way</span>
          <span class="text-sm font-medium font-mono tabular-nums"><%= team["roster_row_count"].to_i %> / <%= team["two_way_row_count"].to_i %></span>
        </div>
      </div>

      <div class="pt-1 flex flex-wrap gap-1.5">
        <% if team["is_taxpayer"] %>
          <span class="entity-chip entity-chip--warning">Taxpayer</span>
        <% end %>
        <% if team["is_repeater_taxpayer"] %>
          <span class="entity-chip entity-chip--danger">Repeater</span>
        <% end %>
        <% if team["is_subject_to_apron"] %>
          <span class="entity-chip entity-chip--accent"><%= team["apron_level_lk"].presence || "Apron" %></span>
        <% end %>
      </div>
    </div>

    <div class="border-t border-border pt-4 space-y-2">
      <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Pivots</div>
      <div class="flex flex-col gap-1.5 text-sm">
        <a href="<%= team_page_href %>" class="text-muted-foreground hover:text-foreground hover:underline">Open canonical team page</a>
        <a href="<%= team_summary_href %>" class="text-muted-foreground hover:text-foreground hover:underline">Open Team Summary at this team</a>
        <a href="<%= salary_book_href %>" class="text-muted-foreground hover:text-foreground hover:underline">Open Salary Book for <%= team_code %></a>
      </div>
    </div>
  </div>
</div>
