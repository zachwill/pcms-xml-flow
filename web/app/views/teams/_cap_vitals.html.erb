<%#
  Cap Vitals — PuckPedia-inspired compact KPI strip for team cap posture.

  locals:
  - team_salary_row: (Hash) row from team_salary_warehouse (current year)
  - team_code: (String) team abbreviation
%>

<% row = local_assigns[:team_salary_row] || {} %>
<% team_code = local_assigns[:team_code].to_s %>

<% cap_total = row["cap_total_hold"] || row["cap_total"] %>
<% room_tax = row["room_under_tax"] %>
<% room_a1 = row["room_under_apron1"] %>
<% room_a2 = row["room_under_apron2"] %>
<% is_taxpayer = row["is_taxpayer"] %>
<% is_repeater = row["is_repeater_taxpayer"] %>
<% apron_level = row["apron_level_lk"] %>
<% roster_count = row["roster_row_count"].to_i %>
<% fa_count = row["fa_row_count"].to_i %>
<% two_way_count = row["two_way_row_count"].to_i %>
<% luxury_tax = row["luxury_tax_owed"] %>

<section class="space-y-3">
  <div class="flex items-center justify-between">
    <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Cap vitals (current year)</h2>
    <% if team_code.present? %>
      <a href="/?team=<%= team_code %>#<%= team_code %>" class="text-xs text-muted-foreground hover:text-foreground hover:underline">View in Salary Book →</a>
    <% end %>
  </div>

  <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3">
    <%# Threshold Rooms %>
    <div class="rounded-lg border border-border bg-background p-3">
      <div class="text-[10px] uppercase tracking-wide text-muted-foreground font-medium">Tax Room</div>
      <div class="mt-1 text-lg font-semibold font-mono tabular-nums <%= room_amount_color(room_tax) %>"><%= format_room_amount(room_tax) %></div>
    </div>

    <div class="rounded-lg border border-border bg-background p-3">
      <div class="text-[10px] uppercase tracking-wide text-muted-foreground font-medium">1st Apron</div>
      <div class="mt-1 text-lg font-semibold font-mono tabular-nums <%= room_amount_color(room_a1) %>"><%= format_room_amount(room_a1) %></div>
    </div>

    <div class="rounded-lg border border-border bg-background p-3">
      <div class="text-[10px] uppercase tracking-wide text-muted-foreground font-medium">2nd Apron</div>
      <div class="mt-1 text-lg font-semibold font-mono tabular-nums <%= room_amount_color(room_a2) %>"><%= format_room_amount(room_a2) %></div>
    </div>

    <%# Total Cap + Tax %>
    <div class="rounded-lg border border-border bg-background p-3">
      <div class="text-[10px] uppercase tracking-wide text-muted-foreground font-medium">Cap Total</div>
      <div class="mt-1 text-lg font-semibold font-mono tabular-nums"><%= format_salary(cap_total) %></div>
      <% if luxury_tax.present? && luxury_tax.to_f > 0 %>
        <div class="mt-0.5 text-[10px] text-muted-foreground">Tax: <span class="font-mono text-red-600 dark:text-red-400"><%= format_salary(luxury_tax) %></span></div>
      <% end %>
    </div>

    <%# Roster Slots %>
    <div class="rounded-lg border border-border bg-background p-3">
      <div class="text-[10px] uppercase tracking-wide text-muted-foreground font-medium">Roster</div>
      <div class="mt-1 text-lg font-semibold font-mono tabular-nums"><%= roster_count %><span class="text-sm text-muted-foreground">/15</span></div>
      <div class="mt-0.5 text-[10px] text-muted-foreground">2W: <span class="font-mono"><%= two_way_count %>/3</span> · FA: <span class="font-mono"><%= fa_count %></span></div>
    </div>

    <%# Status Chips %>
    <div class="rounded-lg border border-border bg-background p-3">
      <div class="text-[10px] uppercase tracking-wide text-muted-foreground font-medium">Status</div>
      <div class="mt-1.5 flex flex-wrap gap-1">
        <% if apron_level.present? && apron_level != "NONE" %>
          <span class="inline-block px-1.5 py-0.5 rounded text-[10px] font-medium
            <%= apron_level.include?("2") ? 'bg-red-100 text-red-700 dark:bg-red-800/40 dark:text-red-300' : 'bg-orange-100 text-orange-700 dark:bg-orange-800/40 dark:text-orange-300' %>
          "><%= apron_level.include?("2") ? "Hard-cap (A2)" : "Apron 1" %></span>
        <% end %>
        <% if is_repeater %>
          <span class="inline-block px-1.5 py-0.5 rounded text-[10px] font-medium bg-purple-100 text-purple-700 dark:bg-purple-800/40 dark:text-purple-300">Repeater</span>
        <% elsif is_taxpayer %>
          <span class="inline-block px-1.5 py-0.5 rounded text-[10px] font-medium bg-amber-100 text-amber-700 dark:bg-amber-800/40 dark:text-amber-300">Taxpayer</span>
        <% else %>
          <span class="inline-block px-1.5 py-0.5 rounded text-[10px] font-medium bg-emerald-100 text-emerald-700 dark:bg-emerald-800/40 dark:text-emerald-300">Under tax</span>
        <% end %>
      </div>
    </div>
  </div>
</section>
