<% players = Array(local_assigns[:players]) %>
<% query = local_assigns[:query].to_s %>
<% seq = local_assigns.fetch(:seq, 0).to_i %>
<% team_code = local_assigns[:team_code].to_s.strip.upcase.presence %>
<% error_message = local_assigns[:error_message].to_s.strip.presence %>
<%
  error_label = "Unable to load players"

  empty_message = if error_message.present?
    error_label
  elsif query.present?
    "No players found"
  elsif team_code.present?
    "No players on #{team_code}"
  else
    "Type to search players"
  end

  scope_label = if query.present?
    "query: #{query.first(24)}"
  elsif team_code.present?
    "team: #{team_code}"
  else
    "all players"
  end

  age_percentiles = age_percentiles_by_player_id(players)
%>

<div
  id="sbplayercb-popup"
  class="w-full overflow-hidden rounded-md bg-background ring-1 ring-border/60"
  data-show="$_sbplayercbopen"
  style="display: none;"
  data-seq="<%= seq %>"
  data-effect="
    const seq = Number(el.dataset.seq || 0);
    if (seq === Number($_sbplayercbrequestseq)) {
      $_sbplayercbloading = false;

      const optioncount = el.querySelectorAll('[data-combobox-option]').length;
      $_sbplayercbresultscount = optioncount;

      if (optioncount <= 0) {
        $_sbplayercbactiveindex = -1;
      } else {
        const activeindex = Number($_sbplayercbactiveindex);
        if (activeindex < 0 || activeindex >= optioncount) {
          $_sbplayercbactiveindex = 0;
        }
      }
    }
  "
>
  <div
    id="sbplayercb-status"
    class="h-6 px-2 border-b border-border/50 flex items-center justify-between text-[10px] uppercase tracking-wide text-muted-foreground/90"
    role="status"
    aria-live="polite"
  >
    <div class="min-w-0 truncate">
      <span data-show="$_sbplayercbloading" style="display: none;">Searching playersâ€¦</span>

      <span data-show="!$_sbplayercbloading">
        <% if error_message.present? %>
          <%= error_label %>
        <% elsif players.any? %>
          <%= pluralize(players.length, "result") %>
        <% else %>
          <%= empty_message %>
        <% end %>
      </span>
    </div>

    <% if players.any? %>
      <span
        class="font-mono tabular-nums text-[10px] text-muted-foreground/70"
        data-show="!$_sbplayercbloading"
      ><%= scope_label %></span>
    <% end %>
  </div>

  <div id="sbplayercb-list" role="listbox" class="max-h-80 overflow-y-auto overscroll-contain py-1">
    <% if players.any? %>
      <% players.each_with_index do |player, index| %>
        <%= render partial: "salary_book/combobox_players_option", locals: {
          player:,
          index:,
          age_percentile: age_percentiles[player["player_id"]]
        } %>
      <% end %>
    <% else %>
      <div class="px-3 py-2 text-xs text-muted-foreground"><%= empty_message %></div>
    <% end %>
  </div>
</div>
