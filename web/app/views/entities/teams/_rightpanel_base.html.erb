<% if @sidebar_summary.present? %>
  <% summary = @sidebar_summary %>
  <% top_rows = Array(summary[:top_rows]) %>
  <% compare_a_row = summary[:compare_a_row] %>
  <% compare_b_row = summary[:compare_b_row] %>
  <% compare_slots = [
    { key: "a", label: "Slot A", row: compare_a_row, tone: "indigo" },
    { key: "b", label: "Slot B", row: compare_b_row, tone: "emerald" }
  ] %>
  <% has_compare = compare_slots.any? { |slot| slot[:row].present? } %>
  <% pressure_counts = summary[:pressure_counts] || {} %>
  <% active_pressure_lens = summary[:active_pressure_lens].to_s.presence || "all" %>
  <% active_pressure_label = summary[:active_pressure_label].presence || "All teams" %>
  <% active_pressure_count = summary[:active_pressure_count].to_i %>
  <% pressure_options = [
    ["all", "All teams"],
    ["over_cap", "Over Cap"],
    ["over_tax", "Over Tax"],
    ["over_apron1", "Over Apron 1"],
    ["over_apron2", "Over Apron 2"]
  ] %>

  <% if compare_a_row.present? && compare_b_row.present? %>
    <% compare_cap_delta = compare_b_row["cap_space"].to_f - compare_a_row["cap_space"].to_f %>
    <% compare_tax_delta = compare_b_row["room_under_tax"].to_f - compare_a_row["room_under_tax"].to_f %>
    <% compare_apron1_delta = compare_b_row["room_under_apron1"].to_f - compare_a_row["room_under_apron1"].to_f %>
  <% end %>

  <% refresh_query_expr = "'q=' + encodeURIComponent($teamsquery) +
    '&conference=' + encodeURIComponent($teamsconference) +
    '&pressure=' + encodeURIComponent($teamspressure) +
    '&sort=' + encodeURIComponent($teamssort) +
    '&compare_a=' + encodeURIComponent($comparea) +
    '&compare_b=' + encodeURIComponent($compareb) +
    '&selected_id=' + encodeURIComponent($overlaytype === 'team' ? $selectedteamid : '')" %>

  <div id="rightpanel-base" class="space-y-4">
    <div class="rounded-lg border border-border bg-background p-3 space-y-3">
      <div>
        <div class="text-[10px] uppercase tracking-wide text-muted-foreground/80">Workspace snapshot</div>
        <div class="text-sm font-semibold text-foreground">
          Teams
          <span class="text-muted-foreground font-medium">· <%= summary[:row_count].to_i %> rows</span>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-1.5">
        <%= render partial: "tools/salary_book/kpi_cell", locals: {
          label: "Rows",
          value: summary[:row_count].to_i.to_s,
          class_name: "w-full"
        } %>

        <%= render partial: "tools/salary_book/kpi_cell", locals: {
          label: "Tax owed",
          value: format_compact_currency(summary[:luxury_tax_total]),
          class_name: "w-full",
          value_class_name: "text-[11px]"
        } %>

        <%= render partial: "tools/salary_book/kpi_cell", locals: {
          label: "East",
          value: summary[:eastern_count].to_i.to_s,
          class_name: "w-full"
        } %>

        <%= render partial: "tools/salary_book/kpi_cell", locals: {
          label: "West",
          value: summary[:western_count].to_i.to_s,
          class_name: "w-full"
        } %>
      </div>

      <div class="grid grid-cols-2 gap-1.5">
        <%= render partial: "tools/salary_book/kpi_cell", locals: {
          label: "Over cap",
          value: summary[:over_cap_count].to_i.to_s,
          class_name: "w-full"
        } %>

        <%= render partial: "tools/salary_book/kpi_cell", locals: {
          label: "Over tax",
          value: summary[:over_tax_count].to_i.to_s,
          class_name: "w-full"
        } %>

        <%= render partial: "tools/salary_book/kpi_cell", locals: {
          label: "Over A1",
          value: summary[:over_apron1_count].to_i.to_s,
          class_name: "w-full"
        } %>

        <%= render partial: "tools/salary_book/kpi_cell", locals: {
          label: "Over A2",
          value: summary[:over_apron2_count].to_i.to_s,
          class_name: "w-full"
        } %>
      </div>

      <% active_chip_classes = case active_pressure_lens
        when "over_apron2"
          "entity-chip entity-chip--danger"
        when "over_apron1"
          "entity-chip entity-chip--warning"
        when "over_tax"
          "entity-chip entity-chip--warning"
        when "over_cap"
          "entity-chip entity-chip--muted"
        else
          "entity-chip entity-chip--success"
        end %>

      <div class="rounded border border-border/70 bg-muted/20 px-2 py-2 space-y-1.5">
        <div class="flex items-center justify-between gap-2 text-[10px] uppercase tracking-wide text-muted-foreground/80">
          <span>Active pressure posture</span>
          <span class="font-mono tabular-nums normal-case tracking-normal"><%= active_pressure_count %> rows</span>
        </div>

        <div class="flex items-center gap-2">
          <span class="<%= active_chip_classes %>"><%= active_pressure_label %></span>
          <span class="text-[10px] text-muted-foreground/80">Current search/conference scope</span>
        </div>

        <div class="grid grid-cols-2 gap-1 text-[10px] tabular-nums">
          <% pressure_options.each do |lens, label| %>
            <div class="flex items-center justify-between rounded border px-1.5 py-1"
                 data-class="{ 'border-primary/40 bg-primary/10': $teamspressure === '<%= lens %>', 'border-border/60 bg-background': $teamspressure !== '<%= lens %>' }">
              <span class="truncate" data-class="{ 'text-foreground font-medium': $teamspressure === '<%= lens %>', 'text-muted-foreground': $teamspressure !== '<%= lens %>' }"><%= label %></span>
              <span class="font-mono"><%= pressure_counts[lens].to_i %></span>
            </div>
          <% end %>
        </div>
      </div>

      <% if Array(summary[:filters]).any? %>
        <div class="pt-1 flex flex-wrap gap-1">
          <% Array(summary[:filters]).each do |label| %>
            <span class="entity-chip entity-chip--muted"><%= label %></span>
          <% end %>
        </div>
      <% end %>
    </div>

    <div class="rounded-lg border border-border bg-background p-3 space-y-2">
      <div class="flex items-center justify-between gap-2">
        <div class="text-[10px] uppercase tracking-wide font-semibold text-muted-foreground/80">Compare slots</div>
        <% if has_compare %>
          <button
            type="button"
            class="cursor-pointer text-[10px] text-muted-foreground hover:text-foreground hover:underline"
            data-on:click="@get('/teams/sse/refresh?' + (<%= refresh_query_expr %>) + '&action=clear_all')"
          >Clear all</button>
        <% end %>
      </div>

      <div class="grid grid-cols-2 gap-2 text-[11px]">
        <% compare_slots.each do |slot| %>
          <% row = slot[:row] %>
          <% slot_badge_class = slot[:tone] == "indigo" ? "text-indigo-700 dark:text-indigo-300 border-indigo-500/40 bg-indigo-500/10" : "text-emerald-700 dark:text-emerald-300 border-emerald-500/40 bg-emerald-500/10" %>
          <div class="rounded border border-border px-2 py-1.5 space-y-1">
            <div class="flex items-center justify-between gap-1">
              <span class="inline-flex items-center rounded border px-1 py-0.5 text-[9px] font-semibold uppercase tracking-wide <%= slot_badge_class %>"><%= slot[:label] %></span>
              <% if row.present? %>
                <button
                  type="button"
                  class="cursor-pointer text-[9px] text-muted-foreground hover:text-foreground hover:underline"
                  data-on:click="@get('/teams/sse/refresh?' + (<%= refresh_query_expr %>) + '&action=clear_slot&slot=<%= slot[:key] %>')"
                >Clear</button>
              <% end %>
            </div>

            <% if row.present? %>
              <% team_id = row["team_id"] %>
              <button
                type="button"
                class="cursor-pointer w-full text-left"
                data-on:click="$selectedteamid = '<%= team_id %>'; $overlaytype = 'team'; @get('/teams/sidebar/<%= team_id %>')"
              >
                <div class="font-medium truncate"><%= row["team_name"] %></div>
                <div class="mt-0.5 text-[10px] text-muted-foreground/80 tabular-nums"><%= row["team_code"] %> · <%= format_room_amount(row["cap_space"]) %></div>
              </button>
            <% else %>
              <div class="text-[10px] text-muted-foreground italic">No team pinned.</div>
            <% end %>
          </div>
        <% end %>
      </div>

      <% if compare_a_row.present? && compare_b_row.present? %>
        <div class="rounded border border-border/60 bg-muted/20 px-2 py-1.5 text-[10px] tabular-nums flex flex-wrap gap-2">
          <span class="font-medium text-muted-foreground"><%= compare_b_row["team_code"] %> vs <%= compare_a_row["team_code"] %></span>
          <span class="<%= compare_cap_delta >= 0 ? 'text-emerald-600 dark:text-emerald-400' : 'text-red-600 dark:text-red-400' %>">Cap <%= format_room_amount(compare_cap_delta) %></span>
          <span class="<%= compare_tax_delta >= 0 ? 'text-emerald-600 dark:text-emerald-400' : 'text-red-600 dark:text-red-400' %>">Tax <%= format_room_amount(compare_tax_delta) %></span>
          <span class="<%= compare_apron1_delta >= 0 ? 'text-emerald-600 dark:text-emerald-400' : 'text-red-600 dark:text-red-400' %>">A1 <%= format_room_amount(compare_apron1_delta) %></span>
        </div>
      <% end %>
    </div>

    <div class="rounded-lg border border-border bg-background">
      <div class="px-3 py-2 border-b border-border text-[10px] uppercase tracking-wide text-muted-foreground/80">
        Pressure board
      </div>

      <% if top_rows.empty? %>
        <div class="p-3 text-sm text-muted-foreground italic">No rows.</div>
      <% else %>
        <div class="divide-y divide-border">
          <% top_rows.each do |row| %>
            <% team_id = row["team_id"] %>
            <% team_code = row["team_code"].to_s %>
            <% pressure_bucket = row["pressure_bucket"].to_s %>
            <% pressure_label, pressure_classes = case pressure_bucket
              when "over_apron2"
                ["Over Apron 2", "text-red-600 dark:text-red-400"]
              when "over_apron1"
                ["Over Apron 1", "text-orange-600 dark:text-orange-400"]
              when "over_tax"
                ["Over Tax", "text-orange-600 dark:text-orange-400"]
              when "over_cap"
                ["Over Cap", "text-muted-foreground"]
              else
                ["Under Cap", "text-emerald-600 dark:text-emerald-400"]
              end %>
            <% open_expr = "$selectedteamid = '#{team_id}'; $overlaytype = 'team'; @get('/teams/sidebar/#{team_id}')" %>

            <button
              type="button"
              class="cursor-pointer w-full px-3 py-2 text-left hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 transition-colors duration-75"
              data-class="{ 'bg-yellow-100/80 dark:bg-yellow-900/20': $selectedteamid === '<%= team_id %>' }"
              data-on:click="<%= open_expr %>"
            >
              <div class="entity-cell-two-line">
                <div class="entity-cell-primary justify-between gap-2">
                  <a href="<%= team_href(team_code: team_code, team_id: team_id) %>" class="truncate font-medium hover:underline" onclick="event.stopPropagation()"><%= row["team_name"] %></a>
                  <span class="font-mono tabular-nums text-[11px] shrink-0 <%= row['room_under_apron2'].to_f < 0 ? 'text-red-600 dark:text-red-400' : '' %>"><%= row["room_under_apron2"].nil? ? "—" : format_room_amount(row["room_under_apron2"]) %></span>
                </div>
                <div class="entity-cell-secondary justify-between gap-2">
                  <span class="truncate <%= pressure_classes %>"><%= pressure_label %></span>
                  <span class="font-mono tabular-nums text-[10px]"><%= row["luxury_tax_owed"].to_f > 0 ? format_compact_currency(row["luxury_tax_owed"]) : "—" %></span>
                </div>
              </div>
            </button>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
<% elsif @team_id.present? %>
  <div id="rightpanel-base" class="space-y-4">
    <%= render partial: "entities/shared/known_slugs", locals: {
      entity_type: "team",
      entity_id: @team_id,
      path_prefix: "teams"
    } %>
  </div>
<% else %>
  <div id="rightpanel-base" class="space-y-4">
    <div class="p-4 rounded-lg border border-border bg-muted/20 text-sm text-muted-foreground">
      Select a team row to inspect cap pressure details.
    </div>
  </div>
<% end %>
