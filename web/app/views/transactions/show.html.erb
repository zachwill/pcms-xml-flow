<% tx = @transaction %>
<% content_for :title, "Transaction ##{tx['transaction_id']}" %>

<% prefetch_canonical_slugs(entity_type: "player", entity_ids: [tx["player_id"]] + @trade_transactions.map { |r| r["player_id"] } + @cap_exception_usage_rows.map { |r| r["player_id"] } + @cap_dead_money_rows.map { |r| r["player_id"] } + @cap_budget_snapshot_rows.map { |r| r["player_id"] }) %>
<% prefetch_canonical_slugs(entity_type: "team", entity_ids: [tx["from_team_id"], tx["to_team_id"], tx["rights_team_id"], tx["sign_and_trade_team_id"]] + @ledger_entries.map { |r| r["team_id"] } + @cap_exception_usage_rows.map { |r| r["team_id"] } + @cap_dead_money_rows.map { |r| r["team_id"] } + @cap_budget_snapshot_rows.map { |r| r["team_id"] }) %>

<%
  party_rows = []
  {
    "From" => [tx["from_team_code"], tx["from_team_id"], tx["from_team_name"]],
    "To" => [tx["to_team_code"], tx["to_team_id"], tx["to_team_name"]],
    "Rights" => [tx["rights_team_code"], tx["rights_team_id"], tx["rights_team_name"]],
    "S&T" => [tx["sign_and_trade_team_code"], tx["sign_and_trade_team_id"], tx["sign_and_trade_team_name"]]
  }.each do |role, tuple|
    code, id, name = tuple
    next if code.blank? && id.blank?

    party_rows << { role: role, team_code: code, team_id: id, team_name: name }
  end

  delta_by_team = @ledger_entries.group_by { |r| [r["team_id"], r["team_code"]] }.transform_values do |rows|
    {
      cap_change: rows.sum { |v| v["cap_change"].to_f },
      tax_change: rows.sum { |v| v["tax_change"].to_f },
      apron_change: rows.sum { |v| v["apron_change"].to_f },
      mts_change: rows.sum { |v| v["mts_change"].to_f }
    }
  end

  timeline_ledger_rows = @ledger_entries.sort_by do |row|
    parsed_date = begin
      Date.parse(row["ledger_date"].to_s)
    rescue ArgumentError, TypeError
      nil
    end

    [parsed_date || Date.new(1900, 1, 1), row["transaction_ledger_entry_id"].to_i]
  end

  net_cap_change = @ledger_entries.sum { |row| row["cap_change"].to_f }
  net_tax_change = @ledger_entries.sum { |row| row["tax_change"].to_f }
  net_apron_change = @ledger_entries.sum { |row| row["apron_change"].to_f }

  route_label = [tx["from_team_code"], tx["to_team_code"]].compact.reject(&:blank?).join(" → ").presence || "—"

  artifact_row_count = @cap_exception_usage_rows.size + @cap_dead_money_rows.size + @cap_budget_snapshot_rows.size

  timeline_phase_keys = %w[all facts parties ledger artifacts]
  active_timeline_phase = params[:phase].to_s.strip.downcase
  active_timeline_phase = "all" unless timeline_phase_keys.include?(active_timeline_phase)

  timeline_phase_options = [
    { key: "all", label: "All", count: 1 + party_rows.size + timeline_ledger_rows.size + artifact_row_count, chip_class: "entity-chip--muted" },
    { key: "facts", label: "Facts", count: 1, chip_class: "entity-chip--accent" },
    { key: "parties", label: "Parties", count: party_rows.size, chip_class: "entity-chip--muted" },
    { key: "ledger", label: "Ledger", count: timeline_ledger_rows.size, chip_class: "entity-chip--accent" },
    { key: "artifacts", label: "Artifacts", count: artifact_row_count, chip_class: "entity-chip--warning" }
  ]

  constraint_chips = []
  constraint_chips << ["Touches trade ##{tx['trade_id']}", "entity-chip--accent"] if tx["trade_id"].present?
  constraint_chips << ["Exception rows #{@cap_exception_usage_rows.size}", "entity-chip--warning"] if @cap_exception_usage_rows.any?
  constraint_chips << ["Dead money rows #{@cap_dead_money_rows.size}", "entity-chip--danger"] if @cap_dead_money_rows.any?
  constraint_chips << ["Budget snapshot rows #{@cap_budget_snapshot_rows.size}", "entity-chip--muted"] if @cap_budget_snapshot_rows.any?

  raw_row_json = lambda do |raw_hash|
    normalized_hash = raw_hash.to_h.each_with_object({}) do |(key, value), memo|
      next if value.nil?

      memo[key.to_s] = value
    end

    JSON.pretty_generate(normalized_hash)
  end

  numeric_delta_class = lambda do |value|
    amount = value.to_f
    if amount.positive?
      "text-emerald-600 dark:text-emerald-400"
    elsif amount.negative?
      "text-red-500"
    else
      "text-muted-foreground"
    end
  end
%>

<div id="entity-directory" class="min-h-screen w-full bg-background">
  <%= render partial: "shared/commandbar", locals: {
    active_entity_scope: "transactions"
  } %>

  <main class="px-4 pb-8 space-y-6" data-entity-workspace>
    <%= render partial: "shared/workspace_header", locals: {
      breadcrumbs: [["Transactions", "/transactions"], ["##{tx['transaction_id']}", nil]],
      title: "Transaction ##{tx['transaction_id']}",
      subtitle: [format_plain_date(tx['transaction_date']), tx['transaction_type_lk'], tx['transaction_description_lk']].compact.join(' · '),
      right_links: [["Open Salary Book", "/"], ["Open related trade", (tx['trade_id'].present? ? trade_href(tx['trade_id']) : nil)]].compact
    } %>

    <div class="lg:flex lg:gap-8">
      <%= render partial: "shared/local_nav", locals: {
        sections: [
          ["timeline", "Causal timeline"],
          ["trade-context", "Trade context"],
          ["endnotes", "Endnotes"]
        ]
      } %>

      <div class="min-w-0 flex-1 space-y-6">
        <section id="timeline" class="scroll-mt-24 space-y-3">
          <div
            id="causal-timeline"
            data-signals="{ timelinephase: '<%= active_timeline_phase %>', factsrawexpanded: false, partiesrawexpanded: false, ledgerrawexpanded: false, artifactsrawexpanded: false }"
          >
            <div class="flex flex-wrap items-center justify-between gap-2">
              <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Causal timeline</h2>
              <div class="flex flex-wrap gap-1.5 text-[10px]">
                <span class="entity-chip entity-chip--muted"><%= party_rows.size %> parties</span>
                <span class="entity-chip entity-chip--accent"><%= timeline_ledger_rows.size %> ledger rows</span>
                <span class="entity-chip entity-chip--warning"><%= artifact_row_count %> artifact rows</span>
              </div>
            </div>

            <div class="mt-2 rounded-lg border border-border/60 bg-muted/10 px-3 py-2">
              <div class="flex flex-wrap items-center gap-2">
                <span class="text-[10px] font-semibold uppercase tracking-wide text-muted-foreground">Phase filters</span>
                <% timeline_phase_options.each do |phase_option| %>
                  <button
                    type="button"
                    class="cursor-pointer inline-flex items-center gap-1 rounded-full border px-2 py-0.5 text-[10px] font-medium transition-colors"
                    data-on:click="$timelinephase = '<%= phase_option[:key] %>'; const url = new URL(window.location.href); if ('<%= phase_option[:key] %>' === 'all') { url.searchParams.delete('phase'); } else { url.searchParams.set('phase', '<%= phase_option[:key] %>'); } window.history.replaceState({}, '', url.pathname + url.search + url.hash);"
                    data-class="{ 'bg-primary text-primary-foreground border-primary': $timelinephase === '<%= phase_option[:key] %>', 'bg-background text-muted-foreground border-border hover:text-foreground hover:border-foreground/25': $timelinephase !== '<%= phase_option[:key] %>' }"
                  >
                    <span><%= phase_option[:label] %></span>
                    <span class="entity-chip <%= phase_option[:chip_class] %>"><%= phase_option[:count] %></span>
                  </button>
                <% end %>
              </div>
            </div>

            <div class="mt-2 rounded-lg border border-border overflow-hidden">
              <div class="divide-y divide-border/60">
                <div data-show="$timelinephase === 'all' || $timelinephase === 'facts'"<% unless %w[all facts].include?(active_timeline_phase) %> style="display: none;"<% end %>>
                  <article class="px-3 py-2 bg-muted/20">
                    <div class="flex items-center justify-between gap-2">
                      <div class="text-[10px] font-semibold uppercase tracking-wide text-muted-foreground">1 · Transaction facts</div>
                      <button
                        type="button"
                        class="cursor-pointer text-[10px] text-muted-foreground hover:text-foreground hover:underline"
                        data-on:click="$factsrawexpanded = !$factsrawexpanded"
                        data-text="$factsrawexpanded ? 'Hide raw rows' : 'Show raw rows'"
                      >Show raw rows</button>
                    </div>
                  </article>

                  <article class="group px-3 py-2 transition-colors duration-75 hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10">
                    <div class="flex flex-wrap items-start gap-3">
                      <div class="w-32 shrink-0 entity-cell-two-line">
                        <div class="entity-cell-primary font-semibold uppercase tracking-wide text-[10px]">1 · Transaction facts</div>
                        <div class="entity-cell-secondary font-mono tabular-nums">Txn #<%= tx["transaction_id"] %></div>
                      </div>

                      <div class="min-w-0 flex-1 space-y-1">
                        <div class="text-sm font-medium"><%= tx["transaction_description_lk"].presence || tx["transaction_type_lk"].presence || "Transaction record" %></div>
                        <div class="text-[11px] text-muted-foreground">
                          <span class="font-mono tabular-nums"><%= format_plain_date(tx["transaction_date"]) %></span>
                          · <span><%= tx["transaction_type_lk"].presence || "type unavailable" %></span>
                          · <span>Route <%= route_label %></span>
                        </div>

                        <div class="flex flex-wrap items-center gap-2 text-[11px]">
                          <% if tx["player_id"].present? %>
                            <a href="<%= player_href(tx['player_id']) %>" class="hover:underline">Player <span class="font-medium"><%= tx["player_name"] %></span></a>
                          <% end %>
                          <% if tx["trade_id"].present? %>
                            <a href="<%= trade_href(tx['trade_id']) %>" class="hover:underline">Trade #<%= tx["trade_id"] %></a>
                          <% end %>
                          <a href="<%= transaction_href(tx['transaction_id']) %>" class="hover:underline">Direct link</a>
                          <% if @draft_selection.present? %>
                            <span class="entity-chip entity-chip--muted">Draft R<%= @draft_selection["draft_round"] %> #<%= @draft_selection["pick_number"] %></span>
                          <% end %>
                        </div>
                      </div>

                      <div class="flex items-start gap-1">
                        <div class="w-24 entity-cell-two-line">
                          <div class="entity-cell-primary justify-end font-mono tabular-nums <%= numeric_delta_class.call(net_cap_change) %>"><%= format_salary(net_cap_change) %></div>
                          <div class="entity-cell-secondary justify-end">Cap Δ</div>
                        </div>
                        <div class="w-24 entity-cell-two-line">
                          <div class="entity-cell-primary justify-end font-mono tabular-nums <%= numeric_delta_class.call(net_tax_change) %>"><%= format_salary(net_tax_change) %></div>
                          <div class="entity-cell-secondary justify-end">Tax Δ</div>
                        </div>
                        <div class="w-24 entity-cell-two-line">
                          <div class="entity-cell-primary justify-end font-mono tabular-nums <%= numeric_delta_class.call(net_apron_change) %>"><%= format_salary(net_apron_change) %></div>
                          <div class="entity-cell-secondary justify-end">Apron Δ</div>
                        </div>
                      </div>
                    </div>

                    <% if constraint_chips.any? %>
                      <div class="mt-2 flex flex-wrap gap-1.5">
                        <% constraint_chips.each do |label, klass| %>
                          <span class="entity-chip <%= klass %>"><%= label %></span>
                        <% end %>
                      </div>
                    <% end %>

                    <div data-show="$factsrawexpanded" style="display: none;" class="mt-2 rounded border border-border/60 bg-muted/20 p-2">
                      <div class="text-[10px] font-semibold uppercase tracking-wide text-muted-foreground">Raw transaction row</div>
                      <pre class="mt-1 overflow-x-auto text-[10px] font-mono tabular-nums text-muted-foreground"><%= raw_row_json.call({
                        transaction_id: tx["transaction_id"],
                        transaction_date: tx["transaction_date"],
                        transaction_type_lk: tx["transaction_type_lk"],
                        transaction_description_lk: tx["transaction_description_lk"],
                        record_status_lk: tx["record_status_lk"],
                        league_lk: tx["league_lk"],
                        salary_year: tx["salary_year"],
                        trade_id: tx["trade_id"],
                        player_id: tx["player_id"],
                        player_name: tx["player_name"],
                        from_team_id: tx["from_team_id"],
                        from_team_code: tx["from_team_code"],
                        to_team_id: tx["to_team_id"],
                        to_team_code: tx["to_team_code"],
                        rights_team_id: tx["rights_team_id"],
                        sign_and_trade_team_id: tx["sign_and_trade_team_id"],
                        net_cap_change: net_cap_change,
                        net_tax_change: net_tax_change,
                        net_apron_change: net_apron_change
                      }) %></pre>
                    </div>
                  </article>
                </div>

                <div data-show="$timelinephase === 'all' || $timelinephase === 'parties'"<% unless %w[all parties].include?(active_timeline_phase) %> style="display: none;"<% end %>>
                  <article class="px-3 py-2 bg-muted/20">
                    <div class="flex items-center justify-between gap-2">
                      <div class="text-[10px] font-semibold uppercase tracking-wide text-muted-foreground">2 · Parties + routing</div>
                      <% if party_rows.any? %>
                        <button
                          type="button"
                          class="cursor-pointer text-[10px] text-muted-foreground hover:text-foreground hover:underline"
                          data-on:click="$partiesrawexpanded = !$partiesrawexpanded"
                          data-text="$partiesrawexpanded ? 'Hide raw rows' : 'Show raw rows'"
                        >Show raw rows</button>
                      <% end %>
                    </div>
                  </article>

                  <% if party_rows.empty? %>
                    <div class="px-3 py-3 text-sm text-muted-foreground italic">No team party rows for this transaction.</div>
                  <% else %>
                    <% party_rows.each do |row| %>
                      <% deltas = delta_by_team[[row[:team_id], row[:team_code]]] || {} %>
                      <article class="group px-3 py-2 transition-colors duration-75 hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10">
                        <div class="flex flex-wrap items-start gap-3">
                          <div class="w-28 shrink-0 entity-cell-two-line">
                            <div class="entity-cell-primary text-xs uppercase tracking-wide text-muted-foreground"><%= row[:role] %></div>
                            <div class="entity-cell-secondary"><%= route_label %></div>
                          </div>

                          <div class="min-w-0 flex-1 space-y-1">
                            <div class="text-sm font-medium">
                              <a href="<%= safe_team_href(team_code: row[:team_code], team_id: row[:team_id]) %>" class="hover:underline"><%= row[:team_code].presence || row[:team_id] %></a>
                              <span class="text-muted-foreground"> · <%= row[:team_name].presence || "team" %></span>
                            </div>

                            <div class="flex flex-wrap items-center gap-2 text-[11px] text-muted-foreground">
                              <% if tx["player_id"].present? %>
                                <a href="<%= player_href(tx['player_id']) %>" class="hover:underline">Player <%= tx["player_name"] %></a>
                              <% end %>
                              <% if tx["trade_id"].present? %>
                                <a href="<%= trade_href(tx['trade_id']) %>" class="hover:underline">Trade #<%= tx["trade_id"] %></a>
                              <% end %>
                              <a href="<%= transaction_href(tx['transaction_id']) %>" class="hover:underline">Txn #<%= tx["transaction_id"] %></a>
                            </div>
                          </div>

                          <div class="flex items-start gap-1">
                            <div class="w-20 entity-cell-two-line">
                              <div class="entity-cell-primary justify-end font-mono tabular-nums <%= numeric_delta_class.call(deltas[:cap_change]) %>"><%= format_salary(deltas[:cap_change]) %></div>
                              <div class="entity-cell-secondary justify-end">Cap Δ</div>
                            </div>
                            <div class="w-20 entity-cell-two-line">
                              <div class="entity-cell-primary justify-end font-mono tabular-nums <%= numeric_delta_class.call(deltas[:tax_change]) %>"><%= format_salary(deltas[:tax_change]) %></div>
                              <div class="entity-cell-secondary justify-end">Tax Δ</div>
                            </div>
                            <div class="w-20 entity-cell-two-line">
                              <div class="entity-cell-primary justify-end font-mono tabular-nums <%= numeric_delta_class.call(deltas[:apron_change]) %>"><%= format_salary(deltas[:apron_change]) %></div>
                              <div class="entity-cell-secondary justify-end">Apron Δ</div>
                            </div>
                          </div>
                        </div>

                        <div data-show="$partiesrawexpanded" style="display: none;" class="mt-2 rounded border border-border/60 bg-muted/20 p-2">
                          <div class="text-[10px] font-semibold uppercase tracking-wide text-muted-foreground">Raw party row</div>
                          <pre class="mt-1 overflow-x-auto text-[10px] font-mono tabular-nums text-muted-foreground"><%= raw_row_json.call({
                            role: row[:role],
                            team_id: row[:team_id],
                            team_code: row[:team_code],
                            team_name: row[:team_name],
                            route_label: route_label,
                            cap_change: deltas[:cap_change],
                            tax_change: deltas[:tax_change],
                            apron_change: deltas[:apron_change],
                            mts_change: deltas[:mts_change]
                          }) %></pre>
                        </div>
                      </article>
                    <% end %>
                  <% end %>
                </div>

                <div data-show="$timelinephase === 'all' || $timelinephase === 'ledger'"<% unless %w[all ledger].include?(active_timeline_phase) %> style="display: none;"<% end %>>
                  <article class="px-3 py-2 bg-muted/20">
                    <div class="flex items-center justify-between gap-2">
                      <div class="text-[10px] font-semibold uppercase tracking-wide text-muted-foreground">3 · Ledger deltas</div>
                      <% if timeline_ledger_rows.any? %>
                        <button
                          type="button"
                          class="cursor-pointer text-[10px] text-muted-foreground hover:text-foreground hover:underline"
                          data-on:click="$ledgerrawexpanded = !$ledgerrawexpanded"
                          data-text="$ledgerrawexpanded ? 'Hide raw rows' : 'Show raw rows'"
                        >Show raw rows</button>
                      <% end %>
                    </div>
                  </article>

                  <% if timeline_ledger_rows.empty? %>
                    <div class="px-3 py-3 text-sm text-muted-foreground italic">No ledger rows for this transaction.</div>
                  <% else %>
                    <% timeline_ledger_rows.each do |row| %>
                      <article class="group px-3 py-2 transition-colors duration-75 hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10">
                        <div class="flex flex-wrap items-start gap-3">
                          <div class="w-32 shrink-0 entity-cell-two-line">
                            <div class="entity-cell-primary text-xs font-mono tabular-nums"><%= format_plain_date(row["ledger_date"]) %></div>
                            <div class="entity-cell-secondary"><%= [row["transaction_type_lk"], row["transaction_description_lk"]].compact.reject(&:blank?).join(" · ").presence || "Ledger event" %></div>
                          </div>

                          <div class="min-w-0 flex-1 space-y-1">
                            <div class="text-sm font-medium">
                              <% if row["team_id"].present? || row["team_code"].present? %>
                                <a href="<%= safe_team_href(team_code: row['team_code'], team_id: row['team_id']) %>" class="hover:underline"><%= row["team_code"].presence || row["team_id"] %></a>
                                <% if row["team_name"].present? %>
                                  <span class="text-muted-foreground"> · <%= row["team_name"] %></span>
                                <% end %>
                              <% else %>
                                <span class="text-muted-foreground">Team unavailable</span>
                              <% end %>
                            </div>

                            <div class="flex flex-wrap items-center gap-2 text-[11px] text-muted-foreground">
                              <% if tx["player_id"].present? %>
                                <a href="<%= player_href(tx['player_id']) %>" class="hover:underline">Player <%= tx["player_name"] %></a>
                              <% end %>
                              <% if tx["trade_id"].present? %>
                                <a href="<%= trade_href(tx['trade_id']) %>" class="hover:underline">Trade #<%= tx["trade_id"] %></a>
                              <% end %>
                              <a href="<%= transaction_href(tx['transaction_id']) %>" class="hover:underline">Txn #<%= tx["transaction_id"] %></a>
                            </div>
                          </div>

                          <div class="flex items-start gap-1">
                            <div class="w-20 entity-cell-two-line">
                              <div class="entity-cell-primary justify-end font-mono tabular-nums <%= numeric_delta_class.call(row['cap_change']) %>"><%= format_salary(row["cap_change"]) %></div>
                              <div class="entity-cell-secondary justify-end">Cap Δ</div>
                            </div>
                            <div class="w-20 entity-cell-two-line">
                              <div class="entity-cell-primary justify-end font-mono tabular-nums <%= numeric_delta_class.call(row['tax_change']) %>"><%= format_salary(row["tax_change"]) %></div>
                              <div class="entity-cell-secondary justify-end">Tax Δ</div>
                            </div>
                            <div class="w-20 entity-cell-two-line">
                              <div class="entity-cell-primary justify-end font-mono tabular-nums <%= numeric_delta_class.call(row['apron_change']) %>"><%= format_salary(row["apron_change"]) %></div>
                              <div class="entity-cell-secondary justify-end">Apron Δ</div>
                            </div>
                            <div class="w-20 entity-cell-two-line">
                              <div class="entity-cell-primary justify-end font-mono tabular-nums <%= numeric_delta_class.call(row['mts_change']) %>"><%= format_salary(row["mts_change"]) %></div>
                              <div class="entity-cell-secondary justify-end">MTS Δ</div>
                            </div>
                          </div>
                        </div>

                        <div data-show="$ledgerrawexpanded" style="display: none;" class="mt-2 rounded border border-border/60 bg-muted/20 p-2">
                          <div class="text-[10px] font-semibold uppercase tracking-wide text-muted-foreground">Raw ledger row</div>
                          <pre class="mt-1 overflow-x-auto text-[10px] font-mono tabular-nums text-muted-foreground"><%= raw_row_json.call({
                            transaction_ledger_entry_id: row["transaction_ledger_entry_id"],
                            ledger_date: row["ledger_date"],
                            salary_year: row["salary_year"],
                            team_id: row["team_id"],
                            team_code: row["team_code"],
                            team_name: row["team_name"],
                            transaction_type_lk: row["transaction_type_lk"],
                            transaction_description_lk: row["transaction_description_lk"],
                            cap_amount: row["cap_amount"],
                            cap_change: row["cap_change"],
                            cap_value: row["cap_value"],
                            tax_amount: row["tax_amount"],
                            tax_change: row["tax_change"],
                            tax_value: row["tax_value"],
                            apron_amount: row["apron_amount"],
                            apron_change: row["apron_change"],
                            apron_value: row["apron_value"],
                            mts_amount: row["mts_amount"],
                            mts_change: row["mts_change"],
                            mts_value: row["mts_value"],
                            trade_bonus_amount: row["trade_bonus_amount"]
                          }) %></pre>
                        </div>
                      </article>
                    <% end %>
                  <% end %>
                </div>

                <div data-show="$timelinephase === 'all' || $timelinephase === 'artifacts'"<% unless %w[all artifacts].include?(active_timeline_phase) %> style="display: none;"<% end %>>
                  <article class="px-3 py-2 bg-muted/20">
                    <div class="flex items-center justify-between gap-2">
                      <div class="text-[10px] font-semibold uppercase tracking-wide text-muted-foreground">4 · Cap artifacts</div>
                      <% if artifact_row_count.positive? %>
                        <button
                          type="button"
                          class="cursor-pointer text-[10px] text-muted-foreground hover:text-foreground hover:underline"
                          data-on:click="$artifactsrawexpanded = !$artifactsrawexpanded"
                          data-text="$artifactsrawexpanded ? 'Hide raw rows' : 'Show raw rows'"
                        >Show raw rows</button>
                      <% end %>
                    </div>
                  </article>

                  <% if artifact_row_count.zero? %>
                    <div class="px-3 py-3 text-sm text-muted-foreground italic">No cap artifact rows tied to this transaction.</div>
                  <% else %>
                    <% @cap_exception_usage_rows.each do |row| %>
                      <article class="group px-3 py-2 transition-colors duration-75 hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10">
                        <div class="flex flex-wrap items-start gap-3">
                          <div class="w-32 shrink-0 entity-cell-two-line">
                            <div class="entity-cell-primary text-xs uppercase tracking-wide">Exception usage</div>
                            <div class="entity-cell-secondary font-mono tabular-nums"><%= format_plain_date(row["effective_date"]) %></div>
                          </div>

                          <div class="min-w-0 flex-1 space-y-1">
                            <div class="text-sm font-medium"><%= row["exception_type_label"].presence || row["exception_type_lk"].presence || "Exception" %></div>
                            <div class="flex flex-wrap items-center gap-2 text-[11px] text-muted-foreground">
                              <% if row["team_id"].present? || row["team_code"].present? %>
                                <a href="<%= safe_team_href(team_code: row['team_code'], team_id: row['team_id']) %>" class="hover:underline">Team <%= row["team_code"].presence || row["team_id"] %></a>
                              <% end %>
                              <% if row["player_id"].present? %>
                                <a href="<%= player_href(row['player_id']) %>" class="hover:underline">Player <%= row["player_name"] %></a>
                              <% end %>
                              <% if tx["trade_id"].present? %>
                                <a href="<%= trade_href(tx['trade_id']) %>" class="hover:underline">Trade #<%= tx["trade_id"] %></a>
                              <% end %>
                              <a href="<%= transaction_href(tx['transaction_id']) %>" class="hover:underline">Txn #<%= tx["transaction_id"] %></a>
                            </div>
                          </div>

                          <div class="flex items-start gap-1">
                            <div class="w-24 entity-cell-two-line">
                              <div class="entity-cell-primary justify-end font-mono tabular-nums <%= numeric_delta_class.call(row['change_amount']) %>"><%= format_salary(row["change_amount"]) %></div>
                              <div class="entity-cell-secondary justify-end">Change</div>
                            </div>
                            <div class="w-24 entity-cell-two-line">
                              <div class="entity-cell-primary justify-end font-mono tabular-nums"><%= format_salary(row["remaining_exception_amount"]) %></div>
                              <div class="entity-cell-secondary justify-end">Remaining</div>
                            </div>
                          </div>
                        </div>

                        <div data-show="$artifactsrawexpanded" style="display: none;" class="mt-2 rounded border border-border/60 bg-muted/20 p-2">
                          <div class="text-[10px] font-semibold uppercase tracking-wide text-muted-foreground">Raw exception row</div>
                          <pre class="mt-1 overflow-x-auto text-[10px] font-mono tabular-nums text-muted-foreground"><%= raw_row_json.call({
                            source_type: "exception_usage",
                            team_exception_detail_id: row["team_exception_detail_id"],
                            effective_date: row["effective_date"],
                            exception_action_lk: row["exception_action_lk"],
                            exception_action_label: row["exception_action_label"],
                            transaction_type_lk: row["transaction_type_lk"],
                            transaction_type_label: row["transaction_type_label"],
                            transaction_id: row["transaction_id"],
                            player_id: row["player_id"],
                            player_name: row["player_name"],
                            contract_id: row["contract_id"],
                            change_amount: row["change_amount"],
                            remaining_exception_amount: row["remaining_exception_amount"],
                            team_exception_id: row["team_exception_id"],
                            team_id: row["team_id"],
                            team_code: row["team_code"],
                            team_name: row["team_name"],
                            exception_type_lk: row["exception_type_lk"],
                            exception_type_label: row["exception_type_label"],
                            trade_id: row["trade_id"]
                          }) %></pre>
                        </div>
                      </article>
                    <% end %>

                    <% @cap_dead_money_rows.each do |row| %>
                      <article class="group px-3 py-2 transition-colors duration-75 hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10">
                        <div class="flex flex-wrap items-start gap-3">
                          <div class="w-32 shrink-0 entity-cell-two-line">
                            <div class="entity-cell-primary text-xs uppercase tracking-wide">Dead money</div>
                            <div class="entity-cell-secondary font-mono tabular-nums"><%= format_year_label(row["salary_year"]) %></div>
                          </div>

                          <div class="min-w-0 flex-1 space-y-1">
                            <div class="text-sm font-medium"><%= row["player_name"].presence || "Player unavailable" %></div>
                            <div class="flex flex-wrap items-center gap-2 text-[11px] text-muted-foreground">
                              <% if row["team_id"].present? || row["team_code"].present? %>
                                <a href="<%= safe_team_href(team_code: row['team_code'], team_id: row['team_id']) %>" class="hover:underline">Team <%= row["team_code"].presence || row["team_id"] %></a>
                              <% end %>
                              <% if row["player_id"].present? %>
                                <a href="<%= player_href(row['player_id']) %>" class="hover:underline">Player profile</a>
                              <% end %>
                              <% if tx["trade_id"].present? %>
                                <a href="<%= trade_href(tx['trade_id']) %>" class="hover:underline">Trade #<%= tx["trade_id"] %></a>
                              <% end %>
                              <a href="<%= transaction_href(tx['transaction_id']) %>" class="hover:underline">Txn #<%= tx["transaction_id"] %></a>
                            </div>
                          </div>

                          <div class="flex items-start gap-1">
                            <div class="w-20 entity-cell-two-line">
                              <div class="entity-cell-primary justify-end font-mono tabular-nums"><%= format_salary(row["cap_value"]) %></div>
                              <div class="entity-cell-secondary justify-end">Cap</div>
                            </div>
                            <div class="w-20 entity-cell-two-line">
                              <div class="entity-cell-primary justify-end font-mono tabular-nums"><%= format_salary(row["tax_value"]) %></div>
                              <div class="entity-cell-secondary justify-end">Tax</div>
                            </div>
                            <div class="w-20 entity-cell-two-line">
                              <div class="entity-cell-primary justify-end font-mono tabular-nums"><%= format_salary(row["apron_value"]) %></div>
                              <div class="entity-cell-secondary justify-end">Apron</div>
                            </div>
                          </div>
                        </div>

                        <div data-show="$artifactsrawexpanded" style="display: none;" class="mt-2 rounded border border-border/60 bg-muted/20 p-2">
                          <div class="text-[10px] font-semibold uppercase tracking-wide text-muted-foreground">Raw dead-money row</div>
                          <pre class="mt-1 overflow-x-auto text-[10px] font-mono tabular-nums text-muted-foreground"><%= raw_row_json.call({
                            source_type: "dead_money",
                            transaction_waiver_amount_id: row["transaction_waiver_amount_id"],
                            salary_year: row["salary_year"],
                            team_id: row["team_id"],
                            team_code: row["team_code"],
                            team_name: row["team_name"],
                            player_id: row["player_id"],
                            player_name: row["player_name"],
                            contract_id: row["contract_id"],
                            version_number: row["version_number"],
                            waive_date: row["waive_date"],
                            cap_value: row["cap_value"],
                            tax_value: row["tax_value"],
                            apron_value: row["apron_value"],
                            mts_value: row["mts_value"]
                          }) %></pre>
                        </div>
                      </article>
                    <% end %>

                    <% @cap_budget_snapshot_rows.each do |row| %>
                      <article class="group px-3 py-2 transition-colors duration-75 hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10">
                        <div class="flex flex-wrap items-start gap-3">
                          <div class="w-32 shrink-0 entity-cell-two-line">
                            <div class="entity-cell-primary text-xs uppercase tracking-wide">Budget snapshot</div>
                            <div class="entity-cell-secondary font-mono tabular-nums"><%= format_year_label(row["salary_year"]) %></div>
                          </div>

                          <div class="min-w-0 flex-1 space-y-1">
                            <div class="text-sm font-medium"><%= row["budget_group_label"].presence || row["budget_group_lk"].presence || "Budget posture" %></div>
                            <div class="flex flex-wrap items-center gap-2 text-[11px] text-muted-foreground">
                              <% if row["team_id"].present? || row["team_code"].present? %>
                                <a href="<%= safe_team_href(team_code: row['team_code'], team_id: row['team_id']) %>" class="hover:underline">Team <%= row["team_code"].presence || row["team_id"] %></a>
                              <% end %>
                              <% if row["player_id"].present? %>
                                <a href="<%= player_href(row['player_id']) %>" class="hover:underline">Player <%= row["player_name"] %></a>
                              <% end %>
                              <% if tx["trade_id"].present? %>
                                <a href="<%= trade_href(tx['trade_id']) %>" class="hover:underline">Trade #<%= tx["trade_id"] %></a>
                              <% end %>
                              <a href="<%= transaction_href(tx['transaction_id']) %>" class="hover:underline">Txn #<%= tx["transaction_id"] %></a>
                            </div>
                          </div>

                          <div class="flex items-start gap-1">
                            <div class="w-20 entity-cell-two-line">
                              <div class="entity-cell-primary justify-end font-mono tabular-nums"><%= format_salary(row["cap_amount"]) %></div>
                              <div class="entity-cell-secondary justify-end">Cap</div>
                            </div>
                            <div class="w-20 entity-cell-two-line">
                              <div class="entity-cell-primary justify-end font-mono tabular-nums"><%= format_salary(row["tax_amount"]) %></div>
                              <div class="entity-cell-secondary justify-end">Tax</div>
                            </div>
                            <div class="w-20 entity-cell-two-line">
                              <div class="entity-cell-primary justify-end font-mono tabular-nums"><%= format_salary(row["apron_amount"]) %></div>
                              <div class="entity-cell-secondary justify-end">Apron</div>
                            </div>
                          </div>
                        </div>

                        <div data-show="$artifactsrawexpanded" style="display: none;" class="mt-2 rounded border border-border/60 bg-muted/20 p-2">
                          <div class="text-[10px] font-semibold uppercase tracking-wide text-muted-foreground">Raw budget row</div>
                          <pre class="mt-1 overflow-x-auto text-[10px] font-mono tabular-nums text-muted-foreground"><%= raw_row_json.call({
                            source_type: "budget_snapshot",
                            team_budget_snapshot_id: row["team_budget_snapshot_id"],
                            salary_year: row["salary_year"],
                            team_id: row["team_id"],
                            team_code: row["team_code"],
                            team_name: row["team_name"],
                            player_id: row["player_id"],
                            player_name: row["player_name"],
                            contract_id: row["contract_id"],
                            version_number: row["version_number"],
                            transaction_type_lk: row["transaction_type_lk"],
                            transaction_description_lk: row["transaction_description_lk"],
                            budget_group_lk: row["budget_group_lk"],
                            budget_group_label: row["budget_group_label"],
                            signing_method_lk: row["signing_method_lk"],
                            signing_method_label: row["signing_method_label"],
                            option_lk: row["option_lk"],
                            option_label: row["option_label"],
                            option_decision_lk: row["option_decision_lk"],
                            option_decision_label: row["option_decision_label"],
                            cap_amount: row["cap_amount"],
                            tax_amount: row["tax_amount"],
                            apron_amount: row["apron_amount"],
                            mts_amount: row["mts_amount"]
                          }) %></pre>
                        </div>
                      </article>
                    <% end %>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section id="trade-context" class="scroll-mt-24 space-y-3">
          <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Trade context</h2>

          <% if tx["trade_id"].present? %>
            <div class="rounded-lg border border-border overflow-hidden">
              <div class="divide-y divide-border/60">
                <article class="group px-3 py-2 transition-colors duration-75 hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10">
                  <div class="flex flex-wrap items-start gap-3">
                    <div class="w-32 shrink-0 entity-cell-two-line">
                      <div class="entity-cell-primary text-xs uppercase tracking-wide">Linked trade</div>
                      <div class="entity-cell-secondary font-mono tabular-nums">#<%= tx["trade_id"] %></div>
                    </div>

                    <div class="min-w-0 flex-1 space-y-1">
                      <div class="text-sm font-medium"><a href="<%= trade_href(tx['trade_id']) %>" class="hover:underline">Open trade #<%= tx["trade_id"] %></a></div>
                      <% if @trade.present? %>
                        <div class="text-[11px] text-muted-foreground">
                          <span class="font-mono tabular-nums"><%= @trade["team_count"] || 0 %> teams</span>
                          · <span class="font-mono tabular-nums"><%= @trade["player_line_item_count"] || 0 %> players</span>
                          · <span class="font-mono tabular-nums"><%= @trade["pick_line_item_count"] || 0 %> picks</span>
                        </div>
                      <% end %>
                    </div>
                  </div>
                </article>

                <% if @trade_transactions.any? %>
                  <article class="px-3 py-2 bg-muted/20">
                    <div class="text-[10px] font-semibold uppercase tracking-wide text-muted-foreground">Other transactions in this trade</div>
                  </article>

                  <% @trade_transactions.each do |row| %>
                    <article class="group px-3 py-2 transition-colors duration-75 hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10">
                      <div class="flex flex-wrap items-start gap-3">
                        <div class="w-28 shrink-0 entity-cell-two-line">
                          <div class="entity-cell-primary font-mono tabular-nums"><a href="<%= transaction_href(row['transaction_id']) %>" class="hover:underline">Txn #<%= row["transaction_id"] %></a></div>
                          <div class="entity-cell-secondary"><%= format_plain_date(row["transaction_date"]) %></div>
                        </div>

                        <div class="min-w-0 flex-1 space-y-1">
                          <div class="text-sm font-medium"><%= [row["transaction_type_lk"], row["transaction_description_lk"]].compact.reject(&:blank?).join(" · ").presence || "Trade transaction" %></div>
                          <div class="flex flex-wrap items-center gap-2 text-[11px] text-muted-foreground">
                            <% if row["player_id"].present? %>
                              <a href="<%= player_href(row['player_id']) %>" class="hover:underline">Player <%= row["player_name"] %></a>
                            <% end %>
                            <span>Route <%= [row["from_team_code"], row["to_team_code"]].compact.reject(&:blank?).join(" → ").presence || "—" %></span>
                            <a href="<%= trade_href(tx['trade_id']) %>" class="hover:underline">Trade #<%= tx["trade_id"] %></a>
                          </div>
                        </div>
                      </div>
                    </article>
                  <% end %>
                <% end %>
              </div>
            </div>
          <% else %>
            <div class="p-4 rounded-lg bg-muted/30 border border-border/50 text-sm text-muted-foreground italic">Standalone transaction (no trade_id).</div>
          <% end %>
        </section>

        <section id="endnotes" class="scroll-mt-24 space-y-3">
          <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Related endnotes</h2>

          <% if @endnotes.empty? %>
            <div class="p-4 rounded-lg bg-muted/30 border border-border/50 text-sm text-muted-foreground italic">No endnotes linked to this transaction's trade context.</div>
          <% else %>
            <div class="rounded-lg border border-border overflow-hidden divide-y divide-border/60">
              <% @endnotes.each do |note| %>
                <article class="group px-3 py-2 transition-colors duration-75 hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10">
                  <div class="flex flex-wrap items-start gap-3">
                    <div class="w-24 shrink-0 entity-cell-two-line">
                      <div class="entity-cell-primary font-mono tabular-nums">#<%= note["endnote_id"] %></div>
                      <div class="entity-cell-secondary"><%= note["status_lk"].presence || "status" %></div>
                    </div>

                    <div class="min-w-0 flex-1 space-y-1">
                      <div class="text-sm whitespace-pre-line"><%= note["explanation"].presence || note["conveyance_text"].presence || note["protections_text"].presence || "—" %></div>
                      <div class="flex flex-wrap items-center gap-1.5 text-[10px]">
                        <% if note["is_swap"] %>
                          <span class="entity-chip entity-chip--accent">Swap</span>
                        <% end %>
                        <% if note["is_conditional"] %>
                          <span class="entity-chip entity-chip--warning">Conditional</span>
                        <% end %>
                        <% if tx["trade_id"].present? %>
                          <a href="<%= trade_href(tx['trade_id']) %>" class="hover:underline text-muted-foreground">Trade #<%= tx["trade_id"] %></a>
                        <% end %>
                      </div>
                    </div>
                  </div>
                </article>
              <% end %>
            </div>
          <% end %>
        </section>
      </div>
    </div>
  </main>
</div>
