<div id="drafts-results" class="space-y-3">
  <div class="flex items-end justify-between gap-4">
    <div>
      <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">
        <% if @view == "grid" %>
          Draft ownership grid · start <%= @year %>
        <% elsif @view == "picks" %>
          Draft picks · <%= @year %>
        <% else %>
          Draft selections · <%= @year %>
        <% end %>
        · <%= @sort_label %>
      </h2>
      <p class="text-[11px] text-muted-foreground mt-1">
        <% if @view == "grid" %>
          Click a cell to inspect protections and trade provenance without leaving the grid.
        <% elsif @view == "picks" %>
          Click a pick row to inspect ownership chain, protections, and pivots.
        <% else %>
          Click a selection row to trace pre-draft provenance and linked transactions.
        <% end %>
        <% if @lens != "all" %>
          <span class="font-medium text-foreground">Lens: <%= @lens_label %></span>
        <% end %>
      </p>
    </div>

    <div class="text-[11px] text-muted-foreground tabular-nums">
      <% if @view == "grid" %>
        <span><%= @grid_teams.size %> teams · <%= @grid_years.size %> years</span>
      <% else %>
        <span><%= @results.size %> rows</span>
      <% end %>
    </div>
  </div>

  <% if @view == "grid" %>
    <% if @grid_teams.empty? %>
      <div class="p-4 rounded-lg bg-muted/30 border border-border/50 text-sm text-muted-foreground italic">
        No draft pick data available for this grid window.
      </div>
    <% else %>
      <% show_rounds = (@round.present? && @round != "all") ? [@round.to_i] : [1, 2] %>

      <div class="overflow-x-auto rounded-lg border border-border">
        <table class="min-w-full text-xs border-collapse">
          <thead class="bg-muted/40 text-[10px] uppercase tracking-wide text-muted-foreground/90">
            <tr>
              <th class="text-left px-2 py-2 font-medium sticky left-0 z-10 bg-muted/40 border-r border-border min-w-[4rem]">Team</th>
              <th class="text-center px-1 py-2 font-medium min-w-[2rem]">Rd</th>
              <% @grid_years.each do |year| %>
                <th class="text-left px-2 py-2 font-medium font-mono tabular-nums min-w-[8rem]"><%= year %></th>
              <% end %>
            </tr>
          </thead>
          <tbody>
            <% @grid_teams.each_with_index do |(team_code, team_name), team_idx| %>
              <% show_rounds.each_with_index do |round, round_idx| %>
                <%
                  is_first_round_row = round_idx == 0
                  is_last_round_row = round_idx == show_rounds.size - 1
                  border_class = is_last_round_row ? "border-b border-border" : ""
                  bg_class = team_idx.even? ? "bg-background" : "bg-muted/20"
                %>
                <tr class="group hover:bg-yellow-50/70 dark:hover:bg-yellow-900/25 transition-colors duration-75 <%= border_class %> <%= bg_class %>">
                  <td class="px-2 py-1 sticky left-0 z-10 border-r border-border <%= bg_class %> group-hover:bg-yellow-50 dark:group-hover:bg-yellow-900/25 transition-colors duration-75">
                    <% if is_first_round_row %>
                      <div class="entity-cell-two-line">
                        <div class="text-[11px] font-medium">
                          <a href="<%= team_href(team_code: team_code) %>" class="hover:underline"><%= team_code %></a>
                        </div>
                        <% if show_rounds.size > 1 %>
                          <div class="text-[9px] text-muted-foreground truncate max-w-[5rem]"><%= team_name %></div>
                        <% end %>
                      </div>
                    <% end %>
                  </td>
                  <td class="px-1 py-1 text-center text-[10px] text-muted-foreground font-mono tabular-nums"><%= round %></td>

                  <% @grid_years.each do |year| %>
                    <%
                      cell = @grid_data.dig(team_code, round, year)
                      cell_text = cell ? cell[:text].to_s : "—"
                      cell_key = "grid-#{team_code}-#{year}-#{round}"
                      cell_open_expr = "$overlaytype = 'pick'; $overlaykey = '#{cell_key}'; @get('/drafts/sidebar/pick?team=#{team_code}&year=#{year}&round=#{round}')"
                    %>
                    <td
                      class="px-2 py-1 text-[11px] leading-snug max-w-[12rem] transition-colors duration-75"
                      data-class="{ 'bg-yellow-100/80 dark:bg-yellow-900/20': $overlaytype === 'pick' && $overlaykey === '<%= cell_key %>' }"
                    >
                      <% if cell.present? %>
                        <button
                          type="button"
                          class="cursor-pointer w-full text-left hover:underline focus-visible:underline"
                          data-on:click="<%= cell_open_expr %>"
                          title="<%= cell_text %>"
                        >
                          <% if cell[:has_swap] %>
                            <span class="inline-flex items-center px-1 py-0 rounded text-[9px] font-medium bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300 mr-0.5">S</span>
                          <% end %>
                          <% if cell[:has_conditional] && !cell[:has_swap] %>
                            <span class="inline-flex items-center px-1 py-0 rounded text-[9px] font-medium bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300 mr-0.5">C</span>
                          <% end %>
                          <% if cell[:provenance_trade_count].to_i.positive? %>
                            <span class="inline-flex items-center px-1 py-0 rounded text-[9px] font-medium bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 mr-0.5">P<%= cell[:provenance_trade_count].to_i %></span>
                          <% end %>
                          <span class="<%= cell[:has_conditional] ? 'italic' : '' %> <%= cell[:has_forfeited] ? 'line-through text-muted-foreground/60' : (cell[:has_outgoing] ? 'text-amber-600 dark:text-amber-400' : 'text-muted-foreground') %>"><%= truncate(cell_text, length: 44) %></span>
                        </button>
                      <% else %>
                        <span class="text-muted-foreground/60">—</span>
                      <% end %>
                    </td>
                  <% end %>
                </tr>
              <% end %>
            <% end %>
          </tbody>
        </table>
      </div>
    <% end %>

  <% elsif @results.empty? %>
    <div class="p-4 rounded-lg bg-muted/30 border border-border/50 text-sm text-muted-foreground italic">
      No <%= @view == "picks" ? "draft picks" : "draft selections" %> found for this filter set.
    </div>

  <% else %>
    <div class="overflow-x-auto rounded-lg border border-border">
      <table class="entity-table min-w-full text-xs">
        <thead class="bg-muted/40 text-[10px] uppercase tracking-wide text-muted-foreground/90">
          <% if @view == "picks" %>
            <tr>
              <th class="text-left px-3 py-2 font-medium">Pick</th>
              <th class="text-left px-3 py-2 font-medium">Original</th>
              <th class="text-left px-3 py-2 font-medium">Current owner</th>
              <th class="text-left px-3 py-2 font-medium">Status</th>
              <th class="text-left px-3 py-2 font-medium">Protections</th>
              <th class="text-right px-3 py-2 font-medium">Complexity</th>
            </tr>
          <% else %>
            <tr>
              <th class="text-center px-3 py-2 font-medium">Pick</th>
              <th class="text-left px-3 py-2 font-medium">Player</th>
              <th class="text-left px-3 py-2 font-medium">Drafting team</th>
              <th class="text-left px-3 py-2 font-medium">Transaction</th>
              <th class="text-right px-3 py-2 font-medium">Provenance</th>
            </tr>
          <% end %>
        </thead>
        <tbody class="divide-y divide-border">
          <% if @view == "picks" %>
            <% @results.each do |pick| %>
              <%
                row_key = "pick-#{pick['original_team_code']}-#{pick['draft_year']}-#{pick['draft_round']}"
                open_expr = "$overlaytype = 'pick'; $overlaykey = '#{row_key}'; @get('/drafts/sidebar/pick?team=#{pick['original_team_code']}&year=#{pick['draft_year']}&round=#{pick['draft_round']}')"
                status_text = pick["pick_status"].presence || "Own"
              %>
              <tr
                class="group cursor-pointer hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 transition-colors duration-75"
                data-class="{ 'bg-yellow-100/80 dark:bg-yellow-900/20': $overlaytype === 'pick' && $overlaykey === '<%= row_key %>' }"
                data-on:click="<%= open_expr %>"
              >
                <td class="px-3 py-2 font-mono tabular-nums">
                  <a href="<%= draft_pick_path(team_code: pick['original_team_code'], year: pick['draft_year'], round: pick['draft_round']) %>" class="hover:underline" onclick="event.stopPropagation()">R<%= pick["draft_round"] %> · <%= pick["draft_year"] %></a>
                </td>
                <td class="px-3 py-2">
                  <div class="entity-cell-two-line">
                    <div class="entity-cell-primary">
                      <a href="<%= team_href(team_code: pick['original_team_code']) %>" class="font-medium hover:underline" onclick="event.stopPropagation()"><%= pick["original_team_code"] %></a>
                    </div>
                    <div class="entity-cell-secondary truncate"><%= pick["original_team_name"].presence || "—" %></div>
                  </div>
                </td>
                <td class="px-3 py-2">
                  <div class="entity-cell-two-line">
                    <div class="entity-cell-primary">
                      <% if pick["current_team_code"].present? %>
                        <a href="<%= team_href(team_code: pick['current_team_code']) %>" class="font-medium hover:underline <%= pick['current_team_code'] != pick['original_team_code'] ? 'text-amber-600 dark:text-amber-400' : '' %>" onclick="event.stopPropagation()"><%= pick["current_team_code"] %></a>
                      <% else %>
                        <span class="text-muted-foreground">—</span>
                      <% end %>
                    </div>
                    <div class="entity-cell-secondary truncate"><%= pick["current_team_name"].presence || "—" %></div>
                  </div>
                </td>
                <td class="px-3 py-2">
                  <div class="flex items-center gap-1.5">
                    <% if pick["is_swap"] %>
                      <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300">Swap</span>
                    <% end %>
                    <% if pick["has_conditional"] %>
                      <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-300">Conditional</span>
                    <% end %>
                    <% if pick["has_forfeited"] %>
                      <span class="inline-flex items-center px-1.5 py-0.5 rounded text-[10px] font-medium bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-300">Forfeited</span>
                    <% end %>
                    <% if !pick["is_swap"] && !pick["has_conditional"] && !pick["has_forfeited"] %>
                      <span class="text-muted-foreground text-[11px]"><%= status_text %></span>
                    <% end %>
                  </div>
                </td>
                <td class="px-3 py-2 text-muted-foreground text-[11px] max-w-xs truncate"><%= pick["protections_summary"].presence || "—" %></td>
                <td class="px-3 py-2 text-right font-mono tabular-nums">
                  <% risk_score = pick["ownership_risk_score"].to_i %>
                  <% provenance_count = pick["provenance_trade_count"].to_i %>
                  <div class="space-y-0.5">
                    <div class="font-medium"><%= risk_score %></div>
                    <div class="text-[10px] leading-none text-muted-foreground">P<%= provenance_count %> · <%= pick["asset_line_count"].to_i %> lines</div>
                  </div>
                </td>
              </tr>
            <% end %>
          <% else %>
            <% @results.each do |sel| %>
              <%
                row_key = "selection-#{sel['transaction_id']}"
                open_expr = "$overlaytype = 'selection'; $overlaykey = '#{row_key}'; @get('/drafts/sidebar/selection/#{sel['transaction_id']}')"
              %>
              <tr
                class="group cursor-pointer hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 transition-colors duration-75"
                data-class="{ 'bg-yellow-100/80 dark:bg-yellow-900/20': $overlaytype === 'selection' && $overlaykey === '<%= row_key %>' }"
                data-on:click="<%= open_expr %>"
              >
                <td class="px-3 py-2 text-center font-mono tabular-nums">
                  <div class="text-sm font-medium"><%= sel["pick_number"] %></div>
                  <div class="text-[10px] text-muted-foreground">R<%= sel["draft_round"] %> · <%= sel["draft_year"] %></div>
                </td>
                <td class="px-3 py-2">
                  <div class="entity-cell-two-line">
                    <div class="entity-cell-primary">
                      <% if sel["player_id"].present? %>
                        <a href="<%= player_href(sel['player_id']) %>" class="font-medium truncate hover:underline" onclick="event.stopPropagation()"><%= sel["player_name"] %></a>
                      <% else %>
                        <span class="text-muted-foreground">—</span>
                      <% end %>
                    </div>
                    <div class="entity-cell-secondary">id: <code class="font-mono tabular-nums"><%= sel["player_id"].presence || "—" %></code></div>
                  </div>
                </td>
                <td class="px-3 py-2">
                  <div class="entity-cell-two-line">
                    <div class="entity-cell-primary">
                      <a href="<%= team_href(team_code: sel['drafting_team_code']) %>" class="font-medium hover:underline" onclick="event.stopPropagation()"><%= sel["drafting_team_code"] %></a>
                    </div>
                    <div class="entity-cell-secondary truncate"><%= sel["drafting_team_name"].presence || "—" %></div>
                  </div>
                </td>
                <td class="px-3 py-2 text-muted-foreground">
                  <div class="entity-cell-two-line">
                    <div class="entity-cell-primary">
                      <a href="<%= transaction_href(sel['transaction_id']) %>" class="font-mono tabular-nums hover:underline" onclick="event.stopPropagation()">#<%= sel["transaction_id"] %></a>
                    </div>
                    <div class="entity-cell-secondary">
                      <%= sel["transaction_date"].present? ? Date.parse(sel["transaction_date"].to_s).strftime("%b %d, %Y") : "—" %>
                      <% if sel["trade_id"].present? %>
                        <span class="px-1 text-muted-foreground/50">·</span>
                        <a href="<%= trade_href(sel['trade_id']) %>" class="font-mono tabular-nums hover:underline" onclick="event.stopPropagation()">T#<%= sel["trade_id"] %></a>
                      <% end %>
                    </div>
                  </div>
                </td>
                <td class="px-3 py-2 text-right font-mono tabular-nums">
                  <% provenance_count = sel["provenance_trade_count"].to_i %>
                  <% risk_score = sel["provenance_risk_score"].to_i %>
                  <% if provenance_count.positive? || risk_score.positive? %>
                    <div class="space-y-0.5">
                      <div class="font-medium"><%= provenance_count %></div>
                      <div class="text-[10px] leading-none text-muted-foreground">risk <%= risk_score %></div>
                    </div>
                  <% else %>
                    <span class="text-muted-foreground">—</span>
                  <% end %>
                </td>
              </tr>
            <% end %>
          <% end %>
        </tbody>
      </table>
    </div>
  <% end %>
</div>
