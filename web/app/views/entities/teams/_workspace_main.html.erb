<%
  compare_slots = [
    { key: "a", label: "Slot A", team_id: @compare_a_id, row: @compare_a_row, tone: "indigo" },
    { key: "b", label: "Slot B", team_id: @compare_b_id, row: @compare_b_row, tone: "emerald" }
  ]
  has_compare = compare_slots.any? { |slot| slot[:row].present? }
  compare_pair_ready = @compare_a_row.present? && @compare_b_row.present?

  if compare_pair_ready
    cap_space_delta = @compare_b_row["cap_space"].to_f - @compare_a_row["cap_space"].to_f
    tax_room_delta = @compare_b_row["room_under_tax"].to_f - @compare_a_row["room_under_tax"].to_f
    apron1_delta = @compare_b_row["room_under_apron1"].to_f - @compare_a_row["room_under_apron1"].to_f
    apron2_delta = @compare_b_row["room_under_apron2"].to_f - @compare_a_row["room_under_apron2"].to_f
    luxury_tax_delta = @compare_b_row["luxury_tax_owed"].to_f - @compare_a_row["luxury_tax_owed"].to_f
  end

  refresh_query_expr = "'q=' + encodeURIComponent($teamsquery) +
    '&conference=' + encodeURIComponent($teamsconference) +
    '&pressure=' + encodeURIComponent($teamspressure) +
    '&sort=' + encodeURIComponent($teamssort) +
    '&compare_a=' + encodeURIComponent($comparea) +
    '&compare_b=' + encodeURIComponent($compareb) +
    '&selected_id=' + encodeURIComponent($overlaytype === 'team' ? $selectedteamid : '')"

  compare_url_sync_expr = "
    const params = new URLSearchParams(window.location.search);
    const nextCompareA = String($comparea || '');
    const nextCompareB = String($compareb || '');
    const currentCompareA = params.get('compare_a') || '';
    const currentCompareB = params.get('compare_b') || '';
    if (currentCompareA === nextCompareA && currentCompareB === nextCompareB) { return; }
    params.set('compare_a', nextCompareA);
    params.set('compare_b', nextCompareB);
    const nextQuery = params.toString();
    const nextUrl = window.location.pathname + (nextQuery ? ('?' + nextQuery) : '');
    if ((window.location.pathname + window.location.search) !== nextUrl) { window.history.replaceState({}, '', nextUrl); }
  ".squish
%>

<main id="maincanvas" class="flex-1 min-w-0 overflow-y-auto overflow-x-hidden bg-background">
  <div id="teams-maincanvas" class="px-4 py-4 space-y-4">
    <div id="teams-compare-url-sync" class="hidden" aria-hidden="true" data-effect="<%= compare_url_sync_expr %>"></div>

    <div class="flex items-end justify-between gap-4">
      <div>
        <div class="text-[10px] uppercase tracking-wide text-muted-foreground/80">Teams workspace</div>
        <h2 class="text-sm font-semibold text-foreground">
          Cap pressure scan
          <span class="text-muted-foreground font-medium">· <%= @teams.size %> rows</span>
          <% if has_compare %>
            <span class="text-muted-foreground font-medium">· <%= compare_slots.count { |slot| slot[:row].present? } %> pinned</span>
          <% end %>
        </h2>
      </div>

      <div class="text-[11px] text-muted-foreground tabular-nums">
        <span>Luxury tax owed: <%= format_compact_currency(@sidebar_summary[:luxury_tax_total]) %></span>
      </div>
    </div>

    <div id="teams-compare-strip" class="rounded-lg border border-border bg-muted/20 px-3 py-3 space-y-2">
      <div class="flex items-center justify-between gap-3">
        <div>
          <div class="text-[10px] uppercase tracking-wide font-semibold text-muted-foreground/80">Compare board</div>
          <div class="text-[11px] text-muted-foreground">Pin two teams inline (Pin A / Pin B) to hold cap pressure candidates while you keep scanning.</div>
        </div>

        <% if has_compare %>
          <button
            type="button"
            class="cursor-pointer h-7 px-2 rounded border border-border bg-background text-[11px] font-medium hover:bg-muted"
            data-on:click="@get('/teams/sse/refresh?' + (<%= refresh_query_expr %>) + '&action=clear_all')"
          >Clear compare</button>
        <% end %>
      </div>

      <div class="grid grid-cols-2 gap-2">
        <% compare_slots.each do |slot| %>
          <% row = slot[:row] %>
          <% team_id = slot[:team_id] %>
          <% tone_classes = slot[:tone] == "indigo" ? "text-indigo-700 dark:text-indigo-300 border-indigo-500/40 bg-indigo-500/10" : "text-emerald-700 dark:text-emerald-300 border-emerald-500/40 bg-emerald-500/10" %>

          <div class="rounded border border-border bg-background px-2.5 py-2 space-y-1.5 min-h-[74px]">
            <div class="flex items-center justify-between gap-2">
              <span class="inline-flex items-center rounded border px-1.5 py-0.5 text-[10px] font-semibold uppercase tracking-wide <%= tone_classes %>"><%= slot[:label] %></span>

              <% if row.present? %>
                <button
                  type="button"
                  class="cursor-pointer text-[10px] text-muted-foreground hover:text-foreground hover:underline"
                  data-on:click="@get('/teams/sse/refresh?' + (<%= refresh_query_expr %>) + '&action=clear_slot&slot=<%= slot[:key] %>')"
                >Clear</button>
              <% end %>
            </div>

            <% if row.present? %>
              <button
                type="button"
                class="cursor-pointer block w-full text-left"
                data-on:click="$selectedteamid = '<%= team_id %>'; $overlaytype = 'team'; @get('/teams/sidebar/<%= team_id %>')"
              >
                <div class="text-sm font-medium leading-tight truncate"><%= row["team_name"] %></div>
                <div class="text-[10px] text-muted-foreground/80 tabular-nums"><%= row["team_code"] %> · <%= format_year_label(2025) %></div>
                <div class="mt-1.5 grid grid-cols-3 gap-2 text-[10px] tabular-nums">
                  <div>
                    <div class="text-muted-foreground/70 uppercase tracking-wide">Cap</div>
                    <div class="font-medium <%= row['cap_space'].to_f >= 0 ? 'text-emerald-600 dark:text-emerald-400' : 'text-red-600 dark:text-red-400' %>"><%= format_room_amount(row["cap_space"]) %></div>
                  </div>
                  <div>
                    <div class="text-muted-foreground/70 uppercase tracking-wide">Tax</div>
                    <div class="font-medium <%= row['room_under_tax'].to_f >= 0 ? 'text-foreground' : 'text-red-600 dark:text-red-400' %>"><%= format_room_amount(row["room_under_tax"]) %></div>
                  </div>
                  <div>
                    <div class="text-muted-foreground/70 uppercase tracking-wide">A1</div>
                    <div class="font-medium <%= row['room_under_apron1'].to_f >= 0 ? 'text-foreground' : 'text-red-600 dark:text-red-400' %>"><%= format_room_amount(row["room_under_apron1"]) %></div>
                  </div>
                </div>
              </button>
            <% else %>
              <div class="text-[11px] text-muted-foreground italic">No team pinned.</div>
            <% end %>
          </div>
        <% end %>
      </div>

      <% if compare_pair_ready %>
        <div class="rounded border border-border/60 bg-background px-2.5 py-2 text-[11px] tabular-nums flex flex-wrap items-center gap-3">
          <span class="font-medium text-muted-foreground"><%= @compare_b_row["team_code"] %> vs <%= @compare_a_row["team_code"] %> delta</span>
          <span class="<%= cap_space_delta >= 0 ? 'text-emerald-600 dark:text-emerald-400' : 'text-red-600 dark:text-red-400' %>">Cap: <%= format_room_amount(cap_space_delta) %></span>
          <span class="<%= tax_room_delta >= 0 ? 'text-emerald-600 dark:text-emerald-400' : 'text-red-600 dark:text-red-400' %>">Tax: <%= format_room_amount(tax_room_delta) %></span>
          <span class="<%= apron1_delta >= 0 ? 'text-emerald-600 dark:text-emerald-400' : 'text-red-600 dark:text-red-400' %>">A1: <%= format_room_amount(apron1_delta) %></span>
          <span class="<%= apron2_delta >= 0 ? 'text-emerald-600 dark:text-emerald-400' : 'text-red-600 dark:text-red-400' %>">A2: <%= format_room_amount(apron2_delta) %></span>
          <span class="<%= luxury_tax_delta <= 0 ? 'text-emerald-600 dark:text-emerald-400' : 'text-red-600 dark:text-red-400' %>">Tax owed: <%= luxury_tax_delta.zero? ? '±$0' : format_room_amount(-luxury_tax_delta) %></span>
        </div>
      <% end %>
    </div>

    <% if @teams.empty? %>
      <div class="p-6 rounded-lg border border-border bg-muted/20 text-sm text-muted-foreground italic text-center">
        No teams match these filters.
      </div>
    <% else %>
      <div class="rounded-lg border border-border overflow-hidden">
        <div class="sticky top-0 z-10 bg-muted/70 backdrop-blur-sm border-b border-border">
          <div class="flex items-center px-4 h-8 text-[10px] uppercase tracking-wide text-muted-foreground/90 font-medium">
            <div class="w-64 shrink-0">Team</div>
            <div class="w-24 shrink-0 text-right font-mono tabular-nums">Cap Space</div>
            <div class="w-24 shrink-0 text-right font-mono tabular-nums">Room Tax</div>
            <div class="w-24 shrink-0 text-right font-mono tabular-nums">Room A1</div>
            <div class="w-24 shrink-0 text-right font-mono tabular-nums">Room A2</div>
            <div class="w-24 shrink-0 text-right font-mono tabular-nums">Tax Owed</div>
            <div class="w-16 shrink-0 text-right font-mono tabular-nums">Roster</div>
            <div class="w-16 shrink-0 text-right font-mono tabular-nums">2W</div>
            <div class="w-32 shrink-0">Pressure</div>
          </div>
        </div>

        <div class="divide-y divide-border/50">
          <% @teams.each do |team| %>
            <% team_id = team["team_id"] %>
            <% team_code = team["team_code"].to_s %>
            <% team_href_value = team_href(team_code: team_code, team_id: team_id) %>
            <% pressure_bucket = team["pressure_bucket"].to_s %>

            <% pressure_label, pressure_chip_classes = case pressure_bucket
              when "over_apron2"
                ["Over Apron 2", "entity-chip entity-chip--danger"]
              when "over_apron1"
                ["Over Apron 1", "entity-chip entity-chip--warning"]
              when "over_tax"
                ["Over Tax", "entity-chip entity-chip--warning"]
              when "over_cap"
                ["Over Cap", "entity-chip entity-chip--muted"]
              else
                ["Under Cap", "entity-chip entity-chip--success"]
              end %>

            <% cap_space = team["cap_space"] %>
            <% room_tax = team["room_under_tax"] %>
            <% room_a1 = team["room_under_apron1"] %>
            <% room_a2 = team["room_under_apron2"] %>
            <% luxury_tax_owed = team["luxury_tax_owed"] %>

            <% row_click_expr = "$selectedteamid = '#{team_id}'; $overlaytype = 'team'; @get('/teams/sidebar/#{team_id}')" %>
            <% pin_a_expr = "@get('/teams/sse/refresh?' + (#{refresh_query_expr}) + '&action=pin&slot=a&team_id=#{team_id}')" %>
            <% pin_b_expr = "@get('/teams/sse/refresh?' + (#{refresh_query_expr}) + '&action=pin&slot=b&team_id=#{team_id}')" %>

            <div
              class="group cursor-pointer transition-colors duration-75 hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10"
              role="button"
              tabindex="0"
              data-class="{ 'bg-yellow-100/80 dark:bg-yellow-900/20': $selectedteamid === '<%= team_id %>', 'ring-1 ring-inset ring-indigo-500/50': $comparea === '<%= team_id %>', 'ring-1 ring-inset ring-emerald-500/50': $compareb === '<%= team_id %>' }"
              data-on:click="<%= row_click_expr %>"
              data-on:keydown="if (evt.key === 'Enter' || evt.key === ' ') { evt.preventDefault(); <%= row_click_expr %>; }"
            >
              <div class="flex items-center px-4 min-h-[48px]">
                <div class="w-64 shrink-0">
                  <div class="grid grid-cols-[36px_1fr] grid-rows-[24px_16px]">
                    <div class="row-span-2 flex items-center justify-start">
                      <div class="w-8 h-8 rounded border border-border bg-background overflow-hidden flex items-center justify-center">
                        <img
                          src="<%= team_logo_url(team_id) %>"
                          alt="<%= team_code %>"
                          class="w-full h-full object-contain"
                          loading="lazy"
                          decoding="async"
                          onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                        />
                        <span class="hidden text-[9px] font-mono text-muted-foreground"><%= team_code %></span>
                      </div>
                    </div>

                    <div class="h-[24px] flex items-end min-w-0 pl-2">
                      <a href="<%= team_href_value %>" class="truncate font-medium text-[14px] group-hover:text-primary transition-colors" onclick="event.stopPropagation()"><%= team["team_name"] %></a>
                    </div>

                    <div class="h-[16px] -mt-px flex items-start justify-between gap-2 min-w-0 pl-2 leading-none text-[10px] text-muted-foreground/80 tabular-nums overflow-hidden">
                      <div class="min-w-0 flex items-start gap-1 overflow-hidden whitespace-nowrap">
                        <span class="font-medium"><%= team_code %></span>
                        <span>·</span>
                        <span class="truncate"><%= team["conference_name"].presence || "—" %></span>
                        <% if team["division_name"].present? %>
                          <span>·</span>
                          <span class="truncate"><%= team["division_name"] %></span>
                        <% end %>
                        <span class="inline-flex items-center rounded border border-indigo-500/40 bg-indigo-500/10 px-1 text-[9px] font-semibold text-indigo-700 dark:text-indigo-300" data-show="$comparea === '<%= team_id %>'" style="display: none;">A</span>
                        <span class="inline-flex items-center rounded border border-emerald-500/40 bg-emerald-500/10 px-1 text-[9px] font-semibold text-emerald-700 dark:text-emerald-300" data-show="$compareb === '<%= team_id %>'" style="display: none;">B</span>
                      </div>

                      <div class="ml-1 flex items-center gap-1 shrink-0" data-on:click="evt.stopPropagation()" data-on:keydown="evt.stopPropagation()">
                        <button
                          type="button"
                          class="cursor-pointer h-4 px-1 rounded border border-border/70 text-[9px] font-semibold uppercase tracking-wide text-muted-foreground hover:text-foreground hover:border-foreground/30 transition-colors"
                          aria-label="Pin <%= team['team_name'] %> to compare slot A"
                          title="Pin to compare slot A"
                          data-class="{ 'border-indigo-500/60 bg-indigo-500/10 text-indigo-700 dark:text-indigo-300': $comparea === '<%= team_id %>' }"
                          data-on:click="evt.stopPropagation(); <%= pin_a_expr %>"
                        >Pin A</button>

                        <button
                          type="button"
                          class="cursor-pointer h-4 px-1 rounded border border-border/70 text-[9px] font-semibold uppercase tracking-wide text-muted-foreground hover:text-foreground hover:border-foreground/30 transition-colors"
                          aria-label="Pin <%= team['team_name'] %> to compare slot B"
                          title="Pin to compare slot B"
                          data-class="{ 'border-emerald-500/60 bg-emerald-500/10 text-emerald-700 dark:text-emerald-300': $compareb === '<%= team_id %>' }"
                          data-on:click="evt.stopPropagation(); <%= pin_b_expr %>"
                        >Pin B</button>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="w-24 shrink-0 flex items-center justify-end">
                  <span class="font-mono tabular-nums text-sm <%= if cap_space.nil?
                    'text-muted-foreground'
                  elsif cap_space.to_f < 0
                    'text-red-600 dark:text-red-400'
                  else
                    'text-emerald-600 dark:text-emerald-400'
                  end %>"><%= cap_space.nil? ? '—' : format_room_amount(cap_space) %></span>
                </div>

                <div class="w-24 shrink-0 flex items-center justify-end">
                  <span class="font-mono tabular-nums text-sm <%= room_tax.nil? ? 'text-muted-foreground' : (room_tax.to_f < 0 ? 'text-red-600 dark:text-red-400' : '') %>"><%= room_tax.nil? ? '—' : format_room_amount(room_tax) %></span>
                </div>

                <div class="w-24 shrink-0 flex items-center justify-end">
                  <span class="font-mono tabular-nums text-sm <%= room_a1.nil? ? 'text-muted-foreground' : (room_a1.to_f < 0 ? 'text-red-600 dark:text-red-400' : '') %>"><%= room_a1.nil? ? '—' : format_room_amount(room_a1) %></span>
                </div>

                <div class="w-24 shrink-0 flex items-center justify-end">
                  <span class="font-mono tabular-nums text-sm <%= room_a2.nil? ? 'text-muted-foreground' : (room_a2.to_f < 0 ? 'text-red-600 dark:text-red-400' : '') %>"><%= room_a2.nil? ? '—' : format_room_amount(room_a2) %></span>
                </div>

                <div class="w-24 shrink-0 flex items-center justify-end">
                  <span class="font-mono tabular-nums text-sm <%= luxury_tax_owed.to_f > 0 ? 'text-red-600 dark:text-red-400' : 'text-muted-foreground' %>"><%= luxury_tax_owed.to_f > 0 ? format_compact_currency(luxury_tax_owed) : '—' %></span>
                </div>

                <div class="w-16 shrink-0 flex items-center justify-end">
                  <span class="font-mono tabular-nums text-sm"><%= team["roster_row_count"].present? ? team["roster_row_count"].to_i : '—' %></span>
                </div>

                <div class="w-16 shrink-0 flex items-center justify-end">
                  <span class="font-mono tabular-nums text-sm"><%= team["two_way_row_count"].present? ? team["two_way_row_count"].to_i : '—' %></span>
                </div>

                <div class="w-32 shrink-0">
                  <div class="entity-cell-two-line">
                    <div class="entity-cell-primary">
                      <span class="<%= pressure_chip_classes %>"><%= pressure_label %></span>
                    </div>
                    <div class="entity-cell-secondary">
                      <% if team["is_repeater_taxpayer"] %>
                        <span class="entity-chip entity-chip--danger">Repeater</span>
                      <% elsif team["is_taxpayer"] %>
                        <span class="entity-chip entity-chip--warning">Taxpayer</span>
                      <% else %>
                        <span class="text-muted-foreground/70">No tax</span>
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</main>
