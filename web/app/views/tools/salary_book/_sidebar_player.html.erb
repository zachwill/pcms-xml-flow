<%#
  Player overlay (RightPanel entity) — Tailwind port of the React prototype (PlayerDetail)

  NOTE: Root id must remain stable for Datastar morphing.
%>

<% salary_years = SalaryBookHelper::SALARY_YEARS %>

<% money = ->(v) { v.nil? ? "—" : number_to_currency(v.to_i, precision: 0) } %>
<% compact = ->(v) { format_salary(v) } %>

<% player_id = player["player_id"] %>
<% player_name = player["player_name"] %>
<% team_code = player["team_code"] || "—" %>
<% agent_name = player["agent_name"] %>
<% agent_id = player["agent_id"] %>
<% age_yos = player_age_yos_display(player) %>
<% is_two_way = player["is_two_way"] %>

<%
  years_data = salary_years.map do |y|
    salary = player["cap_#{y}"]
    option = normalize_contract_option(player["option_#{y}"])
    guaranteed_amount = player["guaranteed_amount_#{y}"]
    is_full = player["is_fully_guaranteed_#{y}"]
    is_partial = player["is_partially_guaranteed_#{y}"]
    is_non = player["is_non_guaranteed_#{y}"]
    likely_bonus = player["likely_bonus_#{y}"]
    unlikely_bonus = player["unlikely_bonus_#{y}"]

    guarantee_status = if is_full
      "FULL"
    elsif is_partial
      "PARTIAL"
    elsif is_non
      "NONE"
    end

    {
      year: y,
      salary: salary,
      option: option,
      guaranteed_amount: guaranteed_amount,
      guarantee_status: guarantee_status,
      likely_bonus: likely_bonus,
      unlikely_bonus: unlikely_bonus
    }
  end

  active_years = years_data.select { |yd| yd[:salary].present? && yd[:salary].to_f > 0 }

  total_value = active_years.sum { |yd| yd[:salary].to_f }
  contract_years = active_years.size
%>

<%
  # Trade restrictions
  is_no_trade = player["is_no_trade"]
  is_trade_bonus = player["is_trade_bonus"]
  trade_bonus_percent = player["trade_bonus_percent"]
  is_consent_required = player["is_trade_consent_required_now"]
  is_preconsented = player["is_trade_preconsented"]
  is_poison_pill = player["is_poison_pill"]

  trade_kicker_label = if trade_bonus_percent.present? && trade_bonus_percent.to_f > 0
    pct = trade_bonus_percent.to_f
    pct_str = pct % 1 == 0 ? pct.to_i.to_s : pct.to_s
    "#{pct_str}% Trade Kicker"
  else
    "Trade Kicker"
  end

  restrictions = [
    { label: trade_kicker_label, active: is_trade_bonus, color: "orange" },
    { label: "No-Trade Clause", active: is_no_trade, color: "red" },
    { label: "Consent Required", active: is_consent_required, color: "red" },
    { label: "Poison Pill", active: is_poison_pill, color: "red", italic: true },
    { label: "Pre-consented", active: is_preconsented, color: "green" }
  ]

  active_restrictions = restrictions.select { |r| r[:active] }

  badge_color = {
    "red" => "bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-300",
    "orange" => "bg-orange-100 text-orange-700 dark:bg-orange-900/50 dark:text-orange-300",
    "green" => "bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-300"
  }
%>

<%
  contract_type = player["contract_type_lookup_value"] || player["contract_type_code"]
  signed_using = player["signed_method_lookup_value"]
  exception_type = player["exception_type_lookup_value"]
  min_contract = player["is_min_contract"] ? player["min_contract_lookup_value"] : nil
%>

<div id="rightpanel-overlay" class="h-full" data-signals="{ playertab: 'contract' }">
  <%# Sticky header (keeps back button visible while scrolling) %>
  <div class="sticky top-0 z-20 h-10 px-4 flex items-center justify-between border-b border-border bg-background">
    <%= render partial: "tools/salary_book/sidebar_back_button" %>

    <a
      class="text-xs text-muted-foreground hover:text-foreground hover:underline"
      href="<%= player_href(player_id) %>"
    >Open player page</a>
  </div>

  <div class="px-4 pb-4 pt-4 space-y-6">
    <%# Player header %>
    <div class="flex items-center gap-4">
      <div class="w-20 h-20 rounded border border-border bg-background overflow-hidden shrink-0">
        <img
          src="<%= player_headshot_url(player_id) %>"
          alt="<%= player_name %>"
          class="w-full h-full object-cover object-top bg-muted"
          onerror="if (this.src !== '<%= fallback_headshot_data_uri %>') { this.src = '<%= fallback_headshot_data_uri %>'; }"
        />
      </div>
      <div class="space-y-0.5">
        <h2 class="text-lg font-semibold text-foreground"><%= player_name %></h2>
        <div class="text-sm text-muted-foreground"><%= team_code %></div>
        <% if age_yos.present? %>
          <div class="text-xs text-muted-foreground/80 tabular-nums"><%= age_yos %></div>
        <% end %>
      </div>
    </div>

    <%# Tab toggle (4 tabs) %>
    <div class="relative grid grid-cols-4 p-1 rounded-lg bg-muted border border-border">
      <%# Sliding indicator %>
      <div
        class="absolute top-1 bottom-1 left-1 w-[calc((100%_-_8px)/4)] rounded-md bg-background shadow-sm pointer-events-none transition-[transform,width,opacity] duration-150 ease-out"
        data-class="{
          'translate-x-0': $playertab === 'contract',
          'translate-x-full': $playertab === 'stats',
          'translate-x-[200%]': $playertab === 'history',
          'translate-x-[300%]': $playertab === 'comps'
        }"
        aria-hidden="true"
      ></div>

      <% player_tabs = [
        ["contract", "Contract"],
        ["stats", "Stats"],
        ["history", "History"],
        ["comps", "Comps"]
      ] %>

      <% player_tabs.each do |(id, label)| %>
        <button
          type="button"
          class="cursor-pointer relative z-10 min-w-0 px-3 py-1.5 text-sm font-medium text-center rounded-md transition-colors duration-150
                 focus-visible:outline-none focus-visible:ring-0 focus-visible:border-foreground dark:focus-visible:border-foreground"
          data-on:click="$playertab = '<%= id %>'"
          data-class="{ 'text-foreground': $playertab === '<%= id %>', 'text-muted-foreground hover:text-foreground': $playertab !== '<%= id %>' }"
        ><%= label %></button>
      <% end %>
    </div>

    <%# Contract tab %>
    <div data-show="$playertab === 'contract'" class="space-y-6">

    <%# Contract summary %>
    <div class="space-y-3">
      <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Contract</div>
      <div class="p-4 rounded-lg bg-muted/30 border border-border/50 space-y-3">
        <div class="flex items-baseline justify-between">
          <span class="text-sm text-muted-foreground">Total Value</span>
          <span class="tabular-nums text-lg font-semibold"><%= compact.call(total_value) %></span>
        </div>

        <div class="flex items-baseline justify-between">
          <span class="text-sm text-muted-foreground">Years</span>
          <span class="text-sm font-medium"><%= contract_years %> yr<%= contract_years != 1 ? "s" : "" %></span>
        </div>

        <% if contract_type.present? %>
          <div class="flex items-baseline justify-between">
            <span class="text-sm text-muted-foreground">Type</span>
            <span class="text-sm font-medium text-right ml-4"><%= contract_type %></span>
          </div>
        <% end %>

        <% if signed_using.present? %>
          <div class="flex items-baseline justify-between">
            <span class="text-sm text-muted-foreground">Signed Via</span>
            <span class="text-sm font-medium text-right ml-4"><%= signed_using %></span>
          </div>
        <% end %>

        <% if exception_type.present? %>
          <div class="flex items-baseline justify-between">
            <span class="text-sm text-muted-foreground">Exception</span>
            <span class="text-sm font-medium text-right ml-4"><%= exception_type %></span>
          </div>
        <% end %>

        <% if min_contract.present? %>
          <div class="flex items-baseline justify-between">
            <span class="text-sm text-muted-foreground">Minimum</span>
            <span class="text-sm font-medium text-right ml-4"><%= min_contract %></span>
          </div>
        <% end %>

        <% if is_two_way %>
          <div class="flex items-center justify-between">
            <span class="text-sm text-muted-foreground">Contract Type</span>
            <span class="inline-flex px-2 py-0.5 rounded text-xs font-medium bg-zinc-100/80 dark:bg-zinc-800/60 text-zinc-700 dark:text-zinc-300">Two-Way</span>
          </div>
        <% end %>

        <% if agent_name.present? %>
          <div class="flex items-baseline justify-between">
            <span class="text-sm text-muted-foreground">Agent</span>
            <% if agent_id.present? %>
              <button
                type="button"
                class="cursor-pointer text-sm font-medium text-blue-600 dark:text-blue-400 hover:underline
                       focus-visible:outline-none focus-visible:ring-0 focus-visible:border-foreground dark:focus-visible:border-foreground"
                data-on:click="@get('<%= tools_salary_book_sidebar_agent_path(id: agent_id) %>')"
              ><%= agent_name %></button>
            <% else %>
              <span class="text-sm font-medium"><%= agent_name %></span>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>

    <%# Year-by-year %>
    <div class="space-y-3">
      <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Year-by-Year</div>

      <% if active_years.empty? %>
        <div class="p-3 rounded-lg bg-muted/30 text-sm text-muted-foreground italic">No salary data available</div>
      <% else %>
        <div class="space-y-1">
          <% active_years.each do |yd| %>
            <%
              y = yd[:year]
              salary = yd[:salary]
              option = yd[:option]
              guaranteed_amount = yd[:guaranteed_amount]
              guarantee_status = yd[:guarantee_status]
              likely_bonus = yd[:likely_bonus]
              unlikely_bonus = yd[:unlikely_bonus]

              guarantee_label = case guarantee_status
              when "FULL" then "Full"
              when "PARTIAL" then "Partial"
              when "NONE" then "None"
              end

              show_option = option.present? && y != salary_years.first
              show_guarantee = guarantee_label.present? || guaranteed_amount.present?
              show_likely = likely_bonus.present? && likely_bonus.to_f != 0
              show_unlikely = unlikely_bonus.present? && unlikely_bonus.to_f != 0

              option_badge_classes = case option
              when "PO" then "bg-blue-100 text-blue-700 dark:bg-blue-900/50 dark:text-blue-300"
              when "TO" then "bg-purple-100 text-purple-700 dark:bg-purple-900/50 dark:text-purple-300"
              when "ETO" then "bg-orange-100 text-orange-700 dark:bg-orange-900/50 dark:text-orange-300"
              else nil
              end

              option_label = case option
              when "PO" then "PLAYER"
              when "TO" then "TEAM"
              when "ETO" then "ETO"
              else option
              end
            %>

            <div class="space-y-1 py-2 px-3 rounded hover:bg-muted/30 transition-colors">
              <div class="flex items-center justify-between">
                <div class="flex items-center gap-2">
                  <span class="text-sm text-muted-foreground tabular-nums"><%= format_year_label(y) %></span>
                  <% if show_option && option_badge_classes %>
                    <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-[9px] font-semibold uppercase tracking-wide leading-none <%= option_badge_classes %>">
                      <%= option_label %>
                    </span>
                  <% end %>
                </div>
                <span class="tabular-nums text-sm font-medium"><%= compact.call(salary) %></span>
              </div>

              <% if show_guarantee %>
                <div class="flex items-baseline justify-between text-[11px] text-muted-foreground">
                  <span>Guarantee<%= guarantee_label ? ": #{guarantee_label}" : "" %></span>
                  <span class="tabular-nums"><%= compact.call(guaranteed_amount) %></span>
                </div>
              <% end %>

              <% if show_likely %>
                <div class="flex items-baseline justify-between text-[11px] text-muted-foreground">
                  <span>Likely Bonus</span>
                  <span class="tabular-nums"><%= compact.call(likely_bonus) %></span>
                </div>
              <% end %>

              <% if show_unlikely %>
                <div class="flex items-baseline justify-between text-[11px] text-muted-foreground">
                  <span>Unlikely Bonus</span>
                  <span class="tabular-nums"><%= compact.call(unlikely_bonus) %></span>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>

    <%# Trade Restrictions %>
    <% if active_restrictions.any? %>
      <div class="space-y-3">
        <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Trade Restrictions</div>
        <div class="flex flex-wrap gap-2">
          <% active_restrictions.each do |r| %>
            <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-[9px] font-semibold uppercase tracking-wide leading-none <%= badge_color[r[:color]] %> <%= r[:italic] ? 'italic' : '' %>">
              <%= r[:label] %>
            </span>
          <% end %>
        </div>
      </div>
    <% end %>

    </div><%# end Contract tab %>

    <%# Stats tab %>
    <div data-show="$playertab === 'stats'" class="space-y-4">
      <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Player Stats</div>
      <div class="p-4 rounded-lg bg-muted/30 border border-border/50 text-sm text-muted-foreground italic">
        Per-game and advanced stats coming soon.
      </div>
    </div>

    <%# History tab %>
    <div data-show="$playertab === 'history'" class="space-y-4">
      <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Contract History</div>
      <div class="p-4 rounded-lg bg-muted/30 border border-border/50 text-sm text-muted-foreground italic">
        Past contracts and team history coming soon.
      </div>
    </div>

    <%# Comps tab %>
    <div data-show="$playertab === 'comps'" class="space-y-4">
      <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Comparable Players</div>
      <div class="p-4 rounded-lg bg-muted/30 border border-border/50 text-sm text-muted-foreground italic">
        Similar contracts and player comparisons coming soon.
      </div>
    </div>

  </div>
</div>
