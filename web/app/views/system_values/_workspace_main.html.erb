<% section_meta = [
  { key: "system", label: "System", target: "section-system", visibility: "$showsystemvalues" },
  { key: "tax", label: "Tax", target: "section-tax", visibility: "$showtaxrates" },
  { key: "minimum", label: "Minimum", target: "section-minimum", visibility: "$showsalaryscales" },
  { key: "rookie", label: "Rookie", target: "section-rookie", visibility: "$showrookiescales" }
] %>

<nav id="system-values-wayfinding" class="h-10 border-b border-border bg-muted/20 px-4 flex items-center gap-2">
  <% section_meta.each do |section| %>
    <button
      type="button"
      class="cursor-pointer h-6 px-2 rounded border border-transparent text-[10px] uppercase tracking-wide font-medium transition-colors"
      data-show="<%= section[:visibility] %>"
      data-class="{
        'border-border bg-background text-foreground': $activesection === '<%= section[:key] %>',
        'text-muted-foreground hover:text-foreground hover:border-border/70': $activesection !== '<%= section[:key] %>'
      }"
      data-on:click="
        const target = document.getElementById('<%= section[:target] %>');
        const scroller = document.getElementById('maincanvas');
        if (target && scroller) {
          scroller.scrollTo({ top: Math.max(target.offsetTop - 8, 0), behavior: 'smooth' });
          $activesection = '<%= section[:key] %>';
        }
      "
    ><%= section[:label] %></button>
  <% end %>

  <div class="ml-auto flex items-center gap-1.5">
    <% @section_shift_cards.each do |card| %>
      <% card_class = case card[:variant]
      when "positive"
        "text-emerald-700 dark:text-emerald-300 border-emerald-300/70 dark:border-emerald-500/40 bg-emerald-50/60 dark:bg-emerald-900/20"
      when "negative"
        "text-red-700 dark:text-red-300 border-red-300/70 dark:border-red-500/40 bg-red-50/60 dark:bg-red-900/20"
      when "neutral"
        "text-foreground border-border/80 bg-background"
      else
        "text-muted-foreground border-border/70 bg-background"
      end %>

      <% visibility_signal = section_meta.find { |section| section[:key] == card[:key] }&.dig(:visibility) || "true" %>
      <div data-show="<%= visibility_signal %>" class="h-6 px-2 rounded border text-[10px] font-mono tabular-nums inline-flex items-center gap-1 <%= card_class %>">
        <span class="font-semibold"><%= card[:label] %></span>
        <span><%= card[:metric_label] %> <%= card[:delta_label] %></span>
      </div>
    <% end %>
  </div>
</nav>

<% if @boot_error %>
  <div class="p-4">
    <div class="p-4 rounded-lg border border-border bg-muted/20">
      <div class="text-sm font-medium text-destructive">Warehouse query failed</div>
      <pre class="mt-2 text-xs text-muted-foreground overflow-x-auto"><%= @boot_error %></pre>
    </div>
  </div>
<% else %>
  <div class="divide-y divide-border/60">
    <div id="section-system" class="scroll-mt-2">
      <div
        data-system-values-table-scroll
        class="relative overflow-x-auto overflow-y-visible overscroll-x-contain [scrollbar-width:none] [-ms-overflow-style:none] [&::-webkit-scrollbar]:hidden"
      >
        <div
          data-system-values-sticky-shadow
          class="absolute top-0 bottom-0 pointer-events-none z-[25] transition-opacity duration-150 opacity-0"
          style="left: 144px; width: 6px; background: linear-gradient(to right, rgba(0, 0, 0, 0.06), transparent);"
          aria-hidden="true"
        ></div>

        <%= render partial: "system_values/league_system_values_table", locals: {
          rows: @league_system_values,
          selected_year: @selected_year,
          baseline_year: @baseline_year,
          baseline_row: @baseline_system_values_row,
          overlay_query_expr:,
          sidebar_metric_path: system_values_sidebar_metric_path
        } %>
      </div>
    </div>

    <div id="section-tax" class="scroll-mt-2">
      <div
        data-system-values-table-scroll
        class="relative overflow-x-auto overflow-y-visible overscroll-x-contain [scrollbar-width:none] [-ms-overflow-style:none] [&::-webkit-scrollbar]:hidden"
      >
        <div
          data-system-values-sticky-shadow
          class="absolute top-0 bottom-0 pointer-events-none z-[25] transition-opacity duration-150 opacity-0"
          style="left: 144px; width: 6px; background: linear-gradient(to right, rgba(0, 0, 0, 0.06), transparent);"
          aria-hidden="true"
        ></div>

        <%= render partial: "system_values/league_tax_rates_table", locals: {
          rows: @league_tax_rates,
          selected_year: @selected_year,
          baseline_year: @baseline_year,
          baseline_rows: @baseline_tax_rate_rows,
          overlay_query_expr:,
          sidebar_metric_path: system_values_sidebar_metric_path
        } %>
      </div>
    </div>

    <div id="section-minimum" class="scroll-mt-2">
      <div
        data-system-values-table-scroll
        class="relative overflow-x-auto overflow-y-visible overscroll-x-contain [scrollbar-width:none] [-ms-overflow-style:none] [&::-webkit-scrollbar]:hidden"
      >
        <div
          data-system-values-sticky-shadow
          class="absolute top-0 bottom-0 pointer-events-none z-[25] transition-opacity duration-150 opacity-0"
          style="left: 144px; width: 6px; background: linear-gradient(to right, rgba(0, 0, 0, 0.06), transparent);"
          aria-hidden="true"
        ></div>

        <%= render partial: "system_values/league_salary_scales_table", locals: {
          rows: @league_salary_scales,
          selected_year: @selected_year,
          baseline_year: @baseline_year,
          baseline_rows: @baseline_salary_scale_rows,
          overlay_query_expr:,
          sidebar_metric_path: system_values_sidebar_metric_path
        } %>
      </div>
    </div>

    <div id="section-rookie" class="scroll-mt-2">
      <div
        data-system-values-table-scroll
        class="relative overflow-x-auto overflow-y-visible overscroll-x-contain [scrollbar-width:none] [-ms-overflow-style:none] [&::-webkit-scrollbar]:hidden"
      >
        <div
          data-system-values-sticky-shadow
          class="absolute top-0 bottom-0 pointer-events-none z-[25] transition-opacity duration-150 opacity-0"
          style="left: 144px; width: 6px; background: linear-gradient(to right, rgba(0, 0, 0, 0.06), transparent);"
          aria-hidden="true"
        ></div>

        <%= render partial: "system_values/rookie_scale_amounts_table", locals: {
          rows: @rookie_scale_amounts,
          selected_year: @selected_year,
          baseline_year: @baseline_year,
          baseline_rows: @baseline_rookie_scale_rows,
          overlay_query_expr:,
          sidebar_metric_path: system_values_sidebar_metric_path
        } %>
      </div>
    </div>
  </div>
<% end %>
