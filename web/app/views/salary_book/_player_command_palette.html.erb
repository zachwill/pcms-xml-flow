<div
  id="sbplayercmdk"
  class="fixed inset-0 z-[90] flex items-start justify-center px-4 pt-24 pb-10"
  data-combobox-cmdk
  data-signals="{
    _sbplayercmdkopen: false,
    _sbplayercbopen: false,
    _sbplayercbquery: '',
    _sbplayercbactiveindex: -1,
    _sbplayercbcomposing: false,
    _sbplayercbloading: false,
    _sbplayercbrequestq: '',
    _sbplayercbrequestseq: 0,
    _sbplayercblastdispatchedseq: 0,
    _sbplayercbresultscount: 0
  }"
  data-show="$_sbplayercmdkopen"
  style="display: none;"
  data-attr:data-open="$_sbplayercmdkopen ? 'true' : 'false'"
  data-on:keydown="if (evt.key === 'Escape') { evt.preventDefault(); el.dispatchEvent(new CustomEvent('salarybook-cmdk-close', { bubbles: true })); }"
  data-on:salarybook-cmdk-open="
    $_sbplayercmdkopen = true;
    $_sbplayercbopen = true;
    $_sbplayercbquery = '';
    $_sbplayercbactiveindex = 0;
    $_sbplayercbrequestq = '';
    $_sbplayercbresultscount = 0;
    $_sbplayercbloading = true;
    $_sbplayercbrequestseq = Number($_sbplayercbrequestseq) + 1;
    requestAnimationFrame(() => {
      const input = document.getElementById('sbplayercb-input');
      if (input) {
        input.focus();
        input.select();
      }
    });
  "
  data-on:salarybook-cmdk-close="
    $_sbplayercmdkopen = false;
    $_sbplayercbopen = false;
    $_sbplayercbactiveindex = -1;
    $_sbplayercbloading = false;
  "
>
  <div
    id="sbplayercb-loader"
    class="hidden"
    aria-hidden="true"
    data-effect="
      const nextseq = Number($_sbplayercbrequestseq);
      if (nextseq > Number($_sbplayercblastdispatchedseq)) {
        $_sbplayercblastdispatchedseq = nextseq;
        $_sbplayercbloading = true;
        @get('<%= salary_book_combobox_players_search_path %>?team=' + encodeURIComponent($activeteam || '') + '&q=' + encodeURIComponent($_sbplayercbrequestq || '') + '&limit=12&seq=' + nextseq);
      }
    "
  ></div>

  <div
    class="absolute inset-0 bg-zinc-950/25 dark:bg-black/55"
    aria-hidden="true"
    data-on:click="const root = document.getElementById('sbplayercmdk'); if (root) { root.dispatchEvent(new CustomEvent('salarybook-cmdk-close', { bubbles: true })); }"
  ></div>

  <div
    class="relative z-10 w-full max-w-2xl overflow-hidden rounded-xl border border-border/80 bg-background shadow-xl shadow-black/10 dark:shadow-black/35"
    role="dialog"
    aria-modal="true"
    aria-label="Player command palette"
  >
    <div class="h-8 px-3 border-b border-border/60 bg-muted/5 flex items-center justify-between text-[10px] uppercase tracking-wide text-muted-foreground/85">
      <span>Players</span>
      <span class="font-mono tabular-nums text-[10px] text-muted-foreground/80">↑↓: move · Enter: open · Esc: close</span>
    </div>

    <div class="p-2 space-y-2">
      <div class="relative">
        <input
          id="sbplayercb-input"
          type="text"
          class="h-10 w-full rounded-md border border-border bg-background px-3 text-sm text-foreground outline-none transition-colors focus:border-foreground/30"
          placeholder="Search players…"
          role="combobox"
          aria-controls="sbplayercb-list"
          aria-autocomplete="list"
          data-bind="_sbplayercbquery"
          data-attr:aria-expanded="$_sbplayercbopen ? 'true' : 'false'"
          data-attr:aria-activedescendant="Number($_sbplayercbactiveindex) >= 0 ? ('sbplayercb-option-' + Number($_sbplayercbactiveindex)) : ''"
          data-on:focus="$_sbplayercbopen = true"
          data-on:compositionstart="$_sbplayercbcomposing = true"
          data-on:compositionend="
            $_sbplayercbcomposing = false;
            $_sbplayercbopen = true;
            $_sbplayercbactiveindex = 0;
            $_sbplayercbrequestq = $_sbplayercbquery;
            $_sbplayercbloading = true;
            $_sbplayercbrequestseq = Number($_sbplayercbrequestseq) + 1;
          "
          data-on:input__debounce.120ms="
            if (!$_sbplayercbcomposing) {
              $_sbplayercbopen = true;
              $_sbplayercbactiveindex = 0;
              $_sbplayercbrequestq = $_sbplayercbquery;
              $_sbplayercbloading = true;
              $_sbplayercbrequestseq = Number($_sbplayercbrequestseq) + 1;
            }
          "
          data-on:keydown="
            const root = el.closest('#sbplayercmdk');
            const options = root ? Array.from(root.querySelectorAll('[data-combobox-option]')) : [];

            if (evt.key === 'ArrowDown') {
              evt.preventDefault();
              $_sbplayercbopen = true;
              if (options.length > 0) {
                const activeindex = Number($_sbplayercbactiveindex);
                const next = activeindex < 0 ? 0 : ((activeindex + 1) % options.length);
                $_sbplayercbactiveindex = next;
                options[next].scrollIntoView({ block: 'nearest' });
              }
            } else if (evt.key === 'ArrowUp') {
              evt.preventDefault();
              $_sbplayercbopen = true;
              if (options.length > 0) {
                const activeindex = Number($_sbplayercbactiveindex);
                const next = activeindex < 0 ? (options.length - 1) : ((activeindex - 1 + options.length) % options.length);
                $_sbplayercbactiveindex = next;
                options[next].scrollIntoView({ block: 'nearest' });
              }
            } else if (evt.key === 'Enter') {
              if ($_sbplayercbopen && options.length > 0) {
                const activeindex = Number($_sbplayercbactiveindex);
                const targetindex = activeindex >= 0 ? activeindex : 0;
                const activeOption = options[targetindex];
                const playerId = activeOption ? activeOption.getAttribute('data-player-id') : '';

                if (playerId) {
                  evt.preventDefault();
                  @get('/salary-book/sidebar/player/' + encodeURIComponent(playerId));
                  $_sbplayercmdkopen = false;
                  $_sbplayercbopen = false;
                  $_sbplayercbquery = '';
                  $_sbplayercbactiveindex = -1;
                  $_sbplayercbloading = false;
                }
              }
            } else if (evt.key === 'Escape') {
              evt.preventDefault();
              if (root) {
                root.dispatchEvent(new CustomEvent('salarybook-cmdk-close', { bubbles: true }));
              }
            } else if (evt.key === 'Tab') {
              if (root) {
                root.dispatchEvent(new CustomEvent('salarybook-cmdk-close', { bubbles: true }));
              }
            }
          "
        />

        <button
          type="button"
          class="absolute right-1 top-1/2 -translate-y-1/2 h-8 px-2 rounded text-[10px] uppercase tracking-wide text-muted-foreground/80 hover:text-foreground hover:bg-muted/60 transition-colors"
          data-show="$_sbplayercbquery !== ''"
          style="display: none;"
          data-on:mousedown="evt.preventDefault()"
          data-on:click="
            $_sbplayercbquery = '';
            $_sbplayercbactiveindex = 0;
            $_sbplayercbopen = true;
            $_sbplayercbrequestq = '';
            $_sbplayercbloading = true;
            $_sbplayercbrequestseq = Number($_sbplayercbrequestseq) + 1;
          "
        >
          Clear
        </button>
      </div>

      <%= render partial: "salary_book/combobox_players_popup", locals: {
        players: [],
        query: "",
        seq: 0,
        team_code: @initial_team,
        error_message: nil
      } %>
    </div>
  </div>
</div>
