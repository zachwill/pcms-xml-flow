<%#
  TeamSection — Tailwind port of the React prototype (TeamSection + SalaryTable)

  Layout:
  - Vertical sticky header group (TeamHeader + horizontally-scrollable TableHeader)
  - Horizontally-scrollable body (Player rows + supplementary sections + totals)
  - Sticky left "player" column
%>

<% salary_years ||= SalaryBookHelper::SALARY_YEARS %>
<% cap_holds ||= [] %>
<% exceptions ||= [] %>
<% dead_money ||= [] %>
<% picks ||= [] %>
<% team_summaries ||= {} %>
<% team_meta ||= {} %>

<%# Extract team info %>
<% team_name = team_meta["team_name"] || team_code %>
<% conference = team_meta["conference_name"] || "—" %>
<% team_id = team_meta["team_id"] %>
<% logo_url = team_logo_url(team_id) %>

<%# Current-year summary for KPI cards %>
<% current_summary = team_summaries[year] || team_summaries[salary_years.first] || {} %>
<% roster_count = current_summary["roster_row_count"] %>
<% two_way_count = current_summary["two_way_row_count"] %>
<% cap_total = current_summary["cap_total"] %>
<% cap_space = current_summary["cap_space"] %>
<% room_tax = current_summary["room_under_tax"] %>
<% room_a1 = current_summary["room_under_first_apron"] %>
<% room_a2 = current_summary["room_under_second_apron"] %>

<%
  # Column math (must match Tailwind widths)
  # w-52 = 208px, w-24 = 96px, w-40 = 160px
  sticky_left_px = 208
  col_px = 96
  agent_px = 160
  min_table_width_px = sticky_left_px + ((salary_years.length + 1) * col_px) + agent_px
%>

<section
  id="<%= team_code %>"
  data-teamcode="<%= team_code %>"
  class="border-b border-border snap-start"
  style="content-visibility: auto; contain-intrinsic-size: 1200px 600px;"
>
  <div class="relative" data-salarytable>
    <%# Sticky header group (vertical sticky) %>
    <div
      class="sticky top-0 z-30 bg-background will-change-transform
             shadow-[0_1px_3px_0_rgb(0_0_0/0.1),0_1px_2px_-1px_rgb(0_0_0/0.1)]"
    >
      <%# Content wrapper so scroll-spy can fade text/KPIs without fading the background %>
      <div data-header-content>
        <%# TeamHeader (does not horizontally scroll) %>
        <div class="h-14 flex items-center border-b border-border bg-muted">
          <%# Left section: Logo + Team name + Conference (fixed width) %>
          <div class="w-52 shrink-0 pl-4 flex items-center gap-3">
            <div class="w-8 h-8 rounded flex items-center justify-center flex-shrink-0 bg-background border border-border overflow-hidden">
              <% if logo_url %>
                <img
                  src="<%= logo_url %>"
                  alt="<%= team_name %> logo"
                  class="w-full h-full object-contain"
                  onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                />
                <span class="hidden text-[10px] font-mono font-bold uppercase tracking-tight text-muted-foreground"><%= team_code %></span>
              <% else %>
                <span class="text-[10px] font-mono font-bold uppercase tracking-tight text-muted-foreground"><%= team_code %></span>
              <% end %>
            </div>

            <div class="grid grid-rows-[24px_16px] min-w-0">
              <div class="h-[24px] flex items-end min-w-0">
                <button
                  type="button"
                  class="cursor-pointer font-semibold leading-tight text-left text-[14px] block w-full truncate hover:text-primary transition-colors
                         focus:outline-none focus-visible:underline focus-visible:text-primary"
                  data-on:click="$activeteam = '<%= team_code %>'"
                ><%= team_name %></button>
              </div>
              <div class="h-[16px] -mt-px flex items-start min-w-0">
                <span class="text-[10px] leading-none tabular-nums text-muted-foreground/80 truncate"><%= conference %> Conference</span>
              </div>
            </div>
          </div>

          <%# KPI cards row (aligned with year + total columns) %>
          <div class="flex items-center">
            <div class="w-24 shrink-0 flex justify-center">
              <% if roster_count %>
                <%= render partial: "tools/salary_book/kpi_cell", locals: { label: "Roster", value: roster_count.to_s, title: "Number of roster players" } %>
              <% end %>
            </div>

            <div class="w-24 shrink-0 flex justify-center">
              <% if two_way_count %>
                <%= render partial: "tools/salary_book/kpi_cell", locals: { label: "Two-Way", value: two_way_count.to_s, title: "Number of two-way contracts" } %>
              <% end %>
            </div>

            <div class="w-24 shrink-0 flex justify-center">
              <% if cap_total %>
                <%= render partial: "tools/salary_book/kpi_cell", locals: { label: "Total", value: format_compact_currency(cap_total), title: "Current year total salary" } %>
              <% end %>
            </div>

            <div class="w-24 shrink-0 flex justify-center">
              <% if cap_space %>
                <% variant = cap_space.to_f > 0 ? "positive" : "default" %>
                <%= render partial: "tools/salary_book/kpi_cell", locals: { label: "Cap Space", value: format_room_amount(cap_space), title: "Cap space", variant: } %>
              <% end %>
            </div>

            <div class="w-24 shrink-0 flex justify-center" data-show="$displaytaxaprons">
              <% if room_tax %>
                <% variant = room_tax.to_f < 0 ? "negative" : "default" %>
                <%= render partial: "tools/salary_book/kpi_cell", locals: { label: "Tax Room", value: format_room_amount(room_tax), title: "Room under luxury tax", variant: } %>
              <% end %>
            </div>

            <div class="w-24 shrink-0 flex justify-center" data-show="$displaytaxaprons">
              <% if room_a1 %>
                <% variant = room_a1.to_f < 0 ? "negative" : "default" %>
                <%= render partial: "tools/salary_book/kpi_cell", locals: { label: "Apron 1", value: format_room_amount(room_a1), title: "Room under first apron", variant: } %>
              <% end %>
            </div>

            <div class="w-24 shrink-0 flex justify-center" data-show="$displaytaxaprons">
              <% if room_a2 %>
                <% variant = room_a2.to_f < 0 ? "negative" : "default" %>
                <%= render partial: "tools/salary_book/kpi_cell", locals: { label: "Apron 2", value: format_room_amount(room_a2), title: "Room under second apron", variant: } %>
              <% end %>
            </div>

            <%# Agent column spacer %>
            <div class="w-40 shrink-0 pr-4"></div>
          </div>
        </div>

        <%# TableHeader (horizontally scrollable; synced with body) %>
        <div
          data-salarytable-header-scroll
          class="overflow-x-auto overscroll-x-contain
                 [scrollbar-width:none] [-ms-overflow-style:none] [&::-webkit-scrollbar]:hidden"
        >
          <div class="min-w-max" style="min-width: <%= min_table_width_px %>px;">
            <%= render partial: "tools/salary_book/table_header", locals: { salary_years: salary_years, team_code: team_code } %>
          </div>
        </div>
      </div>
    </div>

    <%# Shadow overlay for sticky column edge (appears when horizontally scrolled) %>
    <div
      data-salarytable-sticky-shadow
      class="absolute top-0 bottom-0 pointer-events-none z-40 transition-opacity duration-150 opacity-0"
      style="left: <%= sticky_left_px %>px; width: 10px; background: linear-gradient(to right, color-mix(in srgb, var(--border) 35%, transparent), transparent);"
      aria-hidden="true"
    ></div>


    <%# Body horizontal scroller %>
    <div
      data-salarytable-body-scroll
      class="overflow-x-auto overscroll-x-contain relative
             [scrollbar-width:none] [-ms-overflow-style:none] [&::-webkit-scrollbar]:hidden"
    >
      <div class="min-w-max" style="min-width: <%= min_table_width_px %>px;">
        <%# Player rows %>
        <div class="[&>*:first-child]:mt-1">
          <% players.each do |player| %>
            <%= render partial: "tools/salary_book/player_row", locals: { player: player, salary_years: salary_years } %>
          <% end %>
        </div>

        <% if players.empty? %>
          <div class="h-24 flex items-center justify-center text-muted-foreground text-sm">No players</div>
        <% end %>

        <%# Supplementary rows (Display filters) %>

        <div data-show="$displaycapholds">
          <% if cap_holds.any? %>
            <%= render partial: "tools/salary_book/cap_holds_section", locals: { cap_holds: cap_holds, salary_years: salary_years, team_code: team_code } %>
          <% else %>
            <%= render partial: "tools/salary_book/placeholder_section_row", locals: { label: "Cap Holds", salary_years: salary_years, team_code: team_code } %>
          <% end %>
        </div>

        <div data-show="$displayexceptions">
          <% if exceptions.any? %>
            <%= render partial: "tools/salary_book/exceptions_section", locals: { exceptions: exceptions } %>
          <% else %>
            <%= render partial: "tools/salary_book/placeholder_section_row", locals: { label: "Exceptions", salary_years: salary_years, team_code: team_code } %>
          <% end %>
        </div>

        <div data-show="$displaydeadmoney">
          <% if dead_money.any? %>
            <%= render partial: "tools/salary_book/dead_money_section", locals: { dead_money: dead_money, salary_years: salary_years, team_code: team_code } %>
          <% else %>
            <%= render partial: "tools/salary_book/placeholder_section_row", locals: { label: "Dead Money", salary_years: salary_years, team_code: team_code } %>
          <% end %>
        </div>

        <div data-show="$displaydraftpicks">
          <% if picks.any? %>
            <%= render partial: "tools/salary_book/draft_assets_section", locals: { picks: picks, salary_years: salary_years, team_code: team_code } %>
          <% else %>
            <%= render partial: "tools/salary_book/placeholder_section_row", locals: { label: "Draft Assets", salary_years: salary_years, team_code: team_code } %>
          <% end %>
        </div>

        <%# Totals footer %>
        <%= render partial: "tools/salary_book/totals_footer", locals: { team_summaries: team_summaries, salary_years: salary_years, team_code: team_code } %>
      </div>
    </div>
  </div>
</section>
