<%#
  PlayerRow — Tailwind port of the React prototype (double-row player design)

  Click anywhere → opens Player overlay.
  Click agent name → opens Agent overlay (stopPropagation).
%>

<% player_id = player["player_id"] %>
<% player_name = player["player_name"] %>
<% salary_years ||= SalaryBookHelper::SALARY_YEARS %>
<% epm_value = player["epm_value"] %>
<% epm_percentile = player["epm_percentile"] %>
<% epm_percentile_label = format_percentile_label(epm_percentile) %>
<% epm_color_class = epm_percentile_color_class(epm_percentile) %>
<% epm_has_value = !epm_value.nil? %>

<div
  id="player-<%= player_id %>"
  class="group cursor-pointer border-b border-border/50 transition-colors duration-75
         hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10"
  role="button"
  tabindex="0"
  data-on:click="@get('<%= tools_salary_book_sidebar_player_path(id: player_id) %>')"
  data-on:keydown="if (evt.key === 'Enter' || evt.key === ' ') { evt.preventDefault(); @get('<%= tools_salary_book_sidebar_player_path(id: player_id) %>') }"
>
  <div class="flex">
    <%# Sticky Player column (Headshot + Name + Details) %>
    <div
      class="w-52 shrink-0 pl-4 sticky left-0 z-20 relative
             bg-background transition-colors duration-75
             group-hover:bg-yellow-50 dark:group-hover:bg-yellow-900
             after:absolute after:right-0 after:top-0 after:bottom-0 after:w-px after:bg-border/30"
    >
      <div class="grid grid-cols-[40px_1fr] grid-rows-[24px_16px]" aria-label="<%= player_name %> player info">
        <%# Headshot spans both sub-rows %>
        <div class="row-span-2 flex items-center justify-start">
          <div class="w-7 h-7 rounded border border-border bg-background overflow-hidden">
            <img
              src="<%= player_headshot_url(player_id) %>"
              alt="<%= player_name %>"
              class="w-full h-full object-cover object-top bg-muted"
              loading="lazy"
              decoding="async"
              onerror="if (this.src !== '<%= fallback_headshot_data_uri %>') { this.src = '<%= fallback_headshot_data_uri %>'; }"
            />
          </div>
        </div>

        <%# Row A: Name %>
        <div class="h-[24px] flex items-end min-w-0 pl-1 pr-2">
          <span class="truncate font-medium text-[14px] group-hover:text-primary transition-colors">
            <%= player_name %>
          </span>
        </div>

        <%# Row B: Details %>
        <div class="h-[16px] -mt-px flex items-start gap-2 min-w-0 pl-1 pr-2 leading-none text-[10px] text-muted-foreground/80 tabular-nums">
          <% age_yos = player_age_yos_display(player) %>
          <% if age_yos.present? %>
            <span class="truncate"><%= age_yos %></span>
          <% end %>
          <% if player["is_two_way"] %>
            <span class="text-blue-600 dark:text-blue-400">2W</span>
          <% end %>
          <% if player["is_no_trade"] %>
            <span class="text-red-500">NTC</span>
          <% end %>
        </div>
      </div>
    </div>

    <%# Non-sticky columns (EPM + Years + Total + Agent) %>
    <div class="min-w-0 flex">
      <div
        class="w-24 shrink-0 bg-zinc-100/60 dark:bg-zinc-800/30 text-zinc-700 dark:text-zinc-300 <%= epm_has_value ? 'flex flex-col' : 'grid place-items-center h-[40px]' %>"
        data-show="$displayepm"
        style="display: none;"
        title="<%= epm_percentile_label.present? ? "Latest regular-season EPM (#{epm_percentile_label})" : "Latest regular-season EPM" %>"
      >
        <% if epm_has_value %>
          <div class="h-[24px] flex items-end justify-center text-sm">
            <span class="font-mono tabular-nums <%= epm_color_class %>"><%= format_epm_value(epm_value) %></span>
          </div>
          <div class="h-[16px] -mt-px flex items-start justify-center">
            <% if epm_percentile.present? %>
              <span class="text-[10px] leading-none font-mono tabular-nums whitespace-nowrap <%= epm_color_class || 'text-zinc-700 dark:text-zinc-300' %>"><%= epm_percentile_blocks(epm_percentile) %></span>
            <% else %>
              <span class="text-[10px] leading-none tabular-nums whitespace-nowrap text-muted-foreground/50">—</span>
            <% end %>
          </div>
        <% else %>
          <span class="grid place-items-center w-full">
            <span class="inline-block font-mono tabular-nums text-center text-muted-foreground/50" style="width: 6ch">—</span>
          </span>
        <% end %>
      </div>

      <% salary_years.each do |year| %>
        <% salary = player_salary(player, year) %>
        <% cap_hold = player_cap_hold(player, year) %>
        <% cap_hold_present = cap_hold.present? && cap_hold.to_f > 0 %>
        <% is_empty = salary.nil? %>
        <% cell_classes = salary_cell_classes(player, year) %>
        <% effective_cell_classes = cell_classes %>
        <% tooltip = salary_cell_tooltip(player, year) %>
        <% cell_tooltip = tooltip.presence || (cap_hold_present ? "Cap Hold: #{format_compact_currency(cap_hold)}" : nil) %>
        <% pct = format_pct_cap_with_blocks(player, year) %>
        <% show_two_way_badge = player["is_two_way"] && salary.present? && salary.to_f == 0 %>
        <% is_trade_restricted_cell = trade_restricted_now?(player, year) %>
        <% has_special_bg = effective_cell_classes.include?("bg-") %>
        <% data_class_expr = if is_empty && cap_hold_present
          "{ 'bg-zinc-100/60 dark:bg-zinc-800/30 text-zinc-700 dark:text-zinc-300': $displayplayercapholds, 'bg-yellow-50/70 dark:bg-yellow-900/10': $selectedseason === '#{year}' && !$displayplayercapholds }"
        elsif !has_special_bg
          "{ 'bg-yellow-50/70 dark:bg-yellow-900/10': $selectedseason === '#{year}' }"
        end %>

        <div
          class="w-24 shrink-0 <%= (show_two_way_badge || is_empty) ? 'grid place-items-center h-[40px]' : 'flex flex-col' %> <%= effective_cell_classes %>"
          <% if data_class_expr.present? %>data-class="<%= data_class_expr %>"<% end %>
          <% if cell_tooltip.present? %>title="<%= cell_tooltip %>"<% end %>
        >
          <% if show_two_way_badge %>
            <span class="inline-flex items-center justify-center text-[10px] px-1.5 py-0.5 rounded font-medium <%= is_trade_restricted_cell ? 'bg-red-200 dark:bg-red-900/50 text-red-700 dark:text-red-300' : neutral_badge_classes %>">
              Two-Way
            </span>
          <% elsif is_empty %>
            <% if cap_hold_present %>
              <span class="grid place-items-center w-full" data-show="!$displayplayercapholds">
                <span class="inline-block font-mono tabular-nums text-center text-muted-foreground/50" style="width: 6ch">—</span>
              </span>
              <div class="h-[40px] w-full flex flex-col italic" data-show="$displayplayercapholds" style="display: none;">
                <div class="h-[24px] flex items-end justify-center text-sm">
                  <span class="grid place-items-center w-full">
                    <span class="inline-block font-mono tabular-nums text-right" style="width: 6ch"><%= format_compact_currency(cap_hold) %></span>
                  </span>
                </div>
                <div class="h-[16px] -mt-px flex items-start justify-center">
                  <span class="text-[10px] leading-none tabular-nums whitespace-nowrap uppercase tracking-wide">HOLD</span>
                </div>
              </div>
            <% else %>
              <span class="grid place-items-center w-full">
                <span class="inline-block font-mono tabular-nums text-center text-muted-foreground/50" style="width: 6ch">—</span>
              </span>
            <% end %>
          <% else %>
            <%# Salary row (A) %>
            <div class="h-[24px] flex items-end justify-center text-sm">
              <span class="grid place-items-center w-full">
                <span class="inline-block font-mono tabular-nums text-right" style="width: 6ch"><%= format_salary(salary) %></span>
              </span>
            </div>

            <%# Under-salary row (B): MINIMUM or pct-cap + blocks %>
            <div class="h-[16px] -mt-px flex items-start justify-center">
              <% if player["is_min_contract"] %>
                <span class="text-[10px] leading-none tabular-nums whitespace-nowrap text-muted-foreground/80">MINIMUM</span>
              <% elsif pct %>
                <span class="text-[10px] leading-none tabular-nums whitespace-nowrap text-muted-foreground/80">
                  <%= pct[:label] %>
                  <% if pct[:blocks].present? %>
                    <span class="ml-0.5 opacity-70"><%= pct[:blocks] %></span>
                  <% end %>
                </span>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>

      <%# Total salary column %>
      <% total = player["total_salary_from_2025"] %>
      <% show_two_way_total_badge = player["is_two_way"] %>
      <% is_trade_restricted_total_badge = trade_restricted_now?(player) %>
      <div class="w-24 shrink-0 <%= show_two_way_total_badge ? 'grid place-items-center h-[40px]' : 'flex flex-col' %>" title="<%= player["contract_type_lookup_value"] %>">
        <% if show_two_way_total_badge %>
          <span class="inline-flex items-center justify-center text-[10px] px-1.5 py-0.5 rounded font-medium <%= is_trade_restricted_total_badge ? 'bg-red-200 dark:bg-red-900/50 text-red-700 dark:text-red-300' : neutral_badge_classes %>">
            Two-Way
          </span>
        <% else %>
          <div class="h-[24px] flex items-end justify-center text-sm">
            <span class="grid place-items-center w-full">
              <span class="inline-block font-mono tabular-nums text-right font-semibold" style="width: 7ch"><%= format_salary(total) %></span>
            </span>
          </div>
          <div class="h-[16px] -mt-px flex items-start justify-center">
            <% if player["contract_type_code"].present? %>
              <span class="text-[10px] leading-none tabular-nums whitespace-nowrap text-muted-foreground"><%= player["contract_type_code"] %></span>
            <% else %>
              <span class="text-[10px] leading-none tabular-nums whitespace-nowrap text-muted-foreground/50">—</span>
            <% end %>
          </div>
        <% end %>
      </div>

      <%# Agent + Agency column %>
      <div class="w-40 shrink-0 flex flex-col pr-4 min-w-0 overflow-hidden text-left">
        <%#
          Pixel-tuned alignment (do not casually tweak):
          - Agent text uses `-translate-y-[3px]`
          - Agency text uses `-translate-y-px`
          This preserves baseline alignment with Salary/% rows while avoiding descender clipping
          (e.g. g/p/q/y) in truncated names.
        %>
        <%# Row A: Agent name %>
        <div class="h-[24px] flex items-end justify-start min-w-0 overflow-hidden">
          <% if player["agent_name"].present? && player["agent_id"].present? %>
            <button
              type="button"
              class="cursor-pointer block w-full text-left text-xs leading-tight truncate -translate-y-[3px] text-muted-foreground hover:text-foreground hover:underline
                     focus:outline-none focus-visible:underline focus-visible:text-foreground transition-colors"
              data-on:click="evt.stopPropagation(); @get('<%= tools_salary_book_sidebar_agent_path(id: player["agent_id"]) %>')"
            ><%= player["agent_name"] %></button>
          <% elsif player["agent_name"].present? %>
            <span class="block w-full text-xs leading-tight truncate -translate-y-[3px] text-muted-foreground"><%= player["agent_name"] %></span>
          <% else %>
            <span class="text-xs -translate-y-[3px] text-muted-foreground/50">—</span>
          <% end %>
        </div>

        <%# Row B: Agency name %>
        <div class="h-[16px] -mt-px flex items-start justify-start gap-1.5 leading-none text-[10px] tabular-nums min-w-0 overflow-hidden">
          <% if player["agency_name"].present? %>
            <span class="block w-full text-muted-foreground leading-tight truncate -translate-y-px"><%= player["agency_name"] %></span>
          <% else %>
            <span class="text-muted-foreground/50 -translate-y-px">—</span>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
