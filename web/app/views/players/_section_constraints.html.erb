<% horizon_years = (2025..2030).to_a %>
<% option_chips = horizon_years.filter_map do |year|
  option = normalize_contract_option(@salary_book_row&.fetch("option_#{year}", nil))
  next if option.blank?
  "#{option} #{year}"
end %>
<%
  decision_items = player_next_decision_items(
    salary_book_row: @salary_book_row,
    protection_condition_rows: @protection_condition_rows,
    ledger_entries: @ledger_entries
  )
  option_count = decision_items.count { |item| item[:kind] == "option" }
  expiring_count = decision_items.count { |item| item[:kind] == "expiring" }
  guarantee_count = decision_items.count { |item| item[:kind] == "guarantee" }
  urgent_count = decision_items.count { |item| item.dig(:urgency, :variant) == "danger" }
%>

<section id="constraints" class="space-y-3">
  <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Constraint posture</h2>
  <div class="flex flex-wrap gap-2">
    <% chips = [] %>
    <% if @salary_book_row&.fetch("is_trade_restricted_now", nil) %>
      <% label = "Trade restricted now" %>
      <% if @salary_book_row["trade_restriction_end_date"].present? %>
        <% label = "Trade restricted until #{format_plain_date(@salary_book_row['trade_restriction_end_date'])}" %>
      <% end %>
      <% chips << [label, "entity-chip--danger"] %>
    <% end %>
    <% if @salary_book_row&.fetch("is_trade_consent_required_now", nil) %>
      <% label = "Player consent required" %>
      <% if @salary_book_row["player_consent_end_date"].present? %>
        <% label = "Consent required until #{format_plain_date(@salary_book_row['player_consent_end_date'])}" %>
      <% end %>
      <% chips << [label, "entity-chip--warning"] %>
    <% end %>
    <% if @salary_book_row&.fetch("is_no_trade", nil) %>
      <% chips << ["No-trade clause", "entity-chip--danger"] %>
    <% end %>
    <% if @salary_book_row&.fetch("is_trade_bonus", nil) %>
      <% pct = @salary_book_row["trade_bonus_percent"].presence %>
      <% chips << ["Trade kicker#{pct ? " #{pct.to_f.round}%" : ""}", "entity-chip--warning"] %>
    <% end %>
    <% if @salary_book_row&.fetch("is_poison_pill", nil) %>
      <% chips << ["Poison pill", "entity-chip--warning"] %>
    <% end %>
    <% option_chips.each { |option_label| chips << [option_label, "entity-chip--accent"] } %>

    <% if chips.empty? %>
      <span class="entity-chip entity-chip--muted">No active restrictions</span>
    <% else %>
      <% chips.each do |label, klass| %>
        <span class="entity-chip <%= klass %>"><%= label %></span>
      <% end %>
    <% end %>
  </div>

  <% if decision_items.any? %>
    <div class="rounded-lg border border-border bg-background px-3 py-2">
      <div class="flex flex-wrap items-center justify-between gap-2 text-[11px]">
        <span class="font-medium text-foreground">Decision rail coverage</span>
        <a href="#next-decisions" class="text-muted-foreground hover:text-foreground hover:underline">Jump to next decisions</a>
      </div>

      <div class="mt-2 flex flex-wrap gap-1.5">
        <% if option_count.positive? %><span class="entity-chip entity-chip--accent"><%= option_count %> option</span><% end %>
        <% if expiring_count.positive? %><span class="entity-chip entity-chip--warning"><%= expiring_count %> expiring</span><% end %>
        <% if guarantee_count.positive? %><span class="entity-chip entity-chip--danger"><%= guarantee_count %> guarantee trigger</span><% end %>
        <% if urgent_count.positive? %><span class="entity-chip entity-chip--danger"><%= urgent_count %> urgent</span><% end %>
      </div>
    </div>
  <% end %>
</section>
