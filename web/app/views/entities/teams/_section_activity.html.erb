<section id="activity" class="space-y-3">
  <h2 class="text-xs font-medium uppercase tracking-wide text-muted-foreground">Transaction activity</h2>
  <details class="rounded-lg border border-border bg-background" open>
    <summary class="cursor-pointer px-4 py-3 text-sm font-medium hover:bg-muted/30">
      Recent ledger + exception usage
      <span class="ml-2 text-xs text-muted-foreground">(<%= @recent_ledger_entries.size %> ledger · <%= @exception_usage_rows.size %> exception usage)</span>
    </summary>
    <div class="px-4 pb-4 space-y-4">
      <div class="mt-3">
        <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground mb-2">Recent team ledger entries</div>
        <% if @recent_ledger_entries.empty? %>
          <div class="p-4 rounded-lg bg-muted/30 border border-border/50 text-sm text-muted-foreground italic">No ledger rows found.</div>
        <% else %>
          <div class="overflow-x-auto rounded-lg border border-border">
            <table class="entity-table min-w-full text-xs">
              <thead class="bg-muted/40 text-[10px] uppercase tracking-wide text-muted-foreground/90">
                <tr>
                  <th class="text-left px-3 py-2 font-medium">Date</th>
                  <th class="text-left px-3 py-2 font-medium">Player</th>
                  <th class="text-left px-3 py-2 font-medium">Transaction</th>
                  <th class="text-left px-3 py-2 font-medium">Type</th>
                  <th class="text-right px-3 py-2 font-medium">Cap Δ</th>
                  <th class="text-right px-3 py-2 font-medium">Tax Δ</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-border">
                <% @recent_ledger_entries.first(30).each do |r| %>
                  <tr class="hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 transition-colors duration-75">
                    <td class="px-3 py-2 font-mono tabular-nums"><%= r["ledger_date"] || "—" %></td>
                    <td class="px-3 py-2">
                      <% if r["player_id"].present? %>
                        <a href="<%= player_href(r['player_id']) %>" class="font-medium hover:underline"><%= r["player_name"] %></a>
                      <% else %>
                        <span class="text-muted-foreground"><%= r["player_name"] || "—" %></span>
                      <% end %>
                    </td>
                    <td class="px-3 py-2 font-mono tabular-nums">
                      <% if r["transaction_id"].present? %>
                        <a href="<%= transaction_href(r['transaction_id']) %>" class="hover:underline">#<%= r["transaction_id"] %></a>
                        <% if r["trade_id"].present? %>
                          · <a href="<%= trade_href(r['trade_id']) %>" class="hover:underline">T#<%= r["trade_id"] %></a>
                        <% end %>
                      <% else %>
                        <span class="text-muted-foreground">—</span>
                      <% end %>
                    </td>
                    <td class="px-3 py-2 text-muted-foreground"><%= [r["transaction_type_lk"], r["transaction_description_lk"]].compact.reject(&:blank?).join(" · ").presence || "—" %></td>
                    <td class="px-3 py-2 text-right font-mono tabular-nums"><%= format_salary(r["cap_change"]) %></td>
                    <td class="px-3 py-2 text-right font-mono tabular-nums"><%= format_salary(r["tax_change"]) %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% end %>
      </div>

      <div>
        <div class="text-xs font-medium uppercase tracking-wide text-muted-foreground mb-2">Exception usage audit</div>
        <% if @exception_usage_rows.empty? %>
          <div class="p-4 rounded-lg bg-muted/30 border border-border/50 text-sm text-muted-foreground italic">No exception usage rows found.</div>
        <% else %>
          <div class="overflow-x-auto rounded-lg border border-border">
            <table class="entity-table min-w-full text-xs">
              <thead class="bg-muted/40 text-[10px] uppercase tracking-wide text-muted-foreground/90">
                <tr>
                  <th class="text-left px-3 py-2 font-medium">Date</th>
                  <th class="text-left px-3 py-2 font-medium">Exception</th>
                  <th class="text-left px-3 py-2 font-medium">Player</th>
                  <th class="text-left px-3 py-2 font-medium">Action</th>
                  <th class="text-right px-3 py-2 font-medium">Change</th>
                  <th class="text-right px-3 py-2 font-medium">Remaining</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-border">
                <% @exception_usage_rows.first(30).each do |r| %>
                  <tr class="hover:bg-yellow-50/70 dark:hover:bg-yellow-900/10 transition-colors duration-75">
                    <td class="px-3 py-2 font-mono tabular-nums"><%= r["effective_date"] || "—" %></td>
                    <td class="px-3 py-2 text-muted-foreground"><%= r["exception_type_lk"] || "—" %></td>
                    <td class="px-3 py-2">
                      <% if r["player_id"].present? %>
                        <a href="<%= player_href(r['player_id']) %>" class="font-medium hover:underline"><%= r["player_name"] %></a>
                      <% else %>
                        <span class="text-muted-foreground"><%= r["player_name"] || "—" %></span>
                      <% end %>
                    </td>
                    <td class="px-3 py-2 text-muted-foreground"><%= [r["exception_action_lk"], r["transaction_type_lk"]].compact.reject(&:blank?).join(" · ").presence || "—" %></td>
                    <td class="px-3 py-2 text-right font-mono tabular-nums"><%= format_salary(r["change_amount"]) %></td>
                    <td class="px-3 py-2 text-right font-mono tabular-nums"><%= format_salary(r["remaining_exception_amount"]) %></td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        <% end %>
      </div>
    </div>
  </details>
</section>
